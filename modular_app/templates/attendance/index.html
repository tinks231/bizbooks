<!DOCTYPE html>
<html>
<head>
  <title>Attendance App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial; text-align: center; margin: 20px; background: #f5f5f5; }
    .container { max-width: 500px; margin: 40px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h2 { color: #2c3e50; margin-bottom: 10px; }
    p { color: #7f8c8d; margin-bottom: 30px; }
    input, select, button { font-size: 1.1em; margin: 10px; padding: 12px; width: 90%; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
    button { 
      width: 45%; 
      border: none; 
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    button:disabled { 
      background: #ccc !important; 
      color: #666 !important;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .btn-success { background: #28a745; }
    .btn-success:hover:not(:disabled) { background: #218838; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover:not(:disabled) { background: #c82333; }
    #locationStatus { 
      padding: 15px; 
      margin: 15px 10px; 
      border-radius: 5px; 
      font-weight: bold;
    }
    .loading { background: #fff3cd; color: #856404; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .form-group { margin: 15px 0; text-align: left; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; margin-left: 10px; }
    .button-group { display: flex; justify-content: center; gap: 10px; margin-top: 30px; }
    a { color: #3498db; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <div style="text-align: left; margin-bottom: 20px;">
      <a href="/employee/dashboard" style="display: inline-block; padding: 8px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 5px; font-size: 14px;">
        ‚Üê Back to Portal
      </a>
    </div>
    
    <h2>üìç Mark Attendance</h2>
    <p>Enter your PIN and take a selfie</p>
    
    <div id="locationStatus" class="loading">üìç Getting your location...</div>
    
    <form id="attendanceForm" method="POST" enctype="multipart/form-data" action="/attendance/submit">
      <div class="form-group">
        <label>Enter Your PIN:</label>
        <input type="password" name="pin" id="pin" placeholder="4-digit PIN" maxlength="4" pattern="[0-9]{4}" required autofocus>
      </div>
      
      <input type="hidden" name="latitude" id="latitude">
      <input type="hidden" name="longitude" id="longitude">
      
      <div class="form-group">
        <label>Take a Selfie:</label>
        <input type="file" id="photoInput" name="photo" accept="image/*" capture="user" required>
      </div>
      
      <div class="button-group">
        <button type="submit" name="action" value="check_in" class="btn-success">‚úÖ CHECK IN</button>
        <button type="submit" name="action" value="check_out" class="btn-danger">‚ùå CHECK OUT</button>
      </div>
    </form>
    
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
      <a href="/attendance/history">View Attendance History ‚Üí</a>
    </div>
  </div>

  <script>
    const statusDiv = document.getElementById('locationStatus');
    let locationObtained = false;

    // Get GPS coordinates with better error handling
    if (navigator.geolocation) {
        const options = {
            enableHighAccuracy: true,
            timeout: 10000,  // 10 seconds timeout
            maximumAge: 0
        };
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                // Success!
                document.getElementById('latitude').value = position.coords.latitude;
                document.getElementById('longitude').value = position.coords.longitude;
                locationObtained = true;
                statusDiv.className = 'success';
                statusDiv.innerHTML = '‚úÖ Location obtained! Ready to submit.';
            }, 
            function(error) {
                // Error handling with specific messages
                statusDiv.className = 'error';
                let errorMsg = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = '‚ùå Location permission denied. Please check settings.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = '‚ö†Ô∏è Location unavailable. Try going near a window or outside.';
                        break;
                    case error.TIMEOUT:
                        errorMsg = '‚è±Ô∏è Location timeout. Retrying...';
                        // Retry once
                        setTimeout(() => {
                            navigator.geolocation.getCurrentPosition(
                                function(pos) {
                                    document.getElementById('latitude').value = pos.coords.latitude;
                                    document.getElementById('longitude').value = pos.coords.longitude;
                                    locationObtained = true;
                                    statusDiv.className = 'success';
                                    statusDiv.innerHTML = '‚úÖ Location obtained! Ready to submit.';
                                },
                                function() {
                                    statusDiv.innerHTML = '‚ùå Still cannot get location. You can try submitting anyway.';
                                },
                                options
                            );
                        }, 1000);
                        break;
                    default:
                        errorMsg = '‚ùå Unknown error getting location.';
                        break;
                }
                statusDiv.innerHTML = errorMsg;
            },
            options
        );
    } else {
        statusDiv.className = 'error';
        statusDiv.innerHTML = '‚ùå Geolocation not supported by your browser!';
    }
  </script>
</body>
</html>
