<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}BizBooks - Business Management{% endblock %}</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BizBooks">
    <link rel="apple-touch-icon" href="https://pub-efaabb14d38e46898a2783236c60d05f.r2.dev/bizbooks_logo_square.png">
    
    <!-- Bootstrap CSS (for modals and components) - Cloudflare R2 CDN for ultra-fast loading -->
    <link rel="stylesheet" href="https://pub-efaabb14d38e46898a2783236c60d05f.r2.dev/vendor/bootstrap/css/bootstrap.min.css">
    
    <!-- BizBooks Design System - Form Styles - Cloudflare R2 CDN -->
    <link rel="stylesheet" href="https://pub-efaabb14d38e46898a2783236c60d05f.r2.dev/forms.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            line-height: 1.6;
            background: #f5f7fa;
            color: #2c3e50;
        }
        
        /* ===== SIDEBAR NAVIGATION ===== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 240px;
            height: 100vh;
            background: #2c3e50;
            color: white;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
            transition: transform 0.3s ease;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        
        .sidebar-header {
            padding: 20px;
            background: #34495e;
            border-bottom: 1px solid #1a252f;
        }
        
        .sidebar-brand {
            font-size: 22px;
            font-weight: 700;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-company {
            font-size: 13px;
            color: #95a5a6;
            margin-top: 5px;
            font-weight: normal;
        }
        
        .sidebar-nav {
            padding: 10px 0;
        }
        
        .nav-section {
            margin-top: 20px;
        }
        
        .nav-section-title {
            padding: 10px 20px 5px;
            font-size: 11px;
            font-weight: 700;
            color: #95a5a6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .nav-item {
            display: block;
            padding: 12px 20px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.2s;
            font-size: 14px;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: #34495e;
            border-left-color: #3498db;
        }
        
        .nav-item.active {
            background: #34495e;
            border-left-color: #3498db;
            color: #3498db;
            font-weight: 600;
        }
        
        .nav-item i {
            margin-right: 10px;
            width: 20px;
            display: inline-block;
            text-align: center;
        }
        
        .nav-item.logout {
            color: #e74c3c;
            margin-top: 30px;
            border-top: 1px solid #34495e;
            padding-top: 20px;
        }
        
        .nav-item.logout:hover {
            background: #c0392b;
            border-left-color: #e74c3c;
            color: white;
        }
        
        /* ===== COLLAPSIBLE NAVIGATION ===== */
        .nav-section-collapsible {
            margin-bottom: 5px;
        }
        
        .nav-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            user-select: none;
        }
        
        .nav-section-header:hover {
            background: #34495e;
            border-left-color: #3498db;
        }
        
        .nav-section-header.active {
            background: #34495e;
            border-left-color: #3498db;
        }
        
        .nav-section-label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ecf0f1;
            font-size: 14px;
            font-weight: 600;
        }
        
        .nav-section-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        .nav-section-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
            color: #95a5a6;
        }
        
        .nav-section-header.active .nav-section-arrow {
            transform: rotate(90deg);
        }
        
        .nav-section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #1a252f;
        }
        
        .nav-section-content.open {
            max-height: 1000px; /* Large enough for any content */
        }
        
        .nav-section-content .nav-item {
            padding-left: 54px; /* Indent sub-items */
            font-size: 13px;
            border-left-color: transparent;
        }
        
        .nav-section-content .nav-item:hover {
            background: #2c3e50;
            border-left-color: #3498db;
        }
        
        .nav-section-content .nav-item.active {
            background: #2c3e50;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        /* ===== MAIN CONTENT AREA ===== */
        .main-content {
            margin-left: 240px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }
        
        /* Top Header Bar */
        .top-header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        /* ===== PROFILE DROPDOWN ===== */
        .profile-dropdown {
            position: relative;
        }
        
        .profile-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f5f7fa;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .profile-btn:hover {
            background: #e8ecf1;
            border-color: #3498db;
        }
        
        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            line-height: 1.2;
        }
        
        .profile-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .profile-role {
            font-size: 11px;
            color: #7f8c8d;
        }
        
        .profile-arrow {
            font-size: 10px;
            color: #95a5a6;
            transition: transform 0.2s;
        }
        
        .profile-dropdown.active .profile-arrow {
            transform: rotate(180deg);
        }
        
        .profile-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
            z-index: 1000;
        }
        
        .profile-dropdown.active .profile-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .profile-menu-header {
            padding: 15px 20px;
            border-bottom: 1px solid #ecf0f1;
            background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%);
        }
        
        .profile-menu-header-name {
            font-weight: 700;
            color: #2c3e50;
            font-size: 15px;
        }
        
        .profile-menu-header-email {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 3px;
        }
        
        .profile-menu-items {
            padding: 8px 0;
        }
        
        .profile-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #2c3e50;
            text-decoration: none;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .profile-menu-item:hover {
            background: #f8f9fa;
            color: #3498db;
        }
        
        .profile-menu-item i {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }
        
        .profile-menu-divider {
            height: 1px;
            background: #ecf0f1;
            margin: 8px 0;
        }
        
        .profile-menu-item.logout {
            color: #e74c3c;
        }
        
        .profile-menu-item.logout:hover {
            background: #ffebee;
            color: #c0392b;
        }
        
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #2c3e50;
            padding: 5px;
        }
        
        /* Content Container */
        .container {
            padding: 30px;
            padding-bottom: 100px; /* Extra space for macOS dock/taskbar */
            max-width: 1400px;
        }
        
        /* ===== CARDS ===== */
        .card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f5f7fa;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        /* ===== STATS GRID ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #3498db;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        /* ===== TABLES ===== */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        /* ===== FORMS ===== */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dfe6e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* ===== ALERTS ===== */
        .alert {
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 6px;
            border-left: 4px solid;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-color: #3498db;
            color: #0c5460;
        }
        
        /* ===== CHECKBOX & RADIO BUTTON ALIGNMENT (ALL SCREENS) ===== */
        .form-group label input[type="checkbox"],
        .form-group label input[type="radio"] {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            margin: 0;
            margin-right: 8px;
            cursor: pointer;
        }
        
        .form-group label span {
            font-size: 14px;
            line-height: 1.5;
            white-space: nowrap;
        }
        
        /* Labels with checkboxes/radios */
        label:has(input[type="checkbox"]),
        label:has(input[type="radio"]) {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            white-space: nowrap;
        }
        
        /* ===== MOBILE RESPONSIVE ===== */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px; /* Wider on mobile for better touch targets */
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height (accounts for browser chrome) */
                padding-bottom: 80px; /* Extra padding at bottom for scrolling */
            }
            
            .sidebar.active {
                transform: translateX(0);
                box-shadow: 2px 0 15px rgba(0,0,0,0.3);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            /* Ensure nav items are touchable */
            .nav-item {
                padding: 15px 20px; /* Larger tap targets */
                font-size: 15px;
            }
            
            /* Make logout button more visible */
            .nav-item.logout {
                margin-bottom: 60px; /* Extra margin to ensure it's scrollable */
            }
            
            .container {
                padding: 15px;
            }
            
            .top-header {
                padding: 12px 15px;
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .header-title {
                font-size: 18px;
                text-align: center;
            }
            
            .header-actions {
                display: flex;
                gap: 8px;
                width: 100%;
                justify-content: space-between;
                align-items: center;
            }
            
            .header-actions .btn {
                padding: 8px 10px;
                font-size: 12px;
                white-space: nowrap;
                flex: 1;
            }
            
            /* Profile dropdown on mobile */
            .profile-dropdown {
                flex: 0 0 auto;
            }
            
            .profile-btn {
                padding: 8px;
                min-width: 40px;
                justify-content: center;
            }
            
            .profile-info {
                display: none !important; /* Hide name/company on mobile */
            }
            
            .profile-menu {
                right: 0;
                left: auto;
                min-width: 200px;
            }
            
            /* ===== IMPROVED STATS GRID FOR MOBILE ===== */
            .stats-grid {
                grid-template-columns: repeat(3, 1fr); /* 3 columns for small stats */
                gap: 10px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 15px 10px;
                min-height: auto;
            }
            
            .stat-value {
                font-size: 20px;
                margin-bottom: 5px;
            }
            
            .stat-label {
                font-size: 11px;
                line-height: 1.2;
            }
            
            /* Dashboard cards - MUCH smaller on mobile */
            body .card {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            body .card h2 {
                font-size: 20px !important;
                margin: 0 !important;
            }
            
            body .card p {
                font-size: 12px !important;
                margin: 5px 0 0 0 !important;
            }
            
            /* Make dashboard grid compact on mobile */
            [style*="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr))"] {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
                margin: 15px 0 !important;
            }
            
            /* Recent attendance & low stock tables - 1 column */
            [style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* ===== FORM IMPROVEMENTS ===== */
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            /* Fix forms with inline grid styles (like sites page) */
            form[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Fix grid-column spans on mobile */
            [style*="grid-column: span"] {
                grid-column: span 1 !important;
            }
            
            /* Fix checkbox alignment in forms */
            .form-group label[style*="display: flex"] {
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
                flex-wrap: nowrap !important;
                width: 100% !important;
                justify-content: flex-start !important;
            }
            
            .form-group label input[type="checkbox"],
            .form-group label input[type="radio"] {
                flex-shrink: 0;
                width: 18px;
                height: 18px;
                margin: 0;
            }
            
            .form-group label span {
                flex: 1;
                font-size: 14px;
                line-height: 1.3;
            }
            
            /* Fix "Track Inventory" checkbox */
            .form-group label[style*="font-weight: 700"] {
                font-size: 14px !important;
            }
            
            /* Fix radio buttons (Type: Goods/Service) */
            .form-group > div[style*="display: flex"] {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 10px !important;
            }
            
            /* ===== TABLE IMPROVEMENTS ===== */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            table th,
            table td {
                padding: 8px;
                font-size: 13px;
            }
            
            /* ===== BUTTON IMPROVEMENTS ===== */
            .btn {
                padding: 10px 15px;
                font-size: 14px;
                white-space: nowrap;
            }
            
            .header-actions .btn {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            /* ===== INPUT IMPROVEMENTS ===== */
            input[type="text"],
            input[type="number"],
            input[type="email"],
            input[type="tel"],
            input[type="password"],
            select,
            textarea {
                font-size: 16px !important; /* Prevents iOS zoom on focus */
            }
        }
        
        /* ===== UTILITY CLASSES ===== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .hide-mobile { display: block; }
        
        @media (max-width: 768px) {
            .hide-mobile { display: none; }
        }
        
        /* Pulse animation for notification badge */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 8px rgba(255, 107, 107, 0);
            }
        }
        
        {% block extra_css %}{% endblock %}
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/admin/dashboard" class="sidebar-brand">
                ğŸ¢ BizBooks
            </a>
            {% if tenant %}
            <div class="sidebar-company">{{ tenant.company_name }}</div>
            {% endif %}
        </div>
        <!-- Cache buster: v1 -->
        
        <nav class="sidebar-nav">
            <!-- Home -->
            <a href="/admin/dashboard" class="nav-item {% if request.path == '/admin/dashboard' %}active{% endif %}">
                <i>ğŸ </i> Home
            </a>
            
            <!-- Quick Actions -->
            <div class="nav-section">
                <a href="/admin/bulk-import" class="nav-item {% if '/admin/bulk-import' in request.path %}active{% endif %}" style="background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-left-color: #667eea;">
                    <i>ğŸ“¥</i> Bulk Import
                    <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 8px; font-size: 9px; margin-left: 5px; font-weight: 700;">NEW</span>
                </a>
            </div>
            
            <!-- PARTIES Section (Collapsible) -->
            <div class="nav-section-collapsible">
                <div class="nav-section-header" onclick="toggleSection('parties')">
                    <div class="nav-section-label">
                        <span class="nav-section-icon">ğŸ‘¥</span>
                        <span>Parties</span>
                    </div>
                    <span class="nav-section-arrow">â–¶</span>
                </div>
                <div class="nav-section-content" id="section-parties">
                    <a href="/admin/customers" class="nav-item {% if '/admin/customers' in request.path %}active{% endif %}">
                        <i>ğŸ‘¤</i> Customers
                    </a>
                    <a href="/admin/vendors" class="nav-item {% if '/admin/vendors' in request.path %}active{% endif %}">
                        <i>ğŸ­</i> Vendors
                    </a>
                    <a href="/admin/employees" class="nav-item {% if '/admin/employees' in request.path %}active{% endif %}">
                        <i>ğŸ‘”</i> Employees
                    </a>
                    <a href="/admin/commission-agents" class="nav-item {% if '/admin/commission-agents' in request.path %}active{% endif %}">
                        <i>ğŸ’°</i> Commission Agents
                    </a>
                </div>
            </div>
            
            <!-- ITEMS & INVENTORY Section (Collapsible) -->
            <div class="nav-section-collapsible">
                <div class="nav-section-header" onclick="toggleSection('items')">
                    <div class="nav-section-label">
                        <span class="nav-section-icon">ğŸ“¦</span>
                        <span>Items & Inventory</span>
                    </div>
                    <span class="nav-section-arrow">â–¶</span>
                </div>
                <div class="nav-section-content" id="section-items">
                    <a href="/admin/items" class="nav-item {% if '/admin/items' in request.path and 'groups' not in request.path and 'categories' not in request.path and 'stock' not in request.path and 'adjustments' not in request.path and 'transfers' not in request.path and 'reports' not in request.path %}active{% endif %}">
                        <i>ğŸ“‹</i> All Items
                    </a>
                    <a href="/admin/items/groups" class="nav-item {% if '/admin/items/groups' in request.path %}active{% endif %}">
                        <i>ğŸ“‘</i> Item Groups
                    </a>
                    <a href="/admin/items/categories" class="nav-item {% if '/admin/items/categories' in request.path %}active{% endif %}">
                        <i>ğŸ·ï¸</i> Categories
                    </a>
                    <a href="/admin/items/stock-summary" class="nav-item {% if '/admin/items/stock-summary' in request.path %}active{% endif %}">
                        <i>ğŸ“Š</i> Stock Summary
                    </a>
                    <a href="/admin/sites" class="nav-item {% if '/admin/sites' in request.path %}active{% endif %}">
                        <i>ğŸ“</i> Sites/Warehouses
                    </a>
                    <a href="/admin/items/adjustments" class="nav-item {% if '/admin/items/adjustments' in request.path %}active{% endif %}">
                        <i>ğŸ”§</i> Stock Adjustments
                    </a>
                    <a href="/admin/items/transfers" class="nav-item {% if '/admin/items/transfers' in request.path %}active{% endif %}">
                        <i>ğŸ”„</i> Stock Transfers
                    </a>
                </div>
            </div>
            
            <!-- SALES Section (Collapsible) -->
            <div class="nav-section-collapsible">
                <div class="nav-section-header" onclick="toggleSection('sales')">
                    <div class="nav-section-label">
                        <span class="nav-section-icon">ğŸ’°</span>
                        <span>Sales</span>
                    </div>
                    <span class="nav-section-arrow">â–¶</span>
                </div>
                <div class="nav-section-content" id="section-sales">
                    <a href="/sales-orders" class="nav-item {% if '/sales-orders' in request.path %}active{% endif %}">
                        <i>ğŸ“‹</i> Sales Orders
                    </a>
                    <a href="/delivery-challans/list" class="nav-item {% if '/delivery-challans' in request.path %}active{% endif %}">
                        <i>ğŸšš</i> Delivery Challans
                    </a>
                    <a href="/admin/invoices" class="nav-item {% if '/admin/invoices' in request.path and 'settings' not in request.path %}active{% endif %}">
                        <i>ğŸ“„</i> Invoices
                    </a>
                    <a href="/admin/returns" class="nav-item {% if '/returns' in request.path %}active{% endif %}">
                        <i>â†©ï¸</i> Returns & Refunds
                    </a>
                    <a href="/admin/invoices/settings" class="nav-item {% if '/admin/invoices/settings' in request.path %}active{% endif %}">
                        <i>âš™ï¸</i> Invoice Settings
                    </a>
                </div>
            </div>
            
            <!-- LOYALTY PROGRAM Section (Collapsible) -->
            <div class="nav-section-collapsible">
                <div class="nav-section-header" onclick="toggleSection('loyalty')">
                    <div class="nav-section-label">
                        <span class="nav-section-icon">ğŸ</span>
                        <span>Loyalty Program</span>
                    </div>
                    <span class="nav-section-arrow">â–¶</span>
                </div>
                <div class="nav-section-content" id="section-loyalty">
                    <a href="{{ url_for('loyalty.settings') }}" class="nav-item {% if '/admin/loyalty/settings' in request.path %}active{% endif %}">
                        <i>âš™ï¸</i> Settings
                    </a>
                    <a href="{{ url_for('loyalty.reports') }}" class="nav-item {% if '/admin/loyalty/reports' in request.path %}active{% endif %}">
                        <i>ğŸ“Š</i> Reports & Analytics
                    </a>
                </div>
            </div>
            
            <!-- PURCHASE & EXPENSES Section (Collapsible) -->
            <div class="nav-section-collapsible">
                <div class="nav-section-header" onclick="toggleSection('purchase')">
                    <div class="nav-section-label">
                        <span class="nav-section-icon">ğŸ›’</span>
                        <span>Purchase & Expenses</span>
                    </div>
                    <span class="nav-section-arrow">â–¶</span>
                </div>
                <div class="nav-section-content" id="section-purchase">
                    <a href="/admin/purchase-requests" class="nav-item {% if '/admin/purchase-requests' in request.path %}active{% endif %}">
                        <i>ğŸ“</i> Purchase Requests
                        {% if g.pending_purchase_count and g.pending_purchase_count > 0 %}
                        <span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: auto;">
                            {{ g.pending_purchase_count }}
                        </span>
                        {% endif %}
                    </a>
                    <a href="/admin/purchase-bills" class="nav-item {% if '/admin/purchase-bills' in request.path %}active{% endif %}">
                        <i>ğŸ’¼</i> Purchase Bills
                    </a>
                    <a href="/admin/expenses" class="nav-item {% if '/admin/expenses' in request.path and 'reports' not in request.path and 'categories' not in request.path %}active{% endif %}">
                        <i>ğŸ’¸</i> Expenses
                    </a>
                    <a href="/admin/expenses/categories" class="nav-item {% if '/admin/expenses/categories' in request.path %}active{% endif %}">
                        <i>ğŸ·ï¸</i> Expense Categories
                    </a>
                </div>
            </div>
            
            <!-- PAYROLL Section (Collapsible) -->
            <div class="nav-section-collapsible">
                <div class="nav-section-header" onclick="toggleSection('payroll')">
                    <div class="nav-section-label">
                        <span class="nav-section-icon">ğŸ’°</span>
                        <span>Payroll</span>
                    </div>
                    <span class="nav-section-arrow">â–¶</span>
                </div>
                <div class="nav-section-content" id="section-payroll">
                    <a href="/admin/payroll/pay-salary" class="nav-item {% if '/admin/payroll/pay-salary' in request.path %}active{% endif %}">
                        <i>ğŸ’µ</i> Pay Salary
                    </a>
                    <a href="/admin/payroll/salary-register" class="nav-item {% if '/admin/payroll/salary-register' in request.path %}active{% endif %}">
                        <i>ğŸ“Š</i> Salary Register
                    </a>
                </div>
            </div>
            
            <!-- REPORTS Section (Collapsible) -->
            <div class="nav-section-collapsible">
                <div class="nav-section-header" onclick="toggleSection('reports')">
                    <div class="nav-section-label">
                        <span class="nav-section-icon">ğŸ“Š</span>
                        <span>Reports</span>
                    </div>
                    <span class="nav-section-arrow">â–¶</span>
                </div>
                <div class="nav-section-content" id="section-reports">
                    <a href="/admin/items/reports" class="nav-item {% if '/admin/items/reports' in request.path %}active{% endif %}">
                        <i>ğŸ“¦</i> Inventory Reports
                    </a>
                    <a href="/admin/expenses/reports" class="nav-item {% if '/admin/expenses/reports' in request.path %}active{% endif %}">
                        <i>ğŸ’¸</i> Expense Reports
                    </a>
                    <a href="/admin/customers/outstanding" class="nav-item {% if '/admin/customers/outstanding' in request.path %}active{% endif %}">
                        <i>ğŸ’°</i> Outstanding Report
                    </a>
                    <a href="/admin/commission-reports" class="nav-item {% if '/admin/commission-reports' in request.path %}active{% endif %}">
                        <i>ğŸ’¸</i> Commission Reports
                    </a>
                    <a href="/admin/gst-reports" class="nav-item {% if '/admin/gst-reports' in request.path %}active{% endif %}">
                        <i>ğŸ“‹</i> GST Reports
                    </a>
                    
                    <!-- Accounting Reports (Phase 5) -->
                    <div style="margin: 10px 0 5px 20px; padding: 5px 0; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 11px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Accounting Reports</div>
                    </div>
                    <a href="/admin/accounts/reports/cash-book" class="nav-item {% if '/admin/accounts/reports/cash-book' in request.path %}active{% endif %}">
                        <i>ğŸ“–</i> Cash Book
                    </a>
                    <a href="/admin/accounts/reports/bank-book" class="nav-item {% if '/admin/accounts/reports/bank-book' in request.path %}active{% endif %}">
                        <i>ğŸ¦</i> Bank Book
                    </a>
                    <a href="/admin/accounts/reports/day-book" class="nav-item {% if '/admin/accounts/reports/day-book' in request.path %}active{% endif %}">
                        <i>ğŸ“Š</i> Day Book
                    </a>
                    <a href="/admin/accounts/reports/account-summary" class="nav-item {% if '/admin/accounts/reports/account-summary' in request.path %}active{% endif %}">
                        <i>ğŸ’°</i> Account Summary
                    </a>
                    <a href="/admin/accounts/reports/balance-sheet" class="nav-item {% if '/admin/accounts/reports/balance-sheet' in request.path %}active{% endif %}">
                        <i>ğŸ’¼</i> Balance Sheet
                    </a>
                    <a href="/admin/accounts/reports/profit-loss" class="nav-item {% if '/admin/accounts/reports/profit-loss' in request.path %}active{% endif %}">
                        <i>ğŸ’¹</i> Profit & Loss
                    </a>
                    <a href="/admin/accounts/reports/trial-balance" class="nav-item {% if '/admin/accounts/reports/trial-balance' in request.path %}active{% endif %}">
                        <i>âš–ï¸</i> Trial Balance
                    </a>
                    
                    <!-- Advanced Reports (Aging & Reconciliation) -->
                    <div style="margin: 10px 0 5px 20px; padding: 5px 0; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 11px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Advanced Reports</div>
                    </div>
                    <a href="/admin/accounts/reports/receivables-aging" class="nav-item {% if '/admin/accounts/reports/receivables-aging' in request.path %}active{% endif %}">
                        <i>ğŸ“ˆ</i> Receivables Aging
                    </a>
                    <a href="/admin/accounts/reports/payables-aging" class="nav-item {% if '/admin/accounts/reports/payables-aging' in request.path %}active{% endif %}">
                        <i>ğŸ“‰</i> Payables Aging
                    </a>
                    <a href="/admin/accounts/reports/bank-reconciliation" class="nav-item {% if '/admin/accounts/reports/bank-reconciliation' in request.path %}active{% endif %}">
                        <i>ğŸ¦</i> Bank Reconciliation
                    </a>
                </div>
            </div>
            
            <!-- SUBSCRIPTIONS Section (Collapsible) -->
            <div class="nav-section-collapsible">
                <div class="nav-section-header" onclick="toggleSection('subscriptions')">
                    <div class="nav-section-label">
                        <span class="nav-section-icon">ğŸ’³</span>
                        <span>Subscriptions</span>
                    </div>
                    <span class="nav-section-arrow">â–¶</span>
                </div>
                <div class="nav-section-content" id="section-subscriptions">
                    <a href="/admin/subscriptions/plans" class="nav-item {% if '/admin/subscriptions/plans' in request.path %}active{% endif %}">
                        <i>ğŸ“‹</i> Subscription Plans
                    </a>
                    <a href="/admin/subscriptions/members" class="nav-item {% if '/admin/subscriptions/members' in request.path %}active{% endif %}">
                        <i>ğŸ‘¥</i> Active Members
                    </a>
                    <a href="/admin/subscriptions/schedule" class="nav-item {% if '/admin/subscriptions/schedule' in request.path %}active{% endif %}">
                        <i>ğŸ“…</i> Delivery Schedule
                    </a>
                    <a href="/admin/subscriptions/assets/report" class="nav-item {% if '/admin/subscriptions/assets/report' in request.path %}active{% endif %}">
                        <i>ğŸ—ƒï¸</i> Asset Tracking
                    </a>
                    <a href="/admin/subscriptions/members/enroll" class="nav-item {% if '/admin/subscriptions/members' in request.path %}active{% endif %}">
                        <i>â•</i> Enroll Member
                    </a>
                    <a href="/admin/subscriptions/reports" class="nav-item {% if '/admin/subscriptions/reports' in request.path %}active{% endif %}">
                        <i>ğŸ“Š</i> Reports
                    </a>
                </div>
            </div>
            
            <!-- Accounts & Banking (NEW - Phase 1) -->
            <div class="nav-section-collapsible">
                <div class="nav-section-header" onclick="toggleSection('accounts')">
                    <div class="nav-section-label">
                        <span class="nav-section-icon">ğŸ’°</span>
                        <span>Accounts & Banking</span>
                    </div>
                    <span class="nav-section-arrow">â–¶</span>
                </div>
                <div class="nav-section-content" id="section-accounts">
                    <a href="/admin/accounts" class="nav-item {% if '/admin/accounts' in request.path and '/contra' not in request.path and '/employee-cash' not in request.path %}active{% endif %}">
                        <i>ğŸ¦</i> Bank & Cash Accounts
                    </a>
                    <a href="/admin/accounts/contra" class="nav-item {% if '/admin/accounts/contra' in request.path %}active{% endif %}">
                        <i>ğŸ”„</i> Contra Vouchers
                    </a>
                    <a href="/admin/accounts/employee-cash" class="nav-item {% if '/admin/accounts/employee-cash' in request.path %}active{% endif %}">
                        <i>ğŸ‘·</i> Employee Cash
                    </a>
                    <!-- Phase 6: Receivables will be added here -->
                </div>
            </div>
            
            <!-- Customer Orders (NEW) -->
            <a href="/admin/customer-orders" class="nav-item {% if '/admin/customer-orders' in request.path %}active{% endif %}" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); color: white; font-weight: 600; position: relative;">
                <i>ğŸ›’</i> Customer Orders
                <span id="pending-orders-badge" style="background: #fff; color: #FF6B6B; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 700; margin-left: 8px;">NEW!</span>
            </a>
            <script>
            // Fetch pending orders count dynamically
            if (typeof fetch !== 'undefined') {
                fetch('/admin/customer-orders/count')
                    .then(r => r.json())
                    .then(data => {
                        const badge = document.getElementById('pending-orders-badge');
                        if (badge && data.count > 0) {
                            badge.textContent = data.count;
                            badge.style.animation = 'pulse 1.5s infinite';
                        }
                    })
                    .catch(() => {});
            }
            </script>
            
            <!-- OPERATIONS Section (Collapsible) -->
            <div class="nav-section-collapsible">
                <div class="nav-section-header" onclick="toggleSection('operations')">
                    <div class="nav-section-label">
                        <span class="nav-section-icon">âš™ï¸</span>
                        <span>Operations</span>
                    </div>
                    <span class="nav-section-arrow">â–¶</span>
                </div>
                <div class="nav-section-content" id="section-operations">
                    <a href="/admin/attendance" class="nav-item {% if '/admin/attendance' in request.path %}active{% endif %}">
                        <i>â°</i> Attendance
                    </a>
                    <a href="/admin/tasks" class="nav-item {% if '/admin/tasks' in request.path %}active{% endif %}">
                        <i>ğŸ“‹</i> Tasks
                    </a>
                    <a href="/admin/generate_qr" class="nav-item {% if '/admin/generate_qr' in request.path %}active{% endif %}">
                        <i>ğŸ“±</i> QR Code
                    </a>
                    <a href="/employee/login" class="nav-item" target="_blank">
                        <i>ğŸ‘·</i> Employee Login
                    </a>
                    <a href="/employee/delivery/login" class="nav-item" target="_blank">
                        <i>ğŸšš</i> Delivery Portal
                    </a>
                </div>
            </div>
            
            <!-- SETTINGS & BACKUP Section (Collapsible) -->
            <div class="nav-section-collapsible">
                <div class="nav-section-header" onclick="toggleSection('settings')">
                    <div class="nav-section-label">
                        <span class="nav-section-icon">âš™ï¸</span>
                        <span>Settings & Backup</span>
                    </div>
                    <span class="nav-section-arrow">â–¶</span>
                </div>
                <div class="nav-section-content" id="section-settings">
                    <a href="/admin/backup/download-page" class="nav-item {% if '/admin/backup/download-page' in request.path %}active{% endif %}">
                        <i>ğŸ’¾</i> Backup to Computer
                    </a>
                    <a href="/admin/backup/restore-page" class="nav-item {% if '/admin/backup/restore-page' in request.path %}active{% endif %}">
                        <i>ğŸ”„</i> Restore Backup
                    </a>
                    <a href="/admin/backup/sync-share" class="nav-item {% if '/admin/backup/sync-share' in request.path %}active{% endif %}">
                        <i>â˜ï¸</i> Sync & Share
                    </a>
                </div>
            </div>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    â˜°
                </button>
                <h1 class="header-title">{% block page_title %}Dashboard{% endblock %}</h1>
            </div>
            
            <div class="header-actions">
                {% block header_actions %}
                <a href="/admin/manual_entry" class="btn btn-secondary">
                    âœï¸ Manual Entry
                </a>
                <a href="/admin/generate_qr" class="btn btn-success">
                    ğŸ“± QR Code
                </a>
                {% endblock %}
                
                <!-- Profile Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-btn" onclick="toggleProfileDropdown()">
                        <div class="profile-avatar">
                            {{ tenant.admin_name[0]|upper if tenant and tenant.admin_name else 'A' }}
                        </div>
                        <div class="profile-info hide-mobile">
                            <div class="profile-name">{{ tenant.admin_name if tenant else 'Admin' }}</div>
                            <div class="profile-role">{{ tenant.company_name if tenant else 'Company' }}</div>
                        </div>
                        <span class="profile-arrow hide-mobile">â–¼</span>
                    </div>
                    
                    <div class="profile-menu">
                        <div class="profile-menu-header">
                            <div class="profile-menu-header-name">{{ tenant.admin_name if tenant else 'Admin' }}</div>
                            <div class="profile-menu-header-email">{{ tenant.admin_email if tenant else 'admin@company.com' }}</div>
                        </div>
                        <div class="profile-menu-items">
                            <a href="{{ url_for('admin.profile') }}" class="profile-menu-item">
                                <i>ğŸ‘¤</i> My Profile
                            </a>
                            <a href="{{ url_for('item_attributes_settings.index') }}" class="profile-menu-item">
                                <i>ğŸ¨</i> Item Attributes
                            </a>
                            <a href="/admin/invoices/settings" class="profile-menu-item">
                                <i>âš™ï¸</i> Invoice Settings
                            </a>
                            <div class="profile-menu-divider"></div>
                            <a href="{{ url_for('admin.logout') }}" class="profile-menu-item logout">
                                <i>ğŸšª</i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Flash Messages -->
        <div class="container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} no-print">
                        {{ message }}
                    </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Page Content -->
            {% block content %}
            {% endblock %}
        </div>
    </div>
    
    <!-- JavaScript Libraries - Cloudflare R2 CDN for ultra-fast loading -->
    <script src="https://pub-efaabb14d38e46898a2783236c60d05f.r2.dev/vendor/jquery/jquery-3.6.0.min.js"></script>
    <script src="https://pub-efaabb14d38e46898a2783236c60d05f.r2.dev/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Mobile Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }
        
        // Close sidebar when clicking outside (mobile)
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 768) {
                if (!sidebar.contains(event.target) && event.target !== menuBtn) {
                    sidebar.classList.remove('active');
                }
            }
        });
        
        // Collapsible Navigation Sections
        function toggleSection(sectionId) {
            const content = document.getElementById('section-' + sectionId);
            const header = content.previousElementSibling;
            
            // Close all other sections first (accordion behavior)
            document.querySelectorAll('.nav-section-content').forEach(section => {
                if (section !== content && section.classList.contains('open')) {
                    section.classList.remove('open');
                    section.previousElementSibling.classList.remove('active');
                }
            });
            
            // Toggle current section
            content.classList.toggle('open');
            header.classList.toggle('active');
            
            // Save state to localStorage
            const openSections = [];
            document.querySelectorAll('.nav-section-content.open').forEach(section => {
                const id = section.id.replace('section-', '');
                openSections.push(id);
            });
            localStorage.setItem('openSections', JSON.stringify(openSections));
        }
        
        // Restore open sections from localStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            const openSections = JSON.parse(localStorage.getItem('openSections') || '[]');
            
            // If no saved state, auto-open section with active item
            if (openSections.length === 0) {
                // Find which section contains the active item
                const activeItem = document.querySelector('.nav-section-content .nav-item.active');
                if (activeItem) {
                    const section = activeItem.closest('.nav-section-content');
                    if (section) {
                        section.classList.add('open');
                        section.previousElementSibling.classList.add('active');
                    }
                }
            } else {
                // Restore saved state
                openSections.forEach(sectionId => {
                    const content = document.getElementById('section-' + sectionId);
                    if (content) {
                        content.classList.add('open');
                        content.previousElementSibling.classList.add('active');
                    }
                });
            }
        });
        
        // Form validation helper
        function validateForm(formId) {
            const form = document.getElementById(formId);
            const inputs = form.querySelectorAll('[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.style.borderColor = '#e74c3c';
                    isValid = false;
                } else {
                    input.style.borderColor = '#dfe6e9';
                }
            });
            
            return isValid;
        }
        
        // Profile Dropdown Toggle
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }
        
        // Close profile dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const profileBtn = dropdown.querySelector('.profile-btn');
            
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>

