{% extends "base_sidebar.html" %}

{% block title %}Create Sales Order{% endblock %}

{% block page_title %}üìã Create New Sales Order{% endblock %}

{% block header_actions %}
<a href="{{ url_for('sales_orders.list_orders') }}" class="btn btn-secondary">
    ‚Üê Back to Orders
</a>
{% endblock %}

{% block content %}
<form method="POST" action="{{ url_for('sales_orders.create_order') }}" id="salesOrderForm">
    
    <!-- Customer Information Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Customer Information</h5>
        </div>
        <div class="card-body">
            <!-- Customer Search -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label">Search Existing Customer</label>
                    <div style="position: relative;">
                        <input type="text" id="customer_search" class="form-control" 
                               placeholder="Type customer name or phone..."
                               autocomplete="off"
                               oninput="searchCustomers(this.value)">
                        <div id="customer_dropdown" class="autocomplete-dropdown"></div>
                    </div>
                    <small class="help-text" style="display: block; margin-top: 8px; color: #666; font-size: 13px;">
                        Don't see your customer? <a href="javascript:void(0)" onclick="openAddCustomerModal()" style="color: #667eea; font-weight: 600; text-decoration: none;">‚ûï Add Customer</a>
                    </small>
                    <input type="hidden" id="customer_id" name="customer_id">
                </div>
            </div>
            
            <!-- Customer Details - 2 Column Layout -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Customer Name <span class="text-danger">*</span></label>
                    <input type="text" id="customer_name" name="customer_name" 
                           class="form-control" required placeholder="Customer Name">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Phone</label>
                    <input type="tel" id="customer_phone" name="customer_phone" 
                           class="form-control" placeholder="Phone Number">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" id="customer_email" name="customer_email" 
                           class="form-control" placeholder="Email Address">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">GSTIN</label>
                    <input type="text" id="customer_gstin" name="customer_gstin" 
                           class="form-control" placeholder="27XXXXX1234X1Z5" maxlength="15">
                </div>
            </div>
            
            <!-- Addresses - 2 Column Layout -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Billing Address</label>
                    <textarea id="billing_address" name="billing_address" 
                              class="form-control" rows="3" 
                              placeholder="Enter billing address"></textarea>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Shipping Address</label>
                    <textarea id="shipping_address" name="shipping_address" 
                              class="form-control" rows="3" 
                              placeholder="Enter shipping address"></textarea>
                    <a href="javascript:void(0)" onclick="copyBillingToShipping()" 
                       class="text-primary small">
                        üìã Copy from billing
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Order Details</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Order Date <span class="text-danger">*</span></label>
                    <input type="date" name="order_date" class="form-control" 
                           value="{{ today }}" required>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Expected Delivery</label>
                    <input type="date" name="expected_delivery_date" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Status <span class="text-danger">*</span></label>
                    <select name="status" class="form-select" required>
                        <option value="draft">Draft</option>
                        <option value="confirmed" selected>Confirmed (Reserve Stock)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Items Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Order Items</h5>
            <button type="button" class="btn btn-sm btn-primary" onclick="addItemRow()">
                + Add Item
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 25%;">ITEM <span class="text-danger">*</span></th>
                            <th style="width: 12%;">HSN CODE</th>
                            <th style="width: 10%;">QTY <span class="text-danger">*</span></th>
                            <th style="width: 8%;">UNIT</th>
                            <th style="width: 12%;">RATE <span class="text-danger">*</span></th>
                            <th style="width: 10%;">GST %</th>
                            <th style="width: 8%;" class="text-center">Incl.</th>
                            <th style="width: 12%;" class="text-end">AMOUNT</th>
                            <th style="width: 3%;"></th>
                        </tr>
                    </thead>
                    <tbody id="items_body">
                        <!-- Items added by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Totals -->
            <div class="row justify-content-end">
                <div class="col-md-4">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Subtotal:</strong></td>
                            <td class="text-end"><strong id="display_subtotal">‚Çπ0.00</strong></td>
                        </tr>
                        <tr>
                            <td><strong>Tax (GST):</strong></td>
                            <td class="text-end"><strong id="display_tax">‚Çπ0.00</strong></td>
                        </tr>
                        <tr class="table-active">
                            <td><strong>Total:</strong></td>
                            <td class="text-end"><strong id="display_total">‚Çπ0.00</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Information Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Additional Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Terms & Conditions</label>
                    <textarea name="terms_and_conditions" class="form-control" rows="4"
                              placeholder="Payment terms, delivery conditions, etc.">Payment within 30 days
Delivery as per schedule
Subject to Mumbai jurisdiction</textarea>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Internal Notes</label>
                    <textarea name="notes" class="form-control" rows="4"
                              placeholder="Notes for internal reference..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="card" style="margin-bottom: 100px;">
        <div class="card-body text-end">
            <a href="{{ url_for('sales_orders.list_orders') }}" class="btn btn-secondary btn-lg">
                Cancel
            </a>
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-save"></i> Create Sales Order
            </button>
        </div>
    </div>
</form>

<style>
/* Custom Grid System (Since Bootstrap isn't loaded) */
.row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -15px;
}

.col-md-12, .col-md-6, .col-md-4 {
    padding: 0 15px;
    box-sizing: border-box;
}

.col-md-12 {
    flex: 0 0 100%;
    max-width: 100%;
}

.col-md-6 {
    flex: 0 0 50%;
    max-width: 50%;
}

.col-md-4 {
    flex: 0 0 33.333%;
    max-width: 33.333%;
}

.mb-3 {
    margin-bottom: 1rem;
}

.mb-4 {
    margin-bottom: 1.5rem;
}

.card {
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
    background: white;
    border: 1px solid #ddd;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    padding: 1rem 1.5rem;
}

.card-body {
    padding: 1.5rem;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    display: block;
}

.form-control, .form-select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 1rem;
}

.text-danger {
    color: #dc3545;
}

.autocomplete-dropdown {
    position: absolute;
    z-index: 999;
    background: white;
    border: 2px solid #007bff;
    max-height: 400px;
    overflow-y: auto;
    width: 100%;
    min-width: 400px;
    display: none;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    margin-top: 2px;
    border-radius: 8px;
}

.autocomplete-item {
    padding: 10px 12px;  /* Reduced padding */
    cursor: pointer;
    border-bottom: 1px solid #e9ecef;
    transition: all 0.2s ease;
    font-size: 0.95rem;
}

.autocomplete-item:hover {
    background-color: #e3f2fd;
    border-left: 3px solid #007bff;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item strong {
    font-size: 1rem;
    color: #2c3e50;
    display: block;
    margin-bottom: 3px;
}

.item-autocomplete-dropdown {
    position: fixed;  /* FIXED instead of absolute - prevents nested scroll! */
    z-index: 9999;
    background: white;
    border: 2px solid #007bff;
    max-height: 400px;
    overflow-y: auto;
    width: 600px;  /* Wider to show full item names */
    min-width: 400px;
    display: none;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    border-radius: 8px;
    white-space: normal;  /* Allow text wrapping */
}

.table th {
    font-size: 0.85rem;
    font-weight: 600;
}

textarea.form-control {
    resize: vertical;
}

.btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    font-size: 1rem;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.125rem;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th,
.table td {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    text-align: left;
}

.table-light {
    background-color: #f8f9fa;
}

.table-responsive {
    overflow-x: auto;
}

.text-end {
    text-align: right;
}

.text-center {
    text-align: center;
}

.text-muted {
    color: #6c757d;
}

.text-primary {
    color: #007bff;
}

.small {
    font-size: 0.875rem;
}

.d-flex {
    display: flex;
}

.justify-content-between {
    justify-content: space-between;
}

.justify-content-end {
    justify-content: flex-end;
}

.align-items-center {
    align-items: center;
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    display: inline-block;
}

.bg-secondary {
    background-color: #6c757d;
    color: white;
}

.ms-2 {
    margin-left: 0.5rem;
}

.form-check-input {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
}
</style>

<script>
let itemCount = 0;

// Add initial row on page load
document.addEventListener('DOMContentLoaded', function() {
    addItemRow();
});

function addItemRow() {
    itemCount++;
    const tbody = document.getElementById('items_body');
    const row = document.createElement('tr');
    row.className = 'item-row';
    row.id = `item_row_${itemCount}`;
    
    row.innerHTML = `
        <td style="position: relative;">
            <input type="text" name="item_name[]" id="item_name_${itemCount}" 
                   class="form-control form-control-sm" placeholder="Start typing..." 
                   required oninput="searchItems(${itemCount}, this.value)">
            <div id="item_dropdown_${itemCount}" class="item-autocomplete-dropdown"></div>
            <input type="hidden" name="item_id[]" id="item_id_${itemCount}">
        </td>
        <td>
            <input type="text" name="hsn_code[]" id="hsn_code_${itemCount}" 
                   class="form-control form-control-sm" placeholder="HSN">
        </td>
        <td>
            <input type="number" name="quantity[]" id="quantity_${itemCount}" 
                   class="form-control form-control-sm" step="0.01" min="0.01" value="1" 
                   required oninput="calculateRow(${itemCount})">
        </td>
        <td>
            <select name="unit[]" id="unit_${itemCount}" class="form-select form-select-sm">
                <option value="nos">Nos</option>
                <option value="pcs" selected>Pcs</option>
                <option value="dozen">Dozen</option>
                <option value="kg">Kg</option>
                <option value="qtl">Qtl</option>
                <option value="ton">Ton</option>
                <option value="g">G</option>
                <option value="ltr">Ltr</option>
                <option value="ml">Ml</option>
                <option value="mtr">Mtr</option>
                <option value="cm">Cm</option>
                <option value="ft">Ft</option>
                <option value="sqm">Sqm</option>
                <option value="cum">Cum</option>
                <option value="cft">Cft</option>
                <option value="box">Box</option>
                <option value="bag">Bag</option>
                <option value="packet">Packet</option>
                <option value="bundle">Bundle</option>
            </select>
        </td>
        <td>
            <input type="number" name="rate[]" id="rate_${itemCount}" 
                   class="form-control form-control-sm" step="0.01" min="0" 
                   placeholder="0.00" required oninput="calculateRow(${itemCount})">
        </td>
        <td>
            <select name="gst_rate[]" id="gst_rate_${itemCount}" 
                    class="form-select form-select-sm" onchange="calculateRow(${itemCount})">
                <option value="0">0%</option>
                <option value="5">5%</option>
                <option value="12">12%</option>
                <option value="18" selected>18%</option>
                <option value="28">28%</option>
            </select>
        </td>
        <td class="text-center">
            <input type="checkbox" name="price_inclusive[]" id="price_inclusive_${itemCount}" 
                   class="form-check-input" onchange="calculateRow(${itemCount})">
        </td>
        <td class="text-end">
            <strong id="amount_${itemCount}">‚Çπ0.00</strong>
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-danger" 
                    onclick="removeItemRow(${itemCount})" title="Remove">
                √ó
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
}

function removeItemRow(rowId) {
    const row = document.getElementById(`item_row_${rowId}`);
    if (row && document.querySelectorAll('.item-row').length > 1) {
        row.remove();
        calculateTotals();
    } else {
        alert('At least one item is required');
    }
}

function calculateRow(rowId) {
    const qty = parseFloat(document.getElementById(`quantity_${rowId}`).value) || 0;
    const rate = parseFloat(document.getElementById(`rate_${rowId}`).value) || 0;
    const gstRate = parseFloat(document.getElementById(`gst_rate_${rowId}`).value) || 0;
    const priceInclusive = document.getElementById(`price_inclusive_${rowId}`).checked;
    
    let taxable = qty * rate;
    let tax = 0;
    
    if (priceInclusive) {
        tax = taxable - (taxable / (1 + (gstRate / 100)));
        taxable = taxable - tax;
    } else {
        tax = taxable * (gstRate / 100);
    }
    
    const total = taxable + tax;
    
    document.getElementById(`amount_${rowId}`).textContent = `‚Çπ${total.toFixed(2)}`;
    
    calculateTotals();
}

function calculateTotals() {
    let subtotal = 0;
    let totalTax = 0;
    
    const rows = document.querySelectorAll('.item-row');
    rows.forEach(row => {
        const rowId = row.id.replace('item_row_', '');
        const qty = parseFloat(document.getElementById(`quantity_${rowId}`).value) || 0;
        const rate = parseFloat(document.getElementById(`rate_${rowId}`).value) || 0;
        const gstRate = parseFloat(document.getElementById(`gst_rate_${rowId}`).value) || 0;
        const priceInclusive = document.getElementById(`price_inclusive_${rowId}`).checked;
        
        let taxable = qty * rate;
        let tax = 0;
        
        if (priceInclusive) {
            tax = taxable - (taxable / (1 + (gstRate / 100)));
            taxable = taxable - tax;
        } else {
            tax = taxable * (gstRate / 100);
        }
        
        subtotal += taxable;
        totalTax += tax;
    });
    
    const grandTotal = subtotal + totalTax;
    
    document.getElementById('display_subtotal').textContent = `‚Çπ${subtotal.toFixed(2)}`;
    document.getElementById('display_tax').textContent = `‚Çπ${totalTax.toFixed(2)}`;
    document.getElementById('display_total').textContent = `‚Çπ${grandTotal.toFixed(2)}`;
}

// Customer search - CORRECT API PATH
function searchCustomers(query) {
    if (query.length < 2) {
        document.getElementById('customer_dropdown').style.display = 'none';
        return;
    }
    
    console.log('üîç Searching customers:', query);
    
    fetch(`/admin/customers/api/search?q=${encodeURIComponent(query)}`)
        .then(response => {
            console.log('‚úÖ Response status:', response.status);
            return response.json();
        })
        .then(customers => {
            console.log('‚úÖ Found customers:', customers.length);
            const dropdown = document.getElementById('customer_dropdown');
            if (customers.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item text-muted">No customers found</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            dropdown.innerHTML = '';  // Clear dropdown
            
            if (customers.length > 0) {
                customers.forEach(customer => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.style.cursor = 'pointer';
                    div.innerHTML = `
                        <strong>${customer.name}</strong><br>
                        <small class="text-muted">${customer.phone || ''} ${customer.email ? '‚Ä¢ ' + customer.email : ''}</small>
                    `;
                    
                    // Use click event instead of inline onclick
                    div.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üñ±Ô∏è Customer clicked:', customer.name);
                        selectCustomer(customer.id, customer.name, customer.phone || '', customer.email || '', customer.gstin || '', customer.address || '');
                    });
                    
                    dropdown.appendChild(div);
                });
                
                console.log(`‚úÖ Added ${customers.length} customers to dropdown`);
            }
            
            dropdown.style.display = 'block';
            console.log('‚úÖ Customer dropdown shown');
        })
        .catch(error => {
            console.error('‚ùå Error searching customers:', error);
            const dropdown = document.getElementById('customer_dropdown');
            dropdown.innerHTML = '<div class="autocomplete-item text-danger">Error loading customers</div>';
            dropdown.style.display = 'block';
        });
}

function selectCustomer(id, name, phone, email, gstin, address) {
    document.getElementById('customer_id').value = id;
    document.getElementById('customer_name').value = name;
    document.getElementById('customer_phone').value = phone;
    document.getElementById('customer_email').value = email;
    document.getElementById('customer_gstin').value = gstin;
    document.getElementById('billing_address').value = address;
    document.getElementById('customer_search').value = name;
    document.getElementById('customer_dropdown').style.display = 'none';
}

// Item search
function searchItems(rowId, query) {
    if (query.length < 2) {
        document.getElementById(`item_dropdown_${rowId}`).style.display = 'none';
        return;
    }
    
    console.log('üîç Searching items:', query);
    
    fetch(`/sales-orders/api/search-items?q=${encodeURIComponent(query)}`)
        .then(response => {
            console.log('‚úÖ Items response status:', response.status);
            return response.json();
        })
        .then(items => {
            console.log('‚úÖ Found items:', items.length);
            const dropdown = document.getElementById(`item_dropdown_${rowId}`);
            if (items.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item text-muted">No items found</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            dropdown.innerHTML = '';  // Clear dropdown
            
            if (items.length > 0) {
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.style.cursor = 'pointer';
                    div.innerHTML = `
                        <strong>${item.name}</strong>
                        ${item.hsn_code ? `<span class="badge bg-secondary ms-2">${item.hsn_code}</span>` : ''}
                        <br><small class="text-muted">Rate: ‚Çπ${item.selling_price || 0} ‚Ä¢ GST: ${item.gst_rate || 0}%</small>
                    `;
                    
                    // Use click event instead of inline onclick
                    div.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üñ±Ô∏è Item clicked:', item.name);
                        selectItem(rowId, item.id, item.name, item.hsn_code || '', item.unit || 'pcs', item.selling_price || 0, item.gst_rate || 0);
                    });
                    
                    dropdown.appendChild(div);
                });
                
                console.log(`‚úÖ Added ${items.length} items to dropdown`);
            }
            
            // Position dropdown using fixed positioning with screen boundary check
            try {
                const inputField = document.getElementById(`item_name_${rowId}`);
                if (inputField) {
                    const rect = inputField.getBoundingClientRect();
                    const dropdownHeight = 400; // max-height
                    const spaceBelow = window.innerHeight - rect.bottom;
                    const spaceAbove = rect.top;
                    
                    // If not enough space below, show above
                    if (spaceBelow < dropdownHeight && spaceAbove > spaceBelow) {
                        dropdown.style.bottom = (window.innerHeight - rect.top + 2) + 'px';
                        dropdown.style.top = 'auto';
                    } else {
                        dropdown.style.top = (rect.bottom + 2) + 'px';
                        dropdown.style.bottom = 'auto';
                    }
                    dropdown.style.left = rect.left + 'px';
                    console.log(`üìç Dropdown positioned at: top=${rect.bottom}px, left=${rect.left}px`);
                }
            } catch (err) {
                console.error('‚ùå Positioning error:', err);
            }
            
            dropdown.style.display = 'block';
            console.log('‚úÖ Dropdown shown');
        })
        .catch(error => {
            console.error('‚ùå Error searching items:', error);
            const dropdown = document.getElementById(`item_dropdown_${rowId}`);
            dropdown.innerHTML = '<div class="autocomplete-item text-danger">Error loading items</div>';
            dropdown.style.display = 'block';
        });
}

function selectItem(rowId, itemId, name, hsn, unit, rate, gstRate) {
    document.getElementById(`item_id_${rowId}`).value = itemId;
    document.getElementById(`item_name_${rowId}`).value = name;
    document.getElementById(`hsn_code_${rowId}`).value = hsn;
    document.getElementById(`unit_${rowId}`).value = unit;
    document.getElementById(`rate_${rowId}`).value = rate;
    document.getElementById(`gst_rate_${rowId}`).value = gstRate;
    document.getElementById(`item_dropdown_${rowId}`).style.display = 'none';
    
    calculateRow(rowId);
}

function copyBillingToShipping() {
    document.getElementById('shipping_address').value = document.getElementById('billing_address').value;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// Hide dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.autocomplete-dropdown') && !e.target.closest('#customer_search')) {
        document.getElementById('customer_dropdown').style.display = 'none';
    }
    
    // Hide all item dropdowns
    document.querySelectorAll('.item-autocomplete-dropdown').forEach(dropdown => {
        if (!e.target.closest('.item-autocomplete-dropdown') && 
            !e.target.closest(`#${dropdown.id.replace('_dropdown', '')}`)) {
            dropdown.style.display = 'none';
        }
    });
});

// ========================================
// CUSTOMER MODAL FUNCTIONS
// ========================================

function openAddCustomerModal() {
    document.getElementById('addCustomerModal').style.display = 'flex';
    document.getElementById('newCustomerName').focus();
}

function closeAddCustomerModal() {
    document.getElementById('addCustomerModal').style.display = 'none';
    document.getElementById('addCustomerForm').reset();
}

function submitCustomer(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Disable button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Adding...';
    
    fetch('{{ url_for("customers.add") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        // Success! Auto-fill the customer details in the sales order form
        const customerName = formData.get('name');
        const customerPhone = formData.get('phone');
        const customerEmail = formData.get('email');
        const customerGstin = formData.get('gstin');
        const customerAddress = formData.get('address');
        
        // Check if customer was added successfully
        if (html.includes('successfully') || html.includes('added')) {
            // Fill the sales order form
            document.getElementById('customer_name').value = customerName;
            document.getElementById('customer_phone').value = customerPhone || '';
            document.getElementById('customer_email').value = customerEmail || '';
            document.getElementById('customer_gstin').value = customerGstin || '';
            document.getElementById('billing_address').value = customerAddress || '';
            document.getElementById('shipping_address').value = customerAddress || '';
            
            // Clear the search box
            document.getElementById('customer_search').value = customerName;
            
            // Show success message
            alert(`‚úÖ Customer "${customerName}" added successfully!`);
            closeAddCustomerModal();
        } else {
            alert('‚ùå Error adding customer. Please try again.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'üíæ Save Customer';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error adding customer. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üíæ Save Customer';
    });
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeAddCustomerModal();
    }
});

// Close modal on outside click
document.addEventListener('click', function(event) {
    const modal = document.getElementById('addCustomerModal');
    if (modal && event.target === modal) {
        closeAddCustomerModal();
    }
});
</script>

<!-- Add Customer Modal -->
<div id="addCustomerModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">‚ûï Add New Customer</h3>
            <button onclick="closeAddCustomerModal()" class="modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
        </div>
        <form id="addCustomerForm" onsubmit="submitCustomer(event)">
            <div class="modal-body">
                <!-- Basic Details -->
                <div class="modal-form-row">
                    <div class="form-group">
                        <label class="field-label field-label--required">Customer Name</label>
                        <input type="text" name="name" id="newCustomerName" class="form-control" required placeholder="Enter customer name">
                    </div>
                    <div class="form-group">
                        <label class="field-label">Phone Number</label>
                        <input type="tel" name="phone" class="form-control" placeholder="9876543210">
                    </div>
                </div>
                
                <div class="modal-form-row">
                    <div class="form-group">
                        <label class="field-label">Email Address</label>
                        <input type="email" name="email" class="form-control" placeholder="customer@example.com">
                    </div>
                    <div class="form-group">
                        <label class="field-label">GSTIN</label>
                        <input type="text" name="gstin" class="form-control" placeholder="27XXXXX1234X1Z5" maxlength="15">
                    </div>
                </div>
                
                <div class="modal-form-row modal-form-row--single">
                    <div class="form-group">
                        <label class="field-label">Address</label>
                        <textarea name="address" class="form-control" rows="2" placeholder="Shop/Building, Street, Area, City"></textarea>
                    </div>
                </div>
                
                <div class="modal-form-row">
                    <div class="form-group">
                        <label class="field-label field-label--required">State</label>
                        <select name="state" class="form-control" required>
                            <option value="">Select State</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Goa">Goa</option>
                            <option value="Gujarat">Gujarat</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra" selected>Maharashtra</option>
                            <option value="Manipur">Manipur</option>
                            <option value="Meghalaya">Meghalaya</option>
                            <option value="Mizoram">Mizoram</option>
                            <option value="Nagaland">Nagaland</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Sikkim">Sikkim</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Tripura">Tripura</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="West Bengal">West Bengal</option>
                            <option value="Delhi">Delhi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="field-label">Opening Balance (‚Çπ)</label>
                        <input type="number" name="opening_balance" class="form-control" step="0.01" value="0" placeholder="0">
                    </div>
                </div>
                
                <div class="modal-form-row">
                    <div class="form-group">
                        <label class="field-label">Credit Limit (‚Çπ)</label>
                        <input type="number" name="credit_limit" class="form-control" step="0.01" min="0" value="0" placeholder="50000">
                        <small class="help-text">0 = No limit</small>
                    </div>
                    <div class="form-group">
                        <label class="field-label">Payment Terms (Days)</label>
                        <input type="number" name="payment_terms_days" class="form-control" min="0" value="30" placeholder="30">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeAddCustomerModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ Save Customer</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
    overflow-y: auto;
}

.modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease;
    margin: 20px;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 2px solid #f0f0f0;
    position: sticky;
    top: 0;
    background: white;
    z-index: 1;
}

.modal-body {
    padding: 25px;
}

.modal-footer {
    padding: 15px 25px;
    border-top: 2px solid #f0f0f0;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    position: sticky;
    bottom: 0;
    background: white;
    z-index: 1;
}

.modal-close {
    transition: all 0.2s ease;
}

.modal-close:hover {
    transform: scale(1.2);
    color: #dc3545 !important;
}

.modal-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.modal-form-row--single {
    grid-template-columns: 1fr;
}

.modal-form-row .form-group {
    margin-bottom: 0;
}

.field-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #2d3748;
    font-size: 14px;
}

.field-label--required::after {
    content: ' *';
    color: #dc3545;
}

.help-text {
    display: block;
    font-size: 12px;
    color: #666;
    margin-top: 4px;
}
</style>

{% endblock %}
