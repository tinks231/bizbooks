{% extends "base_sidebar.html" %}

{% block title %}Edit Sales Order{% endblock %}

{% block page_title %}‚úèÔ∏è Edit Sales Order: {{ order.order_number }}{% endblock %}

{% block header_actions %}
<a href="{{ url_for('sales_orders.list_orders') }}" class="btn btn-secondary">
    ‚Üê Back to Orders
</a>
{% endblock %}

{% block content %}
<form method="POST" action="{{ url_for('sales_orders.edit_order', order_id=order.id) }}">
    
    <!-- Customer Information -->
    <div class="form-section">
        <div class="form-section-title">Customer Information</div>
        <div class="form-row">
            <div class="form-group">
                <label>Customer Name <span class="required">*</span></label>
                <input type="text" name="customer_name" class="form-input" value="{{ order.customer_name }}" required>
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" name="customer_phone" class="form-input" value="{{ order.customer_phone or '' }}">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Email</label>
                <input type="email" name="customer_email" class="form-input" value="{{ order.customer_email or '' }}">
            </div>
            <div class="form-group">
                <label>GSTIN</label>
                <input type="text" name="customer_gstin" class="form-input" value="{{ order.customer_gstin or '' }}" maxlength="15">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Billing Address</label>
                <textarea name="billing_address" class="form-input" rows="2">{{ order.billing_address or '' }}</textarea>
            </div>
            <div class="form-group">
                <label>Shipping Address</label>
                <textarea name="shipping_address" class="form-input" rows="2">{{ order.shipping_address or '' }}</textarea>
            </div>
        </div>
    </div>

    <!-- Order Details -->
    <div class="form-section">
        <div class="form-section-title">Order Details</div>
        <div class="form-row">
            <div class="form-group">
                <label>Order Date <span class="required">*</span></label>
                <input type="date" name="order_date" class="form-input" value="{{ order.order_date.strftime('%Y-%m-%d') }}" required>
            </div>
            <div class="form-group">
                <label>Expected Delivery</label>
                <input type="date" name="expected_delivery_date" class="form-input" value="{{ order.expected_delivery_date.strftime('%Y-%m-%d') if order.expected_delivery_date else '' }}">
            </div>
            <div class="form-group">
                <label>Status</label>
                <select name="status" class="form-input">
                    <option value="draft" {% if order.status == 'draft' %}selected{% endif %}>Draft</option>
                    <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="confirmed" {% if order.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                    <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>Notes</label>
            <textarea name="notes" class="form-input" rows="2" placeholder="Any additional notes...">{{ order.notes or '' }}</textarea>
        </div>
    </div>

    <!-- Items -->
    <div class="form-section">
        <div class="form-section-title">Order Items</div>
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th style="width: 100px;">Quantity</th>
                        <th style="width: 100px;">Rate</th>
                        <th style="width: 80px;">GST %</th>
                        <th style="width: 110px;">Total</th>
                        <th style="width: 60px;">Action</th>
                    </tr>
                </thead>
                <tbody id="itemsTable">
                    {% for item in order.items %}
                    <tr>
                        <td>
                            <select name="item_ids[]" class="form-input" required onchange="updateItemPrice(this)" style="padding: 6px 10px; font-size: 13px;">
                                <option value="">Select Item</option>
                                {% for available_item in items %}
                                <option value="{{ available_item.id }}" 
                                        data-price="{{ available_item.selling_price or 0 }}"
                                        data-gst="{{ available_item.gst_rate or 0 }}"
                                        {% if available_item.id == item.item_id %}selected{% endif %}>
                                    {{ available_item.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <input type="number" name="quantities[]" class="form-input" value="{{ item.quantity }}" min="1" step="0.01" required onchange="calculateRowTotal(this)" style="padding: 6px 10px; font-size: 13px;">
                        </td>
                        <td>
                            <input type="number" name="unit_prices[]" class="form-input" value="{{ item.rate }}" min="0" step="0.01" required onchange="calculateRowTotal(this)" style="padding: 6px 10px; font-size: 13px;">
                        </td>
                        <td>
                            <input type="number" name="gst_rates[]" class="form-input" value="{{ item.gst_rate or 0 }}" min="0" step="0.01" onchange="calculateRowTotal(this)" style="padding: 6px 10px; font-size: 13px;">
                        </td>
                        <td>
                            <input type="number" class="form-input row-total" value="{{ (item.quantity * item.rate) * (1 + (item.gst_rate or 0)/100) }}" readonly style="background: #f8f9fa; padding: 6px 10px; font-size: 13px; font-weight: 600;">
                        </td>
                        <td>
                            <button type="button" onclick="removeRow(this)" class="btn btn-danger" style="padding: 6px 10px; font-size: 13px;">üóëÔ∏è</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <button type="button" onclick="addItemRow()" class="btn btn-secondary" style="margin-top: 10px;">‚ûï Add Item</button>
        
        <!-- Total Section -->
        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e9ecef;">
            <div style="display: flex; justify-content: flex-end; align-items: center; gap: 25px;">
                <div>
                    <label style="font-size: 13px; color: #6c757d; margin-bottom: 5px; display: block;">Subtotal</label>
                    <div id="subtotal" style="font-size: 20px; font-weight: 600; color: #2c3e50;">‚Çπ0.00</div>
                </div>
                <div>
                    <label style="font-size: 13px; color: #6c757d; margin-bottom: 5px; display: block;">Tax Amount</label>
                    <div id="tax_amount" style="font-size: 20px; font-weight: 600; color: #2c3e50;">‚Çπ0.00</div>
                </div>
                <div style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); padding: 15px 20px; border-radius: 10px; color: white; min-width: 180px; text-align: center;">
                    <label style="font-size: 13px; opacity: 0.9; margin-bottom: 5px; display: block;">Grand Total</label>
                    <div id="grand_total" style="font-size: 26px; font-weight: 700;">‚Çπ0.00</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">üíæ Update Order</button>
        <a href="{{ url_for('sales_orders.list_orders') }}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
// Store items data for quick access
const itemsData = {
    {% for item in items %}
    "{{ item.id }}": {
        name: "{{ item.name }}",
        price: {{ item.selling_price or 0 }},
        gst: {{ item.gst_rate or 0 }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

// Add new item row
function addItemRow() {
    const tbody = document.getElementById('itemsTable');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <select name="item_ids[]" class="form-input" required onchange="updateItemPrice(this)" style="padding: 6px 10px; font-size: 13px;">
                <option value="">Select Item</option>
                {% for item in items %}
                <option value="{{ item.id }}" data-price="{{ item.selling_price or 0 }}" data-gst="{{ item.gst_rate or 0 }}">{{ item.name }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" name="quantities[]" class="form-input" value="1" min="1" step="0.01" required onchange="calculateRowTotal(this)" style="padding: 6px 10px; font-size: 13px;">
        </td>
        <td>
            <input type="number" name="unit_prices[]" class="form-input" value="0" min="0" step="0.01" required onchange="calculateRowTotal(this)" style="padding: 6px 10px; font-size: 13px;">
        </td>
        <td>
            <input type="number" name="gst_rates[]" class="form-input" value="0" min="0" step="0.01" onchange="calculateRowTotal(this)" style="padding: 6px 10px; font-size: 13px;">
        </td>
        <td>
            <input type="number" class="form-input row-total" value="0" readonly style="background: #f8f9fa; padding: 6px 10px; font-size: 13px; font-weight: 600;">
        </td>
        <td>
            <button type="button" onclick="removeRow(this)" class="btn btn-danger" style="padding: 6px 10px; font-size: 13px;">üóëÔ∏è</button>
        </td>
    `;
    tbody.appendChild(row);
    calculateTotal();
}

// Remove item row
function removeRow(button) {
    if (document.querySelectorAll('#itemsTable tr').length > 1) {
        button.closest('tr').remove();
        calculateTotal();
    } else {
        alert('At least one item is required');
    }
}

// Update item price and GST when item is selected
function updateItemPrice(select) {
    const itemId = select.value;
    const row = select.closest('tr');
    const priceInput = row.querySelector('input[name="unit_prices[]"]');
    const gstInput = row.querySelector('input[name="gst_rates[]"]');
    
    if (itemId && itemsData[itemId]) {
        priceInput.value = itemsData[itemId].price;
        gstInput.value = itemsData[itemId].gst;
    }
    
    calculateRowTotal(priceInput);
}

// Calculate row total (including GST)
function calculateRowTotal(input) {
    const row = input.closest('tr');
    const quantity = parseFloat(row.querySelector('input[name="quantities[]"]').value) || 0;
    const unitPrice = parseFloat(row.querySelector('input[name="unit_prices[]"]').value) || 0;
    const gstRate = parseFloat(row.querySelector('input[name="gst_rates[]"]').value) || 0;
    
    const subtotal = quantity * unitPrice;
    const taxAmount = (subtotal * gstRate) / 100;
    const total = subtotal + taxAmount;
    
    row.querySelector('.row-total').value = total.toFixed(2);
    calculateTotal();
}

// Calculate overall total
function calculateTotal() {
    let subtotal = 0;
    let totalTax = 0;
    
    document.querySelectorAll('#itemsTable tr').forEach(row => {
        const quantity = parseFloat(row.querySelector('input[name="quantities[]"]')?.value) || 0;
        const unitPrice = parseFloat(row.querySelector('input[name="unit_prices[]"]')?.value) || 0;
        const gstRate = parseFloat(row.querySelector('input[name="gst_rates[]"]')?.value) || 0;
        
        const rowSubtotal = quantity * unitPrice;
        const rowTax = (rowSubtotal * gstRate) / 100;
        
        subtotal += rowSubtotal;
        totalTax += rowTax;
    });
    
    const grandTotal = subtotal + totalTax;
    
    document.getElementById('subtotal').textContent = '‚Çπ' + subtotal.toFixed(2);
    document.getElementById('tax_amount').textContent = '‚Çπ' + totalTax.toFixed(2);
    document.getElementById('grand_total').textContent = '‚Çπ' + grandTotal.toFixed(2);
}

// Calculate totals on page load
document.addEventListener('DOMContentLoaded', function() {
    // Recalculate all row totals
    document.querySelectorAll('input[name="quantities[]"]').forEach(input => {
        calculateRowTotal(input);
    });
    calculateTotal();
});
</script>

<style>
/* Fix section title alignment */
.form-section-title {
    padding-left: 0 !important;
    margin-left: 0 !important;
}

/* Ensure row total is bold */
.row-total {
    font-weight: 600 !important;
}
</style>
{% endblock %}

