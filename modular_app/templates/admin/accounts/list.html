{% extends "base_sidebar.html" %}

{% block title %}Bank & Cash Accounts - {{ tenant.company_name }}{% endblock %}

{% block page_title %}üí∞ Bank & Cash Accounts{% endblock %}

{% block header_actions %}
<button onclick="openAddAccountModal()" class="btn btn-primary" style="padding: 12px 24px;">
    <i class="fas fa-plus"></i> Add New Account
</button>
{% endblock %}

{% block content %}

<div class="container-fluid" style="padding: 30px;">
    
    <!-- Stats Cards with Beautiful Gradients -->
    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 25px; text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
            <div style="font-size: 40px; font-weight: 700; margin-bottom: 10px;">{{ total_accounts }}</div>
            <div style="font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.95;">Total Accounts</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 12px; padding: 25px; text-align: center; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);">
            <div style="font-size: 40px; font-weight: 700; margin-bottom: 10px;">‚Çπ{{ "{:,.0f}".format(total_balance) }}</div>
            <div style="font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.95;">Total Balance</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-radius: 12px; padding: 25px; text-align: center; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);">
            <div style="font-size: 40px; font-weight: 700; margin-bottom: 10px;">‚Çπ{{ "{:,.0f}".format(total_cash) }}</div>
            <div style="font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.95;">Cash Balance</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border-radius: 12px; padding: 25px; text-align: center; box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);">
            <div style="font-size: 40px; font-weight: 700; margin-bottom: 10px;">‚Çπ{{ "{:,.0f}".format(total_bank) }}</div>
            <div style="font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.95;">Bank Balance</div>
        </div>
    </div>

    <!-- Accounts Table -->
    <div class="account-table" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden;">
        {% if accounts %}
        <table style="width: 100%; border-collapse: collapse;">
            <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <tr>
                    <th style="padding: 15px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase;">Account Name</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase;">Type</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase;">Bank Details</th>
                    <th style="padding: 15px; text-align: right; font-weight: 600; font-size: 13px; text-transform: uppercase;">Balance</th>
                    <th style="padding: 15px; text-align: center; font-weight: 600; font-size: 13px; text-transform: uppercase;">Status</th>
                    <th style="padding: 15px; text-align: center; font-weight: 600; font-size: 13px; text-transform: uppercase;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for account in accounts %}
                <tr style="border-bottom: 1px solid #f0f0f0; {% if not account[6] %}background: #f8f9fa; opacity: 0.7;{% endif %}">
                    <td style="padding: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">
                                {% if account[2] == 'cash' %}üíµ
                                {% elif account[2] == 'petty_cash' %}üí≥
                                {% else %}üè¶{% endif %}
                            </span>
                            <div>
                                <div style="font-weight: 600; color: #2c3e50;">{{ account[1] }}</div>
                                {% if account[7] %}<span style="font-size: 11px; background: #ffc107; color: #000; padding: 2px 8px; border-radius: 10px; font-weight: 600;">DEFAULT</span>{% endif %}
                            </div>
                        </div>
                    </td>
                    <td style="padding: 15px;">
                        <span style="background: {% if account[2] == 'cash' %}#d4edda{% elif account[2] == 'bank' %}#d1ecf1{% else %}#fff3cd{% endif %}; 
                                     color: {% if account[2] == 'cash' %}#155724{% elif account[2] == 'bank' %}#0c5460{% else %}#856404{% endif %}; 
                                     padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                            {{ account[2]|replace('_', ' ') }}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        {% if account[3] %}
                            <div style="font-size: 13px; color: #555;">{{ account[3] }}</div>
                            {% if account[4] %}<div style="font-size: 12px; color: #999;">A/c: {{ account[4] }}</div>{% endif %}
                        {% else %}
                            <span style="color: #999;">-</span>
                        {% endif %}
                    </td>
                    <td style="padding: 15px; text-align: right;">
                        <div style="font-size: 18px; font-weight: 700; color: {% if account[5] > 0 %}#28a745{% elif account[5] < 0 %}#dc3545{% else %}#6c757d{% endif %};">
                            ‚Çπ{{ "{:,.2f}".format(account[5]) }}
                        </div>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <span style="background: {% if account[6] %}#d4edda{% else %}#f8d7da{% endif %}; 
                                     color: {% if account[6] %}#155724{% else %}#721c24{% endif %}; 
                                     padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                            {% if account[6] %}ACTIVE{% else %}INACTIVE{% endif %}
                        </span>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <a href="{{ url_for('accounts.account_statement', account_id=account[0]) }}" 
                               class="btn btn-info" 
                               style="padding: 8px 12px; font-size: 18px; line-height: 1;"
                               title="View Statement">
                                üëÅÔ∏è
                            </a>
                            <button onclick="openEditAccountModal({{ account[0] }})" 
                                    class="btn btn-warning" 
                                    style="padding: 8px 12px; font-size: 18px; line-height: 1;"
                                    title="Edit Account">
                                ‚úèÔ∏è
                            </button>
                            {% if account[2] != 'cash' %}
                            <form method="POST" action="{{ url_for('accounts.delete_account', account_id=account[0]) }}" style="display: inline;">
                                <button type="submit" 
                                        class="btn btn-danger" 
                                        style="padding: 8px 12px; font-size: 18px; line-height: 1;"
                                        title="Delete Account"
                                        onclick="return confirm('‚ö†Ô∏è Delete account {{ account[1] }}?\n\nThis cannot be undone if there are transactions!')">
                                    üóëÔ∏è
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align: center; padding: 60px 20px; color: #999;">
            <i class="fas fa-university" style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3 style="color: #666;">No accounts found</h3>
            <p>Add your first bank or cash account to get started</p>
            <button onclick="openAddAccountModal()" class="btn btn-primary" style="margin-top: 20px;">
                <i class="fas fa-plus"></i> Add First Account
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Account Modal (Popup like Customer/Vendor) -->
<div id="addAccountModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">üí∞ Add New Account</h3>
            <button onclick="closeAddAccountModal()" class="modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('accounts.create_account') }}">
            <div class="modal-body">
                <div class="form-group">
                    <label class="field-label field-label--required">Account Name</label>
                    <input type="text" name="account_name" class="form-control" placeholder="e.g., HDFC Bank, Cash Counter, Petty Cash" required>
                </div>
                
                <div class="form-group">
                    <label class="field-label field-label--required">Account Type</label>
                    <select name="account_type" id="accountType" class="form-control" onchange="toggleBankFields()" required>
                        <option value="bank">Bank Account</option>
                        <option value="cash">Cash</option>
                        <option value="petty_cash">Petty Cash</option>
                    </select>
                </div>
                
                <div id="bankFields">
                    <div class="form-group">
                        <label class="field-label">Bank Name</label>
                        <input type="text" name="bank_name" class="form-control" placeholder="e.g., HDFC Bank, ICICI Bank">
                    </div>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="field-label">Account Number</label>
                            <input type="text" name="account_number" class="form-control" placeholder="1234567890">
                        </div>
                        <div class="form-group">
                            <label class="field-label">IFSC Code</label>
                            <input type="text" name="ifsc_code" class="form-control" placeholder="HDFC0001234">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Branch</label>
                        <input type="text" name="branch" class="form-control" placeholder="MG Road, Indore">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="field-label">Opening Balance</label>
                    <input type="number" name="opening_balance" class="form-control" step="0.01" value="0.00" placeholder="0.00">
                </div>
                
                <div class="form-group">
                    <label class="field-label">Description</label>
                    <textarea name="description" class="form-control" rows="2" placeholder="Notes about this account"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="inline-checkbox">
                        <input type="checkbox" name="is_default">
                        <span>Set as default account for this type</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeAddAccountModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ Save Account</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Account Modal -->
<div id="editAccountModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">‚úèÔ∏è Edit Account</h3>
            <button onclick="closeEditAccountModal()" class="modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <form method="POST" id="editAccountForm">
            <div class="modal-body">
                <input type="hidden" id="edit_account_id" name="account_id">
                
                <div class="form-group">
                    <label class="field-label field-label--required">Account Name</label>
                    <input type="text" name="account_name" id="edit_account_name" class="form-control" required>
                </div>
                
                <div id="editBankFields">
                    <div class="form-group">
                        <label class="field-label">Bank Name</label>
                        <input type="text" name="bank_name" id="edit_bank_name" class="form-control">
                    </div>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="field-label">Account Number</label>
                            <input type="text" name="account_number" id="edit_account_number" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="field-label">IFSC Code</label>
                            <input type="text" name="ifsc_code" id="edit_ifsc_code" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="field-label">Branch</label>
                        <input type="text" name="branch" id="edit_branch" class="form-control">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="field-label">Description</label>
                    <textarea name="description" id="edit_description" class="form-control" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="field-label field-label--required">Current Balance (‚Çπ)</label>
                    <input type="number" name="current_balance" id="edit_current_balance" class="form-control" step="0.01" required>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        üí° This will update your account balance. An adjustment transaction will be created automatically.
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="inline-checkbox">
                        <input type="checkbox" name="is_active" id="edit_is_active">
                        <span>Account is active</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="inline-checkbox">
                        <input type="checkbox" name="is_default" id="edit_is_default">
                        <span>Set as default account</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeEditAccountModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ Update Account</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Stats Cards Animation */
.stats-grid {
    animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stat-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2) !important;
}

/* Table Styles */
.account-table tbody tr {
    transition: background 0.2s ease;
}

.account-table tbody tr:hover {
    background: #f8f9ff !important;
}

/* Modal Styles (Same as Customer/Vendor) */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    max-height: 90vh;
    overflow-y: auto;
    animation: slideIn 0.3s ease;
}

.modal-header {
    padding: 20px 25px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 25px;
}

.modal-footer {
    padding: 15px 25px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
</style>

<script>
// Modal functions
function openAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'flex';
}

function closeAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'none';
}

function toggleBankFields() {
    const accountType = document.getElementById('accountType').value;
    const bankFields = document.getElementById('bankFields');
    bankFields.style.display = (accountType === 'bank') ? 'block' : 'none';
}

function openEditAccountModal(accountId) {
    // Fetch account details via AJAX
    fetch(`/admin/accounts/get/${accountId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('editAccountForm').action = `/admin/accounts/edit/${accountId}`;
            document.getElementById('edit_account_id').value = data.id;
            document.getElementById('edit_account_name').value = data.account_name;
            document.getElementById('edit_bank_name').value = data.bank_name;
            document.getElementById('edit_account_number').value = data.account_number;
            document.getElementById('edit_ifsc_code').value = data.ifsc_code;
            document.getElementById('edit_branch').value = data.branch;
            document.getElementById('edit_description').value = data.description;
            document.getElementById('edit_current_balance').value = data.current_balance;
            document.getElementById('edit_is_active').checked = data.is_active;
            document.getElementById('edit_is_default').checked = data.is_default;
            
            // Show/hide bank fields based on type
            document.getElementById('editBankFields').style.display = (data.account_type === 'bank') ? 'block' : 'none';
            
            document.getElementById('editAccountModal').style.display = 'flex';
        })
        .catch(error => {
            alert('Error loading account details');
            console.error(error);
        });
}

function closeEditAccountModal() {
    document.getElementById('editAccountModal').style.display = 'none';
}

// Close modals on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAddAccountModal();
        closeEditAccountModal();
    }
});

// Close modals on outside click
document.getElementById('addAccountModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeAddAccountModal();
});

document.getElementById('editAccountModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeEditAccountModal();
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleBankFields();
});
</script>

{% endblock %}

