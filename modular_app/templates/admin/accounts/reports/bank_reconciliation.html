{% extends "base_sidebar.html" %}

{% block title %}Bank Reconciliation - {{ tenant.company_name }}{% endblock %}

{% block content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="margin: 0; font-size: 28px; font-weight: 600;">üè¶ Bank Reconciliation</h1>
            <p style="margin: 5px 0 0 0; color: #666;">Match your records with bank statement</p>
        </div>
        {% if reconciliation_data %}
        <button onclick="window.print()" class="btn btn-primary" style="padding: 10px 20px;">
            üñ®Ô∏è Print Report
        </button>
        {% endif %}
    </div>
</div>

<!-- Filter Card -->
<div class="card" style="margin-bottom: 30px;">
    <div class="card-body">
        <form method="GET" action="{{ url_for('accounts.bank_reconciliation') }}">
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">
                        üè¶ Select Account
                    </label>
                    <select name="account_id" class="form-control" required>
                        {% for account in accounts %}
                        <option value="{{ account[0] }}" {% if selected_account_id == account[0] %}selected{% endif %}>
                            {{ account[1] }} ({{ account[2]|title }}) - Current: ‚Çπ{{ "{:,.2f}".format(account[3]) }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">
                        üìÖ From Date
                    </label>
                    <input type="date" name="from_date" class="form-control" 
                           value="{{ from_date.strftime('%Y-%m-%d') }}" required>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">
                        üìÖ To Date
                    </label>
                    <input type="date" name="to_date" class="form-control" 
                           value="{{ to_date.strftime('%Y-%m-%d') }}" required>
                </div>
                
                <button type="submit" class="btn btn-primary" style="padding: 10px 30px;">
                    üîç Show Report
                </button>
            </div>
        </form>
    </div>
</div>

{% if reconciliation_data %}
<!-- Summary Card -->
<div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
    <h2 style="margin: 0 0 20px 0; font-size: 22px; font-weight: 600;">
        {{ reconciliation_data['account_name'] }} ({{ reconciliation_data['account_type']|title }})
    </h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
        <div>
            <div style="font-size: 14px; opacity: 0.9;">Opening Balance</div>
            <div style="font-size: 24px; font-weight: 700; margin-top: 5px;">
                ‚Çπ{{ "{:,.2f}".format(reconciliation_data['opening_balance']) }}
            </div>
        </div>
        
        <div>
            <div style="font-size: 14px; opacity: 0.9;">Total Receipts (+)</div>
            <div style="font-size: 24px; font-weight: 700; margin-top: 5px; color: #d3f9d8;">
                ‚Çπ{{ "{:,.2f}".format(reconciliation_data['total_debit']) }}
            </div>
        </div>
        
        <div>
            <div style="font-size: 14px; opacity: 0.9;">Total Payments (-)</div>
            <div style="font-size: 24px; font-weight: 700; margin-top: 5px; color: #ffccbc;">
                ‚Çπ{{ "{:,.2f}".format(reconciliation_data['total_credit']) }}
            </div>
        </div>
        
        <div style="border-left: 2px solid rgba(255,255,255,0.3); padding-left: 20px;">
            <div style="font-size: 14px; opacity: 0.9;">Calculated Balance</div>
            <div style="font-size: 24px; font-weight: 700; margin-top: 5px;">
                ‚Çπ{{ "{:,.2f}".format(reconciliation_data['closing_balance']) }}
            </div>
        </div>
        
        <div>
            <div style="font-size: 14px; opacity: 0.9;">Current Balance</div>
            <div style="font-size: 24px; font-weight: 700; margin-top: 5px;">
                ‚Çπ{{ "{:,.2f}".format(reconciliation_data['current_balance']) }}
            </div>
        </div>
        
        {% if reconciliation_data['difference'] != 0 %}
        <div style="background: rgba(255,107,107,0.2); border: 2px solid #ff6b6b; padding: 15px; border-radius: 8px;">
            <div style="font-size: 14px; opacity: 0.9;">‚ö†Ô∏è Difference</div>
            <div style="font-size: 24px; font-weight: 700; margin-top: 5px; color: #ff6b6b;">
                ‚Çπ{{ "{:,.2f}".format(reconciliation_data['difference']|abs) }}
            </div>
        </div>
        {% else %}
        <div style="background: rgba(81,207,102,0.2); border: 2px solid #51cf66; padding: 15px; border-radius: 8px;">
            <div style="font-size: 14px; opacity: 0.9;">‚úÖ Status</div>
            <div style="font-size: 18px; font-weight: 700; margin-top: 5px; color: #2b8a3e;">
                RECONCILED
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Transactions Table -->
<div class="card">
    <div class="card-header" style="background: #f8f9fa; border-bottom: 2px solid #dee2e6; padding: 15px 20px;">
        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">üìã Transaction Details</h3>
        <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">
            Period: {{ from_date.strftime('%d %b %Y') }} to {{ to_date.strftime('%d %b %Y') }}
            ({{ reconciliation_data['transactions']|length }} transactions)
        </p>
    </div>
    <div class="card-body" style="padding: 0; overflow-x: auto;">
        {% if reconciliation_data['transactions'] %}
        <table class="tally-ledger" style="width: 100%; font-size: 13px;">
            <thead>
                <tr style="background: #f1f3f5; border-bottom: 2px solid #dee2e6;">
                    <th style="padding: 12px; text-align: left; font-weight: 600; min-width: 100px;">Date</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; min-width: 150px;">Type</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; min-width: 120px;">Voucher #</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; min-width: 250px;">Particulars</th>
                    <th style="padding: 12px; text-align: right; font-weight: 600; min-width: 120px;">Receipts (+)</th>
                    <th style="padding: 12px; text-align: right; font-weight: 600; min-width: 120px;">Payments (-)</th>
                    <th style="padding: 12px; text-align: right; font-weight: 600; min-width: 120px;">Balance</th>
                </tr>
            </thead>
            <tbody>
                {% for txn in reconciliation_data['transactions'] %}
                <tr style="border-bottom: 1px solid #f1f3f5;">
                    <td style="padding: 10px;">{{ txn['date'].strftime('%d-%b-%y') }}</td>
                    <td style="padding: 10px;">
                        <span style="
                            padding: 3px 8px; 
                            border-radius: 4px; 
                            font-size: 11px; 
                            font-weight: 600;
                            {% if txn['type'] == 'opening_balance' %}
                                background: #e7f5ff; color: #1971c2;
                            {% elif txn['type'] == 'invoice_payment' %}
                                background: #d3f9d8; color: #2b8a3e;
                            {% elif txn['type'] == 'bill_payment' or txn['type'] == 'expense' %}
                                background: #ffdeeb; color: #c92a2a;
                            {% elif txn['type'] == 'contra' %}
                                background: #fff3bf; color: #e67700;
                            {% else %}
                                background: #f1f3f5; color: #495057;
                            {% endif %}
                        ">
                            {{ txn['type'].replace('_', ' ')|title }}
                        </span>
                    </td>
                    <td style="padding: 10px; font-family: monospace;">{{ txn['voucher'] }}</td>
                    <td style="padding: 10px;">{{ txn['narration'] }}</td>
                    <td style="padding: 10px; text-align: right; font-weight: 600; color: #2b8a3e;">
                        {% if txn['debit'] > 0 %}
                        ‚Çπ{{ "{:,.2f}".format(txn['debit']) }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="padding: 10px; text-align: right; font-weight: 600; color: #c92a2a;">
                        {% if txn['credit'] > 0 %}
                        ‚Çπ{{ "{:,.2f}".format(txn['credit']) }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="padding: 10px; text-align: right; font-weight: 700;">
                        ‚Çπ{{ "{:,.2f}".format(txn['balance']) }}
                    </td>
                </tr>
                {% endfor %}
                
                <!-- Summary Row -->
                <tr style="background: #f8f9fa; border-top: 2px solid #495057; font-weight: 700;">
                    <td colspan="4" style="padding: 15px; text-align: right; font-size: 15px;">TOTAL</td>
                    <td style="padding: 15px; text-align: right; color: #2b8a3e; font-size: 15px;">
                        ‚Çπ{{ "{:,.2f}".format(reconciliation_data['total_debit']) }}
                    </td>
                    <td style="padding: 15px; text-align: right; color: #c92a2a; font-size: 15px;">
                        ‚Çπ{{ "{:,.2f}".format(reconciliation_data['total_credit']) }}
                    </td>
                    <td style="padding: 15px; text-align: right; font-size: 15px;">
                        ‚Çπ{{ "{:,.2f}".format(reconciliation_data['closing_balance']) }}
                    </td>
                </tr>
            </tbody>
        </table>
        {% else %}
        <div style="padding: 60px; text-align: center;">
            <div style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;">üìä</div>
            <h3 style="margin: 0 0 10px 0; color: #666;">No Transactions</h3>
            <p style="margin: 0; color: #999;">No transactions found in the selected period</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Reconciliation Instructions -->
<div class="card" style="margin-top: 30px; background: #fff3cd; border-left: 4px solid #ffc107;">
    <div class="card-body">
        <h4 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: #856404;">
            üí° How to Reconcile:
        </h4>
        <ol style="margin: 0; padding-left: 20px; color: #856404;">
            <li style="margin-bottom: 8px;">Get your bank statement for the period</li>
            <li style="margin-bottom: 8px;">Match each transaction in this report with the bank statement</li>
            <li style="margin-bottom: 8px;">Look for transactions in the bank statement that are not in this report (add them!)</li>
            <li style="margin-bottom: 8px;">Look for transactions in this report that are not in the bank statement (investigate!)</li>
            <li>The closing balance should match your bank statement's closing balance</li>
        </ol>
        
        {% if reconciliation_data['difference'] != 0 %}
        <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 5px; border: 1px solid #ffc107;">
            <strong style="color: #c92a2a;">‚ö†Ô∏è Difference Found: ‚Çπ{{ "{:,.2f}".format(reconciliation_data['difference']|abs) }}</strong>
            <p style="margin: 5px 0 0 0; font-size: 13px;">
                This could be due to:
                ‚Ä¢ Transactions not yet recorded ‚Ä¢ Bank charges ‚Ä¢ Interest earned ‚Ä¢ Timing differences
            </p>
        </div>
        {% endif %}
    </div>
</div>

{% endif %}

<style>
    @media print {
        .sidebar, .content-header button, .nav-item, .card:last-child { display: none !important; }
        body { padding: 0 !important; }
        .content-header h1 { font-size: 20px !important; }
    }
</style>
{% endblock %}

