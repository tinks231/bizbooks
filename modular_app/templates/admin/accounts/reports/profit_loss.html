{% extends "base_sidebar.html" %}

{% block title %}Profit & Loss Statement{% endblock %}

{% block page_title %}üíπ Profit & Loss Statement{% endblock %}

{% block header_actions %}
<button onclick="window.print()" class="btn btn-secondary">
    üñ®Ô∏è Print
</button>
{% endblock %}

{% block content %}

<div class="container-fluid" style="padding: 30px;">
    
    <!-- Date Filter Card -->
    <div style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <form method="GET" action="{{ url_for('accounts.profit_loss') }}" style="display: flex; gap: 20px; align-items: end; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">From Date</label>
                <input type="date" name="start_date" value="{{ start_date.strftime('%Y-%m-%d') }}" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">To Date</label>
                <input type="date" name="end_date" value="{{ end_date.strftime('%Y-%m-%d') }}" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            </div>
            <button type="submit" style="padding: 10px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                üîç View P&L
            </button>
        </form>
    </div>

    <!-- Disclaimer Note -->
    <div class="alert alert-secondary" style="border-left: 4px solid #6c757d; margin-bottom: 25px; padding: 15px 20px; background: #f8f9fa; border-radius: 8px;">
        <h6 style="margin: 0 0 8px 0; font-weight: 600; color: #495057;">üìå Report Accuracy Note</h6>
        <p style="margin: 0; font-size: 14px; color: #6c757d; line-height: 1.6;">
            This report is generated from your data for business analysis and record-keeping.
            <br>
            <strong>Before submitting to tax authorities:</strong> Always verify with your Chartered Accountant.
            BizBooks provides the data; your CA ensures compliance.
        </p>
    </div>

    <!-- Report Header -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
        <h2 style="margin: 0 0 10px 0; font-size: 24px;">üíπ Profit & Loss Statement</h2>
        <div style="font-size: 14px; opacity: 0.9;">
            {{ tenant.business_name if tenant else 'Business' }} | Period: {{ start_date.strftime('%d %b %Y') }} to {{ end_date.strftime('%d %b %Y') }}
        </div>
    </div>

    <!-- P&L Statement Table -->
    <div class="tally-ledger" style="background: white; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #333;">
                    <th style="padding: 10px; text-align: left; font-weight: 600; font-size: 12px; width: 70%;">PARTICULARS</th>
                    <th style="padding: 10px; text-align: right; font-weight: 600; font-size: 12px; width: 30%;">AMOUNT (‚Çπ)</th>
                </tr>
            </thead>
            <tbody>
                <!-- ========== INCOME SECTION ========== -->
                <tr style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                    <td colspan="2" style="padding: 12px; font-weight: 700; font-size: 15px; color: #155724; border-bottom: 2px solid #28a745;">
                        üìà INCOME
                    </td>
                </tr>
                
                <!-- Sales Revenue -->
                <tr>
                    <td style="padding: 8px 10px 4px 20px; font-weight: 600; font-size: 13px; color: #666; border-bottom: 1px solid #f0f0f0;">
                        Sales Revenue (Invoices):
                    </td>
                    <td style="padding: 8px 10px 4px 10px; border-bottom: 1px solid #f0f0f0;"></td>
                </tr>
                {% if sales_revenue_detail %}
                    {% for inv in sales_revenue_detail[:10] %}
                    <tr>
                        <td style="padding: 4px 10px 4px 30px; font-size: 11px; color: #555; border-bottom: 1px solid #f9f9f9;">
                            {{ inv[0] }} - {{ inv[1] }} ({{ inv[2].strftime('%d-%b') }})
                            {% if inv[4] != 'paid' %}
                            <span style="color: #ff9800; font-size: 10px;">‚óè Pending</span>
                            {% endif %}
                        </td>
                        <td style="padding: 4px 10px; text-align: right; font-size: 11px; font-family: 'Courier New', monospace; border-bottom: 1px solid #f9f9f9;">
                            {{ "{:,.2f}".format(inv[3]) }}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if sales_revenue_detail|length > 10 %}
                    <tr>
                        <td colspan="2" style="padding: 4px 10px 4px 30px; font-size: 10px; color: #999; font-style: italic; border-bottom: 1px solid #f0f0f0;">
                            ... and {{ sales_revenue_detail|length - 10 }} more invoices
                        </td>
                    </tr>
                    {% endif %}
                {% else %}
                    <tr>
                        <td colspan="2" style="padding: 8px 10px 8px 30px; font-size: 11px; color: #999; font-style: italic; border-bottom: 1px solid #f0f0f0;">
                            No invoices in this period
                        </td>
                    </tr>
                {% endif %}
                <tr style="background: #e8f5e9;">
                    <td style="padding: 8px 10px; font-weight: 700; font-size: 13px; color: #000; border-bottom: 1px solid #ddd;">
                        Total Sales Revenue
                        {% if sales_pending > 0 %}
                        <small style="font-weight: 400; font-size: 11px; color: #ff9800;">
                            (Paid: ‚Çπ{{ "{:,.2f}".format(sales_paid) }} | Pending: ‚Çπ{{ "{:,.2f}".format(sales_pending) }})
                        </small>
                        {% endif %}
                    </td>
                    <td style="padding: 8px 10px; text-align: right; font-weight: 700; font-size: 14px; font-family: 'Courier New', monospace; color: #28a745; border-bottom: 1px solid #ddd;">
                        {{ "{:,.2f}".format(total_sales) }}
                    </td>
                </tr>
                
                <!-- Sales Returns (if any) -->
                {% if total_sales_returns > 0 %}
                <tr>
                    <td style="padding: 8px 10px 4px 20px; font-weight: 600; font-size: 13px; color: #e74c3c; border-bottom: 1px solid #f0f0f0;">
                        Less: Sales Returns
                    </td>
                    <td style="padding: 8px 10px 4px 10px; border-bottom: 1px solid #f0f0f0;"></td>
                </tr>
                {% if sales_returns_detail %}
                    {% for ret in sales_returns_detail[:10] %}
                    <tr>
                        <td style="padding: 4px 10px 4px 30px; font-size: 11px; color: #555; border-bottom: 1px solid #f9f9f9;">
                            {{ ret[0] }} - {{ ret[1] }} ({{ ret[2].strftime('%d-%b') }})
                        </td>
                        <td style="padding: 4px 10px; text-align: right; font-size: 11px; font-family: 'Courier New', monospace; color: #e74c3c; border-bottom: 1px solid #f9f9f9;">
                            ({{ "{:,.2f}".format(ret[3]) }})
                        </td>
                    </tr>
                    {% endfor %}
                {% endif %}
                <tr style="background: #fee;">
                    <td style="padding: 8px 10px; font-weight: 700; font-size: 13px; color: #e74c3c; border-bottom: 2px solid #e74c3c;">
                        Total Sales Returns
                    </td>
                    <td style="padding: 8px 10px; text-align: right; font-weight: 700; font-size: 14px; font-family: 'Courier New', monospace; color: #e74c3c; border-bottom: 2px solid #e74c3c;">
                        ({{ "{:,.2f}".format(total_sales_returns) }})
                    </td>
                </tr>
                
                <!-- Net Sales -->
                <tr style="background: #d4edda;">
                    <td style="padding: 8px 10px; font-weight: 700; font-size: 13px; color: #155724; border-bottom: 2px solid #28a745;">
                        Net Sales Revenue (After Returns)
                    </td>
                    <td style="padding: 8px 10px; text-align: right; font-weight: 700; font-size: 14px; font-family: 'Courier New', monospace; color: #155724; border-bottom: 2px solid #28a745;">
                        {{ "{:,.2f}".format(net_sales) }}
                    </td>
                </tr>
                {% endif %}
                
                <!-- Total Income -->
                <tr style="background: #c3e6cb; border-top: 2px solid #28a745;">
                    <td style="padding: 12px; font-weight: 700; font-size: 15px; color: #155724;">
                        NET SALES REVENUE
                    </td>
                    <td style="padding: 12px; text-align: right; font-weight: 700; font-size: 16px; font-family: 'Courier New', monospace; color: #155724;">
                        {{ "{:,.2f}".format(total_income) }}
                    </td>
                </tr>
                
                <!-- ========== COST OF GOODS SOLD SECTION ========== -->
                <tr style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-top: 3px solid #000;">
                    <td colspan="2" style="padding: 12px; font-weight: 700; font-size: 15px; color: #856404; border-bottom: 2px solid #ffc107;">
                        üì¶ COST OF GOODS SOLD
                    </td>
                </tr>
                
                <!-- Purchase Bills (COGS Details) -->
                <tr>
                    <td style="padding: 8px 10px 4px 20px; font-weight: 600; font-size: 13px; color: #666; border-bottom: 1px solid #f0f0f0;">
                        Purchase Bills:
                    </td>
                    <td style="padding: 8px 10px 4px 10px; border-bottom: 1px solid #f0f0f0;"></td>
                </tr>
                {% if purchase_expenses_detail %}
                    {% for bill in purchase_expenses_detail[:10] %}
                    <tr>
                        <td style="padding: 4px 10px 4px 30px; font-size: 11px; color: #555; border-bottom: 1px solid #f9f9f9;">
                            {{ bill[0] }} - {{ bill[1] }} ({{ bill[2].strftime('%d-%b') }})
                        </td>
                        <td style="padding: 4px 10px; text-align: right; font-size: 11px; font-family: 'Courier New', monospace; border-bottom: 1px solid #f9f9f9;">
                            {{ "{:,.2f}".format(bill[3]) }}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if purchase_expenses_detail|length > 10 %}
                    <tr>
                        <td colspan="2" style="padding: 4px 10px 4px 30px; font-size: 10px; color: #999; font-style: italic; border-bottom: 1px solid #f0f0f0;">
                            ... and {{ purchase_expenses_detail|length - 10 }} more purchase bills
                        </td>
                    </tr>
                    {% endif %}
                {% else %}
                    <tr>
                        <td colspan="2" style="padding: 8px 10px 8px 30px; font-size: 11px; color: #999; font-style: italic; border-bottom: 1px solid #f0f0f0;">
                            No purchase bills in this period
                        </td>
                    </tr>
                {% endif %}
                <tr style="background: #ffeaa7;">
                    <td style="padding: 8px 10px; font-weight: 700; font-size: 13px; color: #856404; border-bottom: 2px solid #ffc107;">
                        Total Cost of Goods Sold
                    </td>
                    <td style="padding: 8px 10px; text-align: right; font-weight: 700; font-size: 14px; font-family: 'Courier New', monospace; color: #856404; border-bottom: 2px solid #ffc107;">
                        {{ "{:,.2f}".format(total_purchases) }}
                    </td>
                </tr>
                
                <!-- Gross Profit (Clear Subtotal) -->
                <tr style="background: {% if gross_profit >= 0 %}#d4edda{% else %}#f8d7da{% endif %}; border-top: 3px solid #000; border-bottom: 3px solid #000;">
                    <td style="padding: 14px 10px 14px 20px; font-weight: 700; font-size: 16px; color: #000;">
                        üí∞ GROSS PROFIT
                        <small style="font-weight: 400; font-size: 12px; color: #666; display: block; margin-top: 4px;">
                            (Net Sales - Cost of Goods Sold)
                        </small>
                    </td>
                    <td style="padding: 14px 10px; text-align: right; font-weight: 700; font-size: 17px; font-family: 'Courier New', monospace; color: {% if gross_profit >= 0 %}#28a745{% else %}#dc3545{% endif %};">
                        {{ "{:,.2f}".format(gross_profit) }}
                    </td>
                </tr>
                
                <!-- ========== OPERATING EXPENSES SECTION ========== -->
                <tr style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border-top: 3px solid #000;">
                    <td colspan="2" style="padding: 12px; font-weight: 700; font-size: 15px; color: #721c24; border-bottom: 2px solid #dc3545;">
                        üìâ OPERATING EXPENSES
                    </td>
                </tr>
                
                <!-- Operating Expenses Details -->
                <tr style="border-top: 2px solid #f0f0f0;">
                    <td style="padding: 8px 10px 4px 20px; font-weight: 600; font-size: 13px; color: #666; border-bottom: 1px solid #f0f0f0;">
                        Operating Expenses:
                    </td>
                    <td style="padding: 8px 10px 4px 10px; border-bottom: 1px solid #f0f0f0;"></td>
                </tr>
                {% if operating_expenses_by_category %}
                    {% for category, amount in operating_expenses_by_category.items() %}
                    <tr>
                        <td style="padding: 4px 10px 4px 30px; font-size: 11px; color: #555; border-bottom: 1px solid #f9f9f9;">
                            {{ category }}
                        </td>
                        <td style="padding: 4px 10px; text-align: right; font-size: 11px; font-family: 'Courier New', monospace; border-bottom: 1px solid #f9f9f9;">
                            {{ "{:,.2f}".format(amount) }}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="2" style="padding: 8px 10px 8px 30px; font-size: 11px; color: #999; font-style: italic; border-bottom: 1px solid #f0f0f0;">
                            No operating expenses in this period
                        </td>
                    </tr>
                {% endif %}
                <tr style="background: #f8d7da;">
                    <td style="padding: 6px 10px; font-weight: 600; font-size: 12px; color: #000; border-bottom: 1px solid #ddd;">
                        Total Operating Expenses
                    </td>
                    <td style="padding: 6px 10px; text-align: right; font-weight: 600; font-size: 13px; font-family: 'Courier New', monospace; color: #dc3545; border-bottom: 1px solid #ddd;">
                        {{ "{:,.2f}".format(total_operating_expenses) }}
                    </td>
                </tr>
                
                <!-- Employee Expenses -->
                {% if employee_expenses_detail %}
                <tr>
                    <td style="padding: 8px 10px 4px 20px; font-weight: 600; font-size: 13px; color: #666; border-bottom: 1px solid #f0f0f0;">
                        Employee Expenses:
                    </td>
                    <td style="padding: 8px 10px 4px 10px; border-bottom: 1px solid #f0f0f0;"></td>
                </tr>
                {% for emp in employee_expenses_detail %}
                <tr>
                    <td style="padding: 4px 10px 4px 30px; font-size: 11px; color: #555; border-bottom: 1px solid #f9f9f9;">
                        {{ emp[0] }}
                    </td>
                    <td style="padding: 4px 10px; text-align: right; font-size: 11px; font-family: 'Courier New', monospace; border-bottom: 1px solid #f9f9f9;">
                        {{ "{:,.2f}".format(emp[1]) }}
                    </td>
                </tr>
                {% endfor %}
                <tr style="background: #f8d7da;">
                    <td style="padding: 6px 10px; font-weight: 600; font-size: 12px; color: #000; border-bottom: 1px solid #ddd;">
                        Total Employee Expenses
                    </td>
                    <td style="padding: 6px 10px; text-align: right; font-weight: 600; font-size: 13px; font-family: 'Courier New', monospace; color: #dc3545; border-bottom: 1px solid #ddd;">
                        {{ "{:,.2f}".format(total_employee_expenses) }}
                    </td>
                </tr>
                {% endif %}
                
                <!-- Salary Expenses -->
                {% if total_salary_expenses > 0 %}
                <tr>
                    <td style="padding: 8px 10px 4px 20px; font-weight: 600; font-size: 13px; color: #666; border-bottom: 1px solid #f0f0f0;">
                        Salary Expenses:
                    </td>
                    <td style="padding: 8px 10px 4px 10px; border-bottom: 1px solid #f0f0f0;"></td>
                </tr>
                {% for emp in salary_expenses_detail %}
                <tr>
                    <td style="padding: 4px 10px 4px 30px; font-size: 12px; color: #555; border-bottom: 1px solid #f9f9f9;">
                        {{ emp[0] }} {% if emp[1] %}({{ emp[1] }}){% endif %}
                    </td>
                    <td style="padding: 4px 10px; text-align: right; font-size: 12px; font-family: 'Courier New', monospace; color: #dc3545; border-bottom: 1px solid #f9f9f9;">
                        {{ "{:,.2f}".format(emp[2]) }}
                    </td>
                </tr>
                {% endfor %}
                <tr style="background: #f8d7da;">
                    <td style="padding: 6px 10px; font-weight: 600; font-size: 12px; color: #000; border-bottom: 1px solid #ddd;">
                        Total Salary Expenses
                    </td>
                    <td style="padding: 6px 10px; text-align: right; font-weight: 600; font-size: 13px; font-family: 'Courier New', monospace; color: #dc3545; border-bottom: 1px solid #ddd;">
                        {{ "{:,.2f}".format(total_salary_expenses) }}
                    </td>
                </tr>
                {% endif %}
                
                <!-- Commission Expenses -->
                {% if total_commission_expenses > 0 %}
                <tr>
                    <td style="padding: 8px 10px 4px 20px; font-weight: 600; font-size: 13px; color: #666; border-bottom: 1px solid #f0f0f0;">
                        Commission Expenses:
                    </td>
                    <td style="padding: 8px 10px 4px 10px; border-bottom: 1px solid #f0f0f0;"></td>
                </tr>
                {% for comm in commission_expenses_detail %}
                <tr>
                    <td style="padding: 4px 10px 4px 30px; font-size: 12px; color: #555; border-bottom: 1px solid #f9f9f9;">
                        {{ comm[1] }}
                    </td>
                    <td style="padding: 4px 10px; text-align: right; font-size: 12px; font-family: 'Courier New', monospace; color: #dc3545; border-bottom: 1px solid #f9f9f9;">
                        {{ "{:,.2f}".format(comm[2]) }}
                    </td>
                </tr>
                {% endfor %}
                <tr style="background: #f8d7da;">
                    <td style="padding: 6px 10px; font-weight: 600; font-size: 12px; color: #000; border-bottom: 1px solid #ddd;">
                        Total Commission Expenses
                    </td>
                    <td style="padding: 6px 10px; text-align: right; font-weight: 600; font-size: 13px; font-family: 'Courier New', monospace; color: #dc3545; border-bottom: 1px solid #ddd;">
                        {{ "{:,.2f}".format(total_commission_expenses) }}
                    </td>
                </tr>
                {% endif %}
                
                <!-- Total Operating Expenses -->
                <tr style="background: #f5c6cb; border-top: 2px solid #dc3545;">
                    <td style="padding: 12px; font-weight: 700; font-size: 15px; color: #721c24;">
                        TOTAL OPERATING EXPENSES
                    </td>
                    <td style="padding: 12px; text-align: right; font-weight: 700; font-size: 16px; font-family: 'Courier New', monospace; color: #721c24;">
                        {{ "{:,.2f}".format(total_operating_expenses + total_employee_expenses + total_salary_expenses + total_commission_expenses) }}
                    </td>
                </tr>
                
                <!-- ========== NET PROFIT ========== -->
                <tr style="background: {% if net_profit >= 0 %}linear-gradient(135deg, #c3e6cb 0%, #a5d6a7 100%){% else %}linear-gradient(135deg, #f5c6cb 0%, #f8b4b4 100%){% endif %}; border-top: 3px solid #000; border-bottom: 3px solid #000;">
                    <td style="padding: 15px; font-weight: 700; font-size: 17px; color: #000;">
                        {% if net_profit >= 0 %}‚úÖ NET PROFIT{% else %}‚ùå NET LOSS{% endif %}
                        <br>
                        <small style="font-size: 12px; font-weight: 400; color: #555;">
                            (Gross Profit - Operating Expenses) | Profit Margin: {{ "{:.2f}".format(profit_margin) }}%
                        </small>
                    </td>
                    <td style="padding: 15px; text-align: right; font-weight: 700; font-size: 18px; font-family: 'Courier New', monospace; color: {% if net_profit >= 0 %}#155724{% else %}#721c24{% endif %};">
                        {{ "{:,.2f}".format(net_profit|abs) }}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 25px;">
        <!-- Total Income Card -->
        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Income</div>
            <div style="font-size: 28px; font-weight: 700; font-family: 'Courier New', monospace;">‚Çπ{{ "{:,.2f}".format(total_income) }}</div>
        </div>
        
        <!-- Total Expenses Card -->
        <div style="background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%); color: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Expenses</div>
            <div style="font-size: 28px; font-weight: 700; font-family: 'Courier New', monospace;">‚Çπ{{ "{:,.2f}".format(total_expenses) }}</div>
        </div>
        
        <!-- Net Profit Card -->
        <div style="background: linear-gradient(135deg, {% if net_profit >= 0 %}#667eea 0%, #764ba2{% else %}#eb3349 0%, #f45c43{% endif %} 100%); color: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">{% if net_profit >= 0 %}Net Profit{% else %}Net Loss{% endif %} ({{ "{:.2f}".format(profit_margin) }}%)</div>
            <div style="font-size: 28px; font-weight: 700; font-family: 'Courier New', monospace;">‚Çπ{{ "{:,.2f}".format(net_profit|abs) }}</div>
        </div>
    </div>
</div>

<style>
/* Tally-Style Ledger Formatting */
.tally-ledger table tbody tr:hover {
    background: #f0f8ff !important;
}

.tally-ledger table tbody tr {
    transition: background 0.2s ease;
}

@media print {
    .sidebar, .btn, .nav-header, button, form {
        display: none !important;
    }
    
    body {
        background: white !important;
    }
    
    .container-fluid {
        padding: 20px !important;
    }
    
    .tally-ledger {
        border: 2px solid #000 !important;
        page-break-inside: avoid;
    }
    
    .tally-ledger table {
        border-collapse: collapse !important;
    }
    
    .tally-ledger td, .tally-ledger th {
        border: 1px solid #000 !important;
    }
    
    div[style*="grid-template-columns"] {
        display: none !important;
    }
}
</style>

{% endblock %}

