{% extends "base_sidebar.html" %}

{% block title %}Create Purchase Bill{% endblock %}

{% block page_title %}üíº Create New Purchase Bill (v2.0){% endblock %}

{% block header_actions %}
<a href="{{ url_for('purchase_bills.list_bills') }}" class="btn btn-secondary">
    ‚Üê Back to Bills
</a>
{% endblock %}

{% block content %}
<style>
    .autocomplete-dropdown {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        max-height: 300px;
        overflow-y: auto;
        width: 100%;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: none;
    }
    .autocomplete-dropdown.show {
        display: block;
    }
    .autocomplete-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }
    .autocomplete-item:hover {
        background: #f8f9ff;
    }
</style>

<form method="POST">
    <!-- Vendor Information Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Vendor Information</h5>
        </div>
        <div class="card-body">
            <!-- Vendor Search -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label">Search Existing Vendor</label>
                    <div style="position: relative;">
                        <input type="text" id="vendor_search" class="form-control"
                               placeholder="Type vendor name or code..."
                               autocomplete="off"
                               oninput="searchVendors(this.value)">
                        <div id="vendor_dropdown" class="autocomplete-dropdown"></div>
                    </div>
                    <input type="hidden" id="vendor_id" name="vendor_id">
                </div>
            </div>
            
            <!-- Vendor Details - 2 Column Layout -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Vendor Name <span class="text-danger">*</span></label>
                    <input type="text" id="vendor_name" name="vendor_name" 
                           class="form-control" required placeholder="Vendor Name">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Phone</label>
                    <input type="tel" id="vendor_phone" name="vendor_phone" 
                           class="form-control" placeholder="Phone Number">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" id="vendor_email" name="vendor_email" 
                           class="form-control" placeholder="Email Address">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">GSTIN</label>
                    <input type="text" id="vendor_gstin" name="vendor_gstin" 
                           class="form-control" placeholder="27XXXXX1234X1Z5" maxlength="15">
                </div>
            </div>
            
            <!-- Address and State - 2 Column Layout -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">State</label>
                    <input type="text" id="vendor_state" name="vendor_state" 
                           class="form-control" value="Maharashtra" placeholder="State">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Address</label>
                    <textarea id="vendor_address" name="vendor_address" 
                              class="form-control" rows="2" 
                              placeholder="Enter vendor address"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Bill Details Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Bill Details</h5>
        </div>
        <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Bill Date <span class="text-danger">*</span></label>
                        <input type="date" name="bill_date" class="form-control" value="{{ today }}" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="date" name="due_date" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Vendor Invoice #</label>
                        <input type="text" name="reference_number" class="form-control" placeholder="Vendor's bill number">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Payment Terms</label>
                        <input type="text" name="payment_terms" class="form-control" placeholder="e.g., Net 30 days">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Line Items Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Line Items</h5>
            <button type="button" class="btn btn-sm btn-primary" onclick="addRow()">
                + Add Item
            </button>
        </div>
        <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="items_table">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 25%;">ITEM <span class="text-danger">*</span></th>
                                <th style="width: 12%;">HSN CODE</th>
                                <th style="width: 10%;">QTY <span class="text-danger">*</span></th>
                                <th style="width: 8%;">UNIT</th>
                                <th style="width: 12%;">RATE <span class="text-danger">*</span></th>
                                <th style="width: 10%;">GST %</th>
                                <th style="width: 12%;" class="text-end">AMOUNT</th>
                                <th style="width: 3%;"></th>
                            </tr>
                        </thead>
                    <tbody id="items_body">
                        <!-- Template row -->
                        <tr class="item-row">
                            <td>
                                <div style="position: relative;">
                                    <input type="text" class="form-control item-search" 
                                           placeholder="Search or type item name..."
                                           autocomplete="off"
                                           oninput="searchItems(this)">
                                    <input type="hidden" class="item-id" name="item_id[]">
                                    <input type="hidden" class="item-name" name="item_name[]">
                                    <div class="item-dropdown autocomplete-dropdown"></div>
                                </div>
                            </td>
                            <td>
                                <input type="text" name="hsn_code[]" class="form-control hsn-input" placeholder="HSN">
                            </td>
                            <td>
                                <input type="number" name="quantity[]" class="form-control qty-input" step="0.001" min="0" value="1" oninput="calculateRow(this)">
                            </td>
                            <td>
                                <input type="text" name="unit[]" class="form-control unit-input" value="pcs">
                            </td>
                            <td>
                                <input type="number" name="rate[]" class="form-control rate-input" step="0.01" min="0" oninput="calculateRow(this)">
                            </td>
                            <td>
                                <input type="number" name="gst_rate[]" class="form-control gst-input" step="0.01" min="0" value="18" oninput="calculateRow(this)">
                            </td>
                            <td>
                                <input type="text" class="form-control amount-display" readonly>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Totals -->
                <div class="row justify-content-end mt-3">
                    <div class="col-md-4">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Subtotal:</strong></td>
                                <td class="text-end"><strong id="subtotal_display">‚Çπ0.00</strong></td>
                            </tr>
                            <tr>
                                <td>CGST:</td>
                                <td class="text-end" id="cgst_display">‚Çπ0.00</td>
                            </tr>
                            <tr>
                                <td>SGST:</td>
                                <td class="text-end" id="sgst_display">‚Çπ0.00</td>
                            </tr>
                            <tr>
                                <td>IGST:</td>
                                <td class="text-end" id="igst_display">‚Çπ0.00</td>
                            </tr>
                            <tr>
                                <td>
                                    Other Charges:
                                    <input type="number" name="other_charges" class="form-control form-control-sm" 
                                           step="0.01" value="0" oninput="calculateTotal()" 
                                           style="width: 120px; display: inline-block; margin-left: 5px;">
                                </td>
                                <td></td>
                            </tr>
                            <tr class="table-active">
                                <td><strong>Total Amount:</strong></td>
                                <td class="text-end"><strong id="total_display" style="font-size: 18px;">‚Çπ0.00</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Details Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Additional Details</h5>
        </div>
        <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="3" placeholder="Internal notes..."></textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Terms & Conditions</label>
                        <textarea name="terms_conditions" class="form-control" rows="3" placeholder="Payment terms, delivery terms..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="card" style="margin-bottom: 100px;">
        <div class="card-body text-end">
            <a href="{{ url_for('purchase_bills.list_bills') }}" class="btn btn-secondary btn-lg me-2">
                Cancel
            </a>
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-save"></i> Create Purchase Bill
            </button>
        </div>
    </div>
</form>

<script>
// Vendor Autocomplete
let vendorTimeout;
function searchVendors(query) {
    clearTimeout(vendorTimeout);
    const dropdown = document.getElementById('vendor_dropdown');
    
    if (query.length < 2) {
        dropdown.classList.remove('show');
        return;
    }
    
    vendorTimeout = setTimeout(() => {
        fetch(`/admin/purchase-bills/api/vendors/search?q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(vendors => {
                if (vendors.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                dropdown.innerHTML = vendors.map(v => `
                    <div class="autocomplete-item" onclick="selectVendor(${v.id}, '${v.name}', '${v.phone || ''}', '${v.email || ''}', '${v.gstin || ''}', '${v.state || 'Maharashtra'}', '${(v.address || '').replace(/'/g, "\\'")}')">
                        <div style="font-weight: 600;">${v.name}</div>
                        <div style="font-size: 12px; color: #666;">${v.company_name || ''} ${v.phone ? '‚Ä¢ ' + v.phone : ''}</div>
                    </div>
                `).join('');
                dropdown.classList.add('show');
            });
    }, 300);
}

function selectVendor(id, name, phone, email, gstin, state, address) {
    document.getElementById('vendor_id').value = id;
    document.getElementById('vendor_name').value = name;
    document.getElementById('vendor_phone').value = phone;
    document.getElementById('vendor_email').value = email;
    document.getElementById('vendor_gstin').value = gstin;
    document.getElementById('vendor_state').value = state;
    document.getElementById('vendor_address').value = address;
    document.getElementById('vendor_search').value = name;
    document.getElementById('vendor_dropdown').classList.remove('show');
    
    // Recalculate GST type
    calculateTotal();
}

// Item Autocomplete
let itemTimeout;
function searchItems(input) {
    clearTimeout(itemTimeout);
    const query = input.value;
    const row = input.closest('.item-row');
    const dropdown = row.querySelector('.item-dropdown');
    
    if (query.length < 2) {
        dropdown.classList.remove('show');
        return;
    }
    
    itemTimeout = setTimeout(() => {
        fetch(`/admin/purchase-bills/api/search-items?q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(items => {
                if (items.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                dropdown.innerHTML = items.map(item => `
                    <div class="autocomplete-item" onclick="selectItem(this, ${item.id}, '${item.name}', '${item.hsn_code}', '${item.unit}', ${item.purchase_price}, ${item.gst_rate})">
                        <div style="font-weight: 600;">${item.name}</div>
                        <div style="font-size: 12px; color: #666;">HSN: ${item.hsn_code} ‚Ä¢ ‚Çπ${item.purchase_price}/${item.unit}</div>
                    </div>
                `).join('');
                dropdown.classList.add('show');
            });
    }, 300);
}

function selectItem(elem, id, name, hsn, unit, price, gst_rate) {
    const row = elem.closest('.item-row');
    row.querySelector('.item-id').value = id;
    row.querySelector('.item-name').value = name;
    row.querySelector('.item-search').value = name;
    row.querySelector('.hsn-input').value = hsn;
    row.querySelector('.unit-input').value = unit;
    row.querySelector('.rate-input').value = price;
    row.querySelector('.gst-input').value = gst_rate;
    row.querySelector('.item-dropdown').classList.remove('show');
    
    calculateRow(row.querySelector('.qty-input'));
}

// Row calculation
function calculateRow(input) {
    const row = input.closest('.item-row');
    const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
    const rate = parseFloat(row.querySelector('.rate-input').value) || 0;
    const gst_rate = parseFloat(row.querySelector('.gst-input').value) || 0;
    
    const taxable = qty * rate;
    const vendor_state = document.getElementById('vendor_state').value.toLowerCase();
    const use_igst = (vendor_state !== 'maharashtra');
    
    let gst_amount;
    if (use_igst) {
        gst_amount = taxable * gst_rate / 100;
    } else {
        gst_amount = taxable * gst_rate / 100;
    }
    
    const total = taxable + gst_amount;
    row.querySelector('.amount-display').value = '‚Çπ' + total.toFixed(2);
    
    calculateTotal();
}

// Total calculation
function calculateTotal() {
    let subtotal = 0;
    let total_cgst = 0;
    let total_sgst = 0;
    let total_igst = 0;
    
    const vendor_state = document.getElementById('vendor_state').value.toLowerCase();
    const use_igst = (vendor_state !== 'maharashtra');
    
    document.querySelectorAll('.item-row').forEach(row => {
        const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
        const rate = parseFloat(row.querySelector('.rate-input').value) || 0;
        const gst_rate = parseFloat(row.querySelector('.gst-input').value) || 0;
        
        if (qty > 0 && rate > 0) {
            const taxable = qty * rate;
            subtotal += taxable;
            
            if (use_igst) {
                total_igst += taxable * gst_rate / 100;
            } else {
                const gst_half = taxable * gst_rate / 200;
                total_cgst += gst_half;
                total_sgst += gst_half;
            }
        }
    });
    
    const other_charges = parseFloat(document.querySelector('input[name="other_charges"]').value) || 0;
    const grand_total = subtotal + total_cgst + total_sgst + total_igst + other_charges;
    
    document.getElementById('subtotal_display').textContent = '‚Çπ' + subtotal.toFixed(2);
    document.getElementById('cgst_display').textContent = '‚Çπ' + total_cgst.toFixed(2);
    document.getElementById('sgst_display').textContent = '‚Çπ' + total_sgst.toFixed(2);
    document.getElementById('igst_display').textContent = '‚Çπ' + total_igst.toFixed(2);
    document.getElementById('total_display').textContent = '‚Çπ' + grand_total.toFixed(2);
}

// Add/Remove rows
function addRow() {
    const tbody = document.getElementById('items_body');
    const newRow = tbody.querySelector('.item-row').cloneNode(true);
    
    // Clear inputs
    newRow.querySelectorAll('input').forEach(input => {
        if (input.classList.contains('qty-input')) {
            input.value = '1';
        } else if (input.classList.contains('unit-input')) {
            input.value = 'pcs';
        } else if (input.classList.contains('gst-input')) {
            input.value = '18';
        } else {
            input.value = '';
        }
    });
    
    tbody.appendChild(newRow);
}

function removeRow(btn) {
    const tbody = document.getElementById('items_body');
    if (tbody.querySelectorAll('.item-row').length > 1) {
        btn.closest('.item-row').remove();
        calculateTotal();
    }
}

// Close dropdowns on outside click
document.addEventListener('click', function(e) {
    if (!e.target.closest('.autocomplete-dropdown') && !e.target.closest('input')) {
        document.querySelectorAll('.autocomplete-dropdown').forEach(d => d.classList.remove('show'));
    }
});
</script>
{% endblock %}

