{% extends "base_sidebar.html" %}

{% block title %}Create Purchase Bill{% endblock %}

{% block page_title %}üíº Create New Purchase Bill{% endblock %}

{% block header_actions %}
<a href="{{ url_for('purchase_bills.list_bills') }}" class="btn btn-secondary">
    ‚Üê Back to Bills
</a>
{% endblock %}

{% block content %}

<form method="POST" enctype="multipart/form-data" id="purchase_bill_form" onsubmit="return validatePurchaseBillForm()">
    <!-- Vendor Information Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Vendor Information</h5>
        </div>
        <div class="card-body">
            <!-- Vendor Search -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="field-label">Search Existing Vendor</label>
                    <div style="position: relative;">
                        <input type="text" id="vendor_search" class="form-control"
                               placeholder="Type vendor name or code..."
                               autocomplete="off"
                               oninput="searchVendors(this.value)">
                        <div id="vendor_dropdown" class="autocomplete-dropdown"></div>
                    </div>
                    <small class="help-text" style="display: block; margin-top: 8px; color: #666; font-size: 13px;">
                        Don't see your vendor? <a href="javascript:void(0)" onclick="openAddVendorModal()" style="color: #667eea; font-weight: 600; text-decoration: none;">‚ûï Add Vendor</a>
                    </small>
                    <input type="hidden" id="vendor_id" name="vendor_id">
                </div>
            </div>
            
            <!-- Vendor Details - 2 Column Layout -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="field-label">Vendor Name <span class="text-danger">*</span></label>
                    <input type="text" id="vendor_name" name="vendor_name" 
                           class="form-control" required placeholder="Vendor Name">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="field-label">Phone</label>
                    <input type="tel" id="vendor_phone" name="vendor_phone" 
                           class="form-control" placeholder="Phone Number">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="field-label">Email</label>
                    <input type="email" id="vendor_email" name="vendor_email" 
                           class="form-control" placeholder="Email Address">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="field-label">GSTIN</label>
                    <input type="text" id="vendor_gstin" name="vendor_gstin" 
                           class="form-control" placeholder="27XXXXX1234X1Z5" maxlength="15">
                </div>
            </div>
            
            <!-- Address and State - 2 Column Layout -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="field-label">State</label>
                    <input type="text" id="vendor_state" name="vendor_state" 
                           class="form-control" value="Maharashtra" placeholder="State">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="field-label">Address</label>
                    <textarea id="vendor_address" name="vendor_address" 
                              class="form-control" rows="2" 
                              placeholder="Enter vendor address"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Bill Details Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Bill Details</h5>
        </div>
        <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="field-label">Bill Date <span class="text-danger">*</span></label>
                        <input type="date" name="bill_date" class="form-control" value="{{ today }}" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="field-label">Due Date</label>
                        <input type="date" name="due_date" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="field-label">Vendor Invoice #</label>
                        <input type="text" name="reference_number" class="form-control" placeholder="Vendor's bill number">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="field-label">Payment Terms</label>
                        <input type="text" name="payment_terms" class="form-control" placeholder="e.g., Net 30 days">
                    </div>
                </div>
                
                <!-- Bill Document Upload -->
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="field-label">üìé Upload Bill Document <span style="color: #666; font-size: 13px;">(Optional - Image or PDF)</span></label>
                        <input type="file" 
                               name="bill_document" 
                               id="bill_document" 
                               class="form-control" 
                               accept="image/*,.pdf"
                               onchange="previewBillDocument(this)">
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Supported: JPG, PNG, PDF (Max 10MB) ‚Ä¢ Images will be compressed automatically
                        </div>
                        <!-- Preview area -->
                        <div id="document_preview" style="margin-top: 15px; display: none;">
                            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>üìÑ Selected File:</strong>
                                        <div id="file_name" style="color: #666; margin-top: 5px;"></div>
                                        <div id="file_size" style="color: #666; font-size: 12px; margin-top: 3px;"></div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="clearDocument()">
                                        ‚úï Remove
                                    </button>
                                </div>
                                <!-- Image preview (if image) -->
                                <img id="image_preview" style="max-width: 300px; max-height: 200px; margin-top: 10px; border-radius: 4px; display: none;" />
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    <!-- Line Items Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Line Items</h5>
            <button type="button" class="btn btn-sm btn-primary" onclick="addRow()">
                + Add Item
            </button>
        </div>
        <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="items_table">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 25%;">ITEM <span class="text-danger">*</span></th>
                                <th style="width: 12%;">HSN CODE</th>
                                <th style="width: 10%;">QTY <span class="text-danger">*</span></th>
                                <th style="width: 8%;">UNIT</th>
                                <th style="width: 12%;">RATE <span class="text-danger">*</span></th>
                                <th style="width: 10%;">GST %</th>
                                <th style="width: 12%;" class="text-end">AMOUNT</th>
                                <th style="width: 3%;"></th>
                            </tr>
                        </thead>
                    <tbody id="items_body">
                        <!-- First row with unique IDs -->
                        <tr class="item-row" id="row_1">
                            <td>
                                <div style="position: relative;">
                                    <input type="text" class="form-control item-search" 
                                           id="item_search_1"
                                           placeholder="Search or type item name..."
                                           autocomplete="off"
                                           oninput="searchItems(this, 1)"
                                           onfocus="searchItems(this, 1)">
                                    <input type="hidden" class="item-id" name="item_id[]" id="item_id_1">
                                    <input type="hidden" class="item-name" name="item_name[]">
                                    
                                    <!-- NEW: Item Action Fields -->
                                    <input type="hidden" name="item_action[]" class="item-action" value="link">
                                    <!-- Values: "link", "create_new", or "new" (no existing item) -->
                                    
                                    <!-- NEW: For Creating New Items -->
                                    <input type="hidden" name="is_new_item[]" class="is-new-item" value="0">
                                    <input type="hidden" name="new_item_sku[]" class="new-item-sku">
                                    <input type="hidden" name="new_item_selling[]" class="new-item-selling">
                                    <input type="hidden" name="new_item_mrp[]" class="new-item-mrp">
                                    <input type="hidden" name="new_item_category[]" class="new-item-category">
                                    
                                    <!-- NEW: For Updating Existing Items -->
                                    <input type="hidden" name="update_selling_price[]" class="update-selling" value="0">
                                    <input type="hidden" name="update_mrp[]" class="update-mrp" value="0">
                                    <input type="hidden" name="updated_selling_value[]" class="updated-selling-value">
                                    <input type="hidden" name="updated_mrp_value[]" class="updated-mrp-value">
                                    
                                    <!-- NEW: Store existing item data for comparison -->
                                    <input type="hidden" class="existing-cost" data-value="">
                                    <input type="hidden" class="existing-selling" data-value="">
                                    <input type="hidden" class="existing-mrp" data-value="">
                                    <input type="hidden" class="existing-stock" data-value="">
                                    <input type="hidden" class="existing-sku" data-value="">
                                    <input type="hidden" class="existing-barcode" data-value="">
                                    
                                    <div class="autocomplete-dropdown" id="dropdown_1" style="display: none;"></div>
                                </div>
                            </td>
                            <td>
                                <input type="text" name="hsn_code[]" class="form-control hsn-input" placeholder="HSN">
                            </td>
                            <td>
                                <input type="number" name="quantity[]" class="form-control qty-input" step="0.001" min="0" value="1" oninput="calculateRow(this)">
                            </td>
                            <td>
                                <select name="unit[]" class="form-control unit-input">
                                    <option value="Nos">Nos</option>
                                    <option value="Pcs" selected>Pcs</option>
                                    <option value="Dozen">Dozen</option>
                                    <option value="Kg">Kg</option>
                                    <option value="Qtl">Qtl</option>
                                    <option value="Ton">Ton</option>
                                    <option value="G">G</option>
                                    <option value="Ltr">Ltr</option>
                                    <option value="Ml">Ml</option>
                                    <option value="Mtr">Mtr</option>
                                    <option value="Cm">Cm</option>
                                    <option value="Ft">Ft</option>
                                    <option value="Sqm">Sqm</option>
                                    <option value="Cum">Cum</option>
                                    <option value="Cft">Cft</option>
                                    <option value="Box">Box</option>
                                    <option value="Bag">Bag</option>
                                    <option value="Packet">Packet</option>
                                    <option value="Bundle">Bundle</option>
                                </select>
                            </td>
                            <td>
                                <input type="number" name="rate[]" class="form-control rate-input" step="0.01" min="0" oninput="calculateRow(this)">
                            </td>
                            <td>
                                <input type="number" name="gst_rate[]" class="form-control gst-input" step="0.01" min="0" value="18" oninput="calculateRow(this)">
                            </td>
                            <td>
                                <input type="text" class="form-control amount-display" readonly>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Totals -->
                <div class="totals-container">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Subtotal:</strong></td>
                            <td><strong id="subtotal_display">‚Çπ0.00</strong></td>
                        </tr>
                        <tr>
                            <td>CGST:</td>
                            <td id="cgst_display">‚Çπ0.00</td>
                        </tr>
                        <tr>
                            <td>SGST:</td>
                            <td id="sgst_display">‚Çπ0.00</td>
                        </tr>
                        <tr>
                            <td>IGST:</td>
                            <td id="igst_display">‚Çπ0.00</td>
                        </tr>
                        <tr>
                            <td>Other Charges:
                                <input type="number" name="other_charges" class="form-control form-control-sm" 
                                       step="0.01" value="0" oninput="calculateTotal()" 
                                       style="width: 100px; display: inline-block; margin-left: 5px;">
                            </td>
                            <td id="other_display"></td>
                        </tr>
                        <tr class="table-active">
                            <td><strong>Total Amount:</strong></td>
                            <td><strong id="total_display">‚Çπ0.00</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Details Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Additional Details</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="field-label">Notes</label>
                    <textarea name="notes" class="form-control" rows="3" placeholder="Internal notes..."></textarea>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="field-label">Terms & Conditions</label>
                    <textarea name="terms_conditions" class="form-control" rows="3" placeholder="Payment terms, delivery terms..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="card" style="margin-bottom: 100px;">
        <div class="card-body text-end">
            <a href="{{ url_for('purchase_bills.list_bills') }}" 
               style="display: inline-flex; align-items: center; justify-content: center; width: 140px; height: 44px; padding: 0; margin-right: 10px; font-size: 16px; font-weight: 600; color: white; background-color: #6c757d; border: 1px solid #6c757d; border-radius: 6px; text-decoration: none; box-sizing: border-box; cursor: pointer;">
                Cancel
            </a>
            <button type="submit" 
                    style="display: inline-flex; align-items: center; justify-content: center; width: 140px; height: 44px; padding: 0; font-size: 16px; font-weight: 600; color: white; background-color: #28a745; border: 1px solid #28a745; border-radius: 6px; box-sizing: border-box; cursor: pointer;">
                ‚úì Save
            </button>
        </div>
    </div>

    <!-- Item Action Choice Modal -->
    <div class="modal fade" id="itemActionModal" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üì¶ Item Found: <span id="modal_item_name"></span></h5>
                    <button type="button" class="close" onclick="$('#itemActionModal').modal('hide')">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Current Item Info -->
                    <div class="alert alert-info">
                        <strong>üì¶ Current Item Details:</strong><br>
                        SKU: <span id="modal_existing_sku"></span> | 
                        Barcode: <span id="modal_existing_barcode"></span><br>
                        <strong>Current Cost:</strong> ‚Çπ<span id="modal_existing_cost"></span> 
                        <small class="text-muted">(will auto-update via WAC)</small> | 
                        <strong>Selling:</strong> ‚Çπ<span id="modal_existing_selling"></span> | 
                        <strong>MRP:</strong> ‚Çπ<span id="modal_existing_mrp"></span><br>
                        Current Stock: <span id="modal_existing_stock"></span> pcs
                    </div>
                    
                    <!-- Auto-Detection Warning -->
                    <div id="modal_mrp_warning" class="alert alert-warning" style="display:none;">
                        <strong>‚ö†Ô∏è MRP Changed!</strong><br>
                        Old MRP: ‚Çπ<span id="modal_old_mrp"></span> ‚Üí 
                        New MRP: ‚Çπ<span id="modal_new_mrp"></span><br>
                        <span id="modal_stock_warning"></span>
                        <br><br>
                        <strong>Recommendation: Create as NEW item</strong><br>
                        <small>Reason: Old stock has different MRP printed on tags. Creating separate item prevents invoice confusion.</small>
                    </div>
                    
                    <!-- Action Choice -->
                    <div class="form-group">
                        <label><strong>How do you want to add this item?</strong></label>
                        
                        <!-- Option 1: Link to Existing -->
                        <div class="card mb-3" style="border: 2px solid #ddd;">
                            <div class="card-body">
                                <label>
                                    <input type="radio" name="modal_item_action" value="link" 
                                           id="modal_action_link" checked>
                                    <strong> Link to existing item</strong>
                                </label>
                                <p class="text-muted small mb-2">
                                    ‚úÖ <strong>Cost price auto-updates</strong> (weighted average at approval)<br>
                                    ‚úÖ Adds to existing stock<br>
                                    ‚úÖ Same SKU, same barcode<br>
                                    ‚ÑπÔ∏è Enter rate & qty in the form below (after closing modal)
                                </p>
                                
                                <div id="link_options" style="margin-left: 30px;">
                                    <label>
                                        <input type="checkbox" id="modal_update_selling">
                                        Update Selling Price: ‚Çπ
                                        <input type="number" id="modal_new_selling_input" 
                                               step="0.01" style="width: 100px;" disabled>
                                    </label>
                                    <br>
                                    <label>
                                        <input type="checkbox" id="modal_update_mrp">
                                        Update MRP: ‚Çπ
                                        <input type="number" id="modal_new_mrp_input" 
                                               step="0.01" style="width: 100px;" disabled>
                                    </label>
                                    <div id="modal_update_mrp_warning" class="text-danger small" 
                                         style="display:none; margin-left: 20px;">
                                        ‚ö†Ô∏è Warning: Old stock exists with different MRP printed!
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Option 2: Create New -->
                        <div class="card" style="border: 2px solid #ddd;">
                            <div class="card-body">
                                <label>
                                    <input type="radio" name="modal_item_action" value="create_new"
                                           id="modal_action_create">
                                    <strong> Create as NEW item</strong>
                                </label>
                                <p class="text-muted small mb-2">
                                    ‚úÖ New SKU (auto-generated)<br>
                                    ‚úÖ New barcode (auto-generated)<br>
                                    ‚úÖ Separate inventory entry<br>
                                    ‚ÑπÔ∏è Enter rate & qty in the form below (after closing modal)
                                </p>
                                
                                <div id="create_new_options" style="margin-left: 30px; display:none;">
                                    <div class="form-group">
                                        <label>New Item Name <span class="text-danger">*</span></label>
                                        <input type="text" id="modal_new_item_name" 
                                               class="form-control" placeholder="Item name">
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label>Cost Price (from bill)</label>
                                            <input type="number" id="modal_new_cost" 
                                                   class="form-control" readonly>
                                        </div>
                                        <div class="col-md-6">
                                            <label>SKU <span class="text-danger">*</span></label>
                                            <input type="text" id="modal_new_sku" 
                                                   class="form-control" 
                                                   placeholder="e.g., AS-SH-WHT-38">
                                            <small class="text-muted">Auto-suggested, but you can edit</small>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <label>Selling Price <span class="text-danger">*</span></label>
                                            <input type="number" id="modal_new_selling" 
                                                   class="form-control" step="0.01">
                                        </div>
                                        <div class="col-md-6">
                                            <label>MRP <span class="text-danger">*</span></label>
                                            <input type="number" id="modal_new_mrp" 
                                                   class="form-control" step="0.01">
                                        </div>
                                    </div>
                                    <div class="form-group mt-2">
                                        <label>Category</label>
                                        <select id="modal_new_category" class="form-control">
                                            <option value="">Select Category</option>
                                            {% for cat in categories %}
                                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="$('#itemActionModal').modal('hide')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyItemAction()">Apply</button>
                </div>
            </div>
        </div>
    </div>

</form>

<script>
// Purchase Bill Form - Initialization
const SCRIPT_VERSION = '2025-12-13-v4';  // Cache busting version
console.log('üîß Purchase Bill form loaded - Version:', SCRIPT_VERSION);

// Load items and vendors into JavaScript
const items = {{ items|tojson|safe }} || [];
const vendors = {{ vendors|tojson|safe }} || [];

// Tenant's state for GST calculation
const tenantState = "{{ tenant_settings.get('state', 'Maharashtra') }}".toLowerCase();

console.log('=== PURCHASE BILLS AUTOCOMPLETE DEBUG ===');
console.log('‚úÖ Loaded items:', items.length, items);
console.log('‚úÖ Loaded vendors:', vendors.length, vendors);

// Verify data structure
if (items.length > 0) {
    console.log('üì¶ Sample item:', items[0]);
}
if (vendors.length > 0) {
    console.log('üè≠ Sample vendor:', vendors[0]);
}

// Vendor Autocomplete (Client-side filtering like items)
function searchVendors(query) {
    const dropdown = document.getElementById('vendor_dropdown');
    query = query.toLowerCase().trim();
    
    console.log('üîç Searching vendors for:', query);
    
    if (!query) {
        dropdown.style.display = 'none';
        return;
    }
    
    // Filter vendors client-side
    const filteredVendors = vendors.filter(v => 
        v.name.toLowerCase().includes(query) ||
        (v.company_name && v.company_name.toLowerCase().includes(query)) ||
        (v.phone && v.phone.includes(query)) ||
        (v.gstin && v.gstin.toLowerCase().includes(query))
    );
    
    console.log('‚úÖ Found vendors:', filteredVendors.length);
    
    if (filteredVendors.length === 0) {
        dropdown.innerHTML = '<div style="padding: 12px; color: #666; text-align: center;">No vendors found. Continue typing to add manually.</div>';
        dropdown.style.display = 'block';
        return;
    }
    
    // Build dropdown HTML with safe escaping
    const escapeHtml = (str) => (str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    
    dropdown.innerHTML = filteredVendors.slice(0, 10).map(v => `
        <div class="autocomplete-item" 
             data-vendor-id="${v.id}"
             data-vendor-name="${escapeHtml(v.name)}"
             data-vendor-phone="${escapeHtml(v.phone)}"
             data-vendor-email="${escapeHtml(v.email)}"
             data-vendor-gstin="${escapeHtml(v.gstin)}"
             data-vendor-state="${escapeHtml(v.state)}"
             data-vendor-address="${escapeHtml(v.address)}"
             style="cursor: pointer; padding: 10px 12px; border-bottom: 1px solid #e9ecef;">
            <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(v.name)}</div>
            <div style="font-size: 12px; color: #666;">
                ${v.company_name ? escapeHtml(v.company_name) + ' ‚Ä¢ ' : ''}
                ${v.phone ? 'üì± ' + escapeHtml(v.phone) : ''}
            </div>
        </div>
    `).join('');
    
    // Add click listeners
    dropdown.querySelectorAll('.autocomplete-item').forEach(div => {
        div.addEventListener('click', function() {
            selectVendor(
                this.dataset.vendorId,
                this.dataset.vendorName,
                this.dataset.vendorPhone,
                this.dataset.vendorEmail,
                this.dataset.vendorGstin,
                this.dataset.vendorState,
                this.dataset.vendorAddress
            );
        });
        // Hover effect
        div.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e3f2fd';
            this.style.borderLeft = '3px solid #007bff';
        });
        div.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
            this.style.borderLeft = '';
        });
    });
    
    dropdown.style.display = 'block';
}

function selectVendor(id, name, phone, email, gstin, state, address) {
    document.getElementById('vendor_id').value = id;
    document.getElementById('vendor_name').value = name;
    document.getElementById('vendor_phone').value = phone;
    document.getElementById('vendor_email').value = email;
    document.getElementById('vendor_gstin').value = gstin;
    document.getElementById('vendor_state').value = state;
    document.getElementById('vendor_address').value = address;
    document.getElementById('vendor_search').value = name;
    document.getElementById('vendor_dropdown').style.display = 'none';
    
    console.log('‚úÖ Vendor selected:', name);
    
    // Recalculate GST type
    calculateTotal();
}

// Item Autocomplete (Matches Invoice Pattern Exactly)
function searchItems(input, rowId) {
    const query = input.value.toLowerCase().trim();
    const dropdown = document.getElementById(`dropdown_${rowId}`);
    
    if (!dropdown) {
        console.error('‚ùå Dropdown not found for row:', rowId);
        return;
    }
    
    console.log('üîç Searching for:', query, 'in row:', rowId);
    
    // Update hidden item-name field with whatever is typed
    const row = input.closest('.item-row');
    if (row) {
        const itemNameInput = row.querySelector('.item-name');
        if (itemNameInput) {
            itemNameInput.value = input.value;
        }
    }
    
    if (!query) {
        dropdown.style.display = 'none';
        return;
    }
    
    // Filter items client-side (search by name, code, or HSN)
    const filteredItems = items.filter(item => 
        item.name.toLowerCase().includes(query) ||
        (item.item_code && item.item_code.toLowerCase().includes(query)) ||
        (item.hsn_code && item.hsn_code.toLowerCase().includes(query))
    );
    
    console.log('‚úÖ Filtered items:', filteredItems.length);
    
    if (filteredItems.length === 0) {
        dropdown.innerHTML = `
            <div class="autocomplete-item" style="background: #fff3cd; color: #856404; cursor: default; border-left: 3px solid #ffc107;">
                <div style="font-weight: 600;">üìù No matching items found</div>
                <div style="font-size: 12px;">Continue typing to add "${input.value}" as a new item</div>
            </div>
        `;
        dropdown.style.display = 'block';
        return;
    }
    
    // Build dropdown HTML
    dropdown.innerHTML = '';
    filteredItems.slice(0, 10).forEach(item => {
        // Extract GST rate
        let gst_rate = 18; // default
        if (item.tax_preference && item.tax_preference.includes('GST@')) {
            try {
                gst_rate = parseFloat(item.tax_preference.split('@')[1].replace('%', ''));
            } catch(e) {}
        }
        
        // Escape HTML to prevent issues with special characters
        const escapeName = (str) => (str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
        
        const div = document.createElement('div');
        div.className = 'autocomplete-item';
        div.style.cursor = 'pointer';
        div.innerHTML = `
            <div style="font-weight: 600;">${escapeName(item.name)}</div>
            <div style="font-size: 12px; color: #666;">üìã HSN: ${escapeName(item.hsn_code) || 'N/A'} ‚Ä¢ üí∞ ‚Çπ${item.purchase_price || 0} ‚Ä¢ üì¶ ${item.unit || 'pcs'}</div>
        `;
        
        // Use event listener instead of inline onclick
        div.addEventListener('click', function() {
            console.log('üñ±Ô∏è Item clicked:', item.name);
            selectItem(
                div,
                item.id,
                item.name,
                item.hsn_code || '',
                item.unit || 'pcs',
                parseFloat(item.purchase_price || 0),
                gst_rate
            );
        });
        
        dropdown.appendChild(div);
    });
    
    dropdown.style.display = 'block';
    console.log('‚úÖ Dropdown shown with', filteredItems.length, 'items');
}

// Hide dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.item-search') && !e.target.closest('.autocomplete-dropdown')) {
        // Hide all dropdowns
        for (let i = 1; i <= rowCounter; i++) {
            const dropdown = document.getElementById(`dropdown_${i}`);
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }
    }
});

// Global variable to track which row we're working with
let currentItemRow = null;

function selectItem(elem, id, name, hsn, unit, cost, gst_rate) {
    const row = elem.closest('.item-row');
    currentItemRow = row;
    
    // Find the full item data from the items array
    const item = items.find(i => i.id === id);
    if (!item) {
        console.error('‚ùå Item not found in items array:', id);
        return;
    }
    
    // Store existing item data
    row.querySelector('.existing-cost').dataset.value = item.purchase_price || cost;
    row.querySelector('.existing-selling').dataset.value = item.selling_price || 0;
    row.querySelector('.existing-mrp').dataset.value = item.mrp || 0;
    row.querySelector('.existing-stock').dataset.value = item.stock_quantity || 0;
    row.querySelector('.existing-sku').dataset.value = item.item_code || '';
    row.querySelector('.existing-barcode').dataset.value = item.barcode || '';
    
    // Get the rate (cost) entered by user
    const enteredRate = parseFloat(row.querySelector('.rate-input').value) || cost;
    
    // Hide dropdown
    const dropdown = row.querySelector('.autocomplete-dropdown');
    if (dropdown) {
        dropdown.style.display = 'none';
    }
    
    // Open modal to choose action
    showItemActionModal(id, name, hsn, unit, cost, item.selling_price || 0, item.mrp || 0, 
                        item.stock_quantity || 0, item.item_code || '', item.barcode || '', 
                        enteredRate, gst_rate);
    
    console.log('‚úÖ Item selected - showing modal:', name);
}

// Show the item action choice modal
function showItemActionModal(itemId, itemName, hsn, unit, cost, selling, mrp, stock, sku, barcode, newRate, gst_rate) {
    // Populate modal with item details
    document.getElementById('modal_item_name').textContent = itemName;
    document.getElementById('modal_existing_sku').textContent = sku || 'N/A';
    document.getElementById('modal_existing_barcode').textContent = barcode || 'N/A';
    document.getElementById('modal_existing_cost').textContent = parseFloat(cost).toFixed(2);
    document.getElementById('modal_existing_selling').textContent = parseFloat(selling).toFixed(2);
    document.getElementById('modal_existing_mrp').textContent = parseFloat(mrp).toFixed(2);
    document.getElementById('modal_existing_stock').textContent = stock;
    
    // Pre-fill new selling/MRP inputs
    document.getElementById('modal_new_selling_input').value = selling;
    document.getElementById('modal_new_mrp_input').value = mrp;
    
    // For create new mode
    const today = new Date().toLocaleDateString('en-IN', { month: 'short', year: 'numeric' });
    document.getElementById('modal_new_item_name').value = itemName + ' (' + today + ')';
    document.getElementById('modal_new_cost').value = newRate;
    document.getElementById('modal_new_selling').value = (newRate * 1.25).toFixed(2); // 25% markup suggestion
    document.getElementById('modal_new_mrp').value = (newRate * 1.40).toFixed(2); // 40% markup suggestion
    
    // Auto-generate SKU for new item
    const lastSku = sku || 'ITM-00000';
    const skuNum = parseInt(lastSku.split('-').pop()) + 1;
    document.getElementById('modal_new_sku').value = `ITM-${String(skuNum).padStart(5, '0')}`;
    
    // Reset warnings
    document.getElementById('modal_mrp_warning').style.display = 'none';
    document.getElementById('modal_update_mrp_warning').style.display = 'none';
    
    // Set default action
    document.getElementById('modal_action_link').checked = true;
    document.getElementById('link_options').style.display = 'block';
    document.getElementById('create_new_options').style.display = 'none';
    
    // Store item data for applyItemAction
    currentItemRow.dataset.itemId = itemId;
    currentItemRow.dataset.itemHsn = hsn;
    currentItemRow.dataset.itemUnit = unit;
    currentItemRow.dataset.itemCost = cost;
    currentItemRow.dataset.itemGstRate = gst_rate;
    
    // Show modal (Bootstrap 3/4 compatible)
    $('#itemActionModal').modal('show');
}

// Apply the selected action
function applyItemAction() {
    if (!currentItemRow) return;
    
    const action = document.querySelector('input[name="modal_item_action"]:checked').value;
    const itemId = currentItemRow.dataset.itemId;
    const itemName = document.getElementById('modal_item_name').textContent;
    const hsn = currentItemRow.dataset.itemHsn;
    const unit = currentItemRow.dataset.itemUnit;
    const cost = currentItemRow.dataset.itemCost;
    const gst_rate = currentItemRow.dataset.itemGstRate;
    
    // Set hidden fields based on action
    if (action === 'link') {
        // Link to existing item
        currentItemRow.querySelector('.item-action').value = 'link';
        currentItemRow.querySelector('.is-new-item').value = '0';
        currentItemRow.querySelector('.item-id').value = itemId;
        currentItemRow.querySelector('.item-name').value = itemName;
        
        // Check if updating prices
        const updateSelling = document.getElementById('modal_update_selling').checked;
        const updateMrp = document.getElementById('modal_update_mrp').checked;
        
        currentItemRow.querySelector('.update-selling').value = updateSelling ? '1' : '0';
        currentItemRow.querySelector('.update-mrp').value = updateMrp ? '1' : '0';
        
        if (updateSelling) {
            const newSelling = document.getElementById('modal_new_selling_input').value;
            currentItemRow.querySelector('.updated-selling-value').value = newSelling;
        }
        
        if (updateMrp) {
            const newMrp = document.getElementById('modal_new_mrp_input').value;
            currentItemRow.querySelector('.updated-mrp-value').value = newMrp;
        }
        
        // Show visual indicator
        currentItemRow.querySelector('.item-search').value = 'üîó ' + itemName + ' (linked)';
        currentItemRow.querySelector('.item-search').style.backgroundColor = '#e8f5e9';
        
        // CRITICAL: Remove 'required' attribute to allow form submission
        const searchInput = currentItemRow.querySelector('.item-search');
        searchInput.removeAttribute('required');
        searchInput.required = false;  // Also set the property directly
        
        console.log('‚úÖ Linked item - removed required attribute:', searchInput.required);
        
    } else if (action === 'create_new') {
        // Create new item
        currentItemRow.querySelector('.item-action').value = 'create_new';
        currentItemRow.querySelector('.is-new-item').value = '1';
        currentItemRow.querySelector('.item-id').value = ''; // No existing ID
        
        const newName = document.getElementById('modal_new_item_name').value;
        const newSku = document.getElementById('modal_new_sku').value;
        const newSelling = document.getElementById('modal_new_selling').value;
        const newMrp = document.getElementById('modal_new_mrp').value;
        const newCategory = document.getElementById('modal_new_category').value;
        
        // Validate required fields
        if (!newName || !newSku || !newSelling || !newMrp) {
            alert('‚ö†Ô∏è Please fill in all required fields (Name, SKU, Selling Price, MRP)');
            return;
        }
        
        currentItemRow.querySelector('.item-name').value = newName;
        currentItemRow.querySelector('.new-item-sku').value = newSku;
        currentItemRow.querySelector('.new-item-selling').value = newSelling;
        currentItemRow.querySelector('.new-item-mrp').value = newMrp;
        currentItemRow.querySelector('.new-item-category').value = newCategory;
        
        // Show visual indicator
        currentItemRow.querySelector('.item-search').value = 'üÜï ' + newName;
        currentItemRow.querySelector('.item-search').style.backgroundColor = '#fff3cd';
        
        // CRITICAL: Remove 'required' attribute to allow form submission
        const searchInput = currentItemRow.querySelector('.item-search');
        searchInput.removeAttribute('required');
        searchInput.required = false;  // Also set the property directly
        
        console.log('‚úÖ New item - removed required attribute:', searchInput.required);
    }
    
    // Fill in other row details
    currentItemRow.querySelector('.hsn-input').value = hsn;
    currentItemRow.querySelector('.unit-input').value = unit;
    currentItemRow.querySelector('.rate-input').value = cost;
    currentItemRow.querySelector('.gst-input').value = gst_rate;
    
    // Recalculate row
    calculateRow(currentItemRow.querySelector('.qty-input'));
    
    // Close modal
    $('#itemActionModal').modal('hide');
    currentItemRow = null;
    
    console.log('‚úÖ Item action applied:', action);
}

// Row calculation
function calculateRow(input) {
    const row = input.closest('.item-row');
    const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
    const rate = parseFloat(row.querySelector('.rate-input').value) || 0;
    const gst_rate = parseFloat(row.querySelector('.gst-input').value) || 0;
    
    const taxable = qty * rate;
    const vendor_state = document.getElementById('vendor_state').value.toLowerCase().trim();
    const use_igst = (vendor_state && vendor_state !== tenantState);
    
    let gst_amount;
    if (use_igst) {
        gst_amount = taxable * gst_rate / 100;
    } else {
        gst_amount = taxable * gst_rate / 100;
    }
    
    const total = taxable + gst_amount;
    row.querySelector('.amount-display').value = '‚Çπ' + total.toFixed(2);
    
    calculateTotal();
}

// Total calculation
function calculateTotal() {
    let subtotal = 0;
    let total_cgst = 0;
    let total_sgst = 0;
    let total_igst = 0;
    
    const vendor_state = document.getElementById('vendor_state').value.toLowerCase().trim();
    const use_igst = (vendor_state && vendor_state !== tenantState);
    
    document.querySelectorAll('.item-row').forEach(row => {
        const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
        const rate = parseFloat(row.querySelector('.rate-input').value) || 0;
        const gst_rate = parseFloat(row.querySelector('.gst-input').value) || 0;
        
        if (qty > 0 && rate > 0) {
            const taxable = qty * rate;
            subtotal += taxable;
            
            if (use_igst) {
                total_igst += taxable * gst_rate / 100;
            } else {
                const gst_half = taxable * gst_rate / 200;
                total_cgst += gst_half;
                total_sgst += gst_half;
            }
        }
    });
    
    const other_charges = parseFloat(document.querySelector('input[name="other_charges"]').value) || 0;
    const grand_total = subtotal + total_cgst + total_sgst + total_igst + other_charges;
    
    document.getElementById('subtotal_display').textContent = '‚Çπ' + subtotal.toFixed(2);
    document.getElementById('cgst_display').textContent = '‚Çπ' + total_cgst.toFixed(2);
    document.getElementById('sgst_display').textContent = '‚Çπ' + total_sgst.toFixed(2);
    document.getElementById('igst_display').textContent = '‚Çπ' + total_igst.toFixed(2);
    document.getElementById('total_display').textContent = '‚Çπ' + grand_total.toFixed(2);
}

// Add/Remove rows
let rowCounter = 1; // Global counter for unique row IDs

function addRow() {
    rowCounter++;
    const tbody = document.getElementById('items_body');
    const newRow = document.createElement('tr');
    newRow.className = 'item-row';
    newRow.id = `row_${rowCounter}`;
    
    newRow.innerHTML = `
        <td>
            <div style="position: relative;">
                <input type="text" class="form-control item-search" 
                       id="item_search_${rowCounter}"
                       placeholder="Search or type item name..."
                       autocomplete="off"
                       oninput="searchItems(this, ${rowCounter})"
                       onfocus="searchItems(this, ${rowCounter})">
                <input type="hidden" class="item-id" name="item_id[]" id="item_id_${rowCounter}">
                <input type="hidden" class="item-name" name="item_name[]">
                
                <!-- NEW: Item Action Fields -->
                <input type="hidden" name="item_action[]" class="item-action" value="link">
                <input type="hidden" name="is_new_item[]" class="is-new-item" value="0">
                <input type="hidden" name="new_item_sku[]" class="new-item-sku">
                <input type="hidden" name="new_item_selling[]" class="new-item-selling">
                <input type="hidden" name="new_item_mrp[]" class="new-item-mrp">
                <input type="hidden" name="new_item_category[]" class="new-item-category">
                <input type="hidden" name="update_selling_price[]" class="update-selling" value="0">
                <input type="hidden" name="update_mrp[]" class="update-mrp" value="0">
                <input type="hidden" name="updated_selling_value[]" class="updated-selling-value">
                <input type="hidden" name="updated_mrp_value[]" class="updated-mrp-value">
                <input type="hidden" class="existing-cost" data-value="">
                <input type="hidden" class="existing-selling" data-value="">
                <input type="hidden" class="existing-mrp" data-value="">
                <input type="hidden" class="existing-stock" data-value="">
                <input type="hidden" class="existing-sku" data-value="">
                <input type="hidden" class="existing-barcode" data-value="">
                
                <div class="autocomplete-dropdown" id="dropdown_${rowCounter}" style="display: none;"></div>
            </div>
        </td>
        <td>
            <input type="text" name="hsn_code[]" class="form-control hsn-input" placeholder="HSN">
        </td>
        <td>
            <input type="number" name="quantity[]" class="form-control qty-input" step="0.001" min="0" value="1" oninput="calculateRow(this)">
        </td>
        <td>
            <select name="unit[]" class="form-control unit-input">
                <option value="Nos">Nos</option>
                <option value="Pcs" selected>Pcs</option>
                <option value="Dozen">Dozen</option>
                <option value="Kg">Kg</option>
                <option value="Qtl">Qtl</option>
                <option value="Ton">Ton</option>
                <option value="G">G</option>
                <option value="Ltr">Ltr</option>
                <option value="Ml">Ml</option>
                <option value="Mtr">Mtr</option>
                <option value="Cm">Cm</option>
                <option value="Ft">Ft</option>
                <option value="Sqm">Sqm</option>
                <option value="Cum">Cum</option>
                <option value="Cft">Cft</option>
                <option value="Box">Box</option>
                <option value="Bag">Bag</option>
                <option value="Packet">Packet</option>
                <option value="Bundle">Bundle</option>
            </select>
        </td>
        <td>
            <input type="number" name="rate[]" class="form-control rate-input" step="0.01" min="0" placeholder="0.00" oninput="calculateRow(this)">
        </td>
        <td>
            <input type="number" name="gst_rate[]" class="form-control gst-input" step="0.01" min="0" value="18" oninput="calculateRow(this)">
        </td>
        <td class="text-end">
            <input type="text" class="form-control amount-display" readonly value="‚Çπ0.00">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">√ó</button>
        </td>
    `;
    
    tbody.appendChild(newRow);
}

function removeRow(btn) {
    const tbody = document.getElementById('items_body');
    if (tbody.querySelectorAll('.item-row').length > 1) {
        btn.closest('.item-row').remove();
        calculateTotal();
    }
}

// Bill Document Upload Preview
function previewBillDocument(input) {
    const preview = document.getElementById('document_preview');
    const fileName = document.getElementById('file_name');
    const fileSize = document.getElementById('file_size');
    const imagePreview = document.getElementById('image_preview');
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Check file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB');
            input.value = '';
            return;
        }
        
        // Show file info
        fileName.textContent = file.name;
        fileSize.textContent = `Size: ${(file.size / 1024).toFixed(2)} KB`;
        preview.style.display = 'block';
        
        // Show image preview if it's an image
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            imagePreview.style.display = 'none';
        }
        
        console.log('‚úÖ Document selected:', file.name, `(${(file.size / 1024).toFixed(2)} KB)`);
    }
}

function clearDocument() {
    const input = document.getElementById('bill_document');
    const preview = document.getElementById('document_preview');
    const imagePreview = document.getElementById('image_preview');
    
    input.value = '';
    preview.style.display = 'none';
    imagePreview.style.display = 'none';
    imagePreview.src = '';
    
    console.log('üóëÔ∏è Document removed');
}

// Form validation before submit - ensures all item_name fields are filled
function validatePurchaseBillForm() {
    console.log('üîç Validating purchase bill form...');
    
    // Get all item rows
    const allRows = document.querySelectorAll('.item-row');
    
    if (allRows.length === 0) {
        alert('‚ö†Ô∏è Error: No item rows found. Please refresh the page.');
        return false;
    }
    
    let hasItems = false;
    let itemCount = 0;
    const allItemNames = [];
    
    // Check each item row
    allRows.forEach((row, index) => {
        const itemSearch = row.querySelector('.item-search');
        const itemNameHidden = row.querySelector('.item-name');
        const itemIdHidden = row.querySelector('.item-id');
        const qtyInput = row.querySelector('.qty-input');
        const rateInput = row.querySelector('.rate-input');
        const hsnInput = row.querySelector('.hsn-input');
        
        const itemSearchValue = itemSearch ? itemSearch.value.trim() : '';
        const itemNameValue = itemNameHidden ? itemNameHidden.value.trim() : '';
        const qty = qtyInput ? parseFloat(qtyInput.value) || 0 : 0;
        const rate = rateInput ? parseFloat(rateInput.value) || 0 : 0;
        
        console.log(`Row ${index}:`, {
            searchValue: itemSearchValue,
            hiddenName: itemNameValue,
            qty: qty,
            rate: rate,
            required: itemSearch ? itemSearch.required : 'N/A'
        });
        
        // If row has search text OR quantity OR rate, it should be saved
        if (itemSearchValue || qty > 0 || rate > 0) {
            // Ensure hidden field is populated
            if (!itemNameValue && itemSearchValue) {
                itemNameHidden.value = itemSearchValue;
            }
            
            // Only count if has name AND qty AND rate
            if (itemNameHidden.value.trim() && qty > 0 && rate > 0) {
                itemCount++;
                hasItems = true;
                allItemNames.push(itemNameHidden.value);
            }
        }
    });
    
    console.log('‚úÖ Validation result:', { hasItems, itemCount, itemNames: allItemNames });
    
    if (!hasItems) {
        alert('‚ö†Ô∏è Please add at least one item with name, quantity and rate!');
        return false;
    }
    
    console.log('‚úÖ Validation passed! Form will submit.');
    return true;
}

// Close dropdowns on outside click
// Click handler already added above - no duplicate needed

// ========================================
// VENDOR MODAL FUNCTIONS
// ========================================

function openAddVendorModal() {
    document.getElementById('addVendorModal').style.display = 'flex';
    document.getElementById('newVendorName').focus();
}

function closeAddVendorModal() {
    document.getElementById('addVendorModal').style.display = 'none';
    document.getElementById('addVendorForm').reset();
}

function submitVendor(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Disable button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Adding...';
    
    fetch('{{ url_for("vendors.add") }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success! Auto-fill the vendor details in the purchase bill form
            const vendor = data.vendor;
            
            // Fill the purchase bill form
            document.getElementById('vendor_name').value = vendor.name;
            document.getElementById('vendor_phone').value = vendor.phone || '';
            document.getElementById('vendor_email').value = vendor.email || '';
            document.getElementById('vendor_gstin').value = vendor.gstin || '';
            document.getElementById('vendor_state').value = vendor.state || 'Maharashtra';
            document.getElementById('vendor_address').value = vendor.address || '';
            
            // Set the hidden vendor_id field if available
            if (document.getElementById('vendor_id') && vendor.id) {
                document.getElementById('vendor_id').value = vendor.id;
            }
            
            // Clear the search box
            if (document.getElementById('vendor_search')) {
                document.getElementById('vendor_search').value = vendor.name;
            }
            
            // Show success message
            alert(`‚úÖ ${data.message}`);
            closeAddVendorModal();
        } else {
            alert(`‚ùå ${data.error || 'Error adding vendor. Please try again.'}`);
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'üíæ Save Vendor';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error adding vendor. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üíæ Save Vendor';
    });
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('addVendorModal');
        if (modal && modal.style.display === 'flex') {
            closeAddVendorModal();
        }
    }
});

// Close modal on outside click
document.addEventListener('click', function(event) {
    const modal = document.getElementById('addVendorModal');
    if (modal && event.target === modal) {
        closeAddVendorModal();
    }
});

// ========================================
// ITEM ACTION MODAL EVENT LISTENERS
// ========================================

// Toggle between link and create new options
document.addEventListener('DOMContentLoaded', function() {
    const linkRadio = document.getElementById('modal_action_link');
    const createRadio = document.getElementById('modal_action_create');
    
    if (linkRadio) {
        linkRadio.addEventListener('change', function() {
            document.getElementById('link_options').style.display = 'block';
            document.getElementById('create_new_options').style.display = 'none';
        });
    }
    
    if (createRadio) {
        createRadio.addEventListener('change', function() {
            document.getElementById('link_options').style.display = 'none';
            document.getElementById('create_new_options').style.display = 'block';
        });
    }
    
    // Enable/disable selling price input
    const updateSellingCheckbox = document.getElementById('modal_update_selling');
    if (updateSellingCheckbox) {
        updateSellingCheckbox.addEventListener('change', function() {
            document.getElementById('modal_new_selling_input').disabled = !this.checked;
        });
    }
    
    // Enable/disable MRP input and show warning
    const updateMrpCheckbox = document.getElementById('modal_update_mrp');
    if (updateMrpCheckbox) {
        updateMrpCheckbox.addEventListener('change', function() {
            document.getElementById('modal_new_mrp_input').disabled = !this.checked;
            const stock = parseFloat(document.getElementById('modal_existing_stock').textContent);
            if (this.checked && stock > 0) {
                document.getElementById('modal_update_mrp_warning').style.display = 'block';
            } else {
                document.getElementById('modal_update_mrp_warning').style.display = 'none';
            }
        });
    }
});
</script>

<!-- Add Vendor Modal -->
<div id="addVendorModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">‚ûï Add New Vendor</h3>
            <button onclick="closeAddVendorModal()" class="modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
        </div>
        <form id="addVendorForm" onsubmit="submitVendor(event)">
            <div class="modal-body">
                <!-- Basic Details -->
                <div class="modal-form-row">
                    <div class="form-group">
                        <label class="field-label field-label--required">Vendor Name</label>
                        <input type="text" name="name" id="newVendorName" class="form-control" required placeholder="Enter vendor name">
                    </div>
                    <div class="form-group">
                        <label class="field-label">Phone Number</label>
                        <input type="tel" name="phone" class="form-control" placeholder="9876543210">
                    </div>
                </div>
                
                <div class="modal-form-row">
                    <div class="form-group">
                        <label class="field-label">Email Address</label>
                        <input type="email" name="email" class="form-control" placeholder="vendor@example.com">
                    </div>
                    <div class="form-group">
                        <label class="field-label">GSTIN</label>
                        <input type="text" name="gstin" class="form-control" placeholder="27XXXXX1234X1Z5" maxlength="15">
                    </div>
                </div>
                
                <div class="modal-form-row">
                    <div class="form-group">
                        <label class="field-label field-label--required">State</label>
                        <select name="state" class="form-control" required>
                            <option value="">Select State</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Goa">Goa</option>
                            <option value="Gujarat">Gujarat</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra" selected>Maharashtra</option>
                            <option value="Manipur">Manipur</option>
                            <option value="Meghalaya">Meghalaya</option>
                            <option value="Mizoram">Mizoram</option>
                            <option value="Nagaland">Nagaland</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Sikkim">Sikkim</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Tripura">Tripura</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="West Bengal">West Bengal</option>
                            <option value="Delhi">Delhi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="field-label">Opening Balance (‚Çπ)</label>
                        <input type="number" name="opening_balance" class="form-control" step="0.01" value="0" placeholder="0">
                    </div>
                </div>
                
                <div class="modal-form-row modal-form-row--single">
                    <div class="form-group">
                        <label class="field-label">Address</label>
                        <textarea name="address" class="form-control" rows="2" placeholder="Shop/Building, Street, Area, City"></textarea>
                    </div>
                </div>
                
                <div class="modal-form-row">
                    <div class="form-group">
                        <label class="field-label">Credit Limit (‚Çπ)</label>
                        <input type="number" name="credit_limit" class="form-control" step="0.01" min="0" value="0" placeholder="50000">
                        <small class="help-text">0 = No limit</small>
                    </div>
                    <div class="form-group">
                        <label class="field-label">Payment Terms (Days)</label>
                        <input type="number" name="payment_terms_days" class="form-control" min="0" value="30" placeholder="30">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeAddVendorModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ Save Vendor</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
    overflow-y: auto;
}

.modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease;
    margin: 20px;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 2px solid #f0f0f0;
    position: sticky;
    top: 0;
    background: white;
    z-index: 1;
}

.modal-body {
    padding: 25px;
}

.modal-footer {
    padding: 15px 25px;
    border-top: 2px solid #f0f0f0;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    position: sticky;
    bottom: 0;
    background: white;
    z-index: 1;
}

.modal-close {
    transition: all 0.2s ease;
}

.modal-close:hover {
    transform: scale(1.2);
    color: #dc3545 !important;
}

.modal-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.modal-form-row--single {
    grid-template-columns: 1fr;
}

.modal-form-row .form-group {
    margin-bottom: 0;
}

.field-label--required::after {
    content: ' *';
    color: #dc3545;
}

.help-text {
    display: block;
    font-size: 12px;
    color: #666;
    margin-top: 4px;
}
</style>

{% endblock %}

