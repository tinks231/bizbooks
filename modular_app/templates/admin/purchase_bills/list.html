{% extends "base_sidebar.html" %}

{% block title %}Purchase Bills - {{ tenant.company_name }}{% endblock %}

{% block header_actions %}
<!-- Remove default Manual Entry & QR Code buttons - not relevant for Purchase Bills -->
{% endblock %}

{% block content %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 25px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    .stat-item {
        background: rgba(255, 255, 255, 0.15);
        padding: 15px;
        border-radius: 8px;
    }
    .stat-value {
        font-size: 24px;
        font-weight: 700;
        margin-top: 5px;
    }
    .filter-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }
    .bill-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .bill-table table {
        width: 100%;
        border-collapse: collapse;
    }
    .bill-table th {
        background: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    .bill-table td {
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
    }
    .bill-table tr:hover {
        background: #f8f9ff;
    }
    .badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    .badge-draft { background: #ffc107; color: #000; }
    .badge-approved { background: #28a745; color: white; }
    .badge-paid { background: #007bff; color: white; }
    .badge-cancelled { background: #dc3545; color: white; }
    .badge-unpaid { background: #dc3545; color: white; }
    .badge-partial { background: #ffc107; color: #000; }
    
    /* ========================================
       MOBILE RESPONSIVE FIXES
       ======================================== */
    @media (max-width: 768px) {
        /* Container - Remove side padding on mobile for edge-to-edge cards */
        .container-fluid {
            padding: 15px 0 !important;
        }
        
        /* Header Section - Add padding only for header */
        .container-fluid > div:first-child {
            flex-direction: column !important;
            gap: 15px;
            align-items: flex-start !important;
            padding: 0 15px !important;
            margin-bottom: 20px !important;
        }
        
        .container-fluid > div:first-child h2 {
            font-size: 24px !important;
        }
        
        .container-fluid > div:first-child p {
            font-size: 14px !important;
        }
        
        /* Create New Bill Button - Full Width on Mobile */
        .container-fluid > div:first-child a.btn {
            width: 100%;
            text-align: center;
            padding: 12px 20px !important;
            font-size: 16px;
            font-weight: 600;
        }
        
        /* Stats Card - Edge to Edge */
        .stats-card {
            border-radius: 0 !important;
            margin-bottom: 0 !important;
            padding: 20px 15px !important;
        }
        
        /* Stats Grid - 2 cards per row on mobile */
        .stats-grid {
            grid-template-columns: 1fr 1fr !important;
            gap: 12px !important;
        }
        
        .stat-item {
            padding: 12px !important;
        }
        
        .stat-value {
            font-size: 20px !important;
        }
        
        /* Filter Bar - Edge to Edge */
        .filter-bar {
            border-radius: 0 !important;
            margin-bottom: 0 !important;
            padding: 20px 15px !important;
        }
        
        /* Filter Bar - Stack vertically on mobile */
        .filter-bar form {
            display: flex !important;
            flex-direction: column !important;
            gap: 15px !important;
        }
        
        .filter-bar form > div {
            grid-column: span 1 !important;
        }
        
        /* Fix label alignment - Left align all labels */
        .filter-bar label {
            text-align: left !important;
            display: block !important;
            margin-bottom: 8px !important;
            font-weight: 600 !important;
            font-size: 14px !important;
        }
        
        /* Make all inputs and selects full width */
        .filter-bar select,
        .filter-bar input {
            width: 100% !important;
        }
        
        .filter-bar form button {
            width: 100% !important;
            padding: 12px !important;
        }
        
        /* View Toggle Button - Add padding */
        .container-fluid > div:nth-of-type(4) {
            padding: 0 15px !important;
        }
        
        /* Bill Table - Edge to Edge */
        .bill-table {
            border-radius: 0 !important;
            margin: 0 !important;
        }
    }
</style>

<div class="container-fluid" style="padding: 30px;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div>
            <h2 style="margin: 0; color: #333;">üíº Purchase Bills</h2>
            <p style="color: #666; margin: 5px 0 0 0;">Manage vendor bills and track payments</p>
        </div>
        <a href="{{ url_for('purchase_bills.create_bill') }}" class="btn btn-primary" style="padding: 12px 24px;">
            <i class="fas fa-plus"></i> Create New Bill
        </a>
    </div>

    <!-- Stats Cards -->
    <div class="stats-card">
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">üìä Summary</div>
        <div class="stats-grid">
            <div class="stat-item">
                <div style="opacity: 0.9;">Total Bills</div>
                <div class="stat-value">{{ total_bills }}</div>
            </div>
            <div class="stat-item">
                <div style="opacity: 0.9;">Total Amount</div>
                <div class="stat-value">‚Çπ{{ "{:,.2f}".format(total_amount) }}</div>
            </div>
            <div class="stat-item">
                <div style="opacity: 0.9;">Total Paid</div>
                <div class="stat-value">‚Çπ{{ "{:,.2f}".format(total_paid) }}</div>
            </div>
            <div class="stat-item">
                <div style="opacity: 0.9;">Total Due</div>
                <div class="stat-value">‚Çπ{{ "{:,.2f}".format(total_due) }}</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
        <form method="GET" style="display: grid; grid-template-columns: 2fr 2fr 2fr 3fr 1fr; gap: 15px; align-items: end;">
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Status</label>
                <select name="status" class="form-control">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Status</option>
                    <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>Draft</option>
                    <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="paid" {% if status_filter == 'paid' %}selected{% endif %}>Paid</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Payment Status</label>
                <select name="payment" class="form-control">
                    <option value="all" {% if payment_filter == 'all' %}selected{% endif %}>All Payments</option>
                    <option value="unpaid" {% if payment_filter == 'unpaid' %}selected{% endif %}>Unpaid</option>
                    <option value="partial" {% if payment_filter == 'partial' %}selected{% endif %}>Partial</option>
                    <option value="paid" {% if payment_filter == 'paid' %}selected{% endif %}>Paid</option>
                </select>
            </div>
            <div style="grid-column: span 2;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Search</label>
                <input type="text" name="search" class="form-control" placeholder="Search by bill #, vendor, reference..." value="{{ search_query }}">
            </div>
            <div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 10px;">
                    <i class="fas fa-search"></i> Filter
                </button>
            </div>
        </form>
    </div>

    <!-- View Toggle (Mobile Only) -->
    <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
        <button id="viewToggle" class="btn btn-primary" onclick="toggleView()" style="display: none;">
            <span id="toggleIcon">üìä</span> <span id="toggleText">Table View</span>
        </button>
    </div>

    <!-- Bills Table -->
    <div class="bill-table">
        {% if bills %}
        
        <!-- Table View (Desktop default) -->
        <div id="tableView" class="desktop-table">
        <table>
            <thead>
                <tr>
                    <th>Bill #</th>
                    <th>Date</th>
                    <th>Vendor</th>
                    <th>Reference</th>
                    <th>Amount</th>
                    <th>Paid</th>
                    <th>Balance</th>
                    <th>Status</th>
                    <th>Payment</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for bill in bills %}
                <tr>
                    <td style="font-weight: 600; color: #667eea;">
                        <a href="{{ url_for('purchase_bills.view_bill', bill_id=bill.id) }}" style="text-decoration: none; color: inherit;">
                            {{ bill.bill_number }}
                        </a>
                    </td>
                    <td>{{ bill.bill_date.strftime('%d %b %Y') }}</td>
                    <td>
                        <div style="font-weight: 600;">{{ bill.vendor_name }}</div>
                        {% if bill.vendor_phone %}
                        <div style="font-size: 12px; color: #666;">{{ bill.vendor_phone }}</div>
                        {% endif %}
                    </td>
                    <td>{{ bill.reference_number or '-' }}</td>
                    <td style="font-weight: 600;">‚Çπ{{ "{:,.2f}".format(bill.total_amount) }}</td>
                    <td style="color: #28a745;">‚Çπ{{ "{:,.2f}".format(bill.paid_amount) }}</td>
                    <td style="color: #dc3545; font-weight: 600;">‚Çπ{{ "{:,.2f}".format(bill.balance_due) }}</td>
                    <td>
                        <span class="badge badge-{{ bill.status }}">{{ bill.status|upper }}</span>
                    </td>
                    <td>
                        <span class="badge badge-{{ bill.payment_status }}">{{ bill.payment_status|upper }}</span>
                    </td>
                    <td>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <a href="{{ url_for('purchase_bills.view_bill', bill_id=bill.id) }}" 
                               class="btn btn-info" 
                               style="padding: 8px 12px; font-size: 18px; line-height: 1;"
                               title="View Bill">
                                üëÅÔ∏è
                            </a>
                            {% if bill.status == 'draft' %}
                            <a href="{{ url_for('purchase_bills.edit_bill', bill_id=bill.id) }}" 
                               class="btn btn-warning" 
                               style="padding: 8px 12px; font-size: 18px; line-height: 1;"
                               title="Edit Bill">
                                ‚úèÔ∏è
                            </a>
                            <form method="POST" action="{{ url_for('purchase_bills.delete_bill', bill_id=bill.id) }}" style="display: inline;">
                                <button type="submit" 
                                        class="btn btn-danger" 
                                        style="padding: 8px 12px; font-size: 18px; line-height: 1;"
                                        title="Delete Bill"
                                        onclick="return confirm('‚ö†Ô∏è Are you sure you want to delete this bill?\n\nThis action cannot be undone.')">
                                    üóëÔ∏è
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        <!-- End Table View -->
        
        <!-- Mobile Card View (Default on mobile) -->
        <div id="cardView" class="mobile-cards" style="display: none;">
            {% for bill in bills %}
            <div class="bill-card" style="background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <!-- Card Header -->
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div>
                        <a href="{{ url_for('purchase_bills.view_bill', bill_id=bill.id) }}"
                           style="font-weight: 700; font-size: 16px; color: #667eea; text-decoration: none;">
                            {{ bill.bill_number }}
                        </a>
                        <div style="color: #7f8c8d; font-size: 13px; margin-top: 4px;">
                            üìÖ {{ bill.bill_date.strftime('%d %b %Y') }}
                        </div>
                        {% if bill.reference_number %}
                        <div style="color: #95a5a6; font-size: 12px; margin-top: 2px;">
                            Ref: {{ bill.reference_number }}
                        </div>
                        {% endif %}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                        <span class="badge badge-{{ bill.status }}" style="font-size: 10px;">{{ bill.status|upper }}</span>
                        <span class="badge badge-{{ bill.payment_status }}" style="font-size: 10px;">{{ bill.payment_status|upper }}</span>
                    </div>
                </div>
                
                <!-- Vendor Info -->
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">Vendor</div>
                    <div style="font-size: 15px; font-weight: 600; color: #2c3e50;">{{ bill.vendor_name }}</div>
                    {% if bill.vendor_phone %}
                    <div style="font-size: 13px; color: #7f8c8d; margin-top: 2px;">üìû {{ bill.vendor_phone }}</div>
                    {% endif %}
                </div>
                
                <!-- Amount Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 6px;">
                        <div style="font-size: 10px; color: #1976d2; margin-bottom: 4px;">Total</div>
                        <div style="font-size: 14px; font-weight: 700; color: #0d47a1;">‚Çπ{{ "{:,.0f}".format(bill.total_amount) }}</div>
                    </div>
                    <div style="background: #c8e6c9; padding: 10px; border-radius: 6px;">
                        <div style="font-size: 10px; color: #2e7d32; margin-bottom: 4px;">Paid</div>
                        <div style="font-size: 14px; font-weight: 700; color: #1b5e20;">‚Çπ{{ "{:,.0f}".format(bill.paid_amount) }}</div>
                    </div>
                    <div style="background: #ffcdd2; padding: 10px; border-radius: 6px;">
                        <div style="font-size: 10px; color: #c62828; margin-bottom: 4px;">Balance</div>
                        <div style="font-size: 14px; font-weight: 700; color: #b71c1c;">‚Çπ{{ "{:,.0f}".format(bill.balance_due) }}</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 8px;">
                    <a href="{{ url_for('purchase_bills.view_bill', bill_id=bill.id) }}"
                       style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
                              padding: 10px; border-radius: 6px; text-align: center; text-decoration: none; font-weight: 600; font-size: 13px;">
                        üëÅÔ∏è View
                    </a>
                    {% if bill.status == 'draft' %}
                    <a href="{{ url_for('purchase_bills.edit_bill', bill_id=bill.id) }}"
                       style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; 
                              padding: 10px; border-radius: 6px; text-align: center; text-decoration: none; font-weight: 600; font-size: 13px;">
                        ‚úèÔ∏è Edit
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- End Card View -->
        
        {% else %}
        <div style="text-align: center; padding: 60px 20px; color: #999;">
            <i class="fas fa-file-invoice" style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3 style="color: #666;">No purchase bills found</h3>
            <p>{% if search_query or status_filter != 'all' or payment_filter != 'all' %}
                Try adjusting your filters
            {% else %}
                Create your first purchase bill to get started
            {% endif %}</p>
            {% if not search_query and status_filter == 'all' and payment_filter == 'all' %}
            <a href="{{ url_for('purchase_bills.create_bill') }}" class="btn btn-primary" style="margin-top: 20px;">
                <i class="fas fa-plus"></i> Create First Bill
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<style>
/* ========================================
   MOBILE VIEW TOGGLE
   ======================================== */
/* Desktop: Always show table, hide toggle */
@media (min-width: 769px) {
    #tableView {
        display: block !important;
    }
    #cardView {
        display: none !important;
    }
    #viewToggle {
        display: none !important;
    }
}

/* Mobile: Show toggle button and respect user preference */
@media (max-width: 768px) {
    /* Show toggle button */
    #viewToggle {
        display: inline-block !important;
    }
    
    /* Default: Card view (when body doesn't have show-table class) */
    body:not(.show-table) #tableView {
        display: none !important;
    }
    body:not(.show-table) #cardView {
        display: block !important;
    }
    
    /* Table view (when body has show-table class) */
    body.show-table #tableView {
        display: block !important;
    }
    body.show-table #cardView {
        display: none !important;
    }
}
</style>

<script>
// View toggle function
function toggleView() {
    const body = document.body;
    const toggleIcon = document.getElementById('toggleIcon');
    const toggleText = document.getElementById('toggleText');
    
    if (body.classList.contains('show-table')) {
        // Switch to Card View
        body.classList.remove('show-table');
        toggleIcon.textContent = 'üìä';
        toggleText.textContent = 'Table View';
        localStorage.setItem('purchaseBillViewPreference', 'cards');
    } else {
        // Switch to Table View
        body.classList.add('show-table');
        toggleIcon.textContent = 'üì±';
        toggleText.textContent = 'Card View';
        localStorage.setItem('purchaseBillViewPreference', 'table');
    }
}

// Load user preference on page load
document.addEventListener('DOMContentLoaded', function() {
    const preference = localStorage.getItem('purchaseBillViewPreference');
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile && preference === 'table') {
        document.body.classList.add('show-table');
        document.getElementById('toggleIcon').textContent = 'üì±';
        document.getElementById('toggleText').textContent = 'Card View';
    }
});
</script>

{% endblock %}

