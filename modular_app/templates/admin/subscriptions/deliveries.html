{% extends "base_sidebar.html" %}

{% block title %}Daily Deliveries{% endblock %}

{% block header_actions %}
<!-- No Manual Entry or QR buttons for subscription pages -->
{% endblock %}

{% block content %}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="subscription-header">
        <h1>üì¶ Daily Deliveries</h1>
        <p>Manage metered subscription deliveries (milk, newspapers, etc.)</p>
    </div>

    <!-- Billing Ready Section (Month-End) -->
    {% set today = now().date() %}
    {% set ready_for_billing = [] %}
    {% for sub in active_subscriptions %}
        {% if sub.plan.plan_type == 'metered' and sub.current_period_end <= today + timedelta(days=3) %}
            {% set _ = ready_for_billing.append(sub) %}
        {% endif %}
    {% endfor %}
    
    {% if ready_for_billing %}
    <div class="alert alert-success" style="margin-bottom: 20px;">
        <h4 style="margin: 0 0 10px 0;">üí∞ Ready for Monthly Billing</h4>
        <p style="margin: 0 0 10px 0;">These subscriptions are ending soon. Generate invoices to bill customers:</p>
        {% for sub in ready_for_billing %}
        <div style="padding: 10px; background: white; border-radius: 6px; margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>{{ sub.customer.name }}</strong> - {{ sub.plan.name }}<br>
                <small style="color: #666;">Period: {{ sub.current_period_start.strftime('%b %d') }} - {{ sub.current_period_end.strftime('%b %d, %Y') }} ({{ (sub.current_period_end - sub.current_period_start).days + 1 }} days)</small>
            </div>
            <a href="{{ url_for('subscriptions.generate_invoice_metered', subscription_id=sub.id) }}" class="btn btn-success">
                üí∞ Generate Invoice
            </a>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- View Toggle -->
    <div class="subscription-section-header">
        <div>
            <h2 id="view_title">üö® Exceptions & Changes</h2>
            <p class="text-muted" style="margin: 0; font-size: 14px;">Shows only paused, modified, or upcoming changes (99% automated!)</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-outline-secondary" onclick="toggleView()" id="toggle_btn">
                üìã View Full Log
            </button>
            <button class="btn btn-success" onclick="openModifyModal()">
                ‚úèÔ∏è Modify Delivery
            </button>
            <button class="btn btn-warning" onclick="openPauseModal()">
                ‚è∏Ô∏è Pause Deliveries
            </button>
        </div>
    </div>

    <!-- Exceptions View (DEFAULT) -->
    <div id="exceptions_view">
        {% if exceptions %}
        <div class="card">
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Plan</th>
                            <th>Quantity</th>
                            <th>Status</th>
                            <th>Reason</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for delivery in exceptions %}
                        <tr>
                            <td><strong>{{ delivery.delivery_date.strftime('%b %d, %Y') }}</strong></td>
                            <td>{{ delivery.subscription.customer.name }}</td>
                            <td>{{ delivery.subscription.plan.name }}</td>
                            <td>
                                {% if delivery.quantity == 0 %}
                                <span class="badge badge-secondary">-</span>
                                {% else %}
                                <strong>{{ delivery.quantity }} {{ delivery.subscription.plan.unit_name }}</strong>
                                {% endif %}
                            </td>
                            <td>
                                {% if delivery.status == 'paused' or delivery.quantity == 0 %}
                                <span class="badge badge-warning">‚è∏Ô∏è Paused</span>
                                {% elif delivery.is_modified %}
                                <span class="badge badge-info">‚úèÔ∏è Modified</span>
                                {% else %}
                                <span class="badge badge-success">‚úÖ Delivered</span>
                                {% endif %}
                            </td>
                            <td>{{ delivery.modification_reason or '-' }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="openEditDeliveryModal({{ delivery.id }}, '{{ delivery.delivery_date }}', {{ delivery.subscription.id }}, {{ delivery.quantity }}, '{{ delivery.subscription.plan.unit_name }}')" title="Edit">
                                    ‚úèÔ∏è
                                </button>
                                {% if delivery.status == 'paused' %}
                                <form method="POST" action="{{ url_for('subscriptions.resume_delivery', delivery_id=delivery.id) }}" style="display: inline;">
                                    <button type="submit" class="btn btn-sm btn-outline-success" title="Resume">
                                        ‚ñ∂Ô∏è
                                    </button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center" style="padding: 60px 20px;">
                <div style="font-size: 64px; margin-bottom: 20px;">üéâ</div>
                <h3>No Exceptions - All Good!</h3>
                <p class="text-muted">All deliveries are running as per default schedule. System is on autopilot! üöÄ</p>
                <p class="text-muted"><small>You'll only see entries here when customers pause, increase, or decrease their orders.</small></p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Full Delivery Log View (HIDDEN by default) -->
    <div id="full_log_view" style="display: none;">
        <div class="form-section">
            <div class="form-row">
                <div class="form-group">
                    <label class="field-label"><strong>Date Range</strong></label>
                    <select id="date_range" class="form-control" onchange="loadFullLog()">
                        <option value="today">Today</option>
                        <option value="week" selected>This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="field-label"><strong>Customer</strong></label>
                    <select id="customer_filter" class="form-control" onchange="loadFullLog()">
                        <option value="">All Customers</option>
                        {% for sub in active_subscriptions %}
                        <option value="{{ sub.id }}">{{ sub.customer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div id="full_log_content">
                    <div class="text-center" style="padding: 40px;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="text-muted" style="margin-top: 15px;">Loading delivery log...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modify Delivery Modal -->
<div class="modal fade" id="modifyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Modify Delivery</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form method="POST" action="{{ url_for('subscriptions.modify_delivery') }}">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="field-label"><strong>Customer *</strong></label>
                        <select name="subscription_id" id="modify_subscription" class="form-control" required onchange="updateModifyUnit()">
                            <option value="">-- Select Customer --</option>
                            {% for sub in active_subscriptions %}
                            <option value="{{ sub.id }}" data-unit="{{ sub.plan.unit_name }}" data-default="{{ sub.default_quantity }}">
                                {{ sub.customer.name }} - {{ sub.plan.name }} ({{ sub.default_quantity }} {{ sub.plan.unit_name }}/day)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>Date *</strong></label>
                        <input type="date" name="delivery_date" class="form-control" required>
                        <small class="form-text text-muted">Select the date you want to modify</small>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>New Quantity *</strong></label>
                        <div class="input-group">
                            <input type="number" name="quantity" id="modify_quantity" class="form-control" step="0.01" min="0" required>
                            <div class="input-group-append">
                                <span class="input-group-text" id="modify_unit">liters</span>
                            </div>
                        </div>
                        <small class="form-text text-muted">Enter 0 to skip this delivery, or enter new quantity (e.g., 3 for party, 1 for reduced)</small>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>Reason *</strong></label>
                        <input type="text" name="reason" class="form-control" placeholder="e.g., Party, Guests, Diet change" required>
                    </div>
                    <div class="alert alert-info">
                        <strong>üí° Quick Options:</strong>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setModifyQuantity(0)">Skip (0)</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setModifyQuantity(1)">Reduce (1)</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setModifyQuantity(3)">Increase (3)</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setModifyQuantity(5)">Party (5)</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">‚úèÔ∏è Modify</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Pause Deliveries Modal -->
<div class="modal fade" id="pauseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚è∏Ô∏è Pause Deliveries (Date Range)</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form method="POST" action="{{ url_for('subscriptions.pause_deliveries') }}">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="field-label"><strong>Customer *</strong></label>
                        <select name="subscription_id" class="form-control" required>
                            <option value="">-- Select Customer --</option>
                            {% for sub in active_subscriptions %}
                            <option value="{{ sub.id }}">{{ sub.customer.name }} - {{ sub.plan.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>From Date *</strong></label>
                        <input type="date" name="date_from" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>To Date *</strong></label>
                        <input type="date" name="date_to" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>Reason</strong></label>
                        <input type="text" name="reason" class="form-control" placeholder="e.g., Vacation, Out of town">
                    </div>
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Note:</strong> This will set quantity to 0 for all days in the selected range.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">‚è∏Ô∏è Pause</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Delivery Modal -->
<div class="modal fade" id="editDeliveryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Edit Delivery</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form method="POST" id="editDeliveryForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="field-label"><strong>Date</strong></label>
                        <input type="text" id="edit_date" class="form-control" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>Quantity *</strong></label>
                        <div class="input-group">
                            <input type="number" name="quantity" id="edit_quantity" class="form-control" step="0.01" min="0" required>
                            <div class="input-group-append">
                                <span class="input-group-text" id="edit_unit">liters</span>
                            </div>
                        </div>
                        <small class="form-text text-muted">Enter 0 to pause this delivery</small>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>Reason</strong></label>
                        <input type="text" name="reason" class="form-control" placeholder="e.g., Party, Guests">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">üíæ Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentView = 'exceptions';

function toggleView() {
    const exceptionsView = document.getElementById('exceptions_view');
    const fullLogView = document.getElementById('full_log_view');
    const toggleBtn = document.getElementById('toggle_btn');
    const viewTitle = document.getElementById('view_title');
    
    if (currentView === 'exceptions') {
        exceptionsView.style.display = 'none';
        fullLogView.style.display = 'block';
        toggleBtn.innerHTML = 'üö® View Exceptions';
        viewTitle.innerHTML = 'üìã Full Delivery Log';
        currentView = 'full';
        loadFullLog();
    } else {
        exceptionsView.style.display = 'block';
        fullLogView.style.display = 'none';
        toggleBtn.innerHTML = 'üìã View Full Log';
        viewTitle.innerHTML = 'üö® Exceptions & Changes';
        currentView = 'exceptions';
    }
}

function loadFullLog() {
    // AJAX call to load full delivery log (to be implemented)
    const dateRange = document.getElementById('date_range').value;
    const customerId = document.getElementById('customer_filter').value;
    
    // Placeholder implementation
    document.getElementById('full_log_content').innerHTML = `
        <div class="alert alert-info">
            <strong>üìä Full delivery log will be loaded here...</strong><br>
            Showing deliveries for: ${dateRange}<br>
            ${customerId ? 'Filtered by customer' : 'All customers'}
        </div>
    `;
}

function openModifyModal() {
    $('#modifyModal').modal('show');
}

function openPauseModal() {
    $('#pauseModal').modal('show');
}

function updateModifyUnit() {
    const select = document.getElementById('modify_subscription');
    const selected = select.options[select.selectedIndex];
    
    if (selected.value) {
        const unit = selected.getAttribute('data-unit');
        const defaultQty = selected.getAttribute('data-default');
        document.getElementById('modify_unit').textContent = unit;
        document.getElementById('modify_quantity').placeholder = 'Default: ' + defaultQty;
    }
}

function setModifyQuantity(qty) {
    document.getElementById('modify_quantity').value = qty;
}

function openEditDeliveryModal(id, date, subscriptionId, quantity, unit) {
    document.getElementById('edit_date').value = date;
    document.getElementById('edit_quantity').value = quantity;
    document.getElementById('edit_unit').textContent = unit;
    document.getElementById('editDeliveryForm').action = '/admin/subscriptions/deliveries/edit/' + id;
    
    $('#editDeliveryModal').modal('show');
}
</script>
{% endblock %}

