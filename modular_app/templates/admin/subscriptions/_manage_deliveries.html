<!-- MANAGE VIEW: Exceptions & Billing -->

<!-- Page Header -->
<div class="report-header">
    <h1>üìù Manage Deliveries</h1>
    <p class="report-date">Exceptions, modifications & monthly billing</p>
</div>

<!-- Billing Ready Section (Month-End) -->
{% set today = now().date() %}
{% set ready_for_billing = [] %}
{% for sub in active_subscriptions %}
    {% if sub.plan.plan_type == 'metered' and sub.current_period_end <= today + timedelta(days=30) %}
        {% set _ = ready_for_billing.append(sub) %}
    {% endif %}
{% endfor %}

{% if ready_for_billing %}
<div class="billing-ready-card">
    <!-- Collapsible Header -->
    <div class="collapsible-header" onclick="toggleManageSection('billing')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="billing-arrow" class="collapse-arrow">‚ñ∂</span>
            <div>
                <h2 style="margin: 0 0 5px 0;">üí∞ Ready for Monthly Billing ({{ ready_for_billing|length }})</h2>
                <p style="margin: 0; color: #666; font-size: 14px;">Click to expand ‚Ä¢ Generate invoices to bill customers</p>
            </div>
        </div>
        <form method="POST" action="{{ url_for('subscriptions.generate_all_invoices') }}" style="display: inline;" onsubmit="event.stopPropagation(); return confirm('Generate invoices for all {{ ready_for_billing|length }} customer(s)? This cannot be undone.');">
            <button type="submit" class="btn-primary" style="padding: 12px 24px; font-size: 16px;">
                üí∞ Generate All ({{ ready_for_billing|length }})
            </button>
        </form>
    </div>
    
    <!-- Collapsible Content -->
    <div id="billing-content" style="display: none;">
        <!-- Search Box -->
        <div style="margin-bottom: 15px;">
            <input type="text" 
                   id="billing-search" 
                   placeholder="üîç Search customers by name..."
                   onkeyup="filterBillingCustomers()"
                   style="width: 100%; max-width: 400px; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
        </div>
        
        <!-- Customer List (Scrollable) -->
        <div style="max-height: 400px; overflow-y: auto;">
            {% for sub in ready_for_billing %}
            <div class="billing-customer-card billing-customer-item" data-customer-name="{{ sub.customer.name|lower }}">
                <div>
                    <strong style="font-size: 16px; color: #2c3e50;">{{ sub.customer.name }}</strong> - {{ sub.plan.name }}<br>
                    <small style="color: #666;">Period: {{ sub.current_period_start.strftime('%b %d') }} - {{ sub.current_period_end.strftime('%b %d, %Y') }} ({{ (sub.current_period_end - sub.current_period_start).days + 1 }} days)</small>
                </div>
                <div style="display: flex; gap: 10px;">
                    <a href="{{ url_for('subscriptions.generate_invoice_metered', subscription_id=sub.id) }}" class="btn-outline">
                        üëÅÔ∏è Preview
                    </a>
                    <form method="POST" action="{{ url_for('subscriptions.generate_invoice_metered', subscription_id=sub.id) }}" style="display: inline;">
                        <button type="submit" class="btn-primary">
                            üí∞ Generate
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <p id="billing-summary" style="margin-top: 10px; font-size: 13px; color: #666;">
            Showing <span id="billing-visible-count">{{ ready_for_billing|length }}</span> of {{ ready_for_billing|length }} customers
        </p>
    </div>
</div>
{% endif %}

<!-- Exceptions Section -->
<div class="exceptions-card">
    <!-- Collapsible Header -->
    <div class="collapsible-header" onclick="toggleManageSection('exceptions')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="exceptions-arrow" class="collapse-arrow">‚ñ∂</span>
            <div>
                <h2 style="margin: 0 0 5px 0;">üö® Exceptions & Changes ({{ exceptions|length }})</h2>
                <p style="margin: 0; color: #666; font-size: 13px;">Click to expand ‚Ä¢ Paused, modified, or upcoming changes (99% automated!)</p>
            </div>
        </div>
        <div style="display: flex; gap: 10px;" onclick="event.stopPropagation();">
            <button class="btn-primary" onclick="openModifyModal()">
                ‚úèÔ∏è Modify Delivery
            </button>
            <button class="btn-primary" onclick="openPauseModal()" style="background: #FFA726;">
                ‚è∏Ô∏è Pause Deliveries
            </button>
        </div>
    </div>

    <!-- Collapsible Content -->
    <div id="exceptions-content" style="display: none;">
        <!-- Exceptions Table -->
        {% if exceptions %}
        <div style="max-height: 500px; overflow-y: auto;">
            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <table class="deliveries-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Plan</th>
                    <th>Quantity</th>
                    <th>Status</th>
                    <th>Reason</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for delivery in exceptions %}
                <tr>
                    <td><strong>{{ delivery.delivery_date.strftime('%b %d, %Y') }}</strong></td>
                    <td>
                        <div class="customer-name">{{ delivery.subscription.customer.name }}</div>
                    </td>
                    <td>{{ delivery.subscription.plan.name }}</td>
                    <td>
                        {% if delivery.quantity == 0 %}
                        <span style="color: #999;">-</span>
                        {% else %}
                        <strong>{{ delivery.quantity }} {{ delivery.subscription.plan.unit_name }}</strong>
                        {% endif %}
                    </td>
                    <td>
                        {% if delivery.status == 'paused' or delivery.quantity == 0 %}
                        <span class="status-badge" style="background: #FFF3E0; color: #F57C00;">‚è∏Ô∏è Paused</span>
                        {% elif delivery.is_modified %}
                        <span class="status-badge" style="background: #E3F2FD; color: #1976D2;">‚úèÔ∏è Modified</span>
                        {% else %}
                        <span class="status-badge completed">‚úÖ Delivered</span>
                        {% endif %}
                    </td>
                    <td>{{ delivery.modification_reason or '-' }}</td>
                    <td>
                        <button class="action-btn" onclick="openEditDeliveryModal({{ delivery.id }}, '{{ delivery.delivery_date }}', {{ delivery.subscription.id }}, {{ delivery.quantity }}, '{{ delivery.subscription.plan.unit_name }}')" title="Edit">
                            ‚úèÔ∏è
                        </button>
                        {% if delivery.status == 'paused' %}
                        <form method="POST" action="{{ url_for('subscriptions.resume_delivery', delivery_id=delivery.id) }}" style="display: inline;">
                            <button type="submit" class="action-btn" style="background: #4CAF50; color: white;" title="Resume">
                                ‚ñ∂Ô∏è
                            </button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
            </div>
        </div>
        {% else %}
        <div style="background: white; border-radius: 12px; padding: 60px 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div style="font-size: 64px; margin-bottom: 20px;">üéâ</div>
            <h3 style="color: #2c3e50; margin-bottom: 10px;">No Exceptions - All Good!</h3>
            <p style="color: #666; font-size: 15px; margin: 0;">All deliveries are running as per default schedule. System is on autopilot! üöÄ</p>
            <p style="color: #999; font-size: 13px; margin-top: 8px;">You'll only see entries here when customers pause, increase, or decrease their orders.</p>
        </div>
        {% endif %}
    </div> <!-- End exceptions-content -->
</div>

<!-- Bulk Assignment Tool - Permanent Employee-Customer Mapping -->
{% if employees %}
<div class="bulk-assign-card">
    <div style="margin-bottom: 15px;">
        <h2 style="margin: 0 0 5px 0;">üë• Permanent Employee-Customer Assignment</h2>
        <p style="margin: 0; color: #666; font-size: 13px;">
            <strong>Step 1:</strong> Select employee ‚Üí <strong>Step 2:</strong> Select their customers ‚Üí <strong>Step 3:</strong> Save
        </p>
        <p style="margin: 5px 0 0 0; color: #ff6b00; font-size: 12px; font-style: italic;">
            üí° This sets the default employee for each customer (applies to ALL future deliveries, not just the selected date)
        </p>
    </div>
    
    <!-- Employee Selector -->
    <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
        <label style="font-size: 14px; font-weight: 700; color: #2c3e50; white-space: nowrap;">
            Select Delivery Employee:
        </label>
        <select id="employee-selector" class="assign-select" style="flex: 1; max-width: 400px; font-size: 15px; padding: 12px;">
            <option value="">-- Choose employee first --</option>
            {% for emp in employees %}
                <option value="{{ emp.id }}">{{ emp.name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <!-- Customer Selection Form -->
    <form id="bulk-assign-form" method="POST" action="{{ url_for('subscriptions.bulk_assign_deliveries') }}" style="display: none;">
        <input type="hidden" name="employee_id" id="selected-employee-id">
        <input type="hidden" name="date" value="{{ target_date.strftime('%Y-%m-%d') if target_date else '' }}">
        
        <div style="margin-bottom: 15px;">
            <!-- Header with Title and Buttons -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; font-size: 16px; color: #2c3e50;">
                    Select Customers for <span id="employee-name-display" style="color: #4CAF50;"></span>:
                </h4>
                <div>
                    <button type="button" onclick="selectAll()" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; margin-right: 10px;">
                        ‚úì Select All
                    </button>
                    <button type="button" onclick="deselectAll()" style="background: #FF5722; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
                        ‚úó Deselect All
                    </button>
                </div>
            </div>
            
            <!-- Search Box and Selection Counter -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 15px;">
                <div style="flex: 1; max-width: 400px;">
                    <input type="text" 
                           id="customer-search" 
                           placeholder="üîç Search customers by name or phone..."
                           style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;"
                           onkeyup="filterCustomers()"
                           onfocus="this.style.borderColor='#4CAF50'"
                           onblur="this.style.borderColor='#e0e0e0'">
                </div>
                <div id="selection-counter" style="font-size: 14px; font-weight: 600; color: #4CAF50; background: #f1f8f4; padding: 10px 20px; border-radius: 8px; white-space: nowrap;">
                    <span id="selected-count">0</span> customers selected
                </div>
            </div>
            
            <!-- Customer Table (Same style as main delivery table) -->
            <div style="border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                <div style="max-height: 500px; overflow-y: auto;">
                    <table class="deliveries-table" id="customer-table">
                        <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                            <tr>
                                <th style="width: 5%;">‚òë</th>
                                <th style="width: 5%;">#</th>
                                <th style="width: 30%;">Customer</th>
                                <th style="width: 20%;">Contact</th>
                                <th style="width: 25%;">Product</th>
                                <th style="width: 15%;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="customer-table-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Results Summary -->
            <div id="search-summary" style="margin-top: 8px; font-size: 13px; color: #666; display: none;">
                Showing <span id="visible-count">0</span> of <span id="total-count">0</span> customers
            </div>
        </div>
        
        <button type="submit" class="btn-date primary" style="margin: 0; width: 100%; padding: 14px; font-size: 16px;">
            üíæ Assign Selected Customers
        </button>
    </form>
</div>
{% endif %}

<!-- Modify Delivery Modal -->
<div class="modal fade" id="modifyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Modify Delivery</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form method="POST" action="{{ url_for('subscriptions.modify_delivery') }}">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="field-label"><strong>Customer *</strong></label>
                        <select name="subscription_id" id="modify_subscription" class="form-control" required onchange="updateModifyUnit()">
                            <option value="">-- Select Customer --</option>
                            {% for sub in active_subscriptions %}
                            <option value="{{ sub.id }}" data-unit="{{ sub.plan.unit_name }}" data-default="{{ sub.default_quantity }}">
                                {{ sub.customer.name }} - {{ sub.plan.name }} ({{ sub.default_quantity }} {{ sub.plan.unit_name }}/day)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>Date *</strong></label>
                        <input type="date" name="delivery_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>New Quantity *</strong></label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" name="new_quantity" id="modify_quantity" class="form-control" step="0.01" min="0" required style="flex: 1;">
                            <span id="modify_unit" style="color: #666; font-weight: 600; min-width: 60px;">units</span>
                        </div>
                        <small class="text-muted">Default: <span id="modify_default">-</span></small>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>Reason</strong></label>
                        <input type="text" name="reason" class="form-control" placeholder="Optional">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">üíæ Save Change</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Pause Deliveries Modal -->
<div class="modal fade" id="pauseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚è∏Ô∏è Pause Deliveries</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form method="POST" action="{{ url_for('subscriptions.pause_deliveries') }}">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="field-label"><strong>Customer *</strong></label>
                        <select name="subscription_id" class="form-control" required>
                            <option value="">-- Select Customer --</option>
                            {% for sub in active_subscriptions %}
                            <option value="{{ sub.id }}">{{ sub.customer.name }} - {{ sub.plan.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>From Date *</strong></label>
                        <input type="date" name="start_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>To Date *</strong></label>
                        <input type="date" name="end_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>Reason</strong></label>
                        <input type="text" name="reason" class="form-control" placeholder="Optional">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">‚è∏Ô∏è Pause Deliveries</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Delivery Modal -->
<div class="modal fade" id="editDeliveryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Edit Delivery</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form method="POST" id="editDeliveryForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="field-label"><strong>Date</strong></label>
                        <input type="text" id="edit_delivery_date" class="form-control" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>New Quantity *</strong></label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" name="quantity" id="edit_quantity" class="form-control" step="0.01" min="0" required style="flex: 1;">
                            <span id="edit_unit" style="color: #666; font-weight: 600; min-width: 60px;">units</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="field-label"><strong>Reason</strong></label>
                        <input type="text" name="reason" class="form-control" placeholder="Optional">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">üíæ Update Delivery</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Manage View Specific Styles */
.billing-ready-card {
    background: #E8F5E9;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    border-left: 5px solid #4CAF50;
}

.collapse-arrow {
    font-size: 16px;
    transition: transform 0.3s ease;
    color: #666;
    display: inline-block;
}

.collapse-arrow.expanded {
    transform: rotate(90deg);
}

.collapsible-header {
    transition: all 0.2s;
}

.collapsible-header:hover {
    opacity: 0.8;
}

.billing-customer-card {
    padding: 15px;
    background: white;
    border-radius: 8px;
    margin-top: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.exceptions-card {
    background: #FFF3E0;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    border-left: 5px solid #FF9800;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-outline {
    background: transparent;
    color: #4CAF50;
    border: 2px solid #4CAF50;
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
}

.btn-outline:hover {
    background: #4CAF50;
    color: white;
}

.action-btn {
    background: #E3F2FD;
    color: #1976D2;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.action-btn:hover {
    background: #1976D2;
    color: white;
    transform: scale(1.05);
}

/* Bulk Assignment Card Styles */
.bulk-assign-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 5px solid #2196F3;
}

.assign-select {
    padding: 10px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #2c3e50;
    cursor: pointer;
    transition: all 0.2s;
}

.assign-select:focus {
    outline: none;
    border-color: #4CAF50;
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
}

.btn-date.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-date.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}
</style>

<!-- JavaScript functions moved to main delivery_schedule.html template -->

