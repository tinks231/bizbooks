{% extends "base_sidebar.html" %}

{% block title %}Enroll New Member{% endblock %}

{% block header_actions %}
<!-- No Manual Entry or QR buttons for subscription pages -->
{% endblock %}

{% block content %}

<style>
/* Subscription Page Specific Styles */
.container-fluid {
    max-width: 1200px;
    margin: 0 auto;
}

.page-header {
    margin-bottom: 30px;
}

.page-header h1 {
    font-size: 28px;
    color: #2c3e50;
    margin-bottom: 5px;
}

.row {
    display: flex;
    gap: 25px;
    flex-wrap: wrap;
}

.col-md-8 {
    flex: 2 1 600px;
    min-width: 0;
}

.col-md-4 {
    flex: 1 1 300px;
    min-width: 280px;
}

.card-body {
    padding: 25px;
}

.form-section {
    margin-bottom: 35px;
    padding-bottom: 25px;
    border-bottom: 2px solid #f0f0f0;
}

.form-section:last-child {
    border-bottom: none;
}

.form-section h4 {
    font-size: 18px;
    color: #2c3e50;
    margin-bottom: 20px;
    font-weight: 600;
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #dfe6e9;
    border-radius: 6px;
    font-size: 14px;
}

.form-control:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.form-text {
    font-size: 12px;
    margin-top: 5px;
    display: block;
}

/* Plan Cards Grid */
#plans_grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.plan-card {
    background: white;
    border: 2px solid #e1e8ed;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.plan-card:hover {
    border-color: #3498db;
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.2);
}

.plan-card.selected {
    border-color: #3498db;
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.05) 0%, rgba(102, 126, 234, 0.05) 100%);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.plan-card.selected::before {
    content: '‚úì';
    position: absolute;
    top: 10px;
    right: 10px;
    background: #3498db;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
}

.plan-header {
    margin-bottom: 12px;
}

.plan-header h5 {
    font-size: 16px;
    color: #2c3e50;
    margin: 0 0 8px 0;
    font-weight: 700;
}

.plan-price {
    font-size: 24px;
    font-weight: 700;
    color: #27ae60;
    margin-bottom: 8px;
}

.plan-duration {
    font-size: 13px;
    color: #7f8c8d;
    font-weight: 500;
    margin-bottom: 8px;
}

.plan-description {
    font-size: 12px;
    color: #95a5a6;
    line-height: 1.4;
}

/* Custom Checkbox */
.custom-control {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.custom-control-input {
    cursor: pointer;
}

.custom-control-label {
    font-weight: 500;
    cursor: pointer;
    margin: 0;
}

/* Payment Fields */
#payment_fields {
    margin-top: 15px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #27ae60;
}

.payment-mode-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.payment-mode-option {
    display: flex;
    align-items: center;
    gap: 8px;
}

.payment-mode-option input {
    cursor: pointer;
}

.payment-mode-option label {
    cursor: pointer;
    margin: 0;
    font-size: 14px;
}

/* Alert Boxes */
.alert {
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
}

.alert-warning {
    background: #fff3cd;
    color: #856404;
    border-left: 4px solid #ffc107;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border-left: 4px solid #28a745;
}

/* Buttons */
.btn-block {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-block.btn-success {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: white;
}

.btn-block.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
}

/* Info Panels */
.info-panel {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.info-panel h4 {
    font-size: 16px;
    color: #2c3e50;
    margin-bottom: 15px;
    font-weight: 600;
}

.info-panel ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.info-panel li {
    padding: 8px 0;
    font-size: 14px;
    color: #34495e;
    line-height: 1.6;
}

.quick-actions {
    margin-top: 20px;
}

.quick-actions a {
    display: block;
    padding: 12px 16px;
    background: #f8f9fa;
    color: #3498db;
    text-decoration: none;
    border-radius: 8px;
    margin-bottom: 10px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.quick-actions a:hover {
    background: #3498db;
    color: white;
    transform: translateX(5px);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .row {
        grid-template-columns: 1fr;
    }
    
    #plans_grid {
        grid-template-columns: 1fr;
    }
    
    .payment-mode-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="container-fluid">
    <div class="page-header">
        <h1>‚ûï Enroll New Member</h1>
        <p class="text-muted">Subscribe a customer to a membership plan</p>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 style="margin: 0;">Enrollment Form</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('subscriptions.enroll_member') }}" onsubmit="return validateForm()">
                        <!-- Step 1: Select Customer -->
                        <div class="form-section">
                            <h4>1Ô∏è‚É£ Select Customer</h4>
                            <div class="form-group">
                                <label class="field-label"><strong>Customer *</strong></label>
                                <select name="customer_id" id="customer_id" class="form-control" required onchange="showCustomerDetails()">
                                    <option value="">-- Select Customer --</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}" data-phone="{{ customer.phone }}" data-email="{{ customer.email or '' }}">
                                        {{ customer.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    Don't see the customer? <a href="/admin/customers/add" target="_blank">Add new customer</a>
                                </small>
                            </div>
                            <div id="customer_details" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <strong>Contact:</strong> <span id="customer_phone"></span><br>
                                <strong>Email:</strong> <span id="customer_email"></span>
                            </div>
                        </div>

                        <!-- Step 2: Choose Plan -->
                        <div class="form-section">
                            <h4>2Ô∏è‚É£ Choose Subscription Plan</h4>
                            <div class="form-group">
                                <div id="plans_grid">
                                    {% if not plans %}
                                    <div class="alert alert-warning">
                                        <strong>‚ö†Ô∏è No active plans found!</strong><br>
                                        Please <a href="/admin/subscriptions/plans">create a plan</a> first.
                                    </div>
                                    {% else %}
                                    {% for plan in plans %}
                                    <div class="plan-card" onclick="selectPlan({{ plan.id }}, {{ plan.price }}, {{ plan.duration_days }})">
                                        <input type="radio" name="plan_id" id="plan_{{ plan.id }}" value="{{ plan.id }}" required style="display: none;">
                                        <div class="plan-header">
                                            <h5>{{ plan.name }}</h5>
                                            <div class="plan-price">‚Çπ{{ '{:,.2f}'.format(plan.price) }}</div>
                                        </div>
                                        <div class="plan-details">
                                            <div class="plan-duration">{{ plan.duration_display }}</div>
                                            {% if plan.description %}
                                            <div class="plan-description">{{ plan.description }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Start Date -->
                        <div class="form-section">
                            <h4>3Ô∏è‚É£ Start Date</h4>
                            <div class="form-group">
                                <label class="field-label"><strong>Subscription Start Date *</strong></label>
                                <input type="date" name="start_date" id="start_date" class="form-control" required onchange="calculatePeriodEnd()">
                                <small class="form-text text-muted">Usually today's date</small>
                            </div>
                            <div id="period_summary" style="display: none; margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #0066cc;">
                                <strong>üìÖ Billing Period:</strong> <span id="period_display"></span><br>
                                <strong>‚è∞ Next Payment Due:</strong> <span id="next_due_display"></span>
                            </div>
                        </div>

                        <!-- Step 4: Payment Status -->
                        <div class="form-section">
                            <h4>4Ô∏è‚É£ Payment Status</h4>
                            
                            <!-- Payment Collection Status -->
                            <div class="form-group">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="payment_collected" name="payment_collected" checked onchange="togglePaymentFields()">
                                    <label class="custom-control-label" for="payment_collected">
                                        <strong>üí∞ Payment Collected?</strong> 
                                        <small class="text-muted d-block">Uncheck if member will pay later (trial period, pay after few days, etc.)</small>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Payment Details (only visible if payment collected) -->
                            <div id="payment-details-section">
                                <div class="row" style="margin-top: 20px;">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="field-label"><strong>Amount (‚Çπ) *</strong></label>
                                            <input type="number" name="payment_amount" id="payment_amount" class="form-control" step="0.01" min="0">
                                            <small class="form-text text-muted">Auto-filled from plan price</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="field-label"><strong>Payment Mode *</strong></label>
                                            <select name="payment_mode" class="form-control">
                                                <option value="Cash">Cash</option>
                                                <option value="UPI">UPI</option>
                                                <option value="Card">Card</option>
                                                <option value="Bank Transfer">Bank Transfer</option>
                                                <option value="Cheque">Cheque</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Invoice Generation (only visible if payment collected) -->
                                <div class="form-group">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="generate_invoice" name="generate_invoice" checked>
                                        <label class="custom-control-label" for="generate_invoice">
                                            <strong>Generate Invoice</strong> (Recommended for accounting)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit -->
                        <div class="form-section" style="border-top: 2px solid #e0e0e0; padding-top: 20px;">
                            <div class="row">
                                <div class="col-md-6">
                                    <a href="{{ url_for('subscriptions.members') }}" class="btn btn-secondary btn-block">
                                        <i class="fas fa-times"></i> Cancel
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <button type="submit" class="btn btn-primary btn-block btn-lg">
                                        <i class="fas fa-check"></i> Enroll Member
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right sidebar with tips -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header" style="background: #e7f3ff;">
                    <h5 style="margin: 0; color: #0066cc;">üí° Enrollment Tips</h5>
                </div>
                <div class="card-body">
                    <h6><strong>Before Enrolling:</strong></h6>
                    <ul>
                        <li>Verify customer details are correct</li>
                        <li>Confirm they agree to the plan terms</li>
                        <li>Collect first payment</li>
                    </ul>
                    
                    <h6 style="margin-top: 20px;"><strong>After Enrollment:</strong></h6>
                    <ul>
                        <li>Customer appears in "Active Members"</li>
                        <li>You'll see payment reminders 3 days before due</li>
                        <li>Auto-renewal can be managed later</li>
                    </ul>
                    
                    <h6 style="margin-top: 20px;"><strong>Payment Options:</strong></h6>
                    <ul>
                        <li><strong>Full Payment:</strong> Collect full plan amount</li>
                        <li><strong>Partial:</strong> Enter amount received (create invoice later for balance)</li>
                    </ul>
                </div>
            </div>

            <div class="card" style="margin-top: 20px; background: #fffbf0; border-color: #f39c12;">
                <div class="card-body">
                    <h6 style="color: #f39c12;"><strong>‚ö° Quick Actions:</strong></h6>
                    <a href="/admin/customers/add" target="_blank" class="btn btn-outline-primary btn-sm btn-block">
                        <i class="fas fa-plus"></i> Add New Customer
                    </a>
                    <a href="/admin/subscriptions/plans" class="btn btn-outline-primary btn-sm btn-block">
                        <i class="fas fa-cog"></i> Manage Plans
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
// Set today as default start date
document.getElementById('start_date').valueAsDate = new Date();

function showCustomerDetails() {
    const select = document.getElementById('customer_id');
    const selected = select.options[select.selectedIndex];
    
    if (selected.value) {
        document.getElementById('customer_phone').textContent = selected.getAttribute('data-phone') || '-';
        document.getElementById('customer_email').textContent = selected.getAttribute('data-email') || '-';
        document.getElementById('customer_details').style.display = 'block';
    } else {
        document.getElementById('customer_details').style.display = 'none';
    }
}

let selectedPlanDuration = 0;

function selectPlan(planId, price, duration) {
    // Remove selected class from all plans
    document.querySelectorAll('.plan-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selected class to clicked plan
    event.currentTarget.classList.add('selected');
    
    // Check the radio button
    document.getElementById('plan_' + planId).checked = true;
    
    // Auto-fill payment amount
    document.getElementById('payment_amount').value = price;
    
    // Store duration for calculation
    selectedPlanDuration = duration;
    
    // Calculate period end if start date is set
    calculatePeriodEnd();
}

function calculatePeriodEnd() {
    const startDate = document.getElementById('start_date').value;
    
    if (startDate && selectedPlanDuration > 0) {
        const start = new Date(startDate);
        const end = new Date(start);
        end.setDate(end.getDate() + selectedPlanDuration);
        
        // Format dates
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        const periodDisplay = start.toLocaleDateString('en-IN', options) + ' to ' + end.toLocaleDateString('en-IN', options);
        const nextDueDisplay = end.toLocaleDateString('en-IN', options);
        
        document.getElementById('period_display').textContent = periodDisplay;
        document.getElementById('next_due_display').textContent = nextDueDisplay;
        document.getElementById('period_summary').style.display = 'block';
    }
}

function togglePaymentFields() {
    const paymentCollected = document.getElementById('payment_collected').checked;
    const paymentDetailsSection = document.getElementById('payment-details-section');
    
    if (paymentCollected) {
        // Show payment fields and invoice option
        paymentDetailsSection.style.display = 'block';
    } else {
        // Hide payment fields and invoice option
        paymentDetailsSection.style.display = 'none';
    }
}

function validateForm() {
    const customerId = document.getElementById('customer_id').value;
    const planRadio = document.querySelector('input[name="plan_id"]:checked');
    const startDate = document.getElementById('start_date').value;
    const paymentCollected = document.getElementById('payment_collected').checked;
    const paymentAmount = document.getElementById('payment_amount').value;
    
    if (!customerId) {
        alert('‚ö†Ô∏è Please select a customer');
        return false;
    }
    
    if (!planRadio) {
        alert('‚ö†Ô∏è Please select a subscription plan');
        return false;
    }
    
    if (!startDate) {
        alert('‚ö†Ô∏è Please select a start date');
        return false;
    }
    
    // Only validate payment if payment is collected
    if (paymentCollected) {
        if (!paymentAmount || parseFloat(paymentAmount) <= 0) {
            alert('‚ö†Ô∏è Please enter a valid payment amount');
            return false;
        }
        return confirm('Confirm enrollment? Customer will be subscribed and payment will be recorded.');
    } else {
        return confirm('Confirm enrollment? Member will be enrolled but payment is PENDING. They can pay later.');
    }
}
</script>
{% endblock %}

