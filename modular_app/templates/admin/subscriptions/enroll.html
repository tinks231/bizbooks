{% extends "base_sidebar.html" %}

{% block title %}Enroll New Member{% endblock %}

{% block header_actions %}
<!-- No Manual Entry or QR buttons for subscription pages -->
{% endblock %}

{% block content %}


<div class="container-fluid">
    <div class="subscription-header">
        <h1>‚ûï Enroll New Member</h1>
        <p>Subscribe a customer to a membership plan</p>
    </div>

    <div class="enroll-form-layout">
        <div class="enroll-form-main">
            <div class="card">
                <div class="card-header">
                    <h3 style="margin: 0;">Enrollment Form</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('subscriptions.enroll_member') }}" onsubmit="return validateForm()">
                        <!-- Step 1: Select Customer -->
                        <div class="enroll-form-section">
                            <h4>1Ô∏è‚É£ Select Customer</h4>
                            <div class="form-group">
                                <label class="field-label"><strong>Customer *</strong></label>
                                <select name="customer_id" id="customer_id" class="form-control" required onchange="showCustomerDetails()">
                                    <option value="">-- Select Customer --</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}" data-phone="{{ customer.phone }}" data-email="{{ customer.email or '' }}">
                                        {{ customer.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    Don't see the customer? <a href="/admin/customers/add" target="_blank">Add new customer</a>
                                </small>
                            </div>
                            <div id="customer_details" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <strong>Contact:</strong> <span id="customer_phone"></span><br>
                                <strong>Email:</strong> <span id="customer_email"></span>
                            </div>
                        </div>

                        <!-- Step 2: Choose Plan -->
                        <div class="enroll-form-section">
                            <h4>2Ô∏è‚É£ Choose Subscription Plan</h4>
                            <div class="form-group">
                                <div class="plan-cards-grid">
                                    {% if not plans %}
                                    <div class="alert alert-warning">
                                        <strong>‚ö†Ô∏è No active plans found!</strong><br>
                                        Please <a href="/admin/subscriptions/plans">create a plan</a> first.
                                    </div>
                                    {% else %}
                                    {% for plan in plans %}
                                    <div class="plan-card" onclick="selectPlan({{ plan.id }}, '{{ plan.plan_type }}', {{ plan.price or 0 }}, {{ plan.duration_days }}, {{ plan.unit_rate or 0 }}, '{{ plan.unit_name or '' }}')">
                                        <input type="radio" name="plan_id" id="plan_{{ plan.id }}" value="{{ plan.id }}" required style="display: none;">
                                        <div class="plan-header">
                                            <h5>{{ plan.name }}</h5>
                                            {% if plan.plan_type == 'metered' %}
                                            <span class="badge badge-info">üìä Metered</span>
                                            {% else %}
                                            <span class="badge badge-primary">üì¶ Fixed</span>
                                            {% endif %}
                                        </div>
                                        <div class="plan-details">
                                            {% if plan.plan_type == 'metered' %}
                                            <div class="plan-price">‚Çπ{{ '{:,.2f}'.format(plan.unit_rate) }}/{{ plan.unit_name }}</div>
                                            <small class="text-muted">Billed monthly based on consumption</small>
                                            {% else %}
                                            <div class="plan-price">‚Çπ{{ '{:,.2f}'.format(plan.price) }}</div>
                                            <div class="plan-duration">{{ plan.duration_display }}</div>
                                            {% endif %}
                                            {% if plan.description %}
                                            <div class="plan-description">{{ plan.description }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Step 2.5: Metered Plan Default Quantity (only for metered plans) -->
                        <div class="enroll-form-section" id="metered_quantity_section" style="display: none;">
                            <h4>üìä Default Daily Quantity</h4>
                            <div class="form-group">
                                <label class="field-label"><strong>Default Quantity per Day *</strong></label>
                                <div class="input-group">
                                    <input type="number" name="default_quantity" id="default_quantity" class="form-control" step="0.01" min="0" placeholder="2">
                                    <div class="input-group-append">
                                        <span class="input-group-text" id="quantity_unit">liters</span>
                                    </div>
                                </div>
                                <small class="form-text text-muted">
                                    This is the standard daily quantity. You can adjust it anytime or pause deliveries when needed.
                                </small>
                            </div>
                            <div class="alert alert-info" style="margin-top: 10px;">
                                <strong>üí° How it works:</strong><br>
                                System will auto-generate daily deliveries with this quantity. You only need to update when there's a change (pause, increase, or decrease).
                            </div>
                        </div>

                        <!-- Step 3: Start Date -->
                        <div class="enroll-form-section">
                            <h4>3Ô∏è‚É£ Start Date</h4>
                            <div class="form-group">
                                <label class="field-label"><strong>Subscription Start Date *</strong></label>
                                <input type="date" name="start_date" id="start_date" class="form-control" required onchange="calculatePeriodEnd()">
                                <small class="form-text text-muted">Usually today's date</small>
                            </div>
                            <div id="period_summary" style="display: none; margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #0066cc;">
                                <strong>üìÖ Billing Period:</strong> <span id="period_display"></span><br>
                                <strong>‚è∞ Next Payment Due:</strong> <span id="next_due_display"></span>
                            </div>
                        </div>

                        <!-- Step 4: Payment Status -->
                        <div class="enroll-form-section">
                            <h4>4Ô∏è‚É£ Payment Status</h4>
                            
                            <!-- Payment Collection Status -->
                            <div class="form-group">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="payment_collected" name="payment_collected" checked onchange="togglePaymentFields()">
                                    <label class="custom-control-label" for="payment_collected">
                                        <strong>üí∞ Payment Collected?</strong> 
                                        <small class="text-muted d-block">Uncheck if member will pay later (trial period, pay after few days, etc.)</small>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Payment Details (only visible if payment collected) -->
                            <div id="payment-details-section">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="field-label"><strong>Amount (‚Çπ) *</strong></label>
                                        <input type="number" name="payment_amount" id="payment_amount" class="form-control" step="0.01" min="0">
                                        <small class="form-text text-muted">Auto-filled from plan price</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="field-label"><strong>Payment Mode *</strong></label>
                                        <select name="payment_mode" class="form-control">
                                            <option value="Cash">Cash</option>
                                            <option value="UPI">UPI</option>
                                            <option value="Card">Card</option>
                                            <option value="Bank Transfer">Bank Transfer</option>
                                            <option value="Cheque">Cheque</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Invoice Generation (only visible if payment collected) -->
                                <div class="form-group">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="generate_invoice" name="generate_invoice" checked>
                                        <label class="custom-control-label" for="generate_invoice">
                                            <strong>Generate Invoice</strong> (Recommended for accounting)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit -->
                        <div class="enroll-form-actions">
                            <a href="{{ url_for('subscriptions.members') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check"></i> Enroll Member
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right sidebar with tips -->
        <div class="enroll-form-sidebar">
            <div class="card">
                <div class="card-header" style="background: #e7f3ff;">
                    <h5 style="margin: 0; color: #0066cc;">üí° Enrollment Tips</h5>
                </div>
                <div class="card-body">
                    <h6><strong>Before Enrolling:</strong></h6>
                    <ul>
                        <li>Verify customer details are correct</li>
                        <li>Confirm they agree to the plan terms</li>
                        <li>Collect first payment</li>
                    </ul>
                    
                    <h6 style="margin-top: 20px;"><strong>After Enrollment:</strong></h6>
                    <ul>
                        <li>Customer appears in "Active Members"</li>
                        <li>You'll see payment reminders 3 days before due</li>
                        <li>Auto-renewal can be managed later</li>
                    </ul>
                    
                    <h6 style="margin-top: 20px;"><strong>Payment Options:</strong></h6>
                    <ul>
                        <li><strong>Full Payment:</strong> Collect full plan amount</li>
                        <li><strong>Partial:</strong> Enter amount received (create invoice later for balance)</li>
                    </ul>
                </div>
            </div>

            <div class="card" style="margin-top: 20px; background: #fffbf0; border-color: #f39c12;">
                <div class="card-body">
                    <h6 style="color: #f39c12;"><strong>‚ö° Quick Actions:</strong></h6>
                    <a href="/admin/customers/add" target="_blank" class="btn btn-outline-primary btn-sm btn-block">
                        <i class="fas fa-plus"></i> Add New Customer
                    </a>
                    <a href="/admin/subscriptions/plans" class="btn btn-outline-primary btn-sm btn-block">
                        <i class="fas fa-cog"></i> Manage Plans
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
// Set today as default start date
document.getElementById('start_date').valueAsDate = new Date();

function showCustomerDetails() {
    const select = document.getElementById('customer_id');
    const selected = select.options[select.selectedIndex];
    
    if (selected.value) {
        document.getElementById('customer_phone').textContent = selected.getAttribute('data-phone') || '-';
        document.getElementById('customer_email').textContent = selected.getAttribute('data-email') || '-';
        document.getElementById('customer_details').style.display = 'block';
    } else {
        document.getElementById('customer_details').style.display = 'none';
    }
}

let selectedPlanDuration = 0;
let selectedPlanType = 'fixed';

function selectPlan(planId, planType, price, duration, unitRate, unitName) {
    // Remove selected class from all plans
    document.querySelectorAll('.plan-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selected class to clicked plan
    event.currentTarget.classList.add('selected');
    
    // Check the radio button
    document.getElementById('plan_' + planId).checked = true;
    
    // Store plan details
    selectedPlanDuration = duration;
    selectedPlanType = planType;
    
    // Handle FIXED vs METERED plans
    if (planType === 'metered') {
        // Show metered quantity section
        document.getElementById('metered_quantity_section').style.display = 'block';
        document.getElementById('quantity_unit').textContent = unitName + 's';
        
        // Make default_quantity required
        document.getElementById('default_quantity').required = true;
        
        // For metered, payment is collected AFTER consumption (monthly)
        // So hide/disable immediate payment collection
        document.getElementById('payment_collected').checked = false;
        togglePaymentFields();
        
        // Update tips
        document.getElementById('payment_amount').placeholder = 'Monthly billing based on consumption';
        document.getElementById('payment_amount').value = '';
        
    } else {
        // Hide metered quantity section
        document.getElementById('metered_quantity_section').style.display = 'none';
        document.getElementById('default_quantity').required = false;
        
        // Auto-fill payment amount for fixed plans
        document.getElementById('payment_amount').value = price;
        
        // Enable payment collection
        document.getElementById('payment_collected').checked = true;
        togglePaymentFields();
    }
    
    // Calculate period end if start date is set
    calculatePeriodEnd();
}

function calculatePeriodEnd() {
    const startDate = document.getElementById('start_date').value;
    
    if (startDate && selectedPlanDuration > 0) {
        const start = new Date(startDate);
        const end = new Date(start);
        end.setDate(end.getDate() + selectedPlanDuration);
        
        // Format dates
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        
        if (selectedPlanType === 'metered') {
            // For metered plans, show billing cycle
            const periodDisplay = start.toLocaleDateString('en-IN', options) + ' to ' + end.toLocaleDateString('en-IN', options);
            const nextDueDisplay = end.toLocaleDateString('en-IN', options);
            
            document.getElementById('period_display').textContent = periodDisplay + ' (First billing cycle)';
            document.getElementById('next_due_display').textContent = nextDueDisplay + ' - Invoice based on actual consumption';
        } else {
            // For fixed plans, show standard period
            const periodDisplay = start.toLocaleDateString('en-IN', options) + ' to ' + end.toLocaleDateString('en-IN', options);
            const nextDueDisplay = end.toLocaleDateString('en-IN', options);
            
            document.getElementById('period_display').textContent = periodDisplay;
            document.getElementById('next_due_display').textContent = nextDueDisplay;
        }
        
        document.getElementById('period_summary').style.display = 'block';
    }
}

function togglePaymentFields() {
    const paymentCollected = document.getElementById('payment_collected').checked;
    const paymentDetailsSection = document.getElementById('payment-details-section');
    
    if (paymentCollected) {
        // Show payment fields and invoice option
        paymentDetailsSection.style.display = 'block';
    } else {
        // Hide payment fields and invoice option
        paymentDetailsSection.style.display = 'none';
    }
}

function validateForm() {
    const customerId = document.getElementById('customer_id').value;
    const planRadio = document.querySelector('input[name="plan_id"]:checked');
    const startDate = document.getElementById('start_date').value;
    const paymentCollected = document.getElementById('payment_collected').checked;
    const paymentAmount = document.getElementById('payment_amount').value;
    const defaultQuantity = document.getElementById('default_quantity').value;
    
    if (!customerId) {
        alert('‚ö†Ô∏è Please select a customer');
        return false;
    }
    
    if (!planRadio) {
        alert('‚ö†Ô∏è Please select a subscription plan');
        return false;
    }
    
    if (!startDate) {
        alert('‚ö†Ô∏è Please select a start date');
        return false;
    }
    
    // Validate default quantity for metered plans
    if (selectedPlanType === 'metered') {
        if (!defaultQuantity || parseFloat(defaultQuantity) <= 0) {
            alert('‚ö†Ô∏è Please enter a valid default daily quantity');
            return false;
        }
        return confirm('Confirm enrollment? Customer will be subscribed and daily deliveries will be auto-generated. First invoice will be generated at the end of the billing cycle.');
    }
    
    // Only validate payment if payment is collected (for fixed plans)
    if (paymentCollected) {
        if (!paymentAmount || parseFloat(paymentAmount) <= 0) {
            alert('‚ö†Ô∏è Please enter a valid payment amount');
            return false;
        }
        return confirm('Confirm enrollment? Customer will be subscribed and payment will be recorded.');
    } else {
        return confirm('Confirm enrollment? Member will be enrolled but payment is PENDING. They can pay later.');
    }
}
</script>
{% endblock %}

