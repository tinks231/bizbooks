{% extends "base_sidebar.html" %}
{% block title %}Expenses - {{ tenant.company_name }}{% endblock %}
{% block page_title %}Expenses{% endblock %}
{% block header_actions %}
<button onclick="document.getElementById('addExpenseForm').style.display='block'" class="btn btn-success">
    ‚ûï Add Expense
</button>
{% endblock %}
{% block content %}
<!-- Summary Cards -->
<div class="stats-grid" style="margin-bottom: 30px;">
    <div class="stat-card">
        <div class="stat-value">‚Çπ{{ "{:,.0f}".format(total_amount) }}</div>
        <div class="stat-label">Total Expenses</div>
    </div>
</div>

<!-- Add Expense Form -->
<div id="addExpenseForm" style="display: none; background: white; border-radius: 8px; padding: 25px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h3>Add Expense</h3>
    <form method="POST" action="{{ url_for('expenses.add') }}">
        <div class="form-row">
            <div class="form-group">
                <label class="field-label">Date *</label>
                <input type="date" name="expense_date" required>
            </div>
            <div class="form-group">
                <label class="field-label">Category *</label>
                <select name="category_id" required>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="field-label">Amount (‚Çπ) *</label>
                <input type="number" name="amount" step="0.01" required>
            </div>
            <div class="form-group">
                <label class="field-label">üí∞ Pay From Account *</label>
                <select name="account_id" required>
                    <option value="">-- Select Account --</option>
                    {% if bank_accounts %}
                        {% for account in bank_accounts %}
                            <option value="{{ account.id }}" 
                                    {% if account.is_default %}selected{% endif %}>
                                {% if account.account_type == 'cash' %}üíµ{% elif account.account_type == 'bank' %}üè¶{% else %}üí∞{% endif %}
                                {{ account.account_name }}
                                {% if account.bank_name %}({{ account.bank_name }}){% endif %}
                                - ‚Çπ{{ "{:,.2f}".format(account.current_balance) }}
                            </option>
                        {% endfor %}
                    {% else %}
                        <option value="" disabled>No accounts found</option>
                    {% endif %}
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="field-label">Payment Method</label>
                <select name="payment_method">
                    <option value="Cash">Cash</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="UPI">UPI</option>
                    <option value="Card">Card</option>
                    <option value="Cheque">Cheque</option>
                </select>
            </div>
            <div class="form-group">
                <!-- Empty for spacing -->
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="field-label">Vendor/Payee</label>
                <input type="text" name="vendor_name">
            </div>
            <div class="form-group">
                <label class="field-label">Reference Number</label>
                <input type="text" name="reference_number">
            </div>
        </div>
        <div class="form-group">
            <label class="field-label">Description *</label>
            <textarea name="description" rows="2" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('addExpenseForm').style.display='none'">Cancel</button>
    </form>
</div>

<!-- View Toggle (Mobile Only) -->
<div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
    <button id="viewToggle" class="btn btn-primary" onclick="toggleView()" style="display: none;">
        <span id="toggleIcon">üìä</span> <span id="toggleText">Table View</span>
    </button>
</div>

<!-- Expenses List -->
<div class="card">
    <h3>All Expenses</h3>
    {% if expenses %}
    
    <!-- Table View (Desktop default) -->
    <div id="tableView" class="desktop-table">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px;">Date</th>
                <th style="padding: 12px;">Category</th>
                <th style="padding: 12px;">Description</th>
                <th style="padding: 12px;">Vendor</th>
                <th style="padding: 12px; text-align: right;">Amount</th>
                <th style="padding: 12px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in expenses %}
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 12px;">{{ expense.expense_date.strftime('%d %b %Y') }}</td>
                <td style="padding: 12px;">{{ expense.category.name }}</td>
                <td style="padding: 12px;">{{ expense.description[:50] }}</td>
                <td style="padding: 12px;">{{ expense.vendor_name or '‚Äî' }}</td>
                <td style="padding: 12px; text-align: right; font-weight: 600;">‚Çπ{{ "{:,.2f}".format(expense.amount) }}</td>
                <td style="padding: 12px;">
                    <a href="{{ url_for('expenses.edit', expense_id=expense.id) }}" style="color: #3498db; margin-right: 10px;">‚úèÔ∏è</a>
                    <a href="{{ url_for('expenses.delete', expense_id=expense.id) }}" onclick="return confirm('Delete this expense?')" style="color: #dc3545;">üóëÔ∏è</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <!-- End Table View -->
    
    <!-- Mobile Card View (Default on mobile) -->
    <div id="cardView" class="mobile-cards" style="display: none;">
        {% for expense in expenses %}
        <div class="expense-card" style="background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <!-- Card Header -->
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 16px; color: #2c3e50;">
                        {{ expense.category.name }}
                    </div>
                    <div style="color: #7f8c8d; font-size: 13px; margin-top: 4px;">
                        üìÖ {{ expense.expense_date.strftime('%d %b %Y') }}
                    </div>
                </div>
                <div style="font-size: 20px; font-weight: 700; color: #e74c3c;">
                    ‚Çπ{{ "{:,.2f}".format(expense.amount) }}
                </div>
            </div>
            
            <!-- Description -->
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">Description</div>
                <div style="font-size: 14px; color: #2c3e50; line-height: 1.4;">{{ expense.description }}</div>
            </div>
            
            <!-- Details Grid -->
            {% if expense.vendor_name or expense.payment_method or expense.reference_number %}
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; font-size: 13px;">
                {% if expense.vendor_name %}
                <div>
                    <div style="font-size: 11px; color: #6c757d;">Vendor</div>
                    <div style="font-weight: 600; color: #495057;">{{ expense.vendor_name }}</div>
                </div>
                {% endif %}
                {% if expense.payment_method %}
                <div>
                    <div style="font-size: 11px; color: #6c757d;">Payment</div>
                    <div style="font-weight: 600; color: #495057;">{{ expense.payment_method }}</div>
                </div>
                {% endif %}
                {% if expense.reference_number %}
                <div style="grid-column: span 2;">
                    <div style="font-size: 11px; color: #6c757d;">Reference</div>
                    <div style="font-weight: 600; color: #495057;">{{ expense.reference_number }}</div>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 8px;">
                <a href="{{ url_for('expenses.edit', expense_id=expense.id) }}"
                   style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
                          padding: 10px; border-radius: 6px; text-align: center; text-decoration: none; font-weight: 600; font-size: 13px;">
                    ‚úèÔ∏è Edit
                </a>
                <a href="{{ url_for('expenses.delete', expense_id=expense.id) }}"
                   onclick="return confirm('Delete this expense?')"
                   style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; 
                          padding: 10px; border-radius: 6px; text-align: center; text-decoration: none; font-weight: 600; font-size: 13px;">
                    üóëÔ∏è Delete
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    <!-- End Card View -->
    
    {% else %}
    <p style="text-align: center; padding: 40px; color: #7f8c8d;">No expenses yet</p>
    {% endif %}
</div>


<script>
// View toggle function
function toggleView() {
    const body = document.body;
    const toggleIcon = document.getElementById('toggleIcon');
    const toggleText = document.getElementById('toggleText');
    
    if (body.classList.contains('show-table')) {
        // Switch to Card View
        body.classList.remove('show-table');
        toggleIcon.textContent = 'üìä';
        toggleText.textContent = 'Table View';
        localStorage.setItem('expenseViewPreference', 'cards');
    } else {
        // Switch to Table View
        body.classList.add('show-table');
        toggleIcon.textContent = 'üì±';
        toggleText.textContent = 'Card View';
        localStorage.setItem('expenseViewPreference', 'table');
    }
}

// Load user preference on page load
document.addEventListener('DOMContentLoaded', function() {
    const preference = localStorage.getItem('expenseViewPreference');
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile && preference === 'table') {
        document.body.classList.add('show-table');
        document.getElementById('toggleIcon').textContent = 'üì±';
        document.getElementById('toggleText').textContent = 'Card View';
    }
});
</script>

{% endblock %}
