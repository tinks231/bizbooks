{% extends "base_sidebar.html" %}
{% block title %}Expense Reports - {{ tenant.company_name }}{% endblock %}
{% block page_title %}Expense Reports{% endblock %}
{% block header_actions %}
<a href="{{ url_for('expenses.index') }}" class="btn btn-secondary">
    ← Back to Expenses
</a>
{% endblock %}
{% block content %}

<!-- Month Selector -->
<div class="card" style="margin-bottom: 20px;">
    <h3>Select Month</h3>
    <form method="GET" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
        <div class="form-group" style="margin: 0;">
            <label class="field-label">Month</label>
            <select name="month">
                {% for m in range(1, 13) %}
                <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>
                    {{ ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'][m-1] }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin: 0;">
            <label class="field-label">Year</label>
            <select name="year">
                {% for y in range(2020, 2031) %}
                <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">View</button>
    </form>
</div>

<!-- Summary Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="stats-card">
        <h4 style="color: #666; font-size: 14px; margin-bottom: 10px;">Total Expenses ({{ ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][selected_month-1] }} {{ selected_year }})</h4>
        <div style="font-size: 32px; font-weight: bold; color: #dc3545;">₹{{ "{:,.2f}".format(month_expenses) }}</div>
    </div>
    
    <div class="stats-card">
        <h4 style="color: #666; font-size: 14px; margin-bottom: 10px;">Total Categories Used</h4>
        <div style="font-size: 32px; font-weight: bold; color: #3498db;">{{ category_breakdown|length }}</div>
    </div>
    
    <div class="stats-card">
        <h4 style="color: #666; font-size: 14px; margin-bottom: 10px;">Days with Expenses</h4>
        <div style="font-size: 32px; font-weight: bold; color: #f39c12;">{{ daily_expenses|length }}</div>
    </div>
</div>

<!-- Category Breakdown -->
<div class="card" style="margin-bottom: 30px;">
    <h3>Category-wise Breakdown</h3>
    {% if category_breakdown %}
    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left;">Category</th>
                <th style="padding: 12px; text-align: center;">Transactions</th>
                <th style="padding: 12px; text-align: right;">Total Amount</th>
                <th style="padding: 12px; text-align: right;">% of Total</th>
            </tr>
        </thead>
        <tbody>
            {% for category in category_breakdown %}
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 12px;">{{ category.name }}</td>
                <td style="padding: 12px; text-align: center;">{{ category.count }}</td>
                <td style="padding: 12px; text-align: right; font-weight: 600;">₹{{ "{:,.2f}".format(category.total) }}</td>
                <td style="padding: 12px; text-align: right;">{{ "%.1f"|format((category.total / month_expenses * 100) if month_expenses > 0 else 0) }}%</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr style="background: #f8f9fa; font-weight: bold; border-top: 2px solid #dee2e6;">
                <td style="padding: 12px;">TOTAL</td>
                <td style="padding: 12px; text-align: center;">{{ category_breakdown|sum(attribute='count') }}</td>
                <td style="padding: 12px; text-align: right;">₹{{ "{:,.2f}".format(month_expenses) }}</td>
                <td style="padding: 12px; text-align: right;">100%</td>
            </tr>
        </tfoot>
    </table>
    {% else %}
    <p style="color: #999; text-align: center; padding: 40px;">No expenses for selected month</p>
    {% endif %}
</div>

<!-- Daily Expenses -->
<div class="card" style="margin-bottom: 30px;">
    <h3>Daily Expenses ({{ ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][selected_month-1] }} {{ selected_year }})</h3>
    {% if daily_expenses %}
    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left;">Date</th>
                <th style="padding: 12px; text-align: right;">Total Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for day in daily_expenses %}
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 12px;">{{ day.expense_date.strftime('%d %B %Y') }}</td>
                <td style="padding: 12px; text-align: right; font-weight: 600;">₹{{ "{:,.2f}".format(day.total) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #999; text-align: center; padding: 40px;">No daily expenses for selected month</p>
    {% endif %}
</div>

<!-- 6 Months Trend -->
<div class="card">
    <h3>6 Months Trend</h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left;">Month</th>
                <th style="padding: 12px; text-align: right;">Total Expenses</th>
            </tr>
        </thead>
        <tbody>
            {% for month_data in months_trend %}
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 12px;">{{ month_data.month }}</td>
                <td style="padding: 12px; text-align: right; font-weight: 600;">₹{{ "{:,.2f}".format(month_data.total) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}
