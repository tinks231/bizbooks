{% extends "base_sidebar.html" %}
{% block title %}Purchase Requests - {{ tenant.company_name }}{% endblock %}
{% block page_title %}
Purchase Requests 
{% if pending_count > 0 %}
<span style="background: #dc3545; color: white; padding: 5px 12px; border-radius: 20px; font-size: 14px; margin-left: 10px;">{{ pending_count }}</span>
{% endif %}
{% endblock %}

{% block header_actions %}
<!-- Remove default Manual Entry & QR Code buttons - not relevant for Purchase Requests -->
{% endblock %}

{% block content %}
<!-- Filter Buttons -->
<div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
    <a href="{{ url_for('admin_purchase.index', status='all') }}" 
       class="btn {% if status_filter == 'all' %}btn-primary{% else %}btn-secondary{% endif %}"
       style="min-width: 100px;">
        All Requests
    </a>
    <a href="{{ url_for('admin_purchase.index', status='pending') }}" 
       class="btn {% if status_filter == 'pending' %}btn-primary{% else %}btn-secondary{% endif %}"
       style="min-width: 100px;">
        Pending {% if pending_count > 0 %}({{ pending_count }}){% endif %}
    </a>
    <a href="{{ url_for('admin_purchase.index', status='approved') }}" 
       class="btn {% if status_filter == 'approved' %}btn-primary{% else %}btn-secondary{% endif %}"
       style="min-width: 100px;">
        Approved
    </a>
    <a href="{{ url_for('admin_purchase.index', status='rejected') }}" 
       class="btn {% if status_filter == 'rejected' %}btn-primary{% else %}btn-secondary{% endif %}"
       style="min-width: 100px;">
        Rejected
    </a>
</div>

<!-- View Toggle (Mobile Only) -->
<div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
    <button id="viewToggle" class="btn btn-primary" onclick="toggleView()" style="display: none;">
        <span id="toggleIcon">üìä</span> <span id="toggleText">Table View</span>
    </button>
</div>

<!-- Requests List -->
{% if requests %}
<div class="card">
    
    <!-- Table View (Desktop default) -->
    <div id="tableView" class="desktop-table">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left;">Date</th>
                <th style="padding: 12px; text-align: left;">Employee</th>
                <th style="padding: 12px; text-align: left;">Item</th>
                <th style="padding: 12px; text-align: right;">Qty</th>
                <th style="padding: 12px; text-align: right;">Est. Price</th>
                <th style="padding: 12px; text-align: center;">Type</th>
                <th style="padding: 12px; text-align: center;">Status</th>
                <th style="padding: 12px; text-align: center;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for req in requests %}
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 12px;">{{ req.created_at.strftime('%d %b %Y') }}</td>
                <td style="padding: 12px;">{{ req.employee.name }}</td>
                <td style="padding: 12px;">{{ req.item_name }}</td>
                <td style="padding: 12px; text-align: right;">{{ req.quantity }}</td>
                <td style="padding: 12px; text-align: right; font-weight: 600;">‚Çπ{{ "{:,.2f}".format(req.estimated_price) }}</td>
                <td style="padding: 12px; text-align: center;">
                    <span style="background: {% if req.request_type == 'expense' %}#e3f2fd{% else %}#f3e5f5{% endif %}; 
                                 padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        {% if req.request_type == 'expense' %}üí∞ Expense{% else %}üì¶ Inventory{% endif %}
                    </span>
                </td>
                <td style="padding: 12px; text-align: center;">
                    <span style="background: {% if req.status == 'pending' %}#fff3cd{% elif req.status == 'approved' %}#d4edda{% else %}#f8d7da{% endif %}; 
                                 color: {% if req.status == 'pending' %}#856404{% elif req.status == 'approved' %}#155724{% else %}#721c24{% endif %}; 
                                 padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                        {% if req.status == 'pending' %}‚è≥ Pending{% elif req.status == 'approved' %}‚úÖ Approved{% else %}‚ùå Rejected{% endif %}
                    </span>
                </td>
                <td style="padding: 12px; text-align: center;">
                    <a href="{{ url_for('admin_purchase.view_request', request_id=req.id) }}" 
                       class="btn btn-primary" style="padding: 6px 15px; font-size: 13px;">
                        View
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <!-- End Table View -->
    
    <!-- Mobile Card View (Default on mobile) -->
    <div id="cardView" class="mobile-cards" style="display: none;">
        {% for req in requests %}
        <div class="request-card" style="background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <!-- Card Header -->
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div>
                    <div style="font-weight: 700; font-size: 16px; color: #2c3e50;">
                        {{ req.item_name }}
                    </div>
                    <div style="color: #7f8c8d; font-size: 13px; margin-top: 4px;">
                        üìÖ {{ req.created_at.strftime('%d %b %Y') }}
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                    {% if req.status == 'pending' %}
                    <span style="background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">
                        ‚è≥ Pending
                    </span>
                    {% elif req.status == 'approved' %}
                    <span style="background: #d4edda; color: #155724; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">
                        ‚úÖ Approved
                    </span>
                    {% else %}
                    <span style="background: #f8d7da; color: #721c24; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">
                        ‚ùå Rejected
                    </span>
                    {% endif %}
                    
                    {% if req.request_type == 'expense' %}
                    <span style="background: #e3f2fd; color: #1976d2; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">
                        üí∞ Expense
                    </span>
                    {% else %}
                    <span style="background: #f3e5f5; color: #7b1fa2; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">
                        üì¶ Inventory
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Employee Info -->
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">Requested By</div>
                <div style="font-size: 15px; font-weight: 600; color: #2c3e50;">{{ req.employee.name }}</div>
            </div>
            
            <!-- Details Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                <div style="background: #fff3e0; padding: 10px; border-radius: 6px;">
                    <div style="font-size: 11px; color: #e65100; margin-bottom: 4px;">Quantity</div>
                    <div style="font-size: 18px; font-weight: 700; color: #bf360c;">{{ req.quantity }}</div>
                </div>
                <div style="background: #e3f2fd; padding: 10px; border-radius: 6px;">
                    <div style="font-size: 11px; color: #1976d2; margin-bottom: 4px;">Est. Price</div>
                    <div style="font-size: 18px; font-weight: 700; color: #0d47a1;">‚Çπ{{ "{:,.2f}".format(req.estimated_price) }}</div>
                </div>
            </div>
            
            <!-- Action Button -->
            <a href="{{ url_for('admin_purchase.view_request', request_id=req.id) }}"
               style="display: block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
                      padding: 12px; border-radius: 6px; text-align: center; text-decoration: none; font-weight: 600; font-size: 14px;">
                üëÅÔ∏è View Details
            </a>
        </div>
        {% endfor %}
    </div>
    <!-- End Card View -->
    
</div>
{% else %}
<div class="card" style="text-align: center; padding: 60px;">
    <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
    <h3 style="color: #666; margin-bottom: 10px;">No Purchase Requests</h3>
    <p style="color: #999;">
        {% if status_filter == 'pending' %}
        No pending requests at the moment.
        {% elif status_filter == 'approved' %}
        No approved requests yet.
        {% elif status_filter == 'rejected' %}
        No rejected requests yet.
        {% else %}
        Employees haven't submitted any purchase requests yet.
        {% endif %}
    </p>
</div>
{% endif %}

<!-- Info Card -->
<div class="card" style="margin-top: 20px; background: #e8f4fd; border-left: 4px solid #2196F3;">
    <h3 style="color: #1976D2; margin-bottom: 10px;">üì± Employee Access</h3>
    <p style="color: #555; line-height: 1.6;">
        Employees can submit purchase requests at:<br>
        <strong style="color: #1976D2;">{{ tenant.subdomain }}.bizbooks.co.in/purchase-request</strong>
    </p>
</div>


<script>
// View toggle function
function toggleView() {
    const body = document.body;
    const toggleIcon = document.getElementById('toggleIcon');
    const toggleText = document.getElementById('toggleText');
    
    if (body.classList.contains('show-table')) {
        // Switch to Card View
        body.classList.remove('show-table');
        toggleIcon.textContent = 'üìä';
        toggleText.textContent = 'Table View';
        localStorage.setItem('purchaseReqViewPreference', 'cards');
    } else {
        // Switch to Table View
        body.classList.add('show-table');
        toggleIcon.textContent = 'üì±';
        toggleText.textContent = 'Card View';
        localStorage.setItem('purchaseReqViewPreference', 'table');
    }
}

// Load user preference on page load
document.addEventListener('DOMContentLoaded', function() {
    const preference = localStorage.getItem('purchaseReqViewPreference');
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile && preference === 'table') {
        document.body.classList.add('show-table');
        document.getElementById('toggleIcon').textContent = 'üì±';
        document.getElementById('toggleText').textContent = 'Card View';
    }
});
</script>

{% endblock %}
