{% extends "base_sidebar.html" %}
{% block title %}Purchase Request #{{ request.id }} - {{ tenant.company_name }}{% endblock %}
{% block page_title %}Purchase Request #{{ request.id }}{% endblock %}
{% block header_actions %}
<a href="{{ url_for('admin_purchase.index') }}" class="btn btn-secondary">
    ‚Üê Back to Requests
</a>
{% endblock %}
{% block content %}

<!-- Request Details -->
<div class="card">
    <h3>Request Details</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px;">
        <div>
            <label style="color: #666; font-size: 13px;">Employee</label>
            <div style="font-weight: 600; font-size: 16px;">{{ request.employee.name }}</div>
        </div>
        <div>
            <label style="color: #666; font-size: 13px;">Date Submitted</label>
            <div style="font-weight: 600; font-size: 16px;">{{ request.created_at.strftime('%d %B %Y, %I:%M %p') }}</div>
        </div>
        <div>
            <label style="color: #666; font-size: 13px;">Status</label>
            <div>
                <span style="background: {% if request.status == 'pending' %}#fff3cd{% elif request.status == 'approved' %}#d4edda{% else %}#f8d7da{% endif %}; 
                             color: {% if request.status == 'pending' %}#856404{% elif request.status == 'approved' %}#155724{% else %}#721c24{% endif %}; 
                             padding: 6px 15px; border-radius: 15px; font-size: 14px; font-weight: 600; display: inline-block;">
                    {% if request.status == 'pending' %}‚è≥ Pending{% elif request.status == 'approved' %}‚úÖ Approved{% else %}‚ùå Rejected{% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Item Information -->
<div class="card">
    <h3>Item Information</h3>
    <table style="width: 100%; margin-top: 15px;">
        <tr style="border-bottom: 1px solid #f0f0f0;">
            <td style="padding: 12px; color: #666; width: 150px;">Item Name:</td>
            <td style="padding: 12px; font-weight: 600;">{{ request.item_name }}</td>
        </tr>
        <tr style="border-bottom: 1px solid #f0f0f0;">
            <td style="padding: 12px; color: #666;">Quantity:</td>
            <td style="padding: 12px; font-weight: 600;">{{ request.quantity }}</td>
        </tr>
        <tr style="border-bottom: 1px solid #f0f0f0;">
            <td style="padding: 12px; color: #666;">Estimated Price:</td>
            <td style="padding: 12px; font-weight: 600; color: #28a745; font-size: 18px;">‚Çπ{{ "{:,.2f}".format(request.estimated_price) }}</td>
        </tr>
        <tr style="border-bottom: 1px solid #f0f0f0;">
            <td style="padding: 12px; color: #666;">Vendor:</td>
            <td style="padding: 12px; font-weight: 600;">{{ request.vendor_name or '‚Äî' }}</td>
        </tr>
        <tr style="border-bottom: 1px solid #f0f0f0;">
            <td style="padding: 12px; color: #666;">Type:</td>
            <td style="padding: 12px;">
                <span style="background: {% if request.request_type == 'expense' %}#e3f2fd{% else %}#f3e5f5{% endif %}; 
                             padding: 4px 12px; border-radius: 12px; font-size: 13px;">
                    {% if request.request_type == 'expense' %}üí∞ General Expense{% else %}üì¶ Add to Inventory{% endif %}
                </span>
            </td>
        </tr>
        <tr>
            <td style="padding: 12px; color: #666; vertical-align: top;">Reason:</td>
            <td style="padding: 12px;">{{ request.reason }}</td>
        </tr>
    </table>
</div>

<!-- Uploaded Document -->
{% if request.document_url %}
<div class="card">
    <h3>Uploaded Document</h3>
    <div style="margin-top: 15px;">
        {% if request.document_url.endswith(('.jpg', '.jpeg', '.png', '.gif')) %}
        <img src="{{ request.document_url }}" style="max-width: 100%; border-radius: 8px; border: 1px solid #ddd;">
        {% else %}
        <a href="{{ request.document_url }}" target="_blank" class="btn btn-primary" style="display: inline-block;">
            üìÑ View Document
        </a>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Approval/Rejection Status -->
{% if request.status != 'pending' %}
<div class="card" style="background: {% if request.status == 'approved' %}#d4edda{% else %}#f8d7da{% endif %};">
    <h3 style="color: {% if request.status == 'approved' %}#155724{% else %}#721c24{% endif %};">
        {% if request.status == 'approved' %}‚úÖ Approved{% else %}‚ùå Rejected{% endif %}
    </h3>
    <table style="width: 100%; margin-top: 15px;">
        <tr>
            <td style="padding: 8px; color: #555; width: 150px;">Processed By:</td>
            <td style="padding: 8px; font-weight: 600;">{{ request.processed_by }}</td>
        </tr>
        <tr>
            <td style="padding: 8px; color: #555;">Processed At:</td>
            <td style="padding: 8px; font-weight: 600;">{{ request.processed_at.strftime('%d %B %Y, %I:%M %p') }}</td>
        </tr>
        {% if request.status == 'approved' and request.admin_notes %}
        <tr>
            <td style="padding: 8px; color: #555; vertical-align: top;">Admin Notes:</td>
            <td style="padding: 8px;">{{ request.admin_notes }}</td>
        </tr>
        {% endif %}
        {% if request.status == 'rejected' %}
        <tr>
            <td style="padding: 8px; color: #555; vertical-align: top;">Rejection Reason:</td>
            <td style="padding: 8px;">{{ request.rejection_reason }}</td>
        </tr>
        {% endif %}
    </table>
</div>
{% endif %}

<!-- Action Forms (only for pending requests) -->
{% if request.status == 'pending' %}
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
    <!-- Approve Form -->
    <div class="card" style="background: #d4edda;">
        <h3 style="color: #155724;">‚úÖ Approve Request</h3>
        <form method="POST" action="{{ url_for('admin_purchase.approve_request', request_id=request.id) }}">
            <div class="form-group">
                <label class="field-label">Create As</label>
                <select name="action_type" id="action_type" onchange="toggleCategorySelection()" required>
                    <option value="expense" {% if request.request_type == 'expense' %}selected{% endif %}>Expense Record</option>
                    <option value="inventory" {% if request.request_type == 'inventory' %}selected{% endif %}>Inventory Item</option>
                </select>
            </div>
            
            <div class="form-group" id="expense_category_div" {% if request.request_type != 'expense' %}style="display: none;"{% endif %}>
                <label class="field-label">Expense Category</label>
                <select name="category_id" id="expense_category_select">
                    {% for cat in expense_categories %}
                    <option value="{{ cat.id }}" {% if request.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group" id="inventory_category_div" {% if request.request_type != 'inventory' %}style="display: none;"{% endif %}>
                <label class="field-label">Item Category</label>
                <select name="category_id" id="inventory_category_select">
                    {% for cat in item_categories %}
                    <option value="{{ cat.id }}" {% if request.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="field-label">Actual Amount (‚Çπ)</label>
                <input type="number" name="actual_amount" step="0.01" value="{{ request.estimated_price }}" required>
            </div>
            
            <div class="form-group" id="payment_method_div" {% if request.request_type != 'expense' %}style="display: none;"{% endif %}>
                <label class="field-label">Payment Method</label>
                <select name="payment_method">
                    <option value="Pending">Pending</option>
                    <option value="Cash">Cash</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="UPI">UPI</option>
                    <option value="Card">Card</option>
                    <option value="Cheque">Cheque</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="field-label">Admin Notes (Optional)</label>
                <textarea name="admin_notes" rows="2" placeholder="Any notes for the employee..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                ‚úÖ Approve & Create Record
            </button>
        </form>
    </div>
    
    <!-- Reject Form -->
    <div class="card" style="background: #f8d7da;">
        <h3 style="color: #721c24;">‚ùå Reject Request</h3>
        <form method="POST" action="{{ url_for('admin_purchase.reject_request', request_id=request.id) }}">
            <div class="form-group">
                <label class="field-label">Rejection Reason *</label>
                <textarea name="rejection_reason" rows="5" placeholder="Explain why this request is rejected..." required></textarea>
            </div>
            
            <button type="submit" class="btn btn-danger" style="width: 100%;" onclick="return confirm('Are you sure you want to reject this request?')">
                ‚ùå Reject Request
            </button>
        </form>
    </div>
</div>

<script>
function toggleCategorySelection() {
    const actionType = document.getElementById('action_type').value;
    const expenseDiv = document.getElementById('expense_category_div');
    const inventoryDiv = document.getElementById('inventory_category_div');
    const paymentDiv = document.getElementById('payment_method_div');
    
    if (actionType === 'expense') {
        expenseDiv.style.display = 'block';
        inventoryDiv.style.display = 'none';
        paymentDiv.style.display = 'block';
    } else {
        inventoryDiv.style.display = 'block';
        expenseDiv.style.display = 'none';
        paymentDiv.style.display = 'none';
    }
}
</script>
{% endif %}

{% endblock %}
