{% extends 'base_sidebar.html' %}

{% block title %}{% if invoice %}Edit Invoice{% else %}Create Invoice{% endif %} - {{ tenant.company_name }}{% endblock %}

{% block page_title %}{% if invoice %}Edit Invoice #{{ invoice.invoice_number }}{% else %}Create New Invoice{% endif %}{% endblock %}

{% block header_actions %}
<a href="{{ url_for('invoices.index') }}" class="btn btn-secondary">
    ‚Üê Back to Invoices
</a>
{% endblock %}

{% block content %}
<form method="POST" action="{% if invoice %}{{ url_for('invoices.edit', invoice_id=invoice.id) }}{% else %}{{ url_for('invoices.create') }}{% endif %}" id="invoiceForm">
    
    {% if sales_order %}
    <!-- Hidden field to link invoice to sales order -->
    <input type="hidden" name="sales_order_id" value="{{ sales_order.id }}">
    {% endif %}
    
    {% if delivery_challan %}
    <!-- Hidden field to link invoice to delivery challan -->
    <input type="hidden" name="delivery_challan_id" value="{{ delivery_challan.id }}">
    {% endif %}
    
    <!-- Customer Details Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Customer Details</h3>
        </div>
        
        <!-- Customer Search/Autocomplete -->
        <div class="form-group" style="position: relative;">
            <label class="field-label" for="customer_search">
                Search Existing Customer
            </label>
            <input type="text" id="customer_search" class="form-control" 
                   placeholder="Type customer name, code, or phone..." 
                   autocomplete="off"
                   oninput="searchCustomers(this.value)"
                   onfocus="searchCustomers(this.value)"
                   onblur="setTimeout(() => hideCustomerDropdown(), 200)">
            <div id="customer_dropdown" class="autocomplete-dropdown" style="display: none;"></div>
            <input type="hidden" id="customer_id" name="customer_id" value="{% if invoice and invoice.customer_id %}{{ invoice.customer_id }}{% endif %}">
            <small class="help-text" style="display: block; margin-top: 8px; color: #666; font-size: 13px;">
                {% if invoice and invoice.customer %}
                    ‚úÖ Linked to: <strong>{{ invoice.customer.customer_code }}</strong>
                {% else %}
                    Don't see your customer? <a href="javascript:void(0)" onclick="openAddCustomerModal()" style="color: #667eea; font-weight: 600; text-decoration: none;">‚ûï Add Customer</a>
                {% endif %}
            </small>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label class="field-label" for="customer_name">Customer Name *</label>
                <input type="text" id="customer_name" name="customer_name" class="form-control" 
                       value="{% if invoice %}{{ invoice.customer_name }}{% endif %}" required>
            </div>
            
            <div class="form-group">
                <label class="field-label" for="customer_phone">Phone Number</label>
                <input type="tel" id="customer_phone" name="customer_phone" class="form-control"
                       value="{% if invoice %}{{ invoice.customer_phone or '' }}{% endif %}">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label class="field-label" for="customer_email">Email Address</label>
                <input type="email" id="customer_email" name="customer_email" class="form-control"
                       value="{% if invoice %}{{ invoice.customer_email or '' }}{% endif %}">
            </div>
            
            <div class="form-group">
                <label class="field-label" for="customer_gstin">GSTIN (Optional)</label>
                <input type="text" id="customer_gstin" name="customer_gstin" class="form-control" 
                       placeholder="27XXXXX1234X1Z5" maxlength="15"
                       value="{% if invoice %}{{ invoice.customer_gstin or '' }}{% endif %}">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label class="field-label" for="customer_address">Address</label>
                <textarea id="customer_address" name="customer_address" class="form-control" rows="2">{% if invoice %}{{ invoice.customer_address or '' }}{% endif %}</textarea>
            </div>
            
            <div class="form-group">
                <label class="field-label" for="customer_state">State *</label>
                <select id="customer_state" name="customer_state" class="form-control" required>
                    {% set selected_state = invoice.customer_state if invoice else 'Maharashtra' %}
                    <option value="Andhra Pradesh" {% if selected_state == 'Andhra Pradesh' %}selected{% endif %}>Andhra Pradesh</option>
                    <option value="Arunachal Pradesh" {% if selected_state == 'Arunachal Pradesh' %}selected{% endif %}>Arunachal Pradesh</option>
                    <option value="Assam" {% if selected_state == 'Assam' %}selected{% endif %}>Assam</option>
                    <option value="Bihar" {% if selected_state == 'Bihar' %}selected{% endif %}>Bihar</option>
                    <option value="Chhattisgarh" {% if selected_state == 'Chhattisgarh' %}selected{% endif %}>Chhattisgarh</option>
                    <option value="Goa" {% if selected_state == 'Goa' %}selected{% endif %}>Goa</option>
                    <option value="Gujarat" {% if selected_state == 'Gujarat' %}selected{% endif %}>Gujarat</option>
                    <option value="Haryana" {% if selected_state == 'Haryana' %}selected{% endif %}>Haryana</option>
                    <option value="Himachal Pradesh" {% if selected_state == 'Himachal Pradesh' %}selected{% endif %}>Himachal Pradesh</option>
                    <option value="Jharkhand" {% if selected_state == 'Jharkhand' %}selected{% endif %}>Jharkhand</option>
                    <option value="Karnataka" {% if selected_state == 'Karnataka' %}selected{% endif %}>Karnataka</option>
                    <option value="Kerala" {% if selected_state == 'Kerala' %}selected{% endif %}>Kerala</option>
                    <option value="Madhya Pradesh" {% if selected_state == 'Madhya Pradesh' %}selected{% endif %}>Madhya Pradesh</option>
                    <option value="Maharashtra" {% if selected_state == 'Maharashtra' %}selected{% endif %}>Maharashtra</option>
                    <option value="Manipur" {% if selected_state == 'Manipur' %}selected{% endif %}>Manipur</option>
                    <option value="Meghalaya" {% if selected_state == 'Meghalaya' %}selected{% endif %}>Meghalaya</option>
                    <option value="Mizoram" {% if selected_state == 'Mizoram' %}selected{% endif %}>Mizoram</option>
                    <option value="Nagaland" {% if selected_state == 'Nagaland' %}selected{% endif %}>Nagaland</option>
                    <option value="Odisha" {% if selected_state == 'Odisha' %}selected{% endif %}>Odisha</option>
                    <option value="Punjab" {% if selected_state == 'Punjab' %}selected{% endif %}>Punjab</option>
                    <option value="Rajasthan" {% if selected_state == 'Rajasthan' %}selected{% endif %}>Rajasthan</option>
                    <option value="Sikkim" {% if selected_state == 'Sikkim' %}selected{% endif %}>Sikkim</option>
                    <option value="Tamil Nadu" {% if selected_state == 'Tamil Nadu' %}selected{% endif %}>Tamil Nadu</option>
                    <option value="Telangana" {% if selected_state == 'Telangana' %}selected{% endif %}>Telangana</option>
                    <option value="Tripura" {% if selected_state == 'Tripura' %}selected{% endif %}>Tripura</option>
                    <option value="Uttar Pradesh" {% if selected_state == 'Uttar Pradesh' %}selected{% endif %}>Uttar Pradesh</option>
                    <option value="Uttarakhand" {% if selected_state == 'Uttarakhand' %}selected{% endif %}>Uttarakhand</option>
                    <option value="West Bengal" {% if selected_state == 'West Bengal' %}selected{% endif %}>West Bengal</option>
                    <option value="Delhi" {% if selected_state == 'Delhi' %}selected{% endif %}>Delhi</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Loyalty Program Section -->
    <div id="loyaltySection" class="card loyalty-card" style="display: none;">
        <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
            <h3 class="card-title">üí∞ Loyalty Points</h3>
        </div>
        <div class="card-body">
            <div class="loyalty-info">
                <div class="loyalty-balance">
                    <div class="balance-label">Current Balance:</div>
                    <div class="balance-value">
                        <span id="loyaltyPoints">0</span> pts
                        <span class="balance-subtext">(= ‚Çπ<span id="loyaltyValue">0</span>)</span>
                    </div>
                </div>
                <div class="loyalty-actions">
                    <button type="button" class="btn btn-success" id="redeemPointsBtn" onclick="openRedeemModal()">
                        üí∞ Use Points for Discount
                    </button>
                </div>
            </div>
            
            <!-- Points to be earned (preview) -->
            <div class="points-preview" id="pointsPreview" style="display: none;">
                <div class="preview-icon">üéÅ</div>
                <div class="preview-content">
                    <strong>Points to be earned on this invoice:</strong>
                    <div class="preview-details">
                        <span id="basePointsPreview">0</span> pts (base)
                        <span id="bonusPointsPreview" style="display: none;"> + <span id="bonusPoints">0</span> pts (bonus)</span>
                        = <strong id="totalPointsPreview">0</strong> pts total
                    </div>
                    <small>New balance: <span id="newBalancePreview">0</span> pts</small>
                </div>
            </div>
            
            <!-- Redeemed points display -->
            <div class="loyalty-redeemed" id="loyaltyRedeemed" style="display: none;">
                <div class="redeemed-badge">
                    ‚úÖ <span id="redeemedPoints">0</span> points redeemed ‚Üí ‚Çπ<span id="redeemedValue">0</span> discount
                    <button type="button" class="btn-remove-loyalty" onclick="removeLoyaltyDiscount()">‚úï</button>
                </div>
            </div>
            
            <!-- Hidden inputs for loyalty -->
            <input type="hidden" id="loyalty_points_redeemed" name="loyalty_points_redeemed" value="0">
            <input type="hidden" id="loyalty_discount" name="loyalty_discount" value="0">
        </div>
    </div>
    
    <!-- Invoice Details Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Invoice Details</h3>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label class="field-label" for="invoice_date">Invoice Date *</label>
                <input type="date" id="invoice_date" name="invoice_date" class="form-control" 
                       value="{% if invoice %}{{ invoice.invoice_date if invoice.invoice_date is string else invoice.invoice_date.strftime('%Y-%m-%d') }}{% else %}{{ today }}{% endif %}" required>
            </div>
            
            <div class="form-group">
                <label class="field-label" for="due_date">Due Date (Optional)</label>
                <input type="date" id="due_date" name="due_date" class="form-control"
                       value="{% if invoice and invoice.due_date %}{{ invoice.due_date if invoice.due_date is string else invoice.due_date.strftime('%Y-%m-%d') }}{% endif %}">
            </div>
        </div>
        
        <!-- üÜï Invoice Type Selection (GST Smart Invoice Management) -->
        <div class="form-row" style="margin-top: 15px; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #f5f7fa 100%); border-radius: 8px; border: 2px solid #2196F3;">
            <div class="form-group" style="width: 100%;">
                <label style="font-weight: 700; color: #1976D2; font-size: 16px; margin-bottom: 15px; display: block;">
                    üìã Invoice Type
                </label>
                
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <!-- Taxable Invoice (Regular GST) -->
                    <label style="flex: 1; min-width: 200px; padding: 15px; background: white; border: 2px solid #4CAF50; border-radius: 8px; cursor: pointer; transition: all 0.3s;" 
                           class="invoice-type-option" data-type="taxable">
                        <input type="radio" name="invoice_type" value="taxable" id="invoiceTypeTaxable" 
                               {% if not invoice or invoice.invoice_type == 'taxable' %}checked{% endif %}
                               onchange="updateInvoiceTypeUI()" 
                               style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="display: inline-block; vertical-align: top;">
                            <strong style="color: #2E7D32; font-size: 15px;">‚úÖ Taxable (GST Invoice)</strong>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                                Regular invoice with GST charges<br>
                                <span style="color: #4CAF50;">Requires GST stock</span>
                            </p>
                        </div>
                    </label>
                    
                    <!-- Non-Taxable Invoice (Kaccha Bill) -->
                    <label style="flex: 1; min-width: 200px; padding: 15px; background: white; border: 2px solid #FF9800; border-radius: 8px; cursor: pointer; transition: all 0.3s;" 
                           class="invoice-type-option" data-type="non_taxable">
                        <input type="radio" name="invoice_type" value="non_taxable" id="invoiceTypeNonTaxable" 
                               onchange="updateInvoiceTypeUI()" 
                               style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="display: inline-block; vertical-align: top;">
                            <strong style="color: #F57C00; font-size: 15px;">üìÑ Non-Taxable (Kaccha Bill)</strong>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                                Invoice without GST (cash sales)<br>
                                <span style="color: #FF9800;">Can use any stock</span>
                            </p>
                        </div>
                    </label>
                    
                    <!-- Credit Adjustment Invoice -->
                    <label style="flex: 1; min-width: 200px; padding: 15px; background: white; border: 2px solid #9C27B0; border-radius: 8px; cursor: pointer; transition: all 0.3s;" 
                           class="invoice-type-option" data-type="credit_adjustment">
                        <input type="radio" name="invoice_type" value="credit_adjustment" id="invoiceTypeCreditAdj" 
                               onchange="updateInvoiceTypeUI()" 
                               style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="display: inline-block; vertical-align: top;">
                            <strong style="color: #7B1FA2; font-size: 15px;">üîÑ Credit Adjustment</strong>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                                GST compliance for kaccha bills<br>
                                <span style="color: #9C27B0;">No stock impact</span>
                            </p>
                        </div>
                    </label>
                </div>
                
                <!-- Hidden checkbox for backward compatibility -->
                <input type="hidden" id="gstEnabled" name="gst_enabled" value="1">
            </div>
        </div>
        
        <!-- üÜï Credit Adjustment Details (Hidden by default) -->
        <div id="creditAdjustmentSection" style="margin-top: 15px; padding: 20px; background: #f3e5f5; border-radius: 8px; border-left: 4px solid #9C27B0; display: none;">
            <h4 style="color: #7B1FA2; margin-top: 0;">üîÑ Credit Adjustment Details</h4>
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                Create a GST-compliant invoice for a previous kaccha bill. Stock will NOT be reduced (already reduced in original invoice).
            </p>
            
            <div class="form-row" style="gap: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label class="field-label">Original Invoice (Optional)</label>
                    <select id="linkedInvoiceId" name="linked_invoice_id" class="form-control">
                        <option value="">--- Not Linked ---</option>
                        <!-- Will be populated dynamically with non-taxable invoices -->
                    </select>
                    <small class="help-text">Link to the original kaccha bill (for reference only)</small>
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label class="field-label">Commission Rate (%)</label>
                    <input type="number" id="creditCommissionRate" name="credit_commission_rate" 
                           class="form-control" value="5" min="0" max="100" step="0.1">
                    <small class="help-text">Your benefit for GST compliance work (recorded as "Other Income")</small>
                </div>
            </div>
            
            <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 15px;">
                <strong style="color: #7B1FA2;">üí° How Credit Adjustment Works:</strong>
                <ul style="margin: 10px 0 0 20px; font-size: 13px; color: #666; line-height: 1.8;">
                    <li>Customer already paid (via kaccha bill)</li>
                    <li>Create this invoice to show GST breakdown for compliance</li>
                    <li>Stock is NOT reduced (already done in kaccha bill)</li>
                    <li>Commission recorded as "Other Income" (your benefit)</li>
                    <li>Appears in GSTR-1 report for CA filing</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Commission Section (Optional) -->
    <div class="card" style="background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%); border: 2px solid #e3f2fd;">
        <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h3 class="card-title">üí∞ Commission (Optional - Internal Use Only)</h3>
            <small style="opacity: 0.9; display: block; margin-top: 5px; font-weight: normal;">
                Select a sales agent to track commission. This will NOT appear on customer invoice.
            </small>
        </div>
        
        <div class="form-row">
            <div class="form-group" style="flex: 2;">
                <label class="field-label" for="commission_agent_id">Sales Agent / Commission Recipient</label>
                <select id="commission_agent_id" name="commission_agent_id" class="form-control" 
                        onchange="updateCommissionRate()">
                    <option value="">--- No Commission ---</option>
                    <optgroup label="üë§ Employees">
                        {% if commission_agents_employee %}
                            {% for agent in commission_agents_employee %}
                            <option value="{{ agent.id }}" 
                                    data-rate="{{ agent.default_commission_percentage }}"
                                    data-type="employee"
                                    {% if invoice and invoice.commission and invoice.commission.agent_id == agent.id %}selected{% endif %}>
                                {{ agent.name }} ({{ agent.code }}) - {{ agent.default_commission_percentage }}%
                            </option>
                            {% endfor %}
                        {% endif %}
                    </optgroup>
                    <optgroup label="üë• External Agents">
                        {% if commission_agents_external %}
                            {% for agent in commission_agents_external %}
                            <option value="{{ agent.id }}" 
                                    data-rate="{{ agent.default_commission_percentage }}"
                                    data-type="external"
                                    {% if invoice and invoice.commission and invoice.commission.agent_id == agent.id %}selected{% endif %}>
                                {{ agent.name }} ({{ agent.code }}) - {{ agent.default_commission_percentage }}%
                            </option>
                            {% endfor %}
                        {% endif %}
                    </optgroup>
                </select>
                <small class="help-text">
                    üí° Employees must be enabled for commission in the Employee Management section.
                </small>
            </div>
            
            <div class="form-group">
                <label class="field-label" for="commission_percentage">Commission % <span style="color: #999;">(Override if needed)</span></label>
                <input type="number" id="commission_percentage" name="commission_percentage" 
                       class="form-control" step="0.01" min="0" max="100" 
                       placeholder="Auto-filled"
                       value="{% if invoice and invoice.commission %}{{ invoice.commission.commission_percentage }}{% endif %}"
                       oninput="calculateCommission()">
                <small style="color: #666;" id="commission_calc_display">
                    Commission: ‚Çπ0.00
                </small>
            </div>
        </div>
    </div>
    
    <!-- Invoice Items Card -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">Invoice Items</h3>
            <button type="button" class="btn btn-primary btn-sm" onclick="addItemRow()">
                + Add Item
            </button>
        </div>
        
        <!-- BARCODE SCANNER INPUT -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; margin: 0; border-radius: 0;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="flex: 0 0 auto;">
                    <div style="width: 48px; height: 48px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                        üì±
                    </div>
                </div>
                <div style="flex: 1;">
                    <label style="color: white; font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block;">
                        Scan Barcode or Type to Search Items
                    </label>
                    <input type="text" 
                           id="barcodeScanner" 
                           placeholder="Focus here and scan barcode or type item name..." 
                           autocomplete="off"
                           style="width: 100%; padding: 12px 16px; font-size: 16px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.95); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <small id="barcodeScannerHint" style="color: rgba(255, 255, 255, 0.9); font-size: 12px; display: block; margin-top: 6px;">
                        üí° Tip: Keep this field focused for quick scanning. Press Tab to skip.
                    </small>
                </div>
            </div>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="table" id="itemsTable">
                <thead>
                    <tr>
                        <th style="width: 30px;">#</th>
                        <th style="min-width: 200px;">Item Name *</th>
                        <th style="min-width: 100px;">HSN/SAC</th>
                        <th style="width: 80px;">Qty *</th>
                        <th style="width: 90px;">MRP</th>
                        <th style="width: 70px;">Disc %</th>
                        <th style="width: 80px;">Unit</th>
                        <th style="width: 100px;" id="rateHeader">Rate *</th>
                        <th style="width: 80px;" id="gstHeader">GST %</th>
                        <th style="width: 120px;">Amount</th>
                        <th style="width: 50px;">Action</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    <!-- Items will be added here -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="9" style="text-align: right; font-weight: bold;">Subtotal:</td>
                        <td><span id="subtotalDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="9" style="text-align: right;">
                            Discount: 
                            <select id="discountType" name="discount_type" onchange="calculateTotal()" 
                                    style="width: 80px; display: inline-block; margin-left: 10px; padding: 5px;">
                                <option value="percentage">%</option>
                                <option value="flat" selected>‚Çπ</option>
                            </select>
                            <input type="number" id="discountValue" name="discount_value" step="0.01" min="0" 
                                   value="0" onchange="calculateTotal()" 
                                   placeholder="0" 
                                   style="width: 100px; display: inline-block; margin-left: 5px; padding: 5px; text-align: right;">
                            <input type="hidden" id="discountAmount" name="discount" value="0">
                        </td>
                        <td><span id="discountDisplay">-‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr id="loyaltyDiscountRow" style="display: none;">
                        <td colspan="9" style="text-align: right; color: #10b981; font-weight: 600;">
                            Loyalty Discount:
                        </td>
                        <td style="color: #10b981; font-weight: 600;"><span id="loyaltyDiscountDisplay">-‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr id="cgstRow">
                        <td colspan="9" style="text-align: right;">CGST:</td>
                        <td><span id="cgstDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr id="sgstRow">
                        <td colspan="9" style="text-align: right;">SGST:</td>
                        <td><span id="sgstDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr id="igstRow" style="display: none;">
                        <td colspan="9" style="text-align: right;">IGST:</td>
                        <td><span id="igstDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="9" style="text-align: right;">Gross Total:</td>
                        <td><span id="grossTotalDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="9" style="text-align: right;">Round-off:</td>
                        <td><span id="roundOffDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr style="background: #f8f9fa;">
                        <td colspan="9" style="text-align: right; font-weight: bold; font-size: 18px;">Net Total:</td>
                        <td style="font-weight: bold; font-size: 18px;"><span id="totalDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    <!-- Notes Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Additional Information</h3>
        </div>
        
        <!-- üÜï Credit Adjustment Payment Info (shown only for credit adjustment) -->
        <div id="creditAdjustmentPaymentInfo" style="display: none; padding: 15px; background: #f3e5f5; border-radius: 8px; border-left: 4px solid #9C27B0; margin-bottom: 15px;">
            <strong style="color: #7B1FA2;">üí° Payment Information</strong>
            <p style="margin: 10px 0 0 0; font-size: 13px; color: #666;">
                ‚úÖ Customer already paid via the original kaccha bill.<br>
                ‚úÖ No new payment is being collected.<br>
                ‚úÖ This invoice is for GST compliance only - no account will be credited.<br>
                ‚úÖ Prevents double-counting of payment.
            </p>
        </div>
        
        <div class="form-group" id="paymentStatusGroup">
            <label class="field-label" for="payment_received">Payment Status *</label>
            {% set payment_status = invoice.payment_status if invoice else 'unpaid' %}
            <select id="payment_received" name="payment_received" class="form-control" required onchange="togglePaymentDetails(this.value)">
                <option value="no" {% if payment_status == 'unpaid' %}selected{% endif %}>Credit Sale (Payment Pending)</option>
                <option value="yes" {% if payment_status == 'paid' %}selected{% endif %}>Cash Sale (Payment Received)</option>
            </select>
            <small class="help-text">Select if payment has been received or it's a credit sale</small>
        </div>
        
        <div id="paymentDetails" style="{% if invoice and invoice.payment_status == 'paid' %}display: block;{% else %}display: none;{% endif %}">
            <!-- Hidden: Payment Method (redundant - account selection handles this) -->
            <input type="hidden" id="payment_method" name="payment_method" value="Cash">
            
            <div class="form-group">
                <label class="field-label" for="payment_reference">Payment Reference (Optional)</label>
                <input type="text" id="payment_reference" name="payment_reference" class="form-control" 
                       placeholder="Transaction ID, Cheque No, etc."
                       value="{% if invoice and invoice.internal_notes %}{{ invoice.internal_notes.replace('Payment Reference: ', '') }}{% endif %}">
            </div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label class="field-label field-label--required" for="payment_account_id">üí∞ Deposit To Account</label>
                <select id="payment_account_id" name="payment_account_id" class="form-control" required>
                    <option value="">-- Select Bank/Cash Account --</option>
                    {% if bank_accounts %}
                        {% for account in bank_accounts %}
                            <option value="{{ account.id }}" 
                                    {% if account.is_default %}selected{% endif %}>
                                {% if account.account_type == 'cash' %}üíµ{% elif account.account_type == 'bank' %}üè¶{% else %}üí∞{% endif %}
                                {{ account.account_name }}
                                {% if account.bank_name %}({{ account.bank_name }}){% endif %}
                                - ‚Çπ{{ "{:,.2f}".format(account.current_balance) }}
                            </option>
                        {% endfor %}
                    {% else %}
                        <option value="" disabled>No accounts found - Please add a bank/cash account first</option>
                    {% endif %}
                </select>
                <small style="display: block; margin-top: 5px; color: #666;">
                    üí° Payment will be credited to this account
                </small>
            </div>
        </div>
        
        <div class="form-group">
            <label class="field-label" for="notes">Terms & Conditions / Notes</label>
            <textarea id="notes" name="notes" class="form-control" rows="3" 
                      placeholder="Payment due within 30 days...">{% if invoice and invoice.notes %}{{ invoice.notes }}{% else %}{{ tenant_settings.get('invoice_terms', 'Payment due within 30 days. Goods once sold will not be taken back.') }}{% endif %}</textarea>
        </div>
    </div>
    
    <!-- Submit Buttons -->
    <div style="display: flex; gap: 15px; margin-bottom: 100px; padding-top: 20px;">
        <button type="submit" class="btn btn-primary" style="flex: 1;">
            {% if invoice %}‚úèÔ∏è Update Invoice{% else %}üíæ Save Invoice{% endif %}
        </button>
        <a href="{{ url_for('invoices.index') }}" class="btn btn-secondary" style="flex: 1;">
            Cancel
        </a>
    </div>
    
    <script>
    function togglePaymentDetails(value) {
        const paymentDetails = document.getElementById('paymentDetails');
        if (value === 'yes') {
            paymentDetails.style.display = 'block';
        } else {
            paymentDetails.style.display = 'none';
        }
    }
    
    // üÜï GST SMART INVOICE: Handle invoice type changes
    function updateInvoiceTypeUI() {
        const invoiceType = document.querySelector('input[name="invoice_type"]:checked').value;
        const creditSection = document.getElementById('creditAdjustmentSection');
        const gstEnabledHidden = document.getElementById('gstEnabled');
        const paymentStatusGroup = document.getElementById('paymentStatusGroup');
        const paymentDetails = document.getElementById('paymentDetails');
        const creditPaymentInfo = document.getElementById('creditAdjustmentPaymentInfo');
        
        // Update visual selection (border highlight)
        document.querySelectorAll('.invoice-type-option').forEach(opt => {
            opt.style.transform = 'scale(1)';
            opt.style.boxShadow = 'none';
        });
        
        const selectedOption = document.querySelector(`.invoice-type-option[data-type="${invoiceType}"]`);
        if (selectedOption) {
            selectedOption.style.transform = 'scale(1.02)';
            selectedOption.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        }
        
        // Show/hide credit adjustment section
        if (invoiceType === 'credit_adjustment') {
            creditSection.style.display = 'block';
            gstEnabledHidden.value = '1';  // Credit adjustment has GST
            
            // üÜï HIDE payment section (no payment collected)
            if (paymentStatusGroup) paymentStatusGroup.style.display = 'none';
            if (paymentDetails) paymentDetails.style.display = 'none';
            if (creditPaymentInfo) creditPaymentInfo.style.display = 'block';
            
            // Set payment_received to 'no' (backend compatibility)
            const paymentSelect = document.getElementById('payment_received');
            if (paymentSelect) paymentSelect.value = 'no';
            
            // Load non-taxable invoices for linking
            loadNonTaxableInvoices();
        } else {
            creditSection.style.display = 'none';
            
            // üÜï SHOW payment section for normal invoices
            if (paymentStatusGroup) paymentStatusGroup.style.display = 'block';
            if (creditPaymentInfo) creditPaymentInfo.style.display = 'none';
            
            // Update hidden gst_enabled field (backward compatibility)
            if (invoiceType === 'taxable') {
                gstEnabledHidden.value = '1';
            } else {
                gstEnabledHidden.value = '0';
            }
        }
        
        // Trigger GST row visibility update
        toggleGSTRows();
    }
    
    // Load non-taxable invoices for credit adjustment linking
    function loadNonTaxableInvoices() {
        const select = document.getElementById('linkedInvoiceId');
        if (!select) return;
        
        if (select.options.length > 1) return;  // Already loaded
        
        // Show loading state
        select.innerHTML = '<option value="">--- Not Linked (Optional) ---</option>';
        select.innerHTML += '<option disabled>Loading recent kaccha bills...</option>';
        
        // Fetch recent non-taxable invoices via API
        fetch('/api/invoices/non-taxable?limit=50')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.invoices) {
                    // Clear loading
                    select.innerHTML = '<option value="">--- Not Linked (Optional) ---</option>';
                    
                    if (data.invoices.length === 0) {
                        select.innerHTML += '<option disabled>No kaccha bills found</option>';
                    } else {
                        // Populate with invoices
                        data.invoices.forEach(inv => {
                            const option = document.createElement('option');
                            option.value = inv.id;
                            option.textContent = `${inv.invoice_number} - ${inv.customer_name} (‚Çπ${inv.total_amount}) - ${inv.invoice_date}`;
                            select.appendChild(option);
                        });
                    }
                } else {
                    select.innerHTML = '<option value="">--- Not Linked (Optional) ---</option>';
                    select.innerHTML += '<option disabled>Error loading invoices</option>';
                }
            })
            .catch(error => {
                console.error('Error loading non-taxable invoices:', error);
                select.innerHTML = '<option value="">--- Not Linked (Optional) ---</option>';
                select.innerHTML += '<option disabled>Error loading invoices</option>';
            });
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateInvoiceTypeUI();
    });
    </script>
    
</form>

<style>
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #2c3e50;
    }
    
    .form-control {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #3498db;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    .table td {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .table tfoot td {
        padding: 12px;
        font-weight: 600;
    }
    
    .table input, .table select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .btn-danger-small {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-danger-small:hover {
        background: #c0392b;
    }
    
    /* Autocomplete Dropdown Styles */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .autocomplete-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
    }
    
    .autocomplete-item:hover {
        background: #f8f9fa;
    }
    
    .autocomplete-item-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
    }
    
    .autocomplete-item-details {
        font-size: 12px;
        color: #666;
        display: flex;
        gap: 15px;
    }
    
    .autocomplete-item-details span {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .autocomplete-no-results {
        padding: 20px;
        text-align: center;
        color: #999;
        font-size: 14px;
    }
    
    /* Loyalty Program Styles */
    .loyalty-card .card-body {
        padding: 20px;
    }
    
    .loyalty-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-radius: 12px;
        margin-bottom: 15px;
    }
    
    .loyalty-balance {
        flex: 1;
    }
    
    .balance-label {
        font-size: 13px;
        color: #059669;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .balance-value {
        font-size: 28px;
        font-weight: 700;
        color: #10b981;
    }
    
    .balance-subtext {
        font-size: 16px;
        color: #059669;
        font-weight: 500;
    }
    
    .loyalty-actions {
        flex: 0 0 auto;
    }
    
    .points-preview {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border-radius: 8px;
        border-left: 4px solid #f59e0b;
        margin-bottom: 15px;
    }
    
    .preview-icon {
        font-size: 32px;
        flex: 0 0 auto;
    }
    
    .preview-content {
        flex: 1;
        font-size: 14px;
    }
    
    .preview-content strong {
        color: #b45309;
    }
    
    .preview-details {
        font-size: 16px;
        margin: 5px 0;
        color: #92400e;
    }
    
    .preview-content small {
        color: #92400e;
        font-size: 13px;
    }
    
    .loyalty-redeemed {
        padding: 15px;
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border-radius: 8px;
        border-left: 4px solid #10b981;
    }
    
    .redeemed-badge {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 15px;
        font-weight: 600;
        color: #059669;
    }
    
    .btn-remove-loyalty {
        background: none;
        border: none;
        color: #dc2626;
        font-size: 18px;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background 0.2s;
    }
    
    .btn-remove-loyalty:hover {
        background: rgba(220, 38, 38, 0.1);
    }
    
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .table {
            font-size: 12px;
        }
        
        .table input, .table select {
            padding: 6px;
            font-size: 12px;
        }
        
        .autocomplete-item {
            padding: 10px;
        }
        
        .autocomplete-item-details {
            font-size: 11px;
            flex-direction: column;
            gap: 4px;
        }
    }
</style>

<script>
    let itemCount = 0;
    // PERFORMANCE: Items now loaded via API for instant page load
    // const items = {{ items|tojson }};  // OLD: Loaded all items (slow with 20K+ items)
    const items = [];  // NEW: Empty array, items loaded via API as user types
    const tenantState = "{{ tenant_settings.get('state', 'Maharashtra') }}";
    
    {% if sales_order %}
    // Sales Order data for pre-filling
    const salesOrderData = {
        customer: {
            id: {{ sales_order.customer_id or 'null' }},
            name: "{{ sales_order.customer_name | replace('"', '\\"') }}",
            phone: "{{ sales_order.customer_phone or '' }}",
            email: "{{ sales_order.customer_email or '' }}",
            gstin: "{{ sales_order.customer_gstin or '' }}",
            address: "{{ sales_order.customer_billing_address or '' }}",
            state: "{{ sales_order.customer_state or 'Maharashtra' }}"
        },
        items: [
            {% for item in sales_order.items %}
            {
                item_id: {{ item.item_id or 'null' }},
                item_name: "{{ item.item_name | replace('"', '\\"') }}",
                hsn_code: "{{ item.hsn_code or '' }}",
                quantity: {{ item.quantity }},
                unit: "{{ item.unit or 'Nos' }}",
                rate: {{ item.rate }},
                gst_rate: {{ item.gst_rate }},
                price_inclusive: {{ 'true' if item.price_inclusive else 'false' }},
                discount_value: {{ item.discount_value or 0 }},
                discount_type: "{{ item.discount_type or 'percentage' }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        notes: "{{ sales_order.terms or '' }}"
    };
    {% else %}
    const salesOrderData = null;
    {% endif %}
    
    // Delivery Challan data for pre-filling
    {% if delivery_challan %}
    const deliveryChallanData = {
        customer: {
            id: {{ delivery_challan.customer_id or 'null' }},
            name: "{{ delivery_challan.customer_name | replace('"', '\\"') }}",
            phone: "{{ delivery_challan.customer_phone or '' }}",
            email: "{{ delivery_challan.customer_email or '' }}",
            gstin: "{{ delivery_challan.customer_gstin or '' }}",
            address: "{{ delivery_challan.customer_billing_address or '' }}",
            state: "{{ delivery_challan.customer_state or 'Maharashtra' }}"
        },
        items: [
            {% for item in delivery_challan.items %}
            {
                item_id: {{ item.item_id or 'null' }},
                item_name: "{{ item.item_name | replace('"', '\\"') }}",
                hsn_code: "{{ item.hsn_code or '' }}",
                quantity: {{ item.quantity }},
                unit: "{{ item.unit or 'Nos' }}",
                rate: {{ item.rate }},
                gst_rate: {{ item.gst_rate }},
                price_inclusive: false,
                discount_value: 0,
                discount_type: "percentage"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        notes: "{{ delivery_challan.notes or '' }}"
    };
    {% else %}
    const deliveryChallanData = null;
    {% endif %}
    
    // Add first item row on page load (or pre-fill from sales order/delivery challan)
    window.addEventListener('DOMContentLoaded', function() {
        {% if sales_order %}
        preFillFromSalesOrder();
        {% elif delivery_challan %}
        preFillFromDeliveryChallan();
        {% else %}
        // Don't add default row - user will add items via barcode or manual search
        // addItemRow();
        {% endif %}
        
        // Initialize barcode scanner
        initBarcodeScanner();
    });
    
    // ========================================
    // BARCODE SCANNER FUNCTIONALITY
    // ========================================
    
    let barcodeBuffer = '';
    let barcodeTimeout = null;
    let isSearching = false;  // üîß FIX: Prevent duplicate searches!
    
    function initBarcodeScanner() {
        const scannerInput = document.getElementById('barcodeScanner');
        
        // Auto-focus on load
        scannerInput.focus();
        
        // Handle input (for both typing and scanning)
        scannerInput.addEventListener('input', function(e) {
            const value = e.target.value.trim();
            
            // Clear previous timeout
            if (barcodeTimeout) {
                clearTimeout(barcodeTimeout);
            }
            
            // Wait 300ms after last keystroke (allows manual typing)
            barcodeTimeout = setTimeout(() => {
                if (value.length >= 3 && !isSearching) {  // üîß FIX: Check if already searching
                    searchByBarcodeOrName(value);
                }
            }, 300);
        });
        
        // Handle Enter key (immediate search)
        scannerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                
                // üîß FIX: Clear the timeout to prevent double search!
                if (barcodeTimeout) {
                    clearTimeout(barcodeTimeout);
                    barcodeTimeout = null;
                }
                
                const value = e.target.value.trim();
                if (value.length > 0 && !isSearching) {  // üîß FIX: Check if already searching
                    searchByBarcodeOrName(value);
                }
            }
        });
        
        // Re-focus on click anywhere on the scanner box
        scannerInput.parentElement.parentElement.addEventListener('click', function() {
            scannerInput.focus();
        });
    }
    
    function searchByBarcodeOrName(query) {
        // üîß FIX: Prevent duplicate searches!
        if (isSearching) {
            console.log('üö´ Already searching, skipping duplicate request');
            return;
        }
        
        isSearching = true;  // üîß FIX: Set flag
        
        const scannerInput = document.getElementById('barcodeScanner');
        const hint = document.getElementById('barcodeScannerHint');
        
        // Show searching status
        hint.textContent = '‚è≥ Searching...';
        hint.style.color = 'rgba(255, 255, 255, 0.9)';
        
        // Try barcode search first
        fetch(`/api/barcode/search?code=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.found) {
                    // Barcode found!
                    playSuccessBeep();
                    hint.textContent = `‚úÖ Found: ${data.item.name}`;
                    hint.style.color = '#4ade80';
                    
                    // Add item to invoice
                    addItemToInvoice(data.item);
                    
                    // Clear and refocus
                    scannerInput.value = '';
                    setTimeout(() => {
                        hint.textContent = 'üí° Tip: Keep this field focused for quick scanning. Press Tab to skip.';
                        hint.style.color = 'rgba(255, 255, 255, 0.9)';
                        scannerInput.focus();
                        isSearching = false;  // üîß FIX: Clear flag
                    }, 1500);
                } else {
                    // Barcode not found, try name search
                    searchItemsByName(query);
                }
            })
            .catch(error => {
                console.error('Barcode search error:', error);
                // Fallback to name search
                searchItemsByName(query);
            });
    }
    
    function searchItemsByName(query) {
        const scannerInput = document.getElementById('barcodeScanner');
        const hint = document.getElementById('barcodeScannerHint');
        
        // Use API to search items (fast with any number of items)
        fetch(`/admin/items/api/search?q=${encodeURIComponent(query)}&limit=5`)
            .then(response => response.json())
            .then(results => {
                if (results.length === 1) {
                    // Exact match - add item
                    playSuccessBeep();
                    hint.textContent = `‚úÖ Found: ${results[0].name}`;
                    hint.style.color = '#4ade80';
                    
                    addItemToInvoice(results[0]);
                    
                    scannerInput.value = '';
                    setTimeout(() => {
                        hint.textContent = 'üí° Tip: Keep this field focused for quick scanning. Press Tab to skip.';
                        hint.style.color = 'rgba(255, 255, 255, 0.9)';
                        scannerInput.focus();
                        isSearching = false;  // üîß FIX: Clear flag
                    }, 1500);
                } else if (results.length > 1) {
                    // Multiple matches
                    playWarningBeep();
                    hint.textContent = `‚ö†Ô∏è ${results.length} items found. Please be more specific.`;
                    hint.style.color = '#fbbf24';
                    isSearching = false;  // üîß FIX: Clear flag
                } else {
                    // No matches
                    playErrorBeep();
                    hint.textContent = `‚ùå Item not found: "${query}"`;
                    hint.style.color = '#f87171';
                    
                    setTimeout(() => {
                        hint.textContent = 'üí° Tip: Keep this field focused for quick scanning. Press Tab to skip.';
                        hint.style.color = 'rgba(255, 255, 255, 0.9)';
                        isSearching = false;  // üîß FIX: Clear flag
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                playErrorBeep();
                hint.textContent = `‚ùå Search failed. Please try again.`;
                hint.style.color = '#f87171';
                isSearching = false;  // üîß FIX: Clear flag
            });
    }
    
    function addItemToInvoice(item) {
        // Check if item already exists in invoice
        const existingRow = findItemInInvoice(item.id);
        
        if (existingRow) {
            // Increment quantity
            const qtyInput = existingRow.querySelector('input[name="quantity[]"]');
            qtyInput.value = parseInt(qtyInput.value) + 1;
            qtyInput.dispatchEvent(new Event('input'));  // Trigger recalculation
            
            // Flash the row
            existingRow.style.background = '#d4edda';
            setTimeout(() => {
                existingRow.style.background = '';
            }, 500);
        } else {
            // Add new row with item data
            addItemRowWithData(item);
        }
    }
    
    function findItemInInvoice(itemId) {
        const tbody = document.getElementById('itemsTableBody');
        const rows = tbody.querySelectorAll('tr');
        
        for (let row of rows) {
            const itemIdInput = row.querySelector('input[name="item_id[]"]');
            if (itemIdInput && parseInt(itemIdInput.value) === itemId) {
                return row;
            }
        }
        return null;
    }
    
    function addItemRowWithData(item) {
        itemCount++;
        const currentRowId = itemCount;  // üîß FIX: Capture itemCount in local variable!
        const tbody = document.getElementById('itemsTableBody');
        const row = document.createElement('tr');
        row.id = `row_${currentRowId}`;
        
        // Pre-populate all item data
        row.innerHTML = `
            <td>${currentRowId}</td>
            <td style="position: relative;">
                <input type="text" name="item_name[]" class="form-control" 
                       value="${item.name}" 
                       readonly
                       style="background: #f8f9fa;">
                <input type="hidden" name="item_id[]" value="${item.id}">
            </td>
            <td>
                <input type="text" name="hsn_code[]" class="form-control" 
                       value="${item.hsn_code || ''}" readonly style="background: #f8f9fa;">
            </td>
            <td>
                <input type="number" name="quantity[]" id="quantity_${currentRowId}" class="form-control" 
                       value="1" min="1" step="1" required 
                       oninput="calculateRow(${currentRowId})">
            </td>
            <td>
                <span style="color: #95a5a6;">${item.mrp ? '‚Çπ' + item.mrp.toFixed(2) : '-'}</span>
                <input type="hidden" name="mrp[]" id="mrp_${currentRowId}" value="${item.mrp || 0}">
            </td>
            <td>
                <span style="color: #95a5a6;">${item.discount_percent || 0}%</span>
                <input type="hidden" name="discount_percent[]" value="${item.discount_percent || 0}">
            </td>
            <td>
                <span style="color: #95a5a6; font-size: 12px;">${item.unit || 'nos'}</span>
                <input type="hidden" name="unit[]" value="${item.unit || 'nos'}">
            </td>
            <td>
                <input type="number" name="rate[]" id="rate_${currentRowId}" class="form-control" 
                       value="${item.selling_price || 0}" min="0" step="0.01" required 
                       oninput="calculateRow(${currentRowId})">
            </td>
            <td>
                <input type="number" name="gst_rate[]" id="gst_rate_${currentRowId}" class="form-control" 
                       value="${item.gst_rate || 18}" min="0" max="28" step="0.01" 
                       oninput="calculateRow(${currentRowId})">
            </td>
            <td>
                <span id="amount_${currentRowId}">‚Çπ0.00</span>
            </td>
            <td>
                <button type="button" class="btn-icon" onclick="removeRow(${currentRowId})" 
                        style="color: #e74c3c; font-size: 18px; padding: 4px 8px;">‚úï</button>
            </td>
        `;
        
        tbody.appendChild(row);
        
        // Calculate initial amount (with small delay to ensure DOM is ready)
        // üîß FIX: Use captured currentRowId instead of global itemCount!
        setTimeout(() => {
            calculateRow(currentRowId);
            calculateTotal();
        }, 50);
        
        // Flash the new row
        row.style.background = '#d4edda';
        setTimeout(() => {
            row.style.background = '';
        }, 500);
    }
    
    // Sound effects
    function playSuccessBeep() {
        const audio = new Audio('data:audio/wav;base64,UklGRhYAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YTQAAAA=');
        audio.play().catch(() => {});
    }
    
    function playErrorBeep() {
        const audio = new Audio('data:audio/wav;base64,UklGRhYAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YTQAAAA=');
        audio.playbackRate = 0.5;
        audio.play().catch(() => {});
    }
    
    function playWarningBeep() {
        const audio = new Audio('data:audio/wav;base64,UklGRhYAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YTQAAAA=');
        audio.playbackRate = 0.75;
        audio.play().catch(() => {});
    }
    
    // Remove row function (for barcode-scanned items)
    function removeRow(rowId) {
        const row = document.getElementById(`row_${rowId}`);
        if (row) {
            row.remove();
            calculateTotal();  // Recalculate totals after removing
        }
    }
    
    function addItemRow() {
        itemCount++;
        const tbody = document.getElementById('itemsTableBody');
        const row = document.createElement('tr');
        row.id = `row_${itemCount}`;
        
        row.innerHTML = `
            <td>${itemCount}</td>
            <td style="position: relative;">
                <input type="text" name="item_name[]" class="form-control item-search" 
                       id="item_search_${itemCount}"
                       placeholder="Type to search items..." 
                       required 
                       autocomplete="off"
                       oninput="searchItems(this, ${itemCount})"
                       onfocus="searchItems(this, ${itemCount})"
                       onblur="setTimeout(() => hideDropdown(${itemCount}), 200)">
                <div class="autocomplete-dropdown" id="dropdown_${itemCount}"></div>
                <input type="hidden" name="item_id[]" id="item_id_${itemCount}">
                <input type="hidden" name="description[]" id="description_${itemCount}">
                <input type="hidden" name="mrp[]" id="mrp_${itemCount}" value="0">
            </td>
            <td>
                <input type="text" name="hsn_code[]" class="form-control" placeholder="8544">
            </td>
            <td>
                <input type="number" name="quantity[]" id="quantity_${itemCount}" class="form-control" step="any" min="0.01" 
                       value="1" placeholder="1" required oninput="calculateRow(${itemCount})">
            </td>
            <td>
                <span id="mrp_display_${itemCount}" style="font-weight: 500; color: #666;">-</span>
            </td>
            <td>
                <span id="discount_display_${itemCount}" style="font-weight: 600; color: #27ae60;">-</span>
                <input type="hidden" name="discount_percent[]" id="discount_percent_${itemCount}" value="0">
            </td>
            <td>
                <select name="unit[]" class="form-control">
                    <option value="Nos">Nos</option>
                    <option value="Pcs">Pcs</option>
                    <option value="Dozen">Dozen</option>
                    <option value="Kg">Kg</option>
                    <option value="Qtl">Qtl</option>
                    <option value="Ton">Ton</option>
                    <option value="G">G</option>
                    <option value="Ltr">Ltr</option>
                    <option value="Ml">Ml</option>
                    <option value="Mtr">Mtr</option>
                    <option value="Cm">Cm</option>
                    <option value="Ft">Ft</option>
                    <option value="Sqm">Sqm</option>
                    <option value="Cum">Cum</option>
                    <option value="Cft">Cft</option>
                    <option value="Box">Box</option>
                    <option value="Bag">Bag</option>
                    <option value="Packet">Packet</option>
                    <option value="Bundle">Bundle</option>
                </select>
            </td>
            <td>
                <input type="number" name="rate[]" id="rate_${itemCount}" class="form-control" step="0.01" min="0.01" 
                       placeholder="1200" required oninput="calculateRow(${itemCount})" style="text-align: right;">
            </td>
            <td>
                <span id="gst_display_${itemCount}" style="font-weight: 500;">18%</span>
                <input type="hidden" name="gst_rate[]" id="gst_rate_${itemCount}" value="18">
            </td>
            <td>
                <span id="amount_${itemCount}">‚Çπ0.00</span>
            </td>
            <td>
                <button type="button" class="btn-danger-small" onclick="removeItemRow(${itemCount})">
                    üóëÔ∏è
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    }
    
    function removeItemRow(rowId) {
        const row = document.getElementById(`row_${rowId}`);
        if (row) {
            row.remove();
            calculateTotal();
        }
    }
    
    // Debounce timer for API calls
    let searchTimeout = null;
    
    function searchItems(input, rowId) {
        const searchTerm = input.value.trim();
        const dropdown = document.getElementById(`dropdown_${rowId}`);
        
        if (!searchTerm) {
            dropdown.style.display = 'none';
            return;
        }
        
        // Show loading indicator
        dropdown.innerHTML = `
            <div class="autocomplete-no-results">
                ‚è≥ Searching...
            </div>
        `;
        dropdown.style.display = 'block';
        
        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        // Debounce API call (wait 300ms after user stops typing)
        searchTimeout = setTimeout(() => {
            // Make API call to search items
            fetch(`/admin/items/api/search?q=${encodeURIComponent(searchTerm)}&limit=10`)
                .then(response => response.json())
                .then(filteredItems => {
                    if (filteredItems.length === 0) {
                        dropdown.innerHTML = `
                            <div class="autocomplete-no-results">
                                No items found. You can type manually or add items to inventory first.
                            </div>
                        `;
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    // Build dropdown HTML using data attributes (safer than inline onclick with special chars)
                    let html = '';
                    filteredItems.forEach(item => { // Already limited by API
            // Escape for HTML display (not for onclick)
            const escapedName = item.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const escapedHsn = (item.hsn_code || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Stock availability display
            let stockDisplay = '';
            if (item.track_inventory) {
                const stock = typeof item.stock === 'number' ? item.stock : 0;
                const stockColor = stock > 0 ? (stock < 10 ? '#f39c12' : '#28a745') : '#e74c3c';
                const stockIcon = stock > 0 ? '‚úì' : '‚ö†Ô∏è';
                stockDisplay = `<span style="color: ${stockColor};">${stockIcon} Stock: ${stock.toFixed(2)}</span>`;
            }
            
            // MRP and discount badge
            let discountBadge = '';
            const discountPercent = item.discount_percent || 0;
            if (item.mrp && item.mrp > 0 && discountPercent > 0) {
                discountBadge = ` <span style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 600;">üí∞ ${discountPercent}% OFF</span>`;
            }
            
            html += `
                <div class="autocomplete-item" 
                     data-row-id="${rowId}"
                     data-item-id="${item.id}"
                     data-item-name="${escapedName}"
                     data-item-price="${item.selling_price || 0}"
                     data-item-mrp="${item.mrp || 0}"
                     data-item-discount="${discountPercent}"
                     data-item-gst="${item.gst_rate || 18}"
                     data-item-hsn="${escapedHsn}">
                    <div class="autocomplete-item-name">${escapedName}${discountBadge}</div>
                    <div class="autocomplete-item-details">
                        ${item.mrp ? `<span>üè∑Ô∏è MRP: ‚Çπ${item.mrp.toFixed(2)}</span>` : ''}
                        ${discountPercent > 0 ? `<span>üí∞ ${discountPercent}% OFF ‚Üí ‚Çπ${item.selling_price || 0}</span>` : `<span>üí∞ Price: ‚Çπ${item.selling_price || 0}</span>`}
                        ${item.hsn_code ? `<span>üìã HSN: ${escapedHsn}</span>` : ''}
                        ${stockDisplay ? stockDisplay : ''}
                    </div>
                </div>
            `;
        });
        
        dropdown.innerHTML = html;
        
        // Add click event listeners to all autocomplete items
        dropdown.querySelectorAll('.autocomplete-item').forEach(itemDiv => {
            itemDiv.addEventListener('click', function() {
                const rowId = this.dataset.rowId;
                const itemId = this.dataset.itemId;
                const itemName = this.dataset.itemName;
                const price = this.dataset.itemPrice;
                const mrp = this.dataset.itemMrp;
                const discountPercent = this.dataset.itemDiscount;
                const gstRate = this.dataset.itemGst;
                const hsn = this.dataset.itemHsn;
                selectItemFromDropdown(rowId, itemId, itemName, price, hsn, mrp, discountPercent, gstRate);
            });
        });
        
        dropdown.style.display = 'block';
                })
                .catch(error => {
                    console.error('API search error:', error);
                    dropdown.innerHTML = `
                        <div class="autocomplete-no-results">
                            ‚ùå Error searching items. Please try again.
                        </div>
                    `;
                });
        }, 300); // 300ms debounce delay
    }
    
    function selectItemFromDropdown(rowId, itemId, itemName, price, hsnCode, mrp, discountPercent, gstRate) {
        console.log('üîç Selecting item:', { rowId, itemId, itemName, price, hsnCode, mrp, discountPercent, gstRate });
        
        const row = document.getElementById(`row_${rowId}`);
        if (!row) {
            console.error('‚ùå Row not found:', rowId);
            return;
        }
        
        // Set item name
        const itemInput = document.getElementById(`item_search_${rowId}`);
        if (itemInput) {
            itemInput.value = itemName;
            console.log('‚úÖ Item name set:', itemName);
        }
        
        // Set hidden item ID
        const itemIdInput = document.getElementById(`item_id_${rowId}`);
        if (itemIdInput) {
            itemIdInput.value = itemId;
            console.log('‚úÖ Item ID set:', itemId);
        }
        
        // Set HSN code
        const hsnInput = row.querySelector('input[name="hsn_code[]"]');
        if (hsnInput && hsnCode) {
            hsnInput.value = hsnCode;
            console.log('‚úÖ HSN code set:', hsnCode);
        }
        
        // Set MRP (hidden input and display)
        const mrpInput = document.getElementById(`mrp_${rowId}`);
        const mrpDisplay = document.getElementById(`mrp_display_${rowId}`);
        if (mrpInput && mrpDisplay) {
            mrpInput.value = mrp || 0;
            mrpDisplay.textContent = mrp && mrp > 0 ? `‚Çπ${parseFloat(mrp).toFixed(2)}` : '-';
            console.log('‚úÖ MRP set:', mrp);
        }
        
        // Set Discount % (hidden input and display)
        const discountInput = document.getElementById(`discount_percent_${rowId}`);
        const discountDisplay = document.getElementById(`discount_display_${rowId}`);
        if (discountInput && discountDisplay) {
            discountInput.value = discountPercent || 0;
            if (discountPercent && discountPercent > 0) {
                discountDisplay.textContent = `${parseFloat(discountPercent).toFixed(1)}%`;
                discountDisplay.style.color = '#27ae60';
            } else {
                discountDisplay.textContent = '-';
                discountDisplay.style.color = '#666';
            }
            console.log('‚úÖ Discount % set:', discountPercent);
        }
        
        // Set GST rate (hidden input and display)
        const gstInput = document.getElementById(`gst_rate_${rowId}`);
        const gstDisplay = document.getElementById(`gst_display_${rowId}`);
        if (gstInput && gstDisplay) {
            gstInput.value = gstRate || 18;
            gstDisplay.textContent = `${gstRate || 18}%`;
            console.log('‚úÖ GST rate set:', gstRate);
        }
        
        // Set selling price in rate field
        const rateInput = document.getElementById(`rate_${rowId}`);
        if (rateInput) {
            rateInput.value = price || 0;
            console.log('‚úÖ Rate set:', price);
        } else {
            console.error('‚ùå Rate input not found for row:', rowId);
        }
        
        // üÜï GST Smart Invoice: Fetch and display stock info
        fetchAndDisplayStockInfo(itemId, rowId);
        
        // Hide dropdown
        hideDropdown(rowId);
        
        // Calculate row totals
        console.log('üßÆ Calculating row:', rowId);
        calculateRow(rowId);
        
        // Focus on quantity field
        const qtyInput = document.getElementById(`quantity_${rowId}`);
        if (qtyInput) {
            qtyInput.focus();
            qtyInput.select();  // Select the default value for easy override
        }
    }
    
    // üÜï GST Smart Invoice: Fetch stock breakdown
    function fetchAndDisplayStockInfo(itemId, rowId) {
        fetch(`/api/gst-invoice/item/${itemId}/stock-info`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create stock info display
                    const row = document.getElementById(`row_${rowId}`);
                    const itemCell = row.querySelector('td:nth-child(2)');
                    
                    // Remove old stock info if exists
                    const oldStockInfo = itemCell.querySelector('.stock-info-badge');
                    if (oldStockInfo) {
                        oldStockInfo.remove();
                    }
                    
                    // Add new stock info
                    const stockBadge = document.createElement('div');
                    stockBadge.className = 'stock-info-badge';
                    stockBadge.style.cssText = 'margin-top: 5px; font-size: 11px; display: flex; gap: 8px;';
                    
                    const gstBadge = `<span style="background: ${data.gst_stock > 0 ? '#28a745' : '#dc3545'}; color: white; padding: 2px 6px; border-radius: 3px; font-weight: 600;">
                        GST: ${data.gst_stock} units
                    </span>`;
                    
                    const nonGstBadge = `<span style="background: ${data.non_gst_stock > 0 ? '#17a2b8' : '#6c757d'}; color: white; padding: 2px 6px; border-radius: 3px; font-weight: 600;">
                        Non-GST: ${data.non_gst_stock} units
                    </span>`;
                    
                    stockBadge.innerHTML = gstBadge + nonGstBadge;
                    itemCell.appendChild(stockBadge);
                    
                    // Store stock info in row data attributes for validation
                    row.dataset.gstStock = data.gst_stock;
                    row.dataset.nonGstStock = data.non_gst_stock;
                    row.dataset.itemId = itemId;
                    
                    console.log('‚úÖ Stock info loaded:', data);
                }
            })
            .catch(error => {
                console.error('‚ùå Error fetching stock info:', error);
            });
    }
    
    function hideDropdown(rowId) {
        const dropdown = document.getElementById(`dropdown_${rowId}`);
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }
    
    function calculateRow(rowId) {
        const row = document.getElementById(`row_${rowId}`);
        if (!row) return;
        
        // Get input values
        const qtyInput = document.getElementById(`quantity_${rowId}`);
        const rateInput = document.getElementById(`rate_${rowId}`);
        const gstRateInput = document.getElementById(`gst_rate_${rowId}`);
        const mrpInput = document.getElementById(`mrp_${rowId}`);
        const priceInclusiveInput = document.getElementById(`price_inclusive_${rowId}`);
        
        const qty = qtyInput ? parseFloat(qtyInput.value) || 0 : 0;
        const rate = rateInput ? parseFloat(rateInput.value) || 0 : 0;
        const gstRate = gstRateInput ? parseFloat(gstRateInput.value) || 0 : 0;
        const mrp = mrpInput ? parseFloat(mrpInput.value) || 0 : 0;
        
        // For edit mode: Read from hidden input (stores '1' or '0')
        // For new items: Checkbox might exist, check if it's a checkbox or hidden input
        let isPriceInclusive = true; // Default to inclusive (most common in India)
        if (priceInclusiveInput) {
            if (priceInclusiveInput.type === 'checkbox') {
                isPriceInclusive = priceInclusiveInput.checked;
            } else if (priceInclusiveInput.type === 'hidden') {
                isPriceInclusive = priceInclusiveInput.value === '1' || priceInclusiveInput.value === 'true';
            }
        }
        
        const gstEnabled = document.getElementById('gstEnabled').value === '1';
        
        let taxableValue, gstAmount, total;
        
        if (gstEnabled) {
            if (isPriceInclusive) {
                // Price is INCLUSIVE of GST: need to extract base price
                // Example: Rate ‚Çπ2231.25 (inclusive) with 12% GST
                // Base = 2231.25 / 1.12 = ‚Çπ1992.19
                // GST = ‚Çπ239.06
                // Total = ‚Çπ2231.25
                total = qty * rate;
                const divisor = 1 + (gstRate / 100);
                taxableValue = total / divisor;
                gstAmount = total - taxableValue;
            } else {
                // Price is EXCLUSIVE of GST: add GST on top
                // Example: Rate ‚Çπ1992.19 (exclusive) with 12% GST
                // Base = ‚Çπ1992.19
                // GST = 1992.19 √ó 0.12 = ‚Çπ239.06
                // Total = ‚Çπ2231.25
                taxableValue = qty * rate;
                gstAmount = taxableValue * (gstRate / 100);
                total = taxableValue + gstAmount;
            }
        } else {
            // GST OFF: Rate is final price, no GST calculation
            total = qty * rate;
            taxableValue = total;
            gstAmount = 0;
        }
        
        // Display amount
        document.getElementById(`amount_${rowId}`).textContent = `‚Çπ${total.toFixed(2)}`;
        
        // Store calculated values as data attributes for total calculation
        row.setAttribute('data-taxable', taxableValue.toFixed(2));
        row.setAttribute('data-gst', gstAmount.toFixed(2));
        row.setAttribute('data-cgst', (gstAmount / 2).toFixed(2));
        row.setAttribute('data-sgst', (gstAmount / 2).toFixed(2));
        row.setAttribute('data-total', total.toFixed(2));
        
        // üÜï GST Smart Invoice: Validate stock on quantity/rate change
        // Only validate if we have stock data and GST is enabled
        if (gstEnabled && row.dataset.itemId && qty > 0) {
            // Use setTimeout to allow validation after UI update
            setTimeout(() => validateGSTStock(rowId), 100);
        }
        
        calculateTotal();
    }
    
    function toggleAllPriceInclusive(checked) {
        const checkboxes = document.querySelectorAll('.price-inclusive-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = checked;
        });
        
        // Recalculate all rows
        const rows = document.querySelectorAll('#itemsTableBody tr');
        rows.forEach((row, index) => {
            const rowId = row.id.replace('row_', '');
            calculateRow(rowId);
        });
    }
    
    function calculateTotal() {
        let subtotal = 0;
        let totalGSTAmount = 0;
        let totalCGST = 0;
        let totalSGST = 0;
        let totalIGST = 0;
        
        const customerState = document.getElementById('customer_state').value;
        const isSameState = customerState === tenantState;
        const gstEnabled = document.getElementById('gstEnabled').value === '1';
        
        // Use stored calculated values from data attributes
        const rows = document.querySelectorAll('#itemsTableBody tr');
        rows.forEach(row => {
            const taxableValue = parseFloat(row.getAttribute('data-taxable')) || 0;
            const gstAmount = parseFloat(row.getAttribute('data-gst')) || 0;
            const cgst = parseFloat(row.getAttribute('data-cgst')) || 0;
            const sgst = parseFloat(row.getAttribute('data-sgst')) || 0;
            
            subtotal += taxableValue;
            
            // Only add GST if enabled
            if (gstEnabled) {
                totalGSTAmount += gstAmount;
                
                if (isSameState) {
                    // Use pre-calculated CGST/SGST (already rounded at row level)
                    totalCGST += cgst;
                    totalSGST += sgst;
                } else {
                    totalIGST += gstAmount;
                }
            }
        });
        
        // Calculate discount based on type
        const discountType = document.getElementById('discountType').value;
        const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
        let discount = 0;
        
        if (discountType === 'percentage') {
            discount = (subtotal * discountValue) / 100;
        } else {
            discount = discountValue;
        }
        
        // Update hidden discount amount field
        document.getElementById('discountAmount').value = discount.toFixed(2);
        
        const subtotalAfterDiscount = subtotal - discount;
        
        // Apply loyalty discount (if any) BEFORE GST calculation
        const loyaltyDiscount = parseFloat(document.getElementById('loyalty_discount').value) || 0;
        const subtotalAfterAllDiscounts = subtotalAfterDiscount - loyaltyDiscount;
        
        // Recalculate GST after all discounts (only if GST is enabled)
        if (gstEnabled && (discount > 0 || loyaltyDiscount > 0)) {
            const discountRatio = subtotalAfterAllDiscounts / (subtotal || 1);
            totalCGST = totalCGST * discountRatio;
            totalSGST = totalSGST * discountRatio;
            totalIGST = totalIGST * discountRatio;
        }
        
        const grossTotal = subtotalAfterAllDiscounts + (gstEnabled ? (totalCGST + totalSGST + totalIGST) : 0);
        const roundedTotal = Math.round(grossTotal);
        const roundOff = roundedTotal - grossTotal;
        
        // Update displays
        document.getElementById('subtotalDisplay').textContent = `‚Çπ${subtotal.toFixed(2)}`;
        document.getElementById('discountDisplay').textContent = discount > 0 ? `-‚Çπ${discount.toFixed(2)}` : `‚Çπ0.00`;
        
        // Show/hide GST rows based on GST enabled status
        if (gstEnabled) {
            document.getElementById('cgstRow').style.display = isSameState ? '' : 'none';
            document.getElementById('sgstRow').style.display = isSameState ? '' : 'none';
            document.getElementById('igstRow').style.display = isSameState ? 'none' : '';
            
            document.getElementById('cgstDisplay').textContent = `‚Çπ${totalCGST.toFixed(2)}`;
            document.getElementById('sgstDisplay').textContent = `‚Çπ${totalSGST.toFixed(2)}`;
            document.getElementById('igstDisplay').textContent = `‚Çπ${totalIGST.toFixed(2)}`;
        } else {
            // Hide all GST rows when GST is disabled
            document.getElementById('cgstRow').style.display = 'none';
            document.getElementById('sgstRow').style.display = 'none';
            document.getElementById('igstRow').style.display = 'none';
        }
        
        // Display gross total, round-off, and net total
        document.getElementById('grossTotalDisplay').textContent = `‚Çπ${grossTotal.toFixed(2)}`;
        document.getElementById('roundOffDisplay').textContent = roundOff >= 0 ? `‚Çπ${roundOff.toFixed(2)}` : `-‚Çπ${Math.abs(roundOff).toFixed(2)}`;
        document.getElementById('totalDisplay').textContent = `‚Çπ${roundedTotal.toFixed(2)}`;
        
        // Recalculate commission when invoice total changes
        calculateCommission();
        
        // Update loyalty points preview if loyalty is active
        if (loyaltySettings && customerLoyaltyData) {
            calculatePointsPreview();
        }
    }
    
    function toggleGSTRows() {
        // When GST is toggled, recalculate ALL rows first (to update their data attributes)
        const rows = document.querySelectorAll('#itemsTableBody tr');
        rows.forEach(row => {
            const rowId = row.id.replace('row_', '');
            if (rowId) {
                calculateRow(rowId);
            }
        });
        
        // Then recalculate total
        calculateTotal();
    }
    
    // Commission Management Functions
    function updateCommissionRate() {
        const agentSelect = document.getElementById('commission_agent_id');
        const selectedOption = agentSelect.options[agentSelect.selectedIndex];
        const commissionPercentageInput = document.getElementById('commission_percentage');
        
        if (selectedOption.value && selectedOption.hasAttribute('data-rate')) {
            const defaultRate = selectedOption.getAttribute('data-rate');
            commissionPercentageInput.value = defaultRate;
            commissionPercentageInput.placeholder = `Default: ${defaultRate}%`;
        } else {
            commissionPercentageInput.value = '';
            commissionPercentageInput.placeholder = 'Auto-filled';
        }
        
        calculateCommission();
    }
    
    function calculateCommission() {
        const agentSelect = document.getElementById('commission_agent_id');
        const commissionPercentageInput = document.getElementById('commission_percentage');
        const commissionDisplay = document.getElementById('commission_calc_display');
        
        // If no agent selected, clear commission
        if (!agentSelect.value) {
            commissionDisplay.innerHTML = 'Commission: ‚Çπ0.00';
            return;
        }
        
        // Get commission percentage
        const commissionPercentage = parseFloat(commissionPercentageInput.value) || 0;
        
        if (commissionPercentage <= 0) {
            commissionDisplay.innerHTML = '<span style="color: #e74c3c;">‚ö†Ô∏è Enter commission %</span>';
            return;
        }
        
        // Get invoice total
        const totalText = document.getElementById('totalDisplay').textContent;
        const invoiceTotal = parseFloat(totalText.replace('‚Çπ', '').replace(',', '')) || 0;
        
        // Calculate commission
        const commissionAmount = (invoiceTotal * commissionPercentage) / 100;
        
        // Display commission
        const selectedOption = agentSelect.options[agentSelect.selectedIndex];
        const agentName = selectedOption.text.split('(')[0].trim();
        
        commissionDisplay.innerHTML = `
            <span style="color: #28a745; font-weight: 600;">
                üí∞ ${agentName} will earn: ‚Çπ${commissionAmount.toFixed(2)} 
                <small class="help-text">(${commissionPercentage}% of ‚Çπ${invoiceTotal.toFixed(2)})</small>
            </span>
        `;
    }
    
    // Recalculate when state changes
    document.getElementById('customer_state').addEventListener('change', calculateTotal);
    
    // Set today's date (only for new invoices)
    {% if not invoice %}
    document.getElementById('invoice_date').valueAsDate = new Date();
    {% endif %}
    
    // Initialize GST toggle and calculations on page load
    window.addEventListener('DOMContentLoaded', function() {
        toggleGSTRows(); // Initialize GST row visibility
        calculateTotal(); // Initialize all calculations
    });
    
    {% if invoice_items %}
    // Edit mode: Pre-populate items
    window.addEventListener('DOMContentLoaded', function() {
        const existingItems = {{ invoice_items|tojson }};
        const tbody = document.getElementById('itemsTableBody');
        tbody.innerHTML = ''; // Clear the default row
        itemCount = 0; // Reset counter
        
        existingItems.forEach(function(item) {
            addItemRowWithData(item);
        });
        
        // Set discount if exists
        {% if invoice.discount_amount %}
        document.getElementById('discountInput').value = {{ invoice.discount_amount }};
        {% endif %}
        
        calculateTotal();
    });
    
    function addItemRowWithData(itemData) {
        itemCount++;
        const tbody = document.getElementById('itemsTableBody');
        const row = document.createElement('tr');
        row.id = `row_${itemCount}`;
        
        // Determine if price was inclusive (reverse calculate)
        const rate = itemData.rate || 0;
        const quantity = itemData.quantity || 1;
        const taxableValue = itemData.taxable_value || 0;
        const gstRate = itemData.gst_rate || 0;
        
        // Check by comparing: if rate * quantity == taxable_value, it's exclusive
        // if different, it was inclusive
        const isExclusive = Math.abs((rate * quantity) - taxableValue) < 0.01;
        const isPriceInclusive = !isExclusive;
        
        row.innerHTML = `
            <td>${itemCount}</td>
            <td style="position: relative;">
                <input type="text" name="item_name[]" class="form-control item-search" 
                       id="item_search_${itemCount}"
                       value="${itemData.item_name || ''}"
                       placeholder="Type to search items..." 
                       required 
                       autocomplete="off"
                       oninput="searchItems(this, ${itemCount})"
                       onfocus="searchItems(this, ${itemCount})"
                       onblur="setTimeout(() => hideDropdown(${itemCount}), 200)">
                <div class="autocomplete-dropdown" id="dropdown_${itemCount}"></div>
                <input type="hidden" name="item_id[]" id="item_id_${itemCount}" value="${itemData.item_id || ''}">
                <input type="hidden" name="description[]" id="description_${itemCount}" value="${itemData.description || ''}">
            </td>
            <td>
                <input type="text" name="hsn_code[]" class="form-control" placeholder="8544" value="${itemData.hsn_code || ''}">
            </td>
            <td>
                <input type="number" name="quantity[]" id="quantity_${itemCount}" class="form-control" step="any" min="0.01" 
                       placeholder="1" value="${itemData.quantity ? (itemData.quantity % 1 === 0 ? parseInt(itemData.quantity) : itemData.quantity) : 1}" required onchange="calculateRow(${itemCount})">
            </td>
            <td>
                <span style="color: #95a5a6; font-size: 12px;">${itemData.mrp ? '‚Çπ' + itemData.mrp.toFixed(2) : '-'}</span>
                <input type="hidden" name="mrp[]" id="mrp_${itemCount}" value="${itemData.mrp || 0}">
            </td>
            <td>
                <span style="color: #95a5a6; font-size: 12px;">${itemData.discount_percent || 0}%</span>
                <input type="hidden" name="discount_percent[]" value="${itemData.discount_percent || 0}">
            </td>
            <td>
                <select name="unit[]" class="form-control">
                    <option value="Nos" ${itemData.unit === 'Nos' || itemData.unit === 'nos' ? 'selected' : ''}>Nos</option>
                    <option value="Pcs" ${itemData.unit === 'Pcs' || itemData.unit === 'pcs' ? 'selected' : ''}>Pcs</option>
                    <option value="Dozen" ${itemData.unit === 'Dozen' || itemData.unit === 'dozen' ? 'selected' : ''}>Dozen</option>
                    <option value="Kg" ${itemData.unit === 'Kg' || itemData.unit === 'kg' ? 'selected' : ''}>Kg</option>
                    <option value="Qtl" ${itemData.unit === 'Qtl' || itemData.unit === 'qtl' ? 'selected' : ''}>Qtl</option>
                    <option value="Ton" ${itemData.unit === 'Ton' || itemData.unit === 'ton' || itemData.unit === 'tons' ? 'selected' : ''}>Ton</option>
                    <option value="G" ${itemData.unit === 'G' || itemData.unit === 'g' ? 'selected' : ''}>G</option>
                    <option value="Ltr" ${itemData.unit === 'Ltr' || itemData.unit === 'ltr' ? 'selected' : ''}>Ltr</option>
                    <option value="Ml" ${itemData.unit === 'Ml' || itemData.unit === 'ml' ? 'selected' : ''}>Ml</option>
                    <option value="Mtr" ${itemData.unit === 'Mtr' || itemData.unit === 'mtr' ? 'selected' : ''}>Mtr</option>
                    <option value="Cm" ${itemData.unit === 'Cm' || itemData.unit === 'cm' ? 'selected' : ''}>Cm</option>
                    <option value="Ft" ${itemData.unit === 'Ft' || itemData.unit === 'ft' ? 'selected' : ''}>Ft</option>
                    <option value="Sqm" ${itemData.unit === 'Sqm' || itemData.unit === 'sqm' ? 'selected' : ''}>Sqm</option>
                    <option value="Cum" ${itemData.unit === 'Cum' || itemData.unit === 'cum' ? 'selected' : ''}>Cum</option>
                    <option value="Cft" ${itemData.unit === 'Cft' || itemData.unit === 'cft' ? 'selected' : ''}>Cft</option>
                    <option value="Box" ${itemData.unit === 'Box' || itemData.unit === 'box' ? 'selected' : ''}>Box</option>
                    <option value="Bag" ${itemData.unit === 'Bag' || itemData.unit === 'bag' ? 'selected' : ''}>Bag</option>
                    <option value="Packet" ${itemData.unit === 'Packet' || itemData.unit === 'packet' ? 'selected' : ''}>Packet</option>
                    <option value="Bundle" ${itemData.unit === 'Bundle' || itemData.unit === 'bundle' ? 'selected' : ''}>Bundle</option>
                </select>
            </td>
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="number" name="rate[]" id="rate_${itemCount}" class="form-control" step="0.01" min="0.01" 
                           placeholder="1200" value="${itemData.rate ? parseFloat(itemData.rate).toFixed(2) : 0}" required onchange="calculateRow(${itemCount})" 
                           style="text-align: right; flex: 1; min-width: 80px;">
                    <!-- Hide Inc checkbox in edit mode - stored value is already correct -->
                    <input type="hidden" name="price_inclusive[]" id="price_inclusive_${itemCount}"
                           class="price-inclusive-checkbox" value="${isPriceInclusive ? '1' : '0'}">
                </div>
            </td>
            <td>
                <select name="gst_rate[]" id="gst_rate_${itemCount}" class="form-control" onchange="calculateRow(${itemCount})">
                    <option value="0" ${itemData.gst_rate === 0 ? 'selected' : ''}>0%</option>
                    <option value="5" ${itemData.gst_rate === 5 ? 'selected' : ''}>5%</option>
                    <option value="12" ${itemData.gst_rate === 12 ? 'selected' : ''}>12%</option>
                    <option value="18" ${itemData.gst_rate === 18 ? 'selected' : ''}>18%</option>
                    <option value="28" ${itemData.gst_rate === 28 ? 'selected' : ''}>28%</option>
                </select>
            </td>
            <td>
                <span id="amount_${itemCount}" style="font-weight: 600;">‚Çπ${itemData.total_amount ? itemData.total_amount.toFixed(2) : '0.00'}</span>
            </td>
            <td>
                <button type="button" class="btn-remove" onclick="removeItem(${itemCount})" title="Remove item">üóëÔ∏è</button>
            </td>
        `;
        
        tbody.appendChild(row);
        
        // üîß CRITICAL FIX: Calculate row totals after adding to DOM
        const currentRowId = itemCount; // Capture current count
        setTimeout(() => {
            calculateRow(currentRowId);
            calculateTotal();
        }, 50);
    }
    {% endif %}
    
    // Customer Autocomplete
    let customerSearchTimeout;
    
    function searchCustomers(query) {
        clearTimeout(customerSearchTimeout);
        
        if (query.length < 2) {
            hideCustomerDropdown();
            return;
        }
        
        customerSearchTimeout = setTimeout(function() {
            fetch(`/admin/customers/api/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(customers => {
                    const dropdown = document.getElementById('customer_dropdown');
                    
                    if (customers.length === 0) {
                        dropdown.innerHTML = '<div class="dropdown-item">No customers found</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    dropdown.innerHTML = customers.map(customer => `
                        <div class="dropdown-item" onclick="selectCustomer(${customer.id}, '${customer.name.replace(/'/g, "\\'")}', '${customer.phone}', '${customer.email}', '${customer.address ? customer.address.replace(/'/g, "\\'").replace(/\n/g, " ") : ""}', '${customer.gstin || ""}', '${customer.state}', '${customer.customer_code}')">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${customer.name}</strong>
                                    <small style="display: block; color: #666;">${customer.customer_code}</small>
                                    ${customer.phone ? `<small style="display: block; color: #666;">üìû ${customer.phone}</small>` : ''}
                                </div>
                                ${customer.outstanding > 0 ? `<span style="color: #e74c3c; font-weight: 600; white-space: nowrap;">‚Çπ${customer.outstanding.toFixed(2)}</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                    
                    dropdown.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error searching customers:', error);
                });
        }, 300);
    }
    
    function selectCustomer(id, name, phone, email, address, gstin, state, customerCode) {
        // Set hidden customer_id
        document.getElementById('customer_id').value = id;
        
        // Fill customer details
        document.getElementById('customer_name').value = name;
        document.getElementById('customer_phone').value = phone || '';
        document.getElementById('customer_email').value = email || '';
        document.getElementById('customer_address').value = address || '';
        document.getElementById('customer_gstin').value = gstin || '';
        document.getElementById('customer_state').value = state || tenantState;  // FIX: Use tenant's state, not hardcoded
        
        // Clear and update search field
        document.getElementById('customer_search').value = `${customerCode} - ${name}`;
        
        // Hide dropdown
        hideCustomerDropdown();
        
        // Trigger state change for GST calculation
        document.getElementById('customer_state').dispatchEvent(new Event('change'));
        
        // Fetch loyalty data for this customer
        fetchCustomerLoyalty(id);
    }
    
    function hideCustomerDropdown() {
        document.getElementById('customer_dropdown').style.display = 'none';
    }
    
    // Pre-fill form from Sales Order data
    function preFillFromSalesOrder() {
        if (!salesOrderData) return;
        
        console.log('üìã Pre-filling invoice from Sales Order...', salesOrderData);
        
        // Fill customer details
        if (salesOrderData.customer) {
            document.getElementById('customer_id').value = salesOrderData.customer.id || '';
            document.getElementById('customer_name').value = salesOrderData.customer.name || '';
            document.getElementById('customer_phone').value = salesOrderData.customer.phone || '';
            document.getElementById('customer_email').value = salesOrderData.customer.email || '';
            document.getElementById('customer_address').value = salesOrderData.customer.address || '';
            document.getElementById('customer_gstin').value = salesOrderData.customer.gstin || '';
            document.getElementById('customer_state').value = salesOrderData.customer.state || 'Maharashtra';
            
            // Update search field
            document.getElementById('customer_search').value = salesOrderData.customer.name;
            console.log('‚úÖ Customer details filled:', salesOrderData.customer.name);
        }
        
        // Fill items
        if (salesOrderData.items && salesOrderData.items.length > 0) {
            salesOrderData.items.forEach((orderItem, index) => {
                console.log(`üì¶ Adding item ${index + 1}:`, orderItem.item_name);
                
                // Add item row
                itemCount++;
                const tbody = document.getElementById('itemsTableBody');
                const row = document.createElement('tr');
                row.id = `row_${itemCount}`;
                const currentRowId = itemCount;
                
                row.innerHTML = `
                    <td>${currentRowId}</td>
                    <td style="position: relative;">
                        <input type="text" name="item_name[]" class="form-control item-search" 
                               id="item_search_${currentRowId}"
                               value="${orderItem.item_name}"
                               placeholder="Type to search items..." 
                               required 
                               autocomplete="off"
                               oninput="searchItems(this, ${currentRowId})"
                               onfocus="searchItems(this, ${currentRowId})"
                               onblur="setTimeout(() => hideDropdown(${currentRowId}), 200)">
                        <div class="autocomplete-dropdown" id="dropdown_${currentRowId}"></div>
                        <input type="hidden" name="item_id[]" id="item_id_${currentRowId}" value="${orderItem.item_id || ''}">
                        <input type="hidden" name="description[]" id="description_${currentRowId}">
                    </td>
                    <td>
                        <input type="text" name="hsn_code[]" class="form-control" placeholder="8544" value="${orderItem.hsn_code || ''}">
                    </td>
                    <td>
                        <input type="number" name="quantity[]" id="quantity_${currentRowId}" class="form-control" 
                               step="0.01" min="0.01" value="${orderItem.quantity}" required oninput="calculateRow(${currentRowId})">
                    </td>
                    <td>
                        <select name="unit[]" class="form-control">
                            <option value="Nos" ${orderItem.unit === 'Nos' || orderItem.unit === 'nos' ? 'selected' : ''}>Nos</option>
                            <option value="Pcs" ${orderItem.unit === 'Pcs' || orderItem.unit === 'pcs' ? 'selected' : ''}>Pcs</option>
                            <option value="Dozen" ${orderItem.unit === 'Dozen' || orderItem.unit === 'dozen' ? 'selected' : ''}>Dozen</option>
                            <option value="Kg" ${orderItem.unit === 'Kg' || orderItem.unit === 'kg' ? 'selected' : ''}>Kg</option>
                            <option value="Qtl" ${orderItem.unit === 'Qtl' || orderItem.unit === 'qtl' ? 'selected' : ''}>Qtl</option>
                            <option value="Ton" ${orderItem.unit === 'Ton' || orderItem.unit === 'ton' || orderItem.unit === 'tons' ? 'selected' : ''}>Ton</option>
                            <option value="G" ${orderItem.unit === 'G' || orderItem.unit === 'g' ? 'selected' : ''}>G</option>
                            <option value="Ltr" ${orderItem.unit === 'Ltr' || orderItem.unit === 'ltr' ? 'selected' : ''}>Ltr</option>
                            <option value="Ml" ${orderItem.unit === 'Ml' || orderItem.unit === 'ml' ? 'selected' : ''}>Ml</option>
                            <option value="Mtr" ${orderItem.unit === 'Mtr' || orderItem.unit === 'mtr' ? 'selected' : ''}>Mtr</option>
                            <option value="Cm" ${orderItem.unit === 'Cm' || orderItem.unit === 'cm' ? 'selected' : ''}>Cm</option>
                            <option value="Ft" ${orderItem.unit === 'Ft' || orderItem.unit === 'ft' ? 'selected' : ''}>Ft</option>
                            <option value="Sqm" ${orderItem.unit === 'Sqm' || orderItem.unit === 'sqm' ? 'selected' : ''}>Sqm</option>
                            <option value="Cum" ${orderItem.unit === 'Cum' || orderItem.unit === 'cum' ? 'selected' : ''}>Cum</option>
                            <option value="Cft" ${orderItem.unit === 'Cft' || orderItem.unit === 'cft' ? 'selected' : ''}>Cft</option>
                            <option value="Box" ${orderItem.unit === 'Box' || orderItem.unit === 'box' ? 'selected' : ''}>Box</option>
                            <option value="Bag" ${orderItem.unit === 'Bag' || orderItem.unit === 'bag' ? 'selected' : ''}>Bag</option>
                            <option value="Packet" ${orderItem.unit === 'Packet' || orderItem.unit === 'packet' ? 'selected' : ''}>Packet</option>
                            <option value="Bundle" ${orderItem.unit === 'Bundle' || orderItem.unit === 'bundle' ? 'selected' : ''}>Bundle</option>
                        </select>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" name="rate[]" id="rate_${currentRowId}" class="form-control" 
                                   step="0.01" min="0.01" value="${orderItem.rate}" placeholder="1200" required 
                                   oninput="calculateRow(${currentRowId})"
                                   style="text-align: right; flex: 1; min-width: 80px;">
                            <label style="display: flex; align-items: center; gap: 4px; margin: 0; cursor: pointer; white-space: nowrap;">
                                <input type="checkbox" name="price_inclusive[]" id="price_inclusive_${currentRowId}" 
                                       class="price-inclusive-checkbox" ${orderItem.price_inclusive ? 'checked' : ''}
                                       onchange="calculateRow(${currentRowId})">
                                <span style="font-size: 11px; color: #666;">Inc</span>
                            </label>
                        </div>
                    </td>
                    <td>
                        <select name="gst_rate[]" id="gst_rate_${currentRowId}" class="form-control" onchange="calculateRow(${currentRowId})">
                            <option value="0" ${orderItem.gst_rate === 0 ? 'selected' : ''}>0%</option>
                            <option value="5" ${orderItem.gst_rate === 5 ? 'selected' : ''}>5%</option>
                            <option value="12" ${orderItem.gst_rate === 12 ? 'selected' : ''}>12%</option>
                            <option value="18" ${orderItem.gst_rate === 18 ? 'selected' : ''}>18%</option>
                            <option value="28" ${orderItem.gst_rate === 28 ? 'selected' : ''}>28%</option>
                        </select>
                    </td>
                    <td>
                        <span id="amount_${currentRowId}">‚Çπ0.00</span>
                    </td>
                    <td>
                        <button type="button" class="btn-danger-small" onclick="removeItemRow(${currentRowId})">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
                
                // Calculate totals for this row
                setTimeout(() => {
                    calculateRow(currentRowId);
                }, 100);
            });
            
            console.log(`‚úÖ Added ${salesOrderData.items.length} items from sales order`);
        }
        
        // Fill notes/terms
        if (salesOrderData.notes) {
            const termsField = document.getElementById('terms_conditions') || document.getElementById('notes');
            if (termsField) {
                termsField.value = salesOrderData.notes;
            }
        }
        
        // Calculate grand total
        setTimeout(() => {
            calculateTotals();
            console.log('‚úÖ Invoice pre-filled from Sales Order successfully!');
        }, 200);
    }
    
    // Pre-fill form from Delivery Challan data
    function preFillFromDeliveryChallan() {
        if (!deliveryChallanData) return;
        
        console.log('üì¶ Pre-filling invoice from Delivery Challan...', deliveryChallanData);
        
        // Fill customer details
        if (deliveryChallanData.customer) {
            document.getElementById('customer_id').value = deliveryChallanData.customer.id || '';
            document.getElementById('customer_name').value = deliveryChallanData.customer.name || '';
            document.getElementById('customer_phone').value = deliveryChallanData.customer.phone || '';
            document.getElementById('customer_email').value = deliveryChallanData.customer.email || '';
            document.getElementById('customer_address').value = deliveryChallanData.customer.address || '';
            document.getElementById('customer_gstin').value = deliveryChallanData.customer.gstin || '';
            document.getElementById('customer_state').value = deliveryChallanData.customer.state || 'Maharashtra';
            
            // Update search field
            document.getElementById('customer_search').value = deliveryChallanData.customer.name;
            console.log('‚úÖ Customer details filled:', deliveryChallanData.customer.name);
        }
        
        // Fill items
        if (deliveryChallanData.items && deliveryChallanData.items.length > 0) {
            deliveryChallanData.items.forEach((challanItem, index) => {
                console.log(`üì¶ Adding item ${index + 1}:`, challanItem.item_name);
                
                // Add item row
                itemCount++;
                const tbody = document.getElementById('itemsTableBody');
                const row = document.createElement('tr');
                row.id = `row_${itemCount}`;
                const currentRowId = itemCount;
                
                row.innerHTML = `
                    <td>${currentRowId}</td>
                    <td style="position: relative;">
                        <input type="text" name="item_name[]" class="form-control item-search" 
                               id="item_search_${currentRowId}"
                               value="${challanItem.item_name}"
                               placeholder="Type to search items..." 
                               required 
                               autocomplete="off"
                               oninput="searchItems(this, ${currentRowId})"
                               onfocus="searchItems(this, ${currentRowId})"
                               onblur="setTimeout(() => hideDropdown(${currentRowId}), 200)">
                        <div class="autocomplete-dropdown" id="dropdown_${currentRowId}"></div>
                        <input type="hidden" name="item_id[]" id="item_id_${currentRowId}" value="${challanItem.item_id || ''}">
                        <input type="hidden" name="description[]" id="description_${currentRowId}">
                    </td>
                    <td>
                        <input type="text" name="hsn_code[]" class="form-control" placeholder="8544" value="${challanItem.hsn_code || ''}">
                    </td>
                    <td>
                        <input type="number" name="quantity[]" id="quantity_${currentRowId}" class="form-control" 
                               step="0.01" min="0.01" value="${challanItem.quantity}" required oninput="calculateRow(${currentRowId})">
                    </td>
                    <td>
                        <select name="unit[]" class="form-control">
                            <option value="Nos" ${challanItem.unit === 'Nos' || challanItem.unit === 'nos' ? 'selected' : ''}>Nos</option>
                            <option value="Pcs" ${challanItem.unit === 'Pcs' || challanItem.unit === 'pcs' ? 'selected' : ''}>Pcs</option>
                            <option value="Dozen" ${challanItem.unit === 'Dozen' || challanItem.unit === 'dozen' ? 'selected' : ''}>Dozen</option>
                            <option value="Kg" ${challanItem.unit === 'Kg' || challanItem.unit === 'kg' ? 'selected' : ''}>Kg</option>
                            <option value="Qtl" ${challanItem.unit === 'Qtl' || challanItem.unit === 'qtl' ? 'selected' : ''}>Qtl</option>
                            <option value="Ton" ${challanItem.unit === 'Ton' || challanItem.unit === 'ton' || challanItem.unit === 'tons' ? 'selected' : ''}>Ton</option>
                            <option value="G" ${challanItem.unit === 'G' || challanItem.unit === 'g' ? 'selected' : ''}>G</option>
                            <option value="Ltr" ${challanItem.unit === 'Ltr' || challanItem.unit === 'ltr' ? 'selected' : ''}>Ltr</option>
                            <option value="Ml" ${challanItem.unit === 'Ml' || challanItem.unit === 'ml' ? 'selected' : ''}>Ml</option>
                            <option value="Mtr" ${challanItem.unit === 'Mtr' || challanItem.unit === 'mtr' ? 'selected' : ''}>Mtr</option>
                            <option value="Cm" ${challanItem.unit === 'Cm' || challanItem.unit === 'cm' ? 'selected' : ''}>Cm</option>
                            <option value="Ft" ${challanItem.unit === 'Ft' || challanItem.unit === 'ft' ? 'selected' : ''}>Ft</option>
                            <option value="Sqm" ${challanItem.unit === 'Sqm' || challanItem.unit === 'sqm' ? 'selected' : ''}>Sqm</option>
                            <option value="Cum" ${challanItem.unit === 'Cum' || challanItem.unit === 'cum' ? 'selected' : ''}>Cum</option>
                            <option value="Cft" ${challanItem.unit === 'Cft' || challanItem.unit === 'cft' ? 'selected' : ''}>Cft</option>
                            <option value="Box" ${challanItem.unit === 'Box' || challanItem.unit === 'box' ? 'selected' : ''}>Box</option>
                            <option value="Bag" ${challanItem.unit === 'Bag' || challanItem.unit === 'bag' ? 'selected' : ''}>Bag</option>
                            <option value="Packet" ${challanItem.unit === 'Packet' || challanItem.unit === 'packet' ? 'selected' : ''}>Packet</option>
                            <option value="Bundle" ${challanItem.unit === 'Bundle' || challanItem.unit === 'bundle' ? 'selected' : ''}>Bundle</option>
                        </select>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" name="rate[]" id="rate_${currentRowId}" class="form-control" 
                                   step="0.01" min="0.01" value="${challanItem.rate}" placeholder="1200" required 
                                   oninput="calculateRow(${currentRowId})"
                                   style="text-align: right; flex: 1; min-width: 80px;">
                            <label style="display: flex; align-items: center; gap: 4px; margin: 0; cursor: pointer; white-space: nowrap;">
                                <input type="checkbox" name="price_inclusive[]" id="price_inclusive_${currentRowId}" 
                                       class="price-inclusive-checkbox" ${challanItem.price_inclusive ? 'checked' : ''}
                                       onchange="calculateRow(${currentRowId})">
                                <span style="font-size: 11px; color: #666;">Inc</span>
                            </label>
                        </div>
                    </td>
                    <td>
                        <select name="gst_rate[]" id="gst_rate_${currentRowId}" class="form-control" onchange="calculateRow(${currentRowId})">
                            <option value="0" ${challanItem.gst_rate === 0 ? 'selected' : ''}>0%</option>
                            <option value="5" ${challanItem.gst_rate === 5 ? 'selected' : ''}>5%</option>
                            <option value="12" ${challanItem.gst_rate === 12 ? 'selected' : ''}>12%</option>
                            <option value="18" ${challanItem.gst_rate === 18 ? 'selected' : ''}>18%</option>
                            <option value="28" ${challanItem.gst_rate === 28 ? 'selected' : ''}>28%</option>
                        </select>
                    </td>
                    <td>
                        <span id="amount_${currentRowId}" style="font-weight: 600;">‚Çπ0.00</span>
                    </td>
                    <td>
                        <button type="button" class="btn-danger-small" onclick="removeItemRow(${currentRowId})">üóëÔ∏è</button>
                    </td>
                `;
                
                tbody.appendChild(row);
                
                // Calculate row amount after adding
                setTimeout(() => calculateRow(currentRowId), 50);
            });
            
            console.log(`‚úÖ Added ${deliveryChallanData.items.length} items from delivery challan`);
        }
        
        // Fill notes/terms
        if (deliveryChallanData.notes) {
            const termsField = document.getElementById('terms_conditions') || document.getElementById('notes');
            if (termsField) {
                termsField.value = deliveryChallanData.notes;
            }
        }
        
        // Calculate grand total
        setTimeout(() => {
            calculateTotals();
            console.log('‚úÖ Invoice pre-filled from Delivery Challan successfully!');
        }, 200);
    }
    
    // ========================================
    // CUSTOMER MODAL FUNCTIONS
    // ========================================
    
    function openAddCustomerModal() {
        document.getElementById('addCustomerModal').style.display = 'flex';
        document.getElementById('newCustomerName').focus();
    }
    
    function closeAddCustomerModal() {
        document.getElementById('addCustomerModal').style.display = 'none';
        document.getElementById('addCustomerForm').reset();
    }
    
    function submitCustomer(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        
        // Disable button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '‚è≥ Adding...';
        
        fetch('{{ url_for("customers.add") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success! Auto-fill the customer details in the invoice form
                const customer = data.customer;
                
                // Fill the invoice form
                document.getElementById('customer_name').value = customer.name;
                document.getElementById('customer_phone').value = customer.phone || '';
                document.getElementById('customer_email').value = customer.email || '';
                document.getElementById('customer_gstin').value = customer.gstin || '';
                document.getElementById('billing_address').value = customer.address || '';
                document.getElementById('shipping_address').value = customer.address || '';
                
                // Set the hidden customer_id field if available
                if (document.getElementById('customer_id') && customer.id) {
                    document.getElementById('customer_id').value = customer.id;
                }
                
                // Clear the search box
                if (document.getElementById('customer_search')) {
                    document.getElementById('customer_search').value = customer.name;
                }
                
                // Show success message
                alert(`‚úÖ ${data.message}`);
                closeAddCustomerModal();
            } else {
                alert(`‚ùå ${data.error || 'Error adding customer. Please try again.'}`);
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'üíæ Save Customer';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error adding customer. Please try again.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'üíæ Save Customer';
        });
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('addCustomerModal');
            if (modal && modal.style.display === 'flex') {
                closeAddCustomerModal();
            }
        }
    });
    
    // Close modal on outside click
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('addCustomerModal');
        if (modal && event.target === modal) {
            closeAddCustomerModal();
        }
    });
</script>

<!-- Add Customer Modal -->
<div id="addCustomerModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">‚ûï Add New Customer</h3>
            <button onclick="closeAddCustomerModal()" class="modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
        </div>
        <form id="addCustomerForm" onsubmit="submitCustomer(event)">
            <div class="modal-body">
                <!-- Basic Details -->
                <div class="modal-form-row">
                    <div class="form-group">
                        <label class="field-label field-label--required">Customer Name</label>
                        <input type="text" name="name" id="newCustomerName" class="form-control" required placeholder="Enter customer name">
                    </div>
                    <div class="form-group">
                        <label class="field-label">Phone Number</label>
                        <input type="tel" name="phone" class="form-control" placeholder="9876543210">
                    </div>
                </div>
                
                <div class="modal-form-row">
                    <div class="form-group">
                        <label class="field-label">Email Address</label>
                        <input type="email" name="email" class="form-control" placeholder="customer@example.com">
                    </div>
                    <div class="form-group">
                        <label class="field-label">GSTIN</label>
                        <input type="text" name="gstin" class="form-control" placeholder="27XXXXX1234X1Z5" maxlength="15">
                    </div>
                </div>
                
                <div class="modal-form-row modal-form-row--single">
                    <div class="form-group">
                        <label class="field-label">Address</label>
                        <textarea name="address" class="form-control" rows="2" placeholder="Shop/Building, Street, Area, City"></textarea>
                    </div>
                </div>
                
                <div class="modal-form-row">
                    <div class="form-group">
                        <label class="field-label field-label--required">State</label>
                        <select name="state" class="form-control" required>
                            <option value="">Select State</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Goa">Goa</option>
                            <option value="Gujarat">Gujarat</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra" selected>Maharashtra</option>
                            <option value="Manipur">Manipur</option>
                            <option value="Meghalaya">Meghalaya</option>
                            <option value="Mizoram">Mizoram</option>
                            <option value="Nagaland">Nagaland</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Sikkim">Sikkim</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Tripura">Tripura</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="West Bengal">West Bengal</option>
                            <option value="Delhi">Delhi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="field-label">Opening Balance (‚Çπ)</label>
                        <input type="number" name="opening_balance" class="form-control" step="0.01" value="0" placeholder="0">
                    </div>
                </div>
                
                <div class="modal-form-row">
                    <div class="form-group">
                        <label class="field-label">Credit Limit (‚Çπ)</label>
                        <input type="number" name="credit_limit" class="form-control" step="0.01" min="0" value="0" placeholder="50000">
                        <small class="help-text">0 = No limit</small>
                    </div>
                    <div class="form-group">
                        <label class="field-label">Payment Terms (Days)</label>
                        <input type="number" name="payment_terms_days" class="form-control" min="0" value="30" placeholder="30">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeAddCustomerModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ Save Customer</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
    overflow-y: auto;
}

.modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease;
    margin: 20px;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 2px solid #f0f0f0;
    position: sticky;
    top: 0;
    background: white;
    z-index: 1;
}

.modal-body {
    padding: 25px;
}

.modal-footer {
    padding: 15px 25px;
    border-top: 2px solid #f0f0f0;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    position: sticky;
    bottom: 0;
    background: white;
    z-index: 1;
}

.modal-close {
    transition: all 0.2s ease;
}

.modal-close:hover {
    transform: scale(1.2);
    color: #dc3545 !important;
}

.modal-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.modal-form-row--single {
    grid-template-columns: 1fr;
}

.modal-form-row .form-group {
    margin-bottom: 0;
}

.field-label--required::after {
    content: ' *';
    color: #dc3545;
}

/* Modal Overlay Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.modal.modal-open {
    display: flex !important;
}
</style>

<!-- Loyalty Redemption Modal -->
<div id="redeemModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2 style="margin: 0; color: #2c3e50; font-size: 20px;">üí∞ Redeem Loyalty Points</h2>
            <button type="button" onclick="closeRedeemModal()" class="modal-close" 
                    style="background: none; border: none; font-size: 28px; color: #95a5a6; cursor: pointer; line-height: 1; padding: 0;">
                √ó
            </button>
        </div>
        <div class="modal-body">
            <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 14px; color: #059669; font-weight: 600; margin-bottom: 5px;">Available Balance</div>
                <div style="font-size: 32px; font-weight: 700; color: #10b981;"><span id="modalAvailablePoints">0</span> pts</div>
                <div style="font-size: 14px; color: #059669; margin-top: 5px;">= ‚Çπ<span id="modalAvailableValue">0</span></div>
            </div>
            
            <div style="background: #fffbeb; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
                <div style="font-size: 13px; color: #92400e; font-weight: 600; margin-bottom: 5px;">Current Invoice Total</div>
                <div style="font-size: 24px; font-weight: 700; color: #b45309;">‚Çπ<span id="modalInvoiceTotal">0</span></div>
            </div>
            
            <div class="form-group">
                <label class="field-label" style="font-weight: 600; margin-bottom: 8px; display: block;">Enter Points to Redeem</label>
                <input type="number" id="pointsToRedeem" class="form-control" min="0" step="1" placeholder="Enter points" 
                       oninput="updateRedemptionPreview()" 
                       style="font-size: 18px; padding: 12px; text-align: center;">
                <small class="help-text" style="margin-top: 8px; display: block; text-align: center;" id="redemptionHint">
                    Enter points to see discount preview
                </small>
            </div>
            
            <div id="redemptionPreview" style="display: none; background: #ecfdf5; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <div style="font-size: 14px; color: #059669; margin-bottom: 5px;">Discount to be applied:</div>
                <div style="font-size: 28px; font-weight: 700; color: #10b981;">‚Çπ<span id="discountPreview">0</span></div>
                <div style="font-size: 13px; color: #059669; margin-top: 5px;">New invoice total: ‚Çπ<span id="newTotalPreview">0</span></div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" onclick="closeRedeemModal()" class="btn btn-secondary">Cancel</button>
            <button type="button" onclick="applyLoyaltyDiscount()" class="btn btn-success" id="applyRedemptionBtn">Apply Discount</button>
        </div>
    </div>
</div>

<script>
// ========================================
// LOYALTY PROGRAM FUNCTIONS
// ========================================

let loyaltySettings = null;
let customerLoyaltyData = null;

// Fetch loyalty settings on page load
window.addEventListener('DOMContentLoaded', function() {
    fetchLoyaltySettings();
    
    // If editing invoice and customer already selected, fetch loyalty
    const existingCustomerId = document.getElementById('customer_id').value;
    if (existingCustomerId && existingCustomerId.trim() !== '') {
        // Wait for settings to load first
        setTimeout(() => {
            fetchCustomerLoyalty(parseInt(existingCustomerId));
        }, 500);
    }
});

function fetchLoyaltySettings() {
    fetch('/api/loyalty/settings')
        .then(response => response.json())
        .then(data => {
            if (data.enabled) {
                loyaltySettings = data;
                console.log('‚úÖ Loyalty program enabled:', data);
            } else {
                console.log('‚ÑπÔ∏è Loyalty program not enabled for this tenant');
            }
        })
        .catch(error => {
            console.error('Error fetching loyalty settings:', error);
        });
}

// Fetch customer loyalty balance when customer is selected
function fetchCustomerLoyalty(customerId) {
    console.log('üéÅ fetchCustomerLoyalty called with ID:', customerId);
    console.log('üéÅ loyaltySettings:', loyaltySettings);
    
    if (!customerId) {
        console.log('‚ùå No customer ID provided');
        document.getElementById('loyaltySection').style.display = 'none';
        customerLoyaltyData = null;
        return;
    }
    
    if (!loyaltySettings) {
        console.log('‚ö†Ô∏è Loyalty settings not loaded yet');
        document.getElementById('loyaltySection').style.display = 'none';
        customerLoyaltyData = null;
        return;
    }
    
    console.log('üîÑ Fetching loyalty balance for customer:', customerId);
    
    fetch(`/api/loyalty/customer/${customerId}/balance`)
        .then(response => {
            console.log('üì° API Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ Loyalty data received:', data);
            
            if (data.points !== undefined) {
                customerLoyaltyData = data;
                updateLoyaltyDisplay();
                document.getElementById('loyaltySection').style.display = 'block';
                calculatePointsPreview(); // Calculate points for current invoice
                console.log('üíö Loyalty section now visible!');
            } else if (data.error) {
                console.error('‚ùå API returned error:', data.error);
                document.getElementById('loyaltySection').style.display = 'none';
            } else {
                console.warn('‚ö†Ô∏è Unexpected API response format:', data);
                document.getElementById('loyaltySection').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('‚ùå Error fetching customer loyalty:', error);
            document.getElementById('loyaltySection').style.display = 'none';
        });
}

function updateLoyaltyDisplay() {
    if (!customerLoyaltyData) return;
    
    const pointsValue = (customerLoyaltyData.points * loyaltySettings.redemption_value).toFixed(2);
    
    document.getElementById('loyaltyPoints').textContent = customerLoyaltyData.points;
    document.getElementById('loyaltyValue').textContent = pointsValue;
}

function calculatePointsPreview() {
    if (!loyaltySettings || !customerLoyaltyData) return;
    
    // Get current invoice total (before loyalty discount)
    const totalText = document.getElementById('totalDisplay').textContent;
    const invoiceTotal = parseFloat(totalText.replace('‚Çπ', '').replace(/,/g, '')) || 0;
    
    if (invoiceTotal <= 0) {
        document.getElementById('pointsPreview').style.display = 'none';
        return;
    }
    
    // Calculate base points
    const basePoints = Math.floor((invoiceTotal / loyaltySettings.points_earning_per_amount) * loyaltySettings.points_earning_rate);
    
    // Apply threshold bonuses (from settings)
    let bonusPoints = 0;
    if (loyaltySettings.threshold_bonuses && loyaltySettings.threshold_bonuses.length > 0) {
        // Find highest applicable threshold
        const applicableThresholds = loyaltySettings.threshold_bonuses
            .filter(t => invoiceTotal >= t.invoice_amount)
            .sort((a, b) => b.invoice_amount - a.invoice_amount);
        
        if (applicableThresholds.length > 0) {
            bonusPoints = applicableThresholds[0].bonus_points;
        }
    }
    
    const totalPoints = basePoints + bonusPoints;
    
    // Cap if max earning per invoice is set
    const maxEarning = loyaltySettings.max_earning_per_invoice || 0;
    const finalPoints = (maxEarning > 0 && totalPoints > maxEarning) ? maxEarning : totalPoints;
    
    // Update display
    document.getElementById('basePointsPreview').textContent = basePoints;
    if (bonusPoints > 0) {
        document.getElementById('bonusPoints').textContent = bonusPoints;
        document.getElementById('bonusPointsPreview').style.display = 'inline';
    } else {
        document.getElementById('bonusPointsPreview').style.display = 'none';
    }
    document.getElementById('totalPointsPreview').textContent = finalPoints;
    
    // FIX: Calculate new balance accounting for any pending redemptions
    // Current balance shown is already reduced if redemption was applied
    const newBalance = customerLoyaltyData.points + finalPoints;
    document.getElementById('newBalancePreview').textContent = newBalance;
    
    console.log('üìä Points Preview:', {
        currentBalance: customerLoyaltyData.points,
        pointsToEarn: finalPoints,
        newBalance: newBalance
    });
    
    // Show preview
    document.getElementById('pointsPreview').style.display = 'flex';
}

// Open redemption modal
function openRedeemModal() {
    if (!customerLoyaltyData || customerLoyaltyData.points <= 0) {
        alert('Customer has no points to redeem');
        return;
    }
    
    // Get current invoice total
    const totalText = document.getElementById('totalDisplay').textContent;
    const invoiceTotal = parseFloat(totalText.replace('‚Çπ', '').replace(/,/g, '')) || 0;
    
    if (invoiceTotal <= 0) {
        alert('Please add items to invoice first');
        return;
    }
    
    // Update modal values
    document.getElementById('modalAvailablePoints').textContent = customerLoyaltyData.points;
    document.getElementById('modalAvailableValue').textContent = (customerLoyaltyData.points * loyaltySettings.redemption_value).toFixed(2);
    document.getElementById('modalInvoiceTotal').textContent = invoiceTotal.toFixed(2);
    document.getElementById('pointsToRedeem').value = '';
    document.getElementById('redemptionPreview').style.display = 'none';
    document.getElementById('redemptionHint').textContent = 'Enter points to see discount preview';
    
    // Set max points (considering max redemption percentage)
    const maxRedemptionPercent = loyaltySettings.max_redemption_percentage || 100;
    const maxDiscountFromPercent = (invoiceTotal * maxRedemptionPercent) / 100;
    const maxPointsFromPercent = Math.floor(maxDiscountFromPercent / loyaltySettings.redemption_value);
    const maxPoints = Math.min(customerLoyaltyData.points, maxPointsFromPercent);
    
    document.getElementById('pointsToRedeem').max = maxPoints;
    document.getElementById('redemptionHint').textContent = `Maximum redeemable: ${maxPoints} pts`;
    
    // Show modal
    document.getElementById('redeemModal').style.display = 'flex';
}

function closeRedeemModal() {
    console.log('üö™ Closing redemption modal...');
    
    const modal = document.getElementById('redeemModal');
    if (modal) {
        modal.style.display = 'none';
        console.log('‚úÖ Modal closed successfully');
    } else {
        console.error('‚ùå Modal element not found!');
    }
}

// Close redeem modal on outside click
document.addEventListener('click', function(event) {
    const modal = document.getElementById('redeemModal');
    if (modal && event.target === modal) {
        closeRedeemModal();
    }
});

// Close redeem modal on Escape key
document.addEventListener('keydown', function(event) {
    const modal = document.getElementById('redeemModal');
    if (event.key === 'Escape' && modal && modal.style.display === 'flex') {
        closeRedeemModal();
    }
});

function updateRedemptionPreview() {
    const pointsToRedeem = parseInt(document.getElementById('pointsToRedeem').value) || 0;
    const maxPoints = parseInt(document.getElementById('pointsToRedeem').max) || 0;
    
    if (pointsToRedeem <= 0) {
        document.getElementById('redemptionPreview').style.display = 'none';
        document.getElementById('redemptionHint').textContent = `Maximum redeemable: ${maxPoints} pts`;
        return;
    }
    
    if (pointsToRedeem > maxPoints) {
        document.getElementById('redemptionPreview').style.display = 'none';
        document.getElementById('redemptionHint').innerHTML = `<span style="color: #dc2626;">‚ö†Ô∏è Cannot redeem more than ${maxPoints} pts</span>`;
        return;
    }
    
    if (pointsToRedeem < loyaltySettings.min_redemption_points) {
        document.getElementById('redemptionPreview').style.display = 'none';
        document.getElementById('redemptionHint').innerHTML = `<span style="color: #dc2626;">‚ö†Ô∏è Minimum ${loyaltySettings.min_redemption_points} pts required</span>`;
        return;
    }
    
    // Calculate discount
    const discount = pointsToRedeem * loyaltySettings.redemption_value;
    const currentTotal = parseFloat(document.getElementById('modalInvoiceTotal').textContent);
    const newTotal = Math.max(0, currentTotal - discount);
    
    // Update preview
    document.getElementById('discountPreview').textContent = discount.toFixed(2);
    document.getElementById('newTotalPreview').textContent = newTotal.toFixed(2);
    document.getElementById('redemptionPreview').style.display = 'block';
    document.getElementById('redemptionHint').textContent = `Redeeming ${pointsToRedeem} pts`;
}

function applyLoyaltyDiscount() {
    console.log('üí∞ Apply Loyalty Discount - START');
    
    try {
        const pointsToRedeem = parseInt(document.getElementById('pointsToRedeem').value) || 0;
        const maxPoints = parseInt(document.getElementById('pointsToRedeem').max) || 0;
        
        console.log('‚úÖ Step 1: Points validated -', pointsToRedeem, 'Max:', maxPoints);
        
        // Validation
        if (pointsToRedeem <= 0) {
            alert('Please enter points to redeem');
            return;
        }
        
        if (pointsToRedeem > maxPoints) {
            alert(`Cannot redeem more than ${maxPoints} points`);
            return;
        }
        
        if (pointsToRedeem < loyaltySettings.min_redemption_points) {
            alert(`Minimum ${loyaltySettings.min_redemption_points} points required for redemption`);
            return;
        }
        
        // Calculate discount
        const discount = pointsToRedeem * loyaltySettings.redemption_value;
        console.log('‚úÖ Step 2: Discount calculated -', discount);
        
        // Check if all required elements exist
        const requiredElements = [
            'loyalty_points_redeemed',
            'loyalty_discount',
            'redeemedPoints',
            'redeemedValue',
            'loyaltyRedeemed',
            'loyaltyDiscountRow',
            'loyaltyDiscountDisplay'
        ];
        
        for (const elementId of requiredElements) {
            if (!document.getElementById(elementId)) {
                console.error(`‚ùå Missing element: ${elementId}`);
                alert(`Error: Missing element "${elementId}". Please refresh the page.`);
                return;
            }
        }
        console.log('‚úÖ Step 3: All required elements found');
        
        // Update hidden inputs
        document.getElementById('loyalty_points_redeemed').value = pointsToRedeem;
        document.getElementById('loyalty_discount').value = discount.toFixed(2);
        console.log('‚úÖ Step 4: Hidden inputs updated');
        
        // Update redeemed display
        document.getElementById('redeemedPoints').textContent = pointsToRedeem;
        document.getElementById('redeemedValue').textContent = discount.toFixed(2);
        document.getElementById('loyaltyRedeemed').style.display = 'block';
        console.log('‚úÖ Step 5: Redeemed display updated');
        
        // Show loyalty discount row in invoice
        document.getElementById('loyaltyDiscountRow').style.display = '';
        document.getElementById('loyaltyDiscountDisplay').textContent = `-‚Çπ${discount.toFixed(2)}`;
        console.log('‚úÖ Step 6: Loyalty discount row shown');
        
        console.log('Before deduction - customerLoyaltyData.points:', customerLoyaltyData.points);
        
        // Update customer display (deduct points temporarily)
        customerLoyaltyData.points -= pointsToRedeem;
        
        console.log('After deduction - customerLoyaltyData.points:', customerLoyaltyData.points);
        console.log('‚úÖ Step 7: Customer points deducted');
        
        updateLoyaltyDisplay();
        console.log('‚úÖ Step 8: Loyalty display updated');
        
        // Recalculate total (loyalty discount applied after manual discount and before GST)
        calculateTotalWithLoyalty();
        console.log('‚úÖ Step 9: Total recalculated');
        
        console.log('‚úÖ Step 10: Loyalty discount applied successfully!');
        
        // Close modal
        closeRedeemModal();
        console.log('‚úÖ Step 11: Modal closed');
        
    } catch (error) {
        console.error('‚ùå Error in applyLoyaltyDiscount:', error);
        console.error('Error stack:', error.stack);
        alert(`Error: ${error.message}\n\nPlease check browser console (F12) for details.`);
    }
}

function removeLoyaltyDiscount() {
    const pointsRedeemed = parseInt(document.getElementById('loyalty_points_redeemed').value) || 0;
    
    // Reset hidden inputs
    document.getElementById('loyalty_points_redeemed').value = '0';
    document.getElementById('loyalty_discount').value = '0';
    
    // Hide redeemed display
    document.getElementById('loyaltyRedeemed').style.display = 'none';
    
    // Hide loyalty discount row
    document.getElementById('loyaltyDiscountRow').style.display = 'none';
    
    // Restore customer points
    customerLoyaltyData.points += pointsRedeemed;
    updateLoyaltyDisplay();
    
    // Recalculate total
    calculateTotal();
    calculatePointsPreview();
}

function calculateTotalWithLoyalty() {
    // Loyalty discount is now integrated into calculateTotal()
    // Just call it and update points preview
    calculateTotal();
    calculatePointsPreview();
}

// üÜï GST Smart Invoice: Validate stock on quantity change
function validateGSTStock(rowId) {
    const row = document.getElementById(`row_${rowId}`);
    if (!row) return;
    
    const itemId = row.dataset.itemId;
    const gstStock = parseFloat(row.dataset.gstStock || 0);
    const nonGstStock = parseFloat(row.dataset.nonGstStock || 0);
    const qtyInput = document.getElementById(`quantity_${rowId}`);
    const quantity = parseFloat(qtyInput.value || 0);
    const itemName = row.querySelector('.item-search').value;
    
    // Only validate for taxable invoices (default type)
    // If you add invoice type selector, check that here
    const invoiceType = 'taxable'; // Default
    
    if (quantity > 0 && itemId && invoiceType === 'taxable') {
        if (quantity > gstStock) {
            // Show warning
            showGSTStockWarning({
                rowId: rowId,
                itemName: itemName,
                requested: quantity,
                gstStock: gstStock,
                nonGstStock: nonGstStock,
                totalStock: gstStock + nonGstStock
            });
            return false;
        }
    }
    return true;
}

function showGSTStockWarning(data) {
    const modal = document.getElementById('gstStockWarningModal');
    const modalBody = document.getElementById('gstWarningContent');
    
    let optionsHtml = '';
    
    // Option 1: Reduce quantity
    if (data.gstStock > 0) {
        optionsHtml += `
            <button class="btn btn-primary btn-block mb-2" onclick="reduceQuantityToAvailable(${data.rowId}, ${data.gstStock})">
                ‚¨áÔ∏è Reduce Quantity to ${data.gstStock} units
                <small class="d-block" style="font-weight: normal;">Use only available GST stock</small>
            </button>
        `;
    }
    
    // Option 2: Change to Non-GST Invoice
    optionsHtml += `
        <button class="btn btn-info btn-block mb-2" onclick="alert('Non-GST invoice mode not yet implemented. Please manually remove GST or reduce quantity.')">
            üîÑ Change to Non-GST Invoice
            <small class="d-block" style="font-weight: normal;">No GST will be charged</small>
        </button>
    `;
    
    // Option 3: Use 2-Step Method (if non-GST stock available)
    if (data.nonGstStock > 0) {
        optionsHtml += `
            <button class="btn btn-success btn-block mb-2" onclick="showTwoStepInfo()">
                üí∞ Use 2-Step Method
                <small class="d-block" style="font-weight: normal;">Sell as non-GST first, then create credit note (earn commission)</small>
            </button>
        `;
    }
    
    // Option 4: Cancel
    optionsHtml += `
        <button class="btn btn-secondary btn-block" onclick="closeGSTWarning()">
            ‚ùå Cancel
        </button>
    `;
    
    modalBody.innerHTML = `
        <div class="alert alert-warning" style="background-color: #fff3cd; border-left: 4px solid #ffc107;">
            <h5 style="color: #856404;">‚ö†Ô∏è Insufficient GST Stock</h5>
            <p style="margin-bottom: 15px; color: #856404;">
                Cannot add <strong>${data.itemName}</strong> to this GST invoice.
            </p>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Requested Quantity</div>
                    <div style="font-size: 20px; font-weight: 600; color: #dc3545;">${data.requested} units</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">GST Stock Available</div>
                    <div style="font-size: 20px; font-weight: 600; color: ${data.gstStock > 0 ? '#28a745' : '#dc3545'};">${data.gstStock} units</div>
                </div>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Non-GST Stock Available</div>
                <div style="font-size: 16px; font-weight: 600; color: #17a2b8;">${data.nonGstStock} units</div>
                <small style="color: #666;">
                    ‚ÑπÔ∏è Non-GST stock cannot be used directly for GST invoices (prevents ITC fraud)
                </small>
            </div>
        </div>
        
        <h6 style="margin-bottom: 15px; color: #333;">Choose an option:</h6>
        ${optionsHtml}
        
        <div style="margin-top: 20px; padding: 10px; background: #e7f3ff; border-radius: 5px; font-size: 13px;">
            <strong>üí° Why this matters:</strong><br>
            You purchased this item <strong>without GST</strong> from an unregistered vendor. 
            Selling it with GST would break the ITC chain and could be considered GST fraud.
        </div>
    `;
    
    // Show modal
    $(modal).modal('show');
}

function reduceQuantityToAvailable(rowId, maxQuantity) {
    const qtyInput = document.getElementById(`quantity_${rowId}`);
    if (qtyInput) {
        qtyInput.value = maxQuantity;
        calculateRow(rowId);
    }
    closeGSTWarning();
}

function showTwoStepInfo() {
    alert(`üìù 2-Step Method:

Step 1: Create a NON-GST invoice now (customer pays, stock reduces)
Step 2: Later, create a Credit Adjustment invoice (GST-compliant, earn commission)

Note: Credit Adjustment UI is coming soon. For now, please:
1. Change this to a non-GST invoice, OR
2. Reduce quantity to available GST stock`);
    
    closeGSTWarning();
}

function closeGSTWarning() {
    $('#gstStockWarningModal').modal('hide');
}
</script>

<!-- üÜï GST Stock Warning Modal -->
<div class="modal fade" id="gstStockWarningModal" tabindex="-1" role="dialog" aria-labelledby="gstStockWarningModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 600px;">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title" id="gstStockWarningModalLabel">
                    üßæ GST Stock Validation
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white; opacity: 0.8;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="gstWarningContent">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

{% endblock %}


