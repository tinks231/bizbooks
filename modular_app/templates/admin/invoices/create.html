{% extends 'base_sidebar.html' %}

{% block title %}{% if invoice %}Edit Invoice{% else %}Create Invoice{% endif %} - {{ tenant.company_name }}{% endblock %}

{% block page_title %}{% if invoice %}Edit Invoice #{{ invoice.invoice_number }}{% else %}Create New Invoice{% endif %}{% endblock %}

{% block header_actions %}
<a href="{{ url_for('invoices.index') }}" class="btn btn-secondary">
    ‚Üê Back to Invoices
</a>
{% endblock %}

{% block content %}
<form method="POST" action="{% if invoice %}{{ url_for('invoices.edit', invoice_id=invoice.id) }}{% else %}{{ url_for('invoices.create') }}{% endif %}" id="invoiceForm">
    
    <!-- Customer Details Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Customer Details</h3>
        </div>
        
        <!-- Customer Search/Autocomplete -->
        <div class="form-group" style="position: relative;">
            <label for="customer_search">
                Search Existing Customer
                <a href="{{ url_for('customers.add') }}" target="_blank" style="font-size: 12px; margin-left: 10px;">
                    + Add New Customer
                </a>
            </label>
            <input type="text" id="customer_search" class="form-control" 
                   placeholder="Type customer name, code, or phone..." 
                   autocomplete="off"
                   oninput="searchCustomers(this.value)"
                   onfocus="searchCustomers(this.value)"
                   onblur="setTimeout(() => hideCustomerDropdown(), 200)">
            <div id="customer_dropdown" class="autocomplete-dropdown" style="display: none;"></div>
            <input type="hidden" id="customer_id" name="customer_id" value="{% if invoice and invoice.customer_id %}{{ invoice.customer_id }}{% endif %}">
            <small style="color: #666;">
                {% if invoice and invoice.customer %}
                    ‚úÖ Linked to: <strong>{{ invoice.customer.customer_code }}</strong>
                {% else %}
                    Select existing customer or fill details below manually
                {% endif %}
            </small>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="customer_name">Customer Name *</label>
                <input type="text" id="customer_name" name="customer_name" class="form-control" 
                       value="{% if invoice %}{{ invoice.customer_name }}{% endif %}" required>
            </div>
            
            <div class="form-group">
                <label for="customer_phone">Phone Number</label>
                <input type="tel" id="customer_phone" name="customer_phone" class="form-control"
                       value="{% if invoice %}{{ invoice.customer_phone or '' }}{% endif %}">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="customer_email">Email Address</label>
                <input type="email" id="customer_email" name="customer_email" class="form-control"
                       value="{% if invoice %}{{ invoice.customer_email or '' }}{% endif %}">
            </div>
            
            <div class="form-group">
                <label for="customer_gstin">GSTIN (Optional)</label>
                <input type="text" id="customer_gstin" name="customer_gstin" class="form-control" 
                       placeholder="27XXXXX1234X1Z5" maxlength="15"
                       value="{% if invoice %}{{ invoice.customer_gstin or '' }}{% endif %}">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="customer_address">Address</label>
                <textarea id="customer_address" name="customer_address" class="form-control" rows="2">{% if invoice %}{{ invoice.customer_address or '' }}{% endif %}</textarea>
            </div>
            
            <div class="form-group">
                <label for="customer_state">State *</label>
                <select id="customer_state" name="customer_state" class="form-control" required>
                    {% set selected_state = invoice.customer_state if invoice else 'Maharashtra' %}
                    <option value="Andhra Pradesh" {% if selected_state == 'Andhra Pradesh' %}selected{% endif %}>Andhra Pradesh</option>
                    <option value="Arunachal Pradesh" {% if selected_state == 'Arunachal Pradesh' %}selected{% endif %}>Arunachal Pradesh</option>
                    <option value="Assam" {% if selected_state == 'Assam' %}selected{% endif %}>Assam</option>
                    <option value="Bihar" {% if selected_state == 'Bihar' %}selected{% endif %}>Bihar</option>
                    <option value="Chhattisgarh" {% if selected_state == 'Chhattisgarh' %}selected{% endif %}>Chhattisgarh</option>
                    <option value="Goa" {% if selected_state == 'Goa' %}selected{% endif %}>Goa</option>
                    <option value="Gujarat" {% if selected_state == 'Gujarat' %}selected{% endif %}>Gujarat</option>
                    <option value="Haryana" {% if selected_state == 'Haryana' %}selected{% endif %}>Haryana</option>
                    <option value="Himachal Pradesh" {% if selected_state == 'Himachal Pradesh' %}selected{% endif %}>Himachal Pradesh</option>
                    <option value="Jharkhand" {% if selected_state == 'Jharkhand' %}selected{% endif %}>Jharkhand</option>
                    <option value="Karnataka" {% if selected_state == 'Karnataka' %}selected{% endif %}>Karnataka</option>
                    <option value="Kerala" {% if selected_state == 'Kerala' %}selected{% endif %}>Kerala</option>
                    <option value="Madhya Pradesh" {% if selected_state == 'Madhya Pradesh' %}selected{% endif %}>Madhya Pradesh</option>
                    <option value="Maharashtra" {% if selected_state == 'Maharashtra' %}selected{% endif %}>Maharashtra</option>
                    <option value="Manipur" {% if selected_state == 'Manipur' %}selected{% endif %}>Manipur</option>
                    <option value="Meghalaya" {% if selected_state == 'Meghalaya' %}selected{% endif %}>Meghalaya</option>
                    <option value="Mizoram" {% if selected_state == 'Mizoram' %}selected{% endif %}>Mizoram</option>
                    <option value="Nagaland" {% if selected_state == 'Nagaland' %}selected{% endif %}>Nagaland</option>
                    <option value="Odisha" {% if selected_state == 'Odisha' %}selected{% endif %}>Odisha</option>
                    <option value="Punjab" {% if selected_state == 'Punjab' %}selected{% endif %}>Punjab</option>
                    <option value="Rajasthan" {% if selected_state == 'Rajasthan' %}selected{% endif %}>Rajasthan</option>
                    <option value="Sikkim" {% if selected_state == 'Sikkim' %}selected{% endif %}>Sikkim</option>
                    <option value="Tamil Nadu" {% if selected_state == 'Tamil Nadu' %}selected{% endif %}>Tamil Nadu</option>
                    <option value="Telangana" {% if selected_state == 'Telangana' %}selected{% endif %}>Telangana</option>
                    <option value="Tripura" {% if selected_state == 'Tripura' %}selected{% endif %}>Tripura</option>
                    <option value="Uttar Pradesh" {% if selected_state == 'Uttar Pradesh' %}selected{% endif %}>Uttar Pradesh</option>
                    <option value="Uttarakhand" {% if selected_state == 'Uttarakhand' %}selected{% endif %}>Uttarakhand</option>
                    <option value="West Bengal" {% if selected_state == 'West Bengal' %}selected{% endif %}>West Bengal</option>
                    <option value="Delhi" {% if selected_state == 'Delhi' %}selected{% endif %}>Delhi</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Invoice Details Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Invoice Details</h3>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="invoice_date">Invoice Date *</label>
                <input type="date" id="invoice_date" name="invoice_date" class="form-control" 
                       value="{% if invoice %}{{ invoice.invoice_date.strftime('%Y-%m-%d') }}{% else %}{{ today }}{% endif %}" required>
            </div>
            
            <div class="form-group">
                <label for="due_date">Due Date (Optional)</label>
                <input type="date" id="due_date" name="due_date" class="form-control"
                       value="{% if invoice and invoice.due_date %}{{ invoice.due_date.strftime('%Y-%m-%d') }}{% endif %}">
            </div>
        </div>
    </div>
    
    <!-- Invoice Items Card -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">Invoice Items</h3>
            <button type="button" class="btn btn-primary btn-sm" onclick="addItemRow()">
                + Add Item
            </button>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="table" id="itemsTable">
                <thead>
                    <tr>
                        <th style="width: 30px;">#</th>
                        <th style="min-width: 200px;">Item Name *</th>
                        <th style="min-width: 100px;">HSN/SAC</th>
                        <th style="width: 80px;">Qty *</th>
                        <th style="width: 80px;">Unit</th>
                        <th style="width: 140px; text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                <span>Rate *</span>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: normal; cursor: pointer; white-space: nowrap;" title="Check this if the rate you enter already includes GST (like MRP on products)">
                                    <input type="checkbox" id="priceInclusiveAll" onchange="toggleAllPriceInclusive(this.checked)">
                                    <span>Tax Inclusive (MRP)</span>
                                </label>
                            </div>
                        </th>
                        <th style="width: 100px;">GST % *</th>
                        <th style="width: 120px;">Amount</th>
                        <th style="width: 50px;">Action</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    <!-- Items will be added here -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="7" style="text-align: right; font-weight: bold;">Subtotal:</td>
                        <td><span id="subtotalDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="7" style="text-align: right;">
                            Discount: 
                            <input type="number" id="discountInput" name="discount" step="0.01" min="0" 
                                   value="0" onchange="calculateTotal()" 
                                   style="width: 100px; display: inline-block; margin-left: 10px; padding: 5px; text-align: right;">
                        </td>
                        <td><span id="discountDisplay">-‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr id="cgstRow">
                        <td colspan="7" style="text-align: right;">CGST:</td>
                        <td><span id="cgstDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr id="sgstRow">
                        <td colspan="7" style="text-align: right;">SGST:</td>
                        <td><span id="sgstDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr id="igstRow" style="display: none;">
                        <td colspan="7" style="text-align: right;">IGST:</td>
                        <td><span id="igstDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="7" style="text-align: right; font-weight: bold; font-size: 18px;">Total:</td>
                        <td style="font-weight: bold; font-size: 18px;"><span id="totalDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    <!-- Notes Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Additional Information</h3>
        </div>
        
        <div class="form-group">
            <label for="payment_received">Payment Status *</label>
            {% set payment_status = invoice.payment_status if invoice else 'unpaid' %}
            <select id="payment_received" name="payment_received" class="form-control" required onchange="togglePaymentDetails(this.value)">
                <option value="no" {% if payment_status == 'unpaid' %}selected{% endif %}>Credit Sale (Payment Pending)</option>
                <option value="yes" {% if payment_status == 'paid' %}selected{% endif %}>Cash Sale (Payment Received)</option>
            </select>
            <small style="color: #666;">Select if payment has been received or it's a credit sale</small>
        </div>
        
        <div id="paymentDetails" style="{% if invoice and invoice.payment_status == 'paid' %}display: block;{% else %}display: none;{% endif %}">
            <div class="form-row">
                <div class="form-group">
                    <label for="payment_method">Payment Method</label>
                    {% set selected_method = invoice.payment_method if invoice else 'Cash' %}
                    <select id="payment_method" name="payment_method" class="form-control">
                        <option value="Cash" {% if selected_method == 'Cash' %}selected{% endif %}>Cash</option>
                        <option value="UPI" {% if selected_method == 'UPI' %}selected{% endif %}>UPI</option>
                        <option value="Card" {% if selected_method == 'Card' %}selected{% endif %}>Card</option>
                        <option value="Cheque" {% if selected_method == 'Cheque' %}selected{% endif %}>Cheque</option>
                        <option value="Bank Transfer" {% if selected_method == 'Bank Transfer' %}selected{% endif %}>Bank Transfer</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="payment_reference">Payment Reference (Optional)</label>
                    <input type="text" id="payment_reference" name="payment_reference" class="form-control" 
                           placeholder="Transaction ID, Cheque No, etc."
                           value="{% if invoice and invoice.internal_notes %}{{ invoice.internal_notes.replace('Payment Reference: ', '') }}{% endif %}">
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="notes">Terms & Conditions / Notes</label>
            <textarea id="notes" name="notes" class="form-control" rows="3" 
                      placeholder="Payment due within 30 days...">{% if invoice and invoice.notes %}{{ invoice.notes }}{% else %}{{ tenant_settings.get('invoice_terms', 'Payment due within 30 days. Goods once sold will not be taken back.') }}{% endif %}</textarea>
        </div>
    </div>
    
    <!-- Submit Buttons -->
    <div style="display: flex; gap: 15px; margin-bottom: 30px;">
        <button type="submit" class="btn btn-primary" style="flex: 1;">
            {% if invoice %}‚úèÔ∏è Update Invoice{% else %}üíæ Save Invoice{% endif %}
        </button>
        <a href="{{ url_for('invoices.index') }}" class="btn btn-secondary" style="flex: 1;">
            Cancel
        </a>
    </div>
    
    <script>
    function togglePaymentDetails(value) {
        const paymentDetails = document.getElementById('paymentDetails');
        if (value === 'yes') {
            paymentDetails.style.display = 'block';
        } else {
            paymentDetails.style.display = 'none';
        }
    }
    </script>
    
</form>

<style>
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #2c3e50;
    }
    
    .form-control {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #3498db;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    .table td {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .table tfoot td {
        padding: 12px;
        font-weight: 600;
    }
    
    .table input, .table select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .btn-danger-small {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-danger-small:hover {
        background: #c0392b;
    }
    
    /* Autocomplete Dropdown Styles */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .autocomplete-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
    }
    
    .autocomplete-item:hover {
        background: #f8f9fa;
    }
    
    .autocomplete-item-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
    }
    
    .autocomplete-item-details {
        font-size: 12px;
        color: #666;
        display: flex;
        gap: 15px;
    }
    
    .autocomplete-item-details span {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .autocomplete-no-results {
        padding: 20px;
        text-align: center;
        color: #999;
        font-size: 14px;
    }
    
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .table {
            font-size: 12px;
        }
        
        .table input, .table select {
            padding: 6px;
            font-size: 12px;
        }
        
        .autocomplete-item {
            padding: 10px;
        }
        
        .autocomplete-item-details {
            font-size: 11px;
            flex-direction: column;
            gap: 4px;
        }
    }
</style>

<script>
    let itemCount = 0;
    const items = {{ items|tojson }};
    const tenantState = "{{ tenant_settings.get('state', 'Maharashtra') }}";
    
    // Add first item row on page load
    window.addEventListener('DOMContentLoaded', function() {
        addItemRow();
    });
    
    function addItemRow() {
        itemCount++;
        const tbody = document.getElementById('itemsTableBody');
        const row = document.createElement('tr');
        row.id = `row_${itemCount}`;
        
        row.innerHTML = `
            <td>${itemCount}</td>
            <td style="position: relative;">
                <input type="text" name="item_name[]" class="form-control item-search" 
                       id="item_search_${itemCount}"
                       placeholder="Type to search items..." 
                       required 
                       autocomplete="off"
                       oninput="searchItems(this, ${itemCount})"
                       onfocus="searchItems(this, ${itemCount})"
                       onblur="setTimeout(() => hideDropdown(${itemCount}), 200)">
                <div class="autocomplete-dropdown" id="dropdown_${itemCount}"></div>
                <input type="hidden" name="item_id[]" id="item_id_${itemCount}">
                <input type="hidden" name="description[]" id="description_${itemCount}">
            </td>
            <td>
                <input type="text" name="hsn_code[]" class="form-control" placeholder="8544">
            </td>
            <td>
                <input type="number" name="quantity[]" class="form-control" step="0.01" min="0.01" 
                       placeholder="1" required onchange="calculateRow(${itemCount})">
            </td>
            <td>
                <select name="unit[]" class="form-control">
                    <option value="Nos">Nos</option>
                    <option value="Kg">Kg</option>
                    <option value="Ltr">Ltr</option>
                    <option value="Mtr">Mtr</option>
                    <option value="Box">Box</option>
                    <option value="Pcs">Pcs</option>
                </select>
            </td>
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="number" name="rate[]" id="rate_${itemCount}" class="form-control" step="0.01" min="0.01" 
                           placeholder="1200" required onchange="calculateRow(${itemCount})" 
                           style="text-align: right; flex: 1; min-width: 80px;">
                    <label style="display: flex; align-items: center; gap: 4px; margin: 0; cursor: pointer; white-space: nowrap;">
                        <input type="checkbox" name="price_inclusive[]" id="price_inclusive_${itemCount}" 
                               class="price-inclusive-checkbox" onchange="calculateRow(${itemCount})" value="off">
                        <span style="font-size: 11px; color: #666;">Inc</span>
                    </label>
                </div>
            </td>
            <td>
                <select name="gst_rate[]" class="form-control" onchange="calculateRow(${itemCount})">
                    <option value="0">0%</option>
                    <option value="5">5%</option>
                    <option value="12">12%</option>
                    <option value="18" selected>18%</option>
                    <option value="28">28%</option>
                </select>
            </td>
            <td>
                <span id="amount_${itemCount}">‚Çπ0.00</span>
            </td>
            <td>
                <button type="button" class="btn-danger-small" onclick="removeItemRow(${itemCount})">
                    üóëÔ∏è
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    }
    
    function removeItemRow(rowId) {
        const row = document.getElementById(`row_${rowId}`);
        if (row) {
            row.remove();
            calculateTotal();
        }
    }
    
    function searchItems(input, rowId) {
        const searchTerm = input.value.toLowerCase().trim();
        const dropdown = document.getElementById(`dropdown_${rowId}`);
        
        if (!searchTerm) {
            dropdown.style.display = 'none';
            return;
        }
        
        // Filter items based on search term
        const filteredItems = items.filter(item => 
            item.name.toLowerCase().includes(searchTerm)
        );
        
        if (filteredItems.length === 0) {
            dropdown.innerHTML = `
                <div class="autocomplete-no-results">
                    No items found. You can type manually or add items to inventory first.
                </div>
            `;
            dropdown.style.display = 'block';
            return;
        }
        
        // Build dropdown HTML
        let html = '';
        filteredItems.slice(0, 10).forEach(item => { // Show max 10 results
            html += `
                <div class="autocomplete-item" onclick="selectItemFromDropdown(${rowId}, ${item.id}, '${item.name.replace(/'/g, "\\'")}', ${item.selling_price}, '${item.hsn_code || ''}')">
                    <div class="autocomplete-item-name">${item.name}</div>
                    <div class="autocomplete-item-details">
                        <span>üí∞ Rate: ‚Çπ${item.selling_price || 0}</span>
                        ${item.hsn_code ? `<span>üìã HSN: ${item.hsn_code}</span>` : ''}
                    </div>
                </div>
            `;
        });
        
        dropdown.innerHTML = html;
        dropdown.style.display = 'block';
    }
    
    function selectItemFromDropdown(rowId, itemId, itemName, price, hsnCode) {
        const row = document.getElementById(`row_${rowId}`);
        if (!row) return;
        
        // Set item name
        const itemInput = document.getElementById(`item_search_${rowId}`);
        itemInput.value = itemName;
        
        // Set hidden item ID
        document.getElementById(`item_id_${rowId}`).value = itemId;
        
        // Set HSN code
        const hsnInput = row.querySelector('input[name="hsn_code[]"]');
        if (hsnInput && hsnCode) {
            hsnInput.value = hsnCode;
        }
        
        // Set rate
        const rateInput = row.querySelector('input[name="rate[]"]');
        if (rateInput) {
            rateInput.value = price || 0;
        }
        
        // Hide dropdown
        hideDropdown(rowId);
        
        // Calculate row totals
        calculateRow(rowId);
        
        // Focus on quantity field
        const qtyInput = row.querySelector('input[name="quantity[]"]');
        if (qtyInput) {
            qtyInput.focus();
        }
    }
    
    function hideDropdown(rowId) {
        const dropdown = document.getElementById(`dropdown_${rowId}`);
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }
    
    function calculateRow(rowId) {
        const row = document.getElementById(`row_${rowId}`);
        if (!row) return;
        
        const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
        const rate = parseFloat(row.querySelector('input[name="rate[]"]').value) || 0;
        const gstRate = parseFloat(row.querySelector('select[name="gst_rate[]"]').value) || 0;
        const priceInclusiveCheckbox = row.querySelector('input[name="price_inclusive[]"]');
        const priceInclusive = priceInclusiveCheckbox && priceInclusiveCheckbox.checked;
        
        let taxableValue, gstAmount, total;
        
        if (priceInclusive) {
            // Price is INCLUSIVE of GST (like MRP)
            // Total amount per unit = rate
            const ratePerUnit = rate;
            total = qty * ratePerUnit;
            
            // Calculate base price (without GST)
            const divisor = 1 + (gstRate / 100);
            taxableValue = total / divisor;
            gstAmount = total - taxableValue;
        } else {
            // Price is EXCLUSIVE of GST (traditional)
            // Base price per unit = rate
            taxableValue = qty * rate;
            gstAmount = taxableValue * (gstRate / 100);
            total = taxableValue + gstAmount;
        }
        
        document.getElementById(`amount_${rowId}`).textContent = `‚Çπ${total.toFixed(2)}`;
        
        // Store calculated values as data attributes for total calculation
        row.setAttribute('data-taxable', taxableValue.toFixed(2));
        row.setAttribute('data-gst', gstAmount.toFixed(2));
        row.setAttribute('data-total', total.toFixed(2));
        
        calculateTotal();
    }
    
    function toggleAllPriceInclusive(checked) {
        const checkboxes = document.querySelectorAll('.price-inclusive-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = checked;
        });
        
        // Recalculate all rows
        const rows = document.querySelectorAll('#itemsTableBody tr');
        rows.forEach((row, index) => {
            const rowId = row.id.replace('row_', '');
            calculateRow(rowId);
        });
    }
    
    function calculateTotal() {
        let subtotal = 0;
        let totalGSTAmount = 0;
        let totalCGST = 0;
        let totalSGST = 0;
        let totalIGST = 0;
        
        const customerState = document.getElementById('customer_state').value;
        const isSameState = customerState === tenantState;
        
        // Show/hide GST rows
        document.getElementById('cgstRow').style.display = isSameState ? '' : 'none';
        document.getElementById('sgstRow').style.display = isSameState ? '' : 'none';
        document.getElementById('igstRow').style.display = isSameState ? 'none' : '';
        
        // Use stored calculated values from data attributes
        const rows = document.querySelectorAll('#itemsTableBody tr');
        rows.forEach(row => {
            const taxableValue = parseFloat(row.getAttribute('data-taxable')) || 0;
            const gstAmount = parseFloat(row.getAttribute('data-gst')) || 0;
            
            subtotal += taxableValue;
            totalGSTAmount += gstAmount;
            
            if (isSameState) {
                totalCGST += gstAmount / 2;
                totalSGST += gstAmount / 2;
            } else {
                totalIGST += gstAmount;
            }
        });
        
        // Apply discount
        const discount = parseFloat(document.getElementById('discountInput').value) || 0;
        const subtotalAfterDiscount = subtotal - discount;
        
        // Recalculate GST after discount
        const discountRatio = subtotalAfterDiscount / (subtotal || 1);
        totalCGST = totalCGST * discountRatio;
        totalSGST = totalSGST * discountRatio;
        totalIGST = totalIGST * discountRatio;
        
        const total = subtotalAfterDiscount + totalCGST + totalSGST + totalIGST;
        
        document.getElementById('subtotalDisplay').textContent = `‚Çπ${subtotal.toFixed(2)}`;
        document.getElementById('discountDisplay').textContent = discount > 0 ? `-‚Çπ${discount.toFixed(2)}` : `‚Çπ0.00`;
        document.getElementById('cgstDisplay').textContent = `‚Çπ${totalCGST.toFixed(2)}`;
        document.getElementById('sgstDisplay').textContent = `‚Çπ${totalSGST.toFixed(2)}`;
        document.getElementById('igstDisplay').textContent = `‚Çπ${totalIGST.toFixed(2)}`;
        document.getElementById('totalDisplay').textContent = `‚Çπ${Math.round(total).toFixed(2)}`;
    }
    
    // Recalculate when state changes
    document.getElementById('customer_state').addEventListener('change', calculateTotal);
    
    // Set today's date (only for new invoices)
    {% if not invoice %}
    document.getElementById('invoice_date').valueAsDate = new Date();
    {% endif %}
    
    {% if invoice and invoice.items %}
    // Edit mode: Pre-populate items
    window.addEventListener('DOMContentLoaded', function() {
        const existingItems = {{ invoice.items|tojson }};
        const tbody = document.getElementById('itemsTableBody');
        tbody.innerHTML = ''; // Clear the default row
        itemCount = 0; // Reset counter
        
        existingItems.forEach(function(item) {
            addItemRowWithData(item);
        });
        
        // Set discount if exists
        {% if invoice.discount_amount %}
        document.getElementById('discountInput').value = {{ invoice.discount_amount }};
        {% endif %}
        
        calculateTotal();
    });
    
    function addItemRowWithData(itemData) {
        itemCount++;
        const tbody = document.getElementById('itemsTableBody');
        const row = document.createElement('tr');
        row.id = `row_${itemCount}`;
        
        // Determine if price was inclusive (reverse calculate)
        const rate = itemData.rate || 0;
        const quantity = itemData.quantity || 1;
        const taxableValue = itemData.taxable_value || 0;
        const gstRate = itemData.gst_rate || 0;
        
        // Check by comparing: if rate * quantity == taxable_value, it's exclusive
        // if different, it was inclusive
        const isExclusive = Math.abs((rate * quantity) - taxableValue) < 0.01;
        const isPriceInclusive = !isExclusive;
        
        row.innerHTML = `
            <td>${itemCount}</td>
            <td style="position: relative;">
                <input type="text" name="item_name[]" class="form-control item-search" 
                       id="item_search_${itemCount}"
                       value="${itemData.item_name || ''}"
                       placeholder="Type to search items..." 
                       required 
                       autocomplete="off"
                       oninput="searchItems(this, ${itemCount})"
                       onfocus="searchItems(this, ${itemCount})"
                       onblur="setTimeout(() => hideDropdown(${itemCount}), 200)">
                <div class="autocomplete-dropdown" id="dropdown_${itemCount}"></div>
                <input type="hidden" name="item_id[]" id="item_id_${itemCount}" value="${itemData.item_id || ''}">
                <input type="hidden" name="description[]" id="description_${itemCount}" value="${itemData.description || ''}">
            </td>
            <td>
                <input type="text" name="hsn_code[]" class="form-control" placeholder="8544" value="${itemData.hsn_code || ''}">
            </td>
            <td>
                <input type="number" name="quantity[]" id="quantity_${itemCount}" class="form-control" step="0.01" min="0.01" 
                       placeholder="1" value="${itemData.quantity || 1}" required onchange="calculateRow(${itemCount})">
            </td>
            <td>
                <select name="unit[]" class="form-control">
                    <option value="Nos" ${itemData.unit === 'Nos' ? 'selected' : ''}>Nos</option>
                    <option value="Kg" ${itemData.unit === 'Kg' ? 'selected' : ''}>Kg</option>
                    <option value="Ltr" ${itemData.unit === 'Ltr' ? 'selected' : ''}>Ltr</option>
                    <option value="Mtr" ${itemData.unit === 'Mtr' ? 'selected' : ''}>Mtr</option>
                    <option value="Box" ${itemData.unit === 'Box' ? 'selected' : ''}>Box</option>
                    <option value="Pcs" ${itemData.unit === 'Pcs' ? 'selected' : ''}>Pcs</option>
                </select>
            </td>
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="number" name="rate[]" id="rate_${itemCount}" class="form-control" step="0.01" min="0.01" 
                           placeholder="1200" value="${itemData.rate || 0}" required onchange="calculateRow(${itemCount})" 
                           style="text-align: right; flex: 1; min-width: 80px;">
                    <label style="display: flex; align-items: center; gap: 4px; margin: 0; cursor: pointer; white-space: nowrap;">
                        <input type="checkbox" name="price_inclusive[]" id="price_inclusive_${itemCount}" 
                               class="price-inclusive-checkbox" ${isPriceInclusive ? 'checked' : ''} onchange="calculateRow(${itemCount})">
                        <span style="font-size: 11px; color: #666;">Inc</span>
                    </label>
                </div>
            </td>
            <td>
                <select name="gst_rate[]" id="gst_rate_${itemCount}" class="form-control" onchange="calculateRow(${itemCount})">
                    <option value="0" ${itemData.gst_rate === 0 ? 'selected' : ''}>0%</option>
                    <option value="5" ${itemData.gst_rate === 5 ? 'selected' : ''}>5%</option>
                    <option value="12" ${itemData.gst_rate === 12 ? 'selected' : ''}>12%</option>
                    <option value="18" ${itemData.gst_rate === 18 ? 'selected' : ''}>18%</option>
                    <option value="28" ${itemData.gst_rate === 28 ? 'selected' : ''}>28%</option>
                </select>
            </td>
            <td>
                <span id="amount_${itemCount}" style="font-weight: 600;">‚Çπ${itemData.total_amount ? itemData.total_amount.toFixed(2) : '0.00'}</span>
            </td>
            <td>
                <button type="button" class="btn-remove" onclick="removeItem(${itemCount})" title="Remove item">üóëÔ∏è</button>
            </td>
        `;
        
        tbody.appendChild(row);
    }
    {% endif %}
    
    // Customer Autocomplete
    let customerSearchTimeout;
    
    function searchCustomers(query) {
        clearTimeout(customerSearchTimeout);
        
        if (query.length < 2) {
            hideCustomerDropdown();
            return;
        }
        
        customerSearchTimeout = setTimeout(function() {
            fetch(`/admin/customers/api/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(customers => {
                    const dropdown = document.getElementById('customer_dropdown');
                    
                    if (customers.length === 0) {
                        dropdown.innerHTML = '<div class="dropdown-item">No customers found</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    dropdown.innerHTML = customers.map(customer => `
                        <div class="dropdown-item" onclick="selectCustomer(${customer.id}, '${customer.name.replace(/'/g, "\\'")}', '${customer.phone}', '${customer.email}', '${customer.address ? customer.address.replace(/'/g, "\\'").replace(/\n/g, " ") : ""}', '${customer.gstin || ""}', '${customer.state}', '${customer.customer_code}')">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${customer.name}</strong>
                                    <small style="display: block; color: #666;">${customer.customer_code}</small>
                                    ${customer.phone ? `<small style="display: block; color: #666;">üìû ${customer.phone}</small>` : ''}
                                </div>
                                ${customer.outstanding > 0 ? `<span style="color: #e74c3c; font-weight: 600; white-space: nowrap;">‚Çπ${customer.outstanding.toFixed(2)}</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                    
                    dropdown.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error searching customers:', error);
                });
        }, 300);
    }
    
    function selectCustomer(id, name, phone, email, address, gstin, state, customerCode) {
        // Set hidden customer_id
        document.getElementById('customer_id').value = id;
        
        // Fill customer details
        document.getElementById('customer_name').value = name;
        document.getElementById('customer_phone').value = phone || '';
        document.getElementById('customer_email').value = email || '';
        document.getElementById('customer_address').value = address || '';
        document.getElementById('customer_gstin').value = gstin || '';
        document.getElementById('customer_state').value = state || 'Maharashtra';
        
        // Clear and update search field
        document.getElementById('customer_search').value = `${customerCode} - ${name}`;
        
        // Hide dropdown
        hideCustomerDropdown();
        
        // Trigger state change for GST calculation
        document.getElementById('customer_state').dispatchEvent(new Event('change'));
    }
    
    function hideCustomerDropdown() {
        document.getElementById('customer_dropdown').style.display = 'none';
    }
</script>

{% endblock %}

