{% extends 'base_sidebar.html' %}

{% block title %}Create Invoice - {{ tenant.company_name }}{% endblock %}

{% block page_title %}Create New Invoice{% endblock %}

{% block header_actions %}
<a href="{{ url_for('invoices.index') }}" class="btn btn-secondary">
    ‚Üê Back to Invoices
</a>
{% endblock %}

{% block content %}
<form method="POST" action="{{ url_for('invoices.create') }}" id="invoiceForm">
    
    <!-- Customer Details Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Customer Details</h3>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="customer_name">Customer Name *</label>
                <input type="text" id="customer_name" name="customer_name" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="customer_phone">Phone Number</label>
                <input type="tel" id="customer_phone" name="customer_phone" class="form-control">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="customer_email">Email Address</label>
                <input type="email" id="customer_email" name="customer_email" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="customer_gstin">GSTIN (Optional)</label>
                <input type="text" id="customer_gstin" name="customer_gstin" class="form-control" 
                       placeholder="27XXXXX1234X1Z5" maxlength="15">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="customer_address">Address</label>
                <textarea id="customer_address" name="customer_address" class="form-control" rows="2"></textarea>
            </div>
            
            <div class="form-group">
                <label for="customer_state">State *</label>
                <select id="customer_state" name="customer_state" class="form-control" required>
                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                    <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                    <option value="Assam">Assam</option>
                    <option value="Bihar">Bihar</option>
                    <option value="Chhattisgarh">Chhattisgarh</option>
                    <option value="Goa">Goa</option>
                    <option value="Gujarat">Gujarat</option>
                    <option value="Haryana">Haryana</option>
                    <option value="Himachal Pradesh">Himachal Pradesh</option>
                    <option value="Jharkhand">Jharkhand</option>
                    <option value="Karnataka">Karnataka</option>
                    <option value="Kerala">Kerala</option>
                    <option value="Madhya Pradesh">Madhya Pradesh</option>
                    <option value="Maharashtra" selected>Maharashtra</option>
                    <option value="Manipur">Manipur</option>
                    <option value="Meghalaya">Meghalaya</option>
                    <option value="Mizoram">Mizoram</option>
                    <option value="Nagaland">Nagaland</option>
                    <option value="Odisha">Odisha</option>
                    <option value="Punjab">Punjab</option>
                    <option value="Rajasthan">Rajasthan</option>
                    <option value="Sikkim">Sikkim</option>
                    <option value="Tamil Nadu">Tamil Nadu</option>
                    <option value="Telangana">Telangana</option>
                    <option value="Tripura">Tripura</option>
                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                    <option value="Uttarakhand">Uttarakhand</option>
                    <option value="West Bengal">West Bengal</option>
                    <option value="Delhi">Delhi</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Invoice Details Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Invoice Details</h3>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="invoice_date">Invoice Date *</label>
                <input type="date" id="invoice_date" name="invoice_date" class="form-control" 
                       value="{{ today }}" required>
            </div>
            
            <div class="form-group">
                <label for="due_date">Due Date (Optional)</label>
                <input type="date" id="due_date" name="due_date" class="form-control">
            </div>
        </div>
    </div>
    
    <!-- Invoice Items Card -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">Invoice Items</h3>
            <button type="button" class="btn btn-primary btn-sm" onclick="addItemRow()">
                + Add Item
            </button>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="table" id="itemsTable">
                <thead>
                    <tr>
                        <th style="width: 30px;">#</th>
                        <th style="min-width: 200px;">Item Name *</th>
                        <th style="min-width: 100px;">HSN/SAC</th>
                        <th style="width: 80px;">Qty *</th>
                        <th style="width: 80px;">Unit</th>
                        <th style="width: 140px; text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                <span>Rate *</span>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: normal; cursor: pointer; white-space: nowrap;" title="Check this if the rate you enter already includes GST (like MRP on products)">
                                    <input type="checkbox" id="priceInclusiveAll" onchange="toggleAllPriceInclusive(this.checked)">
                                    <span>Tax Inclusive (MRP)</span>
                                </label>
                            </div>
                        </th>
                        <th style="width: 100px;">GST % *</th>
                        <th style="width: 120px;">Amount</th>
                        <th style="width: 50px;">Action</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    <!-- Items will be added here -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="7" style="text-align: right; font-weight: bold;">Subtotal:</td>
                        <td><span id="subtotalDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="7" style="text-align: right;">
                            Discount: 
                            <input type="number" id="discountInput" name="discount" step="0.01" min="0" 
                                   value="0" onchange="calculateTotal()" 
                                   style="width: 100px; display: inline-block; margin-left: 10px; padding: 5px; text-align: right;">
                        </td>
                        <td><span id="discountDisplay">-‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr id="cgstRow">
                        <td colspan="7" style="text-align: right;">CGST:</td>
                        <td><span id="cgstDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr id="sgstRow">
                        <td colspan="7" style="text-align: right;">SGST:</td>
                        <td><span id="sgstDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr id="igstRow" style="display: none;">
                        <td colspan="7" style="text-align: right;">IGST:</td>
                        <td><span id="igstDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="7" style="text-align: right; font-weight: bold; font-size: 18px;">Total:</td>
                        <td style="font-weight: bold; font-size: 18px;"><span id="totalDisplay">‚Çπ0.00</span></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    <!-- Notes Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Additional Information</h3>
        </div>
        
        <div class="form-group">
            <label for="payment_received">Payment Status *</label>
            <select id="payment_received" name="payment_received" class="form-control" required onchange="togglePaymentDetails(this.value)">
                <option value="no">Credit Sale (Payment Pending)</option>
                <option value="yes">Cash Sale (Payment Received)</option>
            </select>
            <small style="color: #666;">Select if payment has been received or it's a credit sale</small>
        </div>
        
        <div id="paymentDetails" style="display: none;">
            <div class="form-row">
                <div class="form-group">
                    <label for="payment_method">Payment Method</label>
                    <select id="payment_method" name="payment_method" class="form-control">
                        <option value="Cash">Cash</option>
                        <option value="UPI">UPI</option>
                        <option value="Card">Card</option>
                        <option value="Cheque">Cheque</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="payment_reference">Payment Reference (Optional)</label>
                    <input type="text" id="payment_reference" name="payment_reference" class="form-control" 
                           placeholder="Transaction ID, Cheque No, etc.">
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="notes">Terms & Conditions / Notes</label>
            <textarea id="notes" name="notes" class="form-control" rows="3" 
                      placeholder="Payment due within 30 days...">{{ tenant_settings.get('invoice_terms', 'Payment due within 30 days. Goods once sold will not be taken back.') }}</textarea>
        </div>
    </div>
    
    <!-- Submit Buttons -->
    <div style="display: flex; gap: 15px; margin-bottom: 30px;">
        <button type="submit" class="btn btn-primary" style="flex: 1;">
            üíæ Save Invoice
        </button>
        <a href="{{ url_for('invoices.index') }}" class="btn btn-secondary" style="flex: 1;">
            Cancel
        </a>
    </div>
    
    <script>
    function togglePaymentDetails(value) {
        const paymentDetails = document.getElementById('paymentDetails');
        if (value === 'yes') {
            paymentDetails.style.display = 'block';
        } else {
            paymentDetails.style.display = 'none';
        }
    }
    </script>
    
</form>

<style>
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #2c3e50;
    }
    
    .form-control {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #3498db;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    .table td {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .table tfoot td {
        padding: 12px;
        font-weight: 600;
    }
    
    .table input, .table select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .btn-danger-small {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-danger-small:hover {
        background: #c0392b;
    }
    
    /* Autocomplete Dropdown Styles */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .autocomplete-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
    }
    
    .autocomplete-item:hover {
        background: #f8f9fa;
    }
    
    .autocomplete-item-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
    }
    
    .autocomplete-item-details {
        font-size: 12px;
        color: #666;
        display: flex;
        gap: 15px;
    }
    
    .autocomplete-item-details span {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .autocomplete-no-results {
        padding: 20px;
        text-align: center;
        color: #999;
        font-size: 14px;
    }
    
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .table {
            font-size: 12px;
        }
        
        .table input, .table select {
            padding: 6px;
            font-size: 12px;
        }
        
        .autocomplete-item {
            padding: 10px;
        }
        
        .autocomplete-item-details {
            font-size: 11px;
            flex-direction: column;
            gap: 4px;
        }
    }
</style>

<script>
    let itemCount = 0;
    const items = {{ items|tojson }};
    const tenantState = "{{ tenant_settings.get('state', 'Maharashtra') }}";
    
    // Add first item row on page load
    window.addEventListener('DOMContentLoaded', function() {
        addItemRow();
    });
    
    function addItemRow() {
        itemCount++;
        const tbody = document.getElementById('itemsTableBody');
        const row = document.createElement('tr');
        row.id = `row_${itemCount}`;
        
        row.innerHTML = `
            <td>${itemCount}</td>
            <td style="position: relative;">
                <input type="text" name="item_name[]" class="form-control item-search" 
                       id="item_search_${itemCount}"
                       placeholder="Type to search items..." 
                       required 
                       autocomplete="off"
                       oninput="searchItems(this, ${itemCount})"
                       onfocus="searchItems(this, ${itemCount})"
                       onblur="setTimeout(() => hideDropdown(${itemCount}), 200)">
                <div class="autocomplete-dropdown" id="dropdown_${itemCount}"></div>
                <input type="hidden" name="item_id[]" id="item_id_${itemCount}">
                <input type="hidden" name="description[]" id="description_${itemCount}">
            </td>
            <td>
                <input type="text" name="hsn_code[]" class="form-control" placeholder="8544">
            </td>
            <td>
                <input type="number" name="quantity[]" class="form-control" step="0.01" min="0.01" 
                       placeholder="1" required onchange="calculateRow(${itemCount})">
            </td>
            <td>
                <select name="unit[]" class="form-control">
                    <option value="Nos">Nos</option>
                    <option value="Kg">Kg</option>
                    <option value="Ltr">Ltr</option>
                    <option value="Mtr">Mtr</option>
                    <option value="Box">Box</option>
                    <option value="Pcs">Pcs</option>
                </select>
            </td>
            <td>
                <input type="number" name="rate[]" id="rate_${itemCount}" class="form-control" step="0.01" min="0.01" 
                       placeholder="1200" required onchange="calculateRow(${itemCount})" style="text-align: right;">
                <input type="hidden" name="price_inclusive[]" id="price_inclusive_${itemCount}" class="price-inclusive-checkbox" value="off">
            </td>
            <td>
                <select name="gst_rate[]" class="form-control" onchange="calculateRow(${itemCount})">
                    <option value="0">0%</option>
                    <option value="5">5%</option>
                    <option value="12">12%</option>
                    <option value="18" selected>18%</option>
                    <option value="28">28%</option>
                </select>
            </td>
            <td>
                <span id="amount_${itemCount}">‚Çπ0.00</span>
            </td>
            <td>
                <button type="button" class="btn-danger-small" onclick="removeItemRow(${itemCount})">
                    üóëÔ∏è
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    }
    
    function removeItemRow(rowId) {
        const row = document.getElementById(`row_${rowId}`);
        if (row) {
            row.remove();
            calculateTotal();
        }
    }
    
    function searchItems(input, rowId) {
        const searchTerm = input.value.toLowerCase().trim();
        const dropdown = document.getElementById(`dropdown_${rowId}`);
        
        if (!searchTerm) {
            dropdown.style.display = 'none';
            return;
        }
        
        // Filter items based on search term
        const filteredItems = items.filter(item => 
            item.name.toLowerCase().includes(searchTerm)
        );
        
        if (filteredItems.length === 0) {
            dropdown.innerHTML = `
                <div class="autocomplete-no-results">
                    No items found. You can type manually or add items to inventory first.
                </div>
            `;
            dropdown.style.display = 'block';
            return;
        }
        
        // Build dropdown HTML
        let html = '';
        filteredItems.slice(0, 10).forEach(item => { // Show max 10 results
            html += `
                <div class="autocomplete-item" onclick="selectItemFromDropdown(${rowId}, ${item.id}, '${item.name.replace(/'/g, "\\'")}', ${item.selling_price}, '${item.hsn_code || ''}')">
                    <div class="autocomplete-item-name">${item.name}</div>
                    <div class="autocomplete-item-details">
                        <span>üí∞ Rate: ‚Çπ${item.selling_price || 0}</span>
                        ${item.hsn_code ? `<span>üìã HSN: ${item.hsn_code}</span>` : ''}
                    </div>
                </div>
            `;
        });
        
        dropdown.innerHTML = html;
        dropdown.style.display = 'block';
    }
    
    function selectItemFromDropdown(rowId, itemId, itemName, price, hsnCode) {
        const row = document.getElementById(`row_${rowId}`);
        if (!row) return;
        
        // Set item name
        const itemInput = document.getElementById(`item_search_${rowId}`);
        itemInput.value = itemName;
        
        // Set hidden item ID
        document.getElementById(`item_id_${rowId}`).value = itemId;
        
        // Set HSN code
        const hsnInput = row.querySelector('input[name="hsn_code[]"]');
        if (hsnInput && hsnCode) {
            hsnInput.value = hsnCode;
        }
        
        // Set rate
        const rateInput = row.querySelector('input[name="rate[]"]');
        if (rateInput) {
            rateInput.value = price || 0;
        }
        
        // Hide dropdown
        hideDropdown(rowId);
        
        // Calculate row totals
        calculateRow(rowId);
        
        // Focus on quantity field
        const qtyInput = row.querySelector('input[name="quantity[]"]');
        if (qtyInput) {
            qtyInput.focus();
        }
    }
    
    function hideDropdown(rowId) {
        const dropdown = document.getElementById(`dropdown_${rowId}`);
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }
    
    function calculateRow(rowId) {
        const row = document.getElementById(`row_${rowId}`);
        if (!row) return;
        
        const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
        const rate = parseFloat(row.querySelector('input[name="rate[]"]').value) || 0;
        const gstRate = parseFloat(row.querySelector('select[name="gst_rate[]"]').value) || 0;
        const priceInclusiveInput = row.querySelector('input[name="price_inclusive[]"]');
        const priceInclusive = priceInclusiveInput && priceInclusiveInput.value === 'on';
        
        let taxableValue, gstAmount, total;
        
        if (priceInclusive) {
            // Price is INCLUSIVE of GST (like MRP)
            // Total amount per unit = rate
            const ratePerUnit = rate;
            total = qty * ratePerUnit;
            
            // Calculate base price (without GST)
            const divisor = 1 + (gstRate / 100);
            taxableValue = total / divisor;
            gstAmount = total - taxableValue;
        } else {
            // Price is EXCLUSIVE of GST (traditional)
            // Base price per unit = rate
            taxableValue = qty * rate;
            gstAmount = taxableValue * (gstRate / 100);
            total = taxableValue + gstAmount;
        }
        
        document.getElementById(`amount_${rowId}`).textContent = `‚Çπ${total.toFixed(2)}`;
        
        // Store calculated values as data attributes for total calculation
        row.setAttribute('data-taxable', taxableValue.toFixed(2));
        row.setAttribute('data-gst', gstAmount.toFixed(2));
        row.setAttribute('data-total', total.toFixed(2));
        
        calculateTotal();
    }
    
    function toggleAllPriceInclusive(checked) {
        const hiddenInputs = document.querySelectorAll('.price-inclusive-checkbox');
        hiddenInputs.forEach(input => {
            input.value = checked ? 'on' : 'off';
        });
        
        // Recalculate all rows
        const rows = document.querySelectorAll('#itemsTableBody tr');
        rows.forEach((row, index) => {
            const rowId = row.id.replace('row_', '');
            calculateRow(rowId);
        });
    }
    
    function calculateTotal() {
        let subtotal = 0;
        let totalGSTAmount = 0;
        let totalCGST = 0;
        let totalSGST = 0;
        let totalIGST = 0;
        
        const customerState = document.getElementById('customer_state').value;
        const isSameState = customerState === tenantState;
        
        // Show/hide GST rows
        document.getElementById('cgstRow').style.display = isSameState ? '' : 'none';
        document.getElementById('sgstRow').style.display = isSameState ? '' : 'none';
        document.getElementById('igstRow').style.display = isSameState ? 'none' : '';
        
        // Use stored calculated values from data attributes
        const rows = document.querySelectorAll('#itemsTableBody tr');
        rows.forEach(row => {
            const taxableValue = parseFloat(row.getAttribute('data-taxable')) || 0;
            const gstAmount = parseFloat(row.getAttribute('data-gst')) || 0;
            
            subtotal += taxableValue;
            totalGSTAmount += gstAmount;
            
            if (isSameState) {
                totalCGST += gstAmount / 2;
                totalSGST += gstAmount / 2;
            } else {
                totalIGST += gstAmount;
            }
        });
        
        // Apply discount
        const discount = parseFloat(document.getElementById('discountInput').value) || 0;
        const subtotalAfterDiscount = subtotal - discount;
        
        // Recalculate GST after discount
        const discountRatio = subtotalAfterDiscount / (subtotal || 1);
        totalCGST = totalCGST * discountRatio;
        totalSGST = totalSGST * discountRatio;
        totalIGST = totalIGST * discountRatio;
        
        const total = subtotalAfterDiscount + totalCGST + totalSGST + totalIGST;
        
        document.getElementById('subtotalDisplay').textContent = `‚Çπ${subtotal.toFixed(2)}`;
        document.getElementById('discountDisplay').textContent = discount > 0 ? `-‚Çπ${discount.toFixed(2)}` : `‚Çπ0.00`;
        document.getElementById('cgstDisplay').textContent = `‚Çπ${totalCGST.toFixed(2)}`;
        document.getElementById('sgstDisplay').textContent = `‚Çπ${totalSGST.toFixed(2)}`;
        document.getElementById('igstDisplay').textContent = `‚Çπ${totalIGST.toFixed(2)}`;
        document.getElementById('totalDisplay').textContent = `‚Çπ${Math.round(total).toFixed(2)}`;
    }
    
    // Recalculate when state changes
    document.getElementById('customer_state').addEventListener('change', calculateTotal);
    
    // Set today's date
    document.getElementById('invoice_date').valueAsDate = new Date();
</script>

{% endblock %}

