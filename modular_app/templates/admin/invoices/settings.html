{% extends 'base_sidebar.html' %}

{% block title %}Invoice Settings - {{ tenant.company_name }}{% endblock %}

{% block page_title %}Invoice Settings{% endblock %}

{% block header_actions %}
<a href="{{ url_for('invoices.index') }}" class="btn btn-secondary">
    ‚Üê Back to Invoices
</a>
{% endblock %}

{% block content %}

<form method="POST" action="{{ url_for('invoices.settings') }}" enctype="multipart/form-data">
    
    <!-- Business Details Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Business Details</h3>
            <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">
                These details will appear on your invoices
            </p>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="gstin">GSTIN (GST Number) *</label>
                <input type="text" id="gstin" name="gstin" class="form-control" 
                       value="{{ settings.get('gstin', '') }}" 
                       placeholder="27XXXXX1234X1Z5" 
                       maxlength="15" required>
                <small style="color: #666; margin-top: 5px;">15-digit GST identification number</small>
            </div>
            
            <div class="form-group">
                <label for="pan">PAN Card Number</label>
                <input type="text" id="pan" name="pan" class="form-control" 
                       value="{{ settings.get('pan', '') }}" 
                       placeholder="ABCDE1234F" 
                       maxlength="10" style="text-transform: uppercase;">
                <small style="color: #666; margin-top: 5px;">10-character PAN number (optional)</small>
            </div>
        </div>
        
        <div class="form-group">
            <label for="address">Business Address *</label>
            <textarea id="address" name="address" class="form-control" rows="2" required>{{ settings.get('address', '') }}</textarea>
            <small style="color: #666; margin-top: 5px;">Full address including building/shop number</small>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" name="city" class="form-control" 
                       value="{{ settings.get('city', '') }}" required>
            </div>
            
            <div class="form-group">
                <label for="state">State *</label>
                <select id="state" name="state" class="form-control" required>
                    <option value="">Select State</option>
                    {% set states = [
                        'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh',
                        'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand',
                        'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur',
                        'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab',
                        'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura',
                        'Uttar Pradesh', 'Uttarakhand', 'West Bengal', 'Delhi'
                    ] %}
                    {% for state_name in states %}
                    <option value="{{ state_name }}" {% if settings.get('state') == state_name %}selected{% endif %}>
                        {{ state_name }}
                    </option>
                    {% endfor %}
                </select>
                <small style="color: #666; margin-top: 5px;">Used for GST calculation (CGST+SGST vs IGST)</small>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="pincode">Pincode *</label>
                <input type="text" id="pincode" name="pincode" class="form-control" 
                       value="{{ settings.get('pincode', '') }}" 
                       placeholder="411001" 
                       maxlength="6" required>
            </div>
            
            <div class="form-group">
                <label for="phone">Contact Phone *</label>
                <input type="tel" id="phone" name="phone" class="form-control" 
                       value="{{ settings.get('phone', tenant.admin_phone) }}" 
                       placeholder="9876543210" 
                       maxlength="15" required>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="email">Contact Email *</label>
                <input type="email" id="email" name="email" class="form-control" 
                       value="{{ settings.get('email', tenant.admin_email) }}" 
                       placeholder="contact@yourbusiness.com" required>
            </div>
            
            <div class="form-group">
                <label for="website">Website</label>
                <input type="url" id="website" name="website" class="form-control" 
                       value="{{ settings.get('website', '') }}" 
                       placeholder="www.yourbusiness.com">
            </div>
        </div>
    </div>
    
    <!-- Invoice Customization Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Invoice Customization</h3>
            <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">
                Customize how your invoices look
            </p>
        </div>
        
        <!-- Logo Upload Section -->
        <div class="form-group" style="border: 2px dashed #ddd; padding: 20px; border-radius: 8px; background: #f8f9fa;">
            <label for="logo" style="font-size: 16px; display: flex; align-items: center; gap: 8px;">
                üñºÔ∏è Company Logo
            </label>
            
            {% if settings.get('logo_url') %}
            <div style="margin: 15px 0; padding: 15px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                <p style="margin-bottom: 10px; font-weight: 600; color: #2c3e50;">Current Logo:</p>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <img src="{{ settings.get('logo_url') }}" alt="Current Logo" 
                         style="max-width: 150px; max-height: 100px; object-fit: contain; border: 1px solid #ddd; padding: 10px; background: white;">
                    <div>
                        <p style="margin: 0; color: #666; font-size: 14px;">‚úÖ Logo uploaded successfully</p>
                        <p style="margin: 5px 0 0 0; color: #999; font-size: 12px;">Upload a new image below to replace it</p>
                    </div>
                </div>
            </div>
            {% else %}
            <div style="margin: 10px 0; padding: 15px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffc107;">
                <p style="margin: 0; color: #856404; font-size: 14px;">
                    ‚ö†Ô∏è No logo uploaded yet. Your invoices will appear without a logo.
                </p>
            </div>
            {% endif %}
            
            <input type="file" id="logo" name="logo" class="form-control" 
                   accept="image/png,image/jpeg,image/jpg" 
                   onchange="previewLogo(this)"
                   style="margin-top: 15px;">
            <small style="color: #666; margin-top: 8px;">
                üìå Recommended: PNG or JPG, max 2MB, square format (e.g., 300x300px) for best results
                <br>üîí Secure: Files are stored securely and only visible on your invoices
            </small>
            
            <!-- Logo Preview -->
            <div id="logoPreview" style="margin-top: 15px; display: none;">
                <p style="font-weight: 600; margin-bottom: 8px; color: #2c3e50;">Preview:</p>
                <img id="logoPreviewImg" src="" alt="Logo Preview" 
                     style="max-width: 150px; max-height: 100px; border: 2px solid #3498db; padding: 10px; background: white; border-radius: 5px;">
            </div>
        </div>
        
        <div class="form-group">
            <label for="invoice_terms">Terms & Conditions</label>
            <textarea id="invoice_terms" name="invoice_terms" class="form-control" rows="3">{{ settings.get('invoice_terms', 'Payment due within 30 days.\nGoods once sold will not be taken back.\nSubject to Pune jurisdiction only.') }}</textarea>
            <small style="color: #666; margin-top: 5px;">Default terms that appear on all invoices (can be edited per invoice)</small>
        </div>
        
        <div class="form-group">
            <label for="invoice_footer">Invoice Footer Text</label>
            <input type="text" id="invoice_footer" name="invoice_footer" class="form-control" 
                   value="{{ settings.get('invoice_footer', 'Thank you for your business!') }}" 
                   placeholder="Thank you for your business!">
            <small style="color: #666; margin-top: 5px;">Appears at the bottom of invoices</small>
        </div>
    </div>
    
    <!-- Submit Button -->
    <div style="display: flex; gap: 15px; margin-bottom: 30px;">
        <button type="submit" class="btn btn-primary" style="flex: 1;">
            üíæ Save Settings
        </button>
        <a href="{{ url_for('invoices.index') }}" class="btn btn-secondary" style="flex: 1;">
            Cancel
        </a>
    </div>
    
</form>

<!-- Help Section -->
<div class="card" style="background: #f8f9fa; border-left: 4px solid #3498db;">
    <h4 style="margin-bottom: 15px; color: #2c3e50;">üí° Quick Tips</h4>
    
    <div style="margin-bottom: 15px;">
        <strong>GSTIN Format:</strong>
        <p style="margin: 5px 0; color: #666;">
            15 characters: 2 digits (state code) + 10 digits (PAN) + 1 digit (entity number) + Z + 1 check digit
            <br>Example: <code>27XXXXX1234X1Z5</code>
        </p>
    </div>
    
    <div style="margin-bottom: 15px;">
        <strong>State Selection:</strong>
        <p style="margin: 5px 0; color: #666;">
            Choose your business state correctly! This determines whether CGST+SGST or IGST is applied.
            <br>‚Ä¢ Same state transaction ‚Üí CGST (9%) + SGST (9%) = 18%
            <br>‚Ä¢ Inter-state transaction ‚Üí IGST (18%)
        </p>
    </div>
    
    <div>
        <strong>Need Help?</strong>
        <p style="margin: 5px 0; color: #666;">
            Contact your accountant or CA for GST registration assistance.
        </p>
    </div>
</div>

<style>
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #2c3e50;
    }
    
    .form-control {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #3498db;
    }
    
    small {
        font-size: 12px;
        display: block;
    }
    
    code {
        background: #e8f4fd;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        color: #2c3e50;
    }
    
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    function previewLogo(input) {
        const preview = document.getElementById('logoPreview');
        const previewImg = document.getElementById('logoPreviewImg');
        
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('‚ö†Ô∏è File too large! Please upload an image smaller than 2MB.');
                input.value = '';
                preview.style.display = 'none';
                return;
            }
            
            // Check file type
            if (!file.type.match('image/(png|jpeg|jpg)')) {
                alert('‚ö†Ô∏è Invalid file type! Please upload a PNG or JPG image.');
                input.value = '';
                preview.style.display = 'none';
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
        }
    }
</script>

{% endblock %}

