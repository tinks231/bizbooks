{% extends 'base_sidebar.html' %}

{% block title %}Invoice #{{ invoice.invoice_number }} - {{ tenant.company_name }}{% endblock %}

{% block page_title %}{% endblock %}

{% block header_actions %}
<div class="no-print" style="display: flex; gap: 10px; flex-wrap: wrap;">
    <button onclick="window.print()" class="btn btn-primary">
        üñ®Ô∏è Print Invoice
    </button>
    
    {% if invoice.payment_status in ['unpaid', 'partial'] %}
    <button onclick="document.getElementById('paymentModal').style.display='block'" class="btn btn-success">
        üí∞ Record Payment
    </button>
    {% endif %}
    
    {% if invoice.status == 'draft' %}
    <form method="POST" action="{{ url_for('invoices.mark_sent', invoice_id=invoice.id) }}" style="display: inline;">
        <button type="submit" class="btn btn-primary" 
                onclick="return confirm('Mark this invoice as sent to customer?')">
            ‚úâÔ∏è Mark as Sent
        </button>
    </form>
    <a href="{{ url_for('invoices.edit', invoice_id=invoice.id) }}" class="btn btn-secondary">
        ‚úèÔ∏è Edit
    </a>
    {% endif %}
    
    <a href="{{ url_for('invoices.index') }}" class="btn btn-secondary">
        ‚Üê Back to Invoices
    </a>
</div>
{% endblock %}

{% block content %}

<style>
/* === GLOBAL INVOICE STYLE (Professional Theme) === */

.invoice {
    width: 100%;
    max-width: 1100px;
    margin: 0 auto;
    font-family: "Inter", Arial, sans-serif;
    font-size: 13px;
    color: #2c3e50;
    line-height: 1.45;
    background: #fff;
    padding: 24px 32px;
    box-shadow: 0 1px 3px rgba(15,23,42,0.06);
    box-sizing: border-box;
}

h1, h2, h3, h4 {
    margin: 0;
    font-weight: 600;
}

.text-right { text-align: right; }
.text-center { text-align: center; }

.invoice-header {
    display: grid;
    grid-template-columns: 1fr auto 1fr;  /* symmetric left/right */
    align-items: flex-start;
    column-gap: 16px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e5e7eb;
}

.header-left {
    display: flex;
    align-items: center;
    justify-content: flex-start;
}

.invoice-logo {
    max-height: 48px;
    max-width: 80px;
    object-fit: contain;
}

.header-center {
    text-align: center;
}

.company-name-strong {
    font-size: 16px;
    font-weight: 700;
}

.company-address {
    font-size: 13px;
    color: #4b5563;
    margin-top: 2px;
}

.header-right {
    text-align: right;
    font-size: 13px;
    color: #4b5563;
    padding-right: 8px;  /* Consistent padding for all right-aligned sections */
}

.header-right div {
    margin-bottom: 3px;
}

.invoice-meta-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.invoice-meta-table td {
    padding: 3px 0;          /* tighter than default */
}

.invoice-meta-table td:first-child {
    color: #6b7280;
}

.invoice-meta-table td:last-child {
    font-weight: 500;
}

.invoice-title {
    text-align: center;
    font-size: 22px;
    font-weight: 700;
    margin: 18px 0;
}

.section {
    margin: 15px 0;
}

.section-title {
    font-size: 14px;
    font-weight: 600;
    border-bottom: 1px solid #ececec;
    margin-bottom: 10px;
    padding-bottom: 4px;
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.table th {
    background: #f8f8f8;
    padding: 8px;
    font-size: 12px;
    font-weight: 600;
}

.table td {
    padding: 6px;
    border-bottom: 1px solid #efefef;
}

.table tfoot td {
    border: none;
}

.total-row td {
    padding: 10px 6px;
    font-size: 15px;
    font-weight: 700;
    background: #eef2ff;
}

.footer {
    margin-top: 25px;
    text-align: center;
    font-size: 12px;
    color: #777;
}

.signature-block {
    display: flex;
    justify-content: space-between;
    margin-top: 25px;
}

.signature-box {
    width: 45%;
    text-align: center;
}
.signature-line {
    margin-top: 50px;
    border-top: 1px solid #444;
    padding-top: 6px;
}

/* Print cleanup */
@media print {
    /* Hide ALL UI elements - be very aggressive */
    .no-print,
    .sidebar,
    #sidebar,
    .header-actions,
    nav,
    button,
    .btn,
    .main-sidebar,
    .top-bar,
    .navbar,
    header:not(.invoice-header),
    .header:not(.invoice-header),
    [class*="sidebar"]:not(.invoice),
    [class*="nav"]:not(.invoice),
    .page-header,
    .breadcrumb,
    aside,
    .logo-container,
    .user-profile,
    .menu,
    .navigation,
    *[role="navigation"] { 
        display: none !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
    }
    
    /* Reset page layout - full width */
    html, body { 
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: auto !important;
    }
    
    /* Main content should take full width */
    .main-content {
        margin-left: 0 !important;
        padding-left: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
    }
    
    .top-header {
        display: none !important;
    }
    
    .mobile-menu-btn {
        display: none !important;
    }
    
    aside {
        display: none !important;
    }
    
    .content,
    .container,
    .container-fluid,
    main {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
    }
    
    .invoice { 
        max-width: 100% !important;
        width: 100% !important;
        box-shadow: none !important;
        padding: 10mm !important;  /* Reduced padding for better use of space */
        margin: 0 !important;
    }
    
    /* Ensure all sections are full width */
    .invoice-header,
    .section,
    .table,
    .invoice-meta-table {
        width: 100% !important;
        max-width: 100% !important;
    }
    
    /* Larger fonts for print */
    .invoice {
        font-size: 12pt !important;
    }
    
    .company-name-strong {
        font-size: 16pt !important;
    }
    
    .invoice-title {
        font-size: 20pt !important;
    }
    
    .section-title {
        font-size: 13pt !important;
    }
    
    .table th {
        font-size: 11pt !important;
    }
    
    .table td {
        font-size: 11pt !important;
    }
    
    .total-row td {
        font-size: 14pt !important;
    }
    
    /* Ensure content fits on page */
    .invoice-header,
    .section,
    .table,
    .signature-block {
        page-break-inside: avoid;
    }
    
    /* Let print use the same layout as screen - it already works! */
    .section {
        width: 100% !important;
        max-width: 100% !important;
    }
    
    /* Make Bill To / Invoice Details align with header in print */
    .invoice-info-row {
        display: grid !important;
        grid-template-columns: 1fr auto 1fr !important;  /* same as .invoice-header */
        column-gap: 16px !important;
        align-items: flex-start;
        width: 100% !important;
    }
    
    .invoice-info-row .bill-to {
        grid-column: 1 / span 2;
        width: auto !important;     /* ignore 50% inline width */
        padding-right: 0 !important;
    }
    
    .invoice-info-row .invoice-details {
        grid-column: 3;
        width: auto !important;     /* ignore 45% inline width */
        padding-left: 0 !important;
        text-align: right !important;  /* Align with header-right */
        display: flex;
        flex-direction: column;
        align-items: flex-end;  /* Push content to right edge */
    }
    
    .invoice-info-row .invoice-details .section-title {
        text-align: right !important;
        width: 100%;
    }
    
    .invoice-info-row .invoice-details table {
        width: auto !important;  /* Don't stretch to 100% */
        margin-left: auto;  /* Push table to right */
    }
    
    /* Ensure table cells are right-aligned */
    .invoice-info-row .invoice-details table td {
        text-align: right !important;
        padding: 3px 0 !important;
    }
    
    .invoice-info-row .invoice-details table td:first-child {
        padding-right: 20px !important;  /* Space between label and value */
        text-align: right !important;
    }
    
    /* Ensure items table spans full width and aligns with sections above */
    .invoice .table {
        width: 100% !important;
        table-layout: auto !important;  /* Let browser size columns naturally */
        max-width: 100% !important;
    }
    
    /* Column widths for better wrapping */
    .invoice .table th:nth-child(1),
    .invoice .table td:nth-child(1) {
        width: 4%;     /* # */
    }
    .invoice .table th:nth-child(2),
    .invoice .table td:nth-child(2) {
        width: 30%;    /* Item */
    }
    .invoice .table th:nth-child(3),
    .invoice .table td:nth-child(3) {
        width: 9%;     /* HSN */
    }
    .invoice .table th:nth-child(4),
    .invoice .table td:nth-child(4) {
        width: 8%;     /* Qty */
    }
    .invoice .table th:nth-child(5),
    .invoice .table td:nth-child(5) {
        width: 9%;     /* MRP */
    }
    .invoice .table th:nth-child(6),
    .invoice .table td:nth-child(6) {
        width: 7%;     /* Disc % */
    }
    .invoice .table th:nth-child(7),
    .invoice .table td:nth-child(7) {
        width: 10%;    /* Qty */
    }
    .invoice .table th:nth-child(5),
    .invoice .table td:nth-child(5) {
        width: 10%;    /* Rate */
    }
    .invoice .table th:nth-child(6),
    .invoice .table td:nth-child(6) {
        width: 10%;    /* GST % */
    }
    .invoice .table th:nth-child(7),
    .invoice .table td:nth-child(7) {
        width: 15%;    /* Amount (right-aligned already) */
    }
    
    /* This section is now handled below with consistent 8px padding */
    
    /* 
     * UNIFIED ALIGNMENT STRATEGY:
     * All right-aligned content uses 8px right padding for perfect alignment
     */
    
    /* Header-right section (phone/email/GSTIN) */
    .header-right {
        padding-right: 8px !important;
    }
    
    /* Invoice Details section container */
    .invoice-info-row .invoice-details {
        padding-right: 8px !important;
    }
    
    /* Invoice Details table cells (remove their padding, container has 8px) */
    .invoice-info-row .invoice-details table td {
        padding-right: 0 !important;
        text-align: right !important;
    }
    
    /* Items table: AMOUNT column header and values */
    .invoice .table thead th:last-child,
    .invoice .table tbody td:last-child,
    .invoice .table tfoot td:last-child {
        text-align: right !important;
        padding-right: 8px !important;
    }
    
    /* Subtotal and TOTAL labels (right-align) */
    .invoice .table tfoot tr td:first-child {
        text-align: right !important;
        font-weight: 600 !important;
    }
    
    /* All footer cells right-aligned */
    .invoice .table tfoot tr td {
        text-align: right !important;
    }
    
    /* Print-specific page setup */
    @page {
        margin: 0;  /* Let print dialog control margins - works with "Default" setting */
        size: A4;
    }
    
    /* Override any conflicting styles */
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
}
</style>

<div class="invoice">

    <!-- HEADER -->
    <div class="invoice-header">
        <div class="header-left">
            {% if tenant_settings and tenant_settings.get('logo_url') %}
            <img src="{{ tenant_settings.get('logo_url') }}" class="invoice-logo" alt="Logo">
            {% endif %}
        </div>
        <div class="header-center">
            <div class="company-name-strong">{{ tenant.company_name }}</div>
            {% if tenant_settings and tenant_settings.get('address') %}
            <div class="company-address">{{ tenant_settings.get('address') }}</div>
            {% endif %}
        </div>
        <div class="header-right">
            <div>üìû {{ tenant_settings.get('phone', tenant.admin_phone) if tenant_settings else tenant.admin_phone }}</div>
            <div>‚úâÔ∏è {{ tenant_settings.get('email', tenant.admin_email) if tenant_settings else tenant.admin_email }}</div>
            {% if tenant_settings and tenant_settings.get('gstin') %}
            <div><strong>GSTIN:</strong> {{ tenant_settings.get('gstin') }}</div>
            {% endif %}
        </div>
    </div>

    <div class="invoice-title">TAX INVOICE</div>

    <div class="section">
        <div class="invoice-info-row" style="display:flex;justify-content:space-between;">
            <div class="bill-to" style="width:50%;">
                <div class="section-title">Bill To</div>
                <strong>{{ invoice.customer_name }}</strong><br>
                {% if invoice.customer_id and invoice.customer %}
                <small>Customer ID: {{ invoice.customer.customer_code }}</small><br>
                {% endif %}
                {% if invoice.customer_phone %}üìû {{ invoice.customer_phone }}<br>{% endif %}
                {% if invoice.customer_email %}‚úâÔ∏è {{ invoice.customer_email }}<br>{% endif %}
                {% if invoice.customer_address %}{{ invoice.customer_address }}<br>{% endif %}
                {% if invoice.customer_gstin %}<strong>GSTIN:</strong> {{ invoice.customer_gstin }}<br>{% endif %}
                {% if invoice.customer_state %}<strong>State:</strong> {{ invoice.customer_state }}{% endif %}
            </div>

            <div class="invoice-details" style="width:45%;">
                <div class="section-title">Invoice Details</div>
                <table class="invoice-meta-table">
                    <tr>
                        <td>Invoice No:</td>
                        <td class="text-right">{{ invoice.invoice_number }}</td>
                    </tr>
                    <tr>
                        <td>Date:</td>
                        <td class="text-right">{{ invoice.invoice_date.strftime('%d-%m-%Y') }}</td>
                    </tr>
                    {% if invoice.due_date %}
                    <tr>
                        <td>Due Date:</td>
                        <td class="text-right">{{ invoice.due_date.strftime('%d-%m-%Y') }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td>Status:</td>
                        <td class="text-right">{{ invoice.status.upper() }}</td>
                    </tr>
                    <tr>
                        <td>Payment:</td>
                        <td class="text-right">{{ invoice.payment_status.upper() }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- ITEMS -->
    <table class="table">
        <thead>
            <tr>
                <th>#</th>
                <th>Item</th>
                <th>HSN</th>
                <th>Qty</th>
                <th>MRP</th>
                <th>Disc %</th>
                <th>Rate</th>
                <th>GST %</th>
                <th class="text-right">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for item in invoice.items %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>
                    {{ item.item_name }}
                    {% if item.description %}<br><small style="color:#666;">{{ item.description }}</small>{% endif %}
                </td>
                <td>{{ item.hsn_code or '-' }}</td>
                <td>{{ item.quantity }} {{ item.unit }}</td>
                <td>
                    {% if item.item and item.item.mrp %}
                        ‚Çπ{{ "%.2f"|format(item.item.mrp) }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td style="color: #27ae60; font-weight: 600;">
                    {% if item.item and item.item.discount_percent > 0 %}
                        {{ "%.1f"|format(item.item.discount_percent) }}%
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ "%.2f"|format(item.rate) }}</td>
                <td>{{ item.gst_rate }}%</td>
                <td class="text-right">{{ "%.2f"|format(item.taxable_value + item.cgst_amount + item.sgst_amount + item.igst_amount) }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr><td colspan="8" class="text-right"><strong>Subtotal</strong></td><td class="text-right">‚Çπ{{ "%.2f"|format(invoice.subtotal) }}</td></tr>
            {% if invoice.discount_amount and invoice.discount_amount > 0 %}
            <tr><td colspan="8" class="text-right"><strong>Discount</strong></td><td class="text-right" style="color:#e74c3c;">-‚Çπ{{ "%.2f"|format(invoice.discount_amount) }}</td></tr>
            {% endif %}
            {% if invoice.cgst_amount > 0 %}
            <tr><td colspan="8" class="text-right">CGST</td><td class="text-right">‚Çπ{{ "%.2f"|format(invoice.cgst_amount) }}</td></tr>
            <tr><td colspan="8" class="text-right">SGST</td><td class="text-right">‚Çπ{{ "%.2f"|format(invoice.sgst_amount) }}</td></tr>
            {% endif %}
            {% if invoice.igst_amount > 0 %}
            <tr><td colspan="8" class="text-right">IGST</td><td class="text-right">‚Çπ{{ "%.2f"|format(invoice.igst_amount) }}</td></tr>
            {% endif %}
            {% if invoice.round_off and invoice.round_off != 0 %}
            <tr><td colspan="8" class="text-right">Round Off</td><td class="text-right">‚Çπ{{ "%.2f"|format(invoice.round_off) }}</td></tr>
            {% endif %}
            <tr class="total-row"><td colspan="8" class="text-right">TOTAL</td><td class="text-right">‚Çπ{{ "%.2f"|format(invoice.total_amount) }}</td></tr>
        </tfoot>
    </table>

    <!-- Amount in Words -->
    <div style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-left: 3px solid #3b82f6;">
        <strong>Amount in Words:</strong> <em>{{ invoice.amount_in_words() }}</em>
    </div>

    <!-- Terms & Conditions -->
    {% if invoice.notes %}
    <div style="margin-top: 20px;">
        <div class="section-title">Terms & Conditions</div>
        <div style="font-size: 12px; color: #666; white-space: pre-line;">{{ invoice.notes }}</div>
    </div>
    {% endif %}

    <!-- FOOTER & SIGNATURE -->
    <div class="signature-block">
        <div class="signature-box">
            Customer Signature
            <div class="signature-line"></div>
        </div>
        <div class="signature-box">
            For: <strong>{{ tenant.company_name }}</strong>
            <div class="signature-line"></div>
            Authorized Signatory
        </div>
    </div>

    <div class="footer">
        Thank you for your business!<br>
        <small>This is a computer-generated invoice.</small>
    </div>
</div>

<script>
// Add print-specific class to body when printing
window.addEventListener('beforeprint', function() {
    document.body.classList.add('printing-invoice');
});

window.addEventListener('afterprint', function() {
    document.body.classList.remove('printing-invoice');
});

// Also handle Ctrl+P / Cmd+P
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        document.body.classList.add('printing-invoice');
    }
});
</script>

<style>
/* Additional print styles when printing class is active */
body.printing-invoice .sidebar,
body.printing-invoice #sidebar,
body.printing-invoice .main-sidebar,
body.printing-invoice nav,
body.printing-invoice .navbar,
body.printing-invoice .top-bar,
body.printing-invoice .header-actions,
body.printing-invoice .no-print {
    display: none !important;
}

body.printing-invoice .content,
body.printing-invoice .main-content {
    margin-left: 0 !important;
    padding-left: 0 !important;
    width: 100% !important;
}
</style>

<!-- Payment Modal -->
<div id="paymentModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close" onclick="document.getElementById('paymentModal').style.display='none'">&times;</span>
        <h3>üí∞ Record Payment</h3>
        
        <form method="POST" action="{{ url_for('invoices.record_payment', invoice_id=invoice.id) }}">
            <div class="form-group">
                <label>Amount Paid</label>
                <input type="number" name="amount_paid" class="form-input" step="0.01" 
                       value="{{ invoice.total_amount }}" required>
            </div>
            
            <div class="form-group">
                <label>Payment Method</label>
                <select name="payment_method" class="form-input" required>
                    <option value="Cash">Cash</option>
                    <option value="UPI" selected>UPI</option>
                    <option value="Card">Card</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="Cheque">Cheque</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="field-label field-label--required">üí∞ Deposit To Account</label>
                <select name="account_id" class="form-input" required>
                    <option value="">-- Select Bank/Cash Account --</option>
                    {% if bank_accounts %}
                        {% for account in bank_accounts %}
                            <option value="{{ account.id }}" 
                                    {% if account.is_default %}selected{% endif %}>
                                {% if account.account_type == 'cash' %}üíµ{% elif account.account_type == 'bank' %}üè¶{% else %}üí∞{% endif %}
                                {{ account.account_name }}
                                {% if account.bank_name %}({{ account.bank_name }}){% endif %}
                                - ‚Çπ{{ "{:,.2f}".format(account.current_balance) }}
                            </option>
                        {% endfor %}
                    {% else %}
                        <option value="" disabled>No accounts found - Please add a bank/cash account first</option>
                    {% endif %}
                </select>
                <small style="display: block; margin-top: 5px; color: #666; font-size: 12px;">
                    üí° Payment will be credited to this account
                </small>
            </div>
            
            <div class="form-group">
                <label>Payment Date</label>
                <input type="date" name="payment_date" class="form-input" 
                       value="{{ today.strftime('%Y-%m-%d') if today else '' }}" required>
            </div>
            
            <div class="form-group">
                <label>Notes (Optional)</label>
                <textarea name="payment_notes" class="form-input" rows="3" 
                          placeholder="Transaction ID, reference number, etc."></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn btn-success">Record Payment</button>
                <button type="button" class="btn btn-secondary" 
                        onclick="document.getElementById('paymentModal').style.display='none'">Cancel</button>
            </div>
        </form>
    </div>
</div>

<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background: white;
        margin: 10% auto;
        padding: 30px;
        border-radius: 8px;
        max-width: 600px;
        position: relative;
    }
    
    .close {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 28px;
        font-weight: bold;
        color: #aaa;
        cursor: pointer;
    }
    
    .close:hover {
        color: #000;
    }
    
    .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
</style>

{% endblock %}
