{% extends "base_sidebar.html" %}

{% block title %}Dashboard - {{ tenant.company_name }}{% endblock %}

{% block page_title %}Business Dashboard{% endblock %}

{% block header_actions %}
<button onclick="openWidgetModal()" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
    ‚ûï Add More
</button>
{% endblock %}

{% block content %}

<style>
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0;
}

/* Welcome Banner */
.welcome-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px 30px;
    border-radius: 12px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.welcome-title {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 5px;
}

.welcome-subtitle {
    font-size: 14px;
    opacity: 0.95;
}

/* Financial Grid - Top Cards */
.financial-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.metric-card {
    background: white;
    border-radius: 12px;
    padding: 20px 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 4px solid #3498db;
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.metric-card.sales {
    border-left-color: #27ae60;
}

.metric-card.receivables {
    border-left-color: #f39c12;
}

.metric-card.purchases {
    border-left-color: #3498db;
}

.metric-label {
    font-size: 14px;
    color: #7f8c8d;
    margin-bottom: 8px;
    font-weight: 500;
}

.metric-value {
    font-size: 28px;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 5px;
}

.metric-change {
    font-size: 13px;
    color: #95a5a6;
}

/* Stats Grid - Quick Stats */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.stat-box {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    display: block;
}

.stat-box:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.stat-box.green {
    border-top: 3px solid #27ae60;
}

.stat-box.red {
    border-top: 3px solid #e74c3c;
}

.stat-box.blue {
    border-top: 3px solid #3498db;
}

.stat-box.orange {
    border-top: 3px solid #e67e22;
}

.stat-icon {
    font-size: 32px;
    margin-bottom: 10px;
}

.stat-number {
    font-size: 32px;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 13px;
    color: #7f8c8d;
    font-weight: 500;
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.action-btn {
    background: white;
    border-radius: 12px;
    padding: 20px 15px;
    text-align: center;
    text-decoration: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    display: block;
}

.action-btn:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.action-btn:hover .action-icon,
.action-btn:hover .action-label {
    color: white;
}

.action-icon {
    font-size: 28px;
    margin-bottom: 8px;
    transition: color 0.3s;
}

.action-label {
    font-size: 13px;
    color: #2c3e50;
    font-weight: 600;
    transition: color 0.3s;
}

/* Activity Grid */
.activity-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.activity-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.activity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.activity-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
    font-weight: 700;
    color: #2c3e50;
}

.activity-badge {
    background: #667eea;
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
}

.activity-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.activity-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f5f5f5;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-info {
    flex: 1;
}

.activity-name {
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 3px;
}

.activity-meta {
    font-size: 12px;
    color: #95a5a6;
}

.activity-amount {
    font-size: 15px;
    font-weight: 700;
    color: #27ae60;
}

.activity-amount.expense {
    color: #e74c3c;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #95a5a6;
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 10px;
    opacity: 0.5;
}

/* Widget Modal Styles */
.widget-option {
    background: white;
    border: 2px solid #e1e8ed;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.widget-option:hover {
    border-color: #667eea;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 0;
    }
    
    .welcome-banner {
        padding: 20px;
    }
    
    .welcome-title {
        font-size: 18px;
    }
    
    .financial-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .quick-actions {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }
    
    .activity-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .metric-value {
        font-size: 24px;
    }
    
    .stat-number {
        font-size: 26px;
    }
}

@media (max-width: 480px) {
    .quick-actions {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>


<div class="dashboard-container">
    <!-- Welcome Banner -->
    <div class="welcome-banner">
        <div class="welcome-title">üëã Welcome back, {{ session.admin_name }}!</div>
        <div class="welcome-subtitle">{{ tenant.company_name }} | Today is {{ today.strftime('%A, %d %B %Y') }}</div>
    </div>
    
    <!-- Financial Summary -->
    <div class="financial-grid">
        <div class="metric-card sales">
            <div class="metric-label">üí∞ Today's Sales</div>
            <div class="metric-value">‚Çπ{{ "{:,.0f}".format(today_sales) }}</div>
            <div class="metric-change">{{ today_invoice_count }} invoices</div>
        </div>
        
        <div class="metric-card sales">
            <div class="metric-label">üìä This Month's Sales</div>
            <div class="metric-value">‚Çπ{{ "{:,.0f}".format(month_sales) }}</div>
            <div class="metric-change">{{ month_invoice_count }} invoices</div>
        </div>
        
        <div class="metric-card receivables">
            <div class="metric-label">‚è≥ Pending Receivables</div>
            <div class="metric-value">‚Çπ{{ "{:,.0f}".format(pending_receivables) }}</div>
            <div class="metric-change">To be collected</div>
        </div>
        
        <div class="metric-card purchases">
            <div class="metric-label">üõí This Month's Purchases</div>
            <div class="metric-value">‚Çπ{{ "{:,.0f}".format(month_purchases) }}</div>
            <div class="metric-change">{{ month_bill_count }} bills</div>
        </div>
    </div>
    
    <!-- Quick Stats (Clickable) -->
    <div class="stats-grid">
        <a href="/admin/items" class="stat-box green" style="text-decoration: none; cursor: pointer;">
            <div class="stat-icon">üì¶</div>
            <div class="stat-number">{{ total_items }}</div>
            <div class="stat-label">Total Items</div>
        </a>
        
        <a href="/admin/items?low_stock=1" class="stat-box red" style="text-decoration: none; cursor: pointer;">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-number">{{ low_stock_count }}</div>
            <div class="stat-label">Low Stock Items</div>
        </a>
        
        <a href="/admin/customers" class="stat-box blue" style="text-decoration: none; cursor: pointer;">
            <div class="stat-icon">üë•</div>
            <div class="stat-number">{{ total_customers }}</div>
            <div class="stat-label">Customers</div>
        </a>
        
        <a href="/admin/vendors" class="stat-box orange" style="text-decoration: none; cursor: pointer;">
            <div class="stat-icon">üè¢</div>
            <div class="stat-number">{{ total_vendors }}</div>
            <div class="stat-label">Vendors</div>
        </a>
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="/admin/invoices/create" class="action-btn">
            <div class="action-icon">üìù</div>
            <div class="action-label">New Invoice</div>
        </a>
        
        <a href="/admin/purchase-bills/create" class="action-btn">
            <div class="action-icon">üõí</div>
            <div class="action-label">New Purchase</div>
        </a>
        
        <a href="/admin/items/add" class="action-btn">
            <div class="action-icon">‚ûï</div>
            <div class="action-label">Add Item</div>
        </a>
        
        <a href="/admin/gst-reports" class="action-btn">
            <div class="action-icon">üìã</div>
            <div class="action-label">GST Reports</div>
        </a>
        
        <a href="/admin/items" class="action-btn">
            <div class="action-icon">üìä</div>
            <div class="action-label">View Inventory</div>
        </a>
    </div>
    
    <!-- Recent Activity -->
    <div class="activity-grid">
        <!-- Recent Invoices -->
        <div class="activity-card">
            <div class="activity-header">
                <div class="activity-title">
                    <span>üìÑ</span>
                    <span>Recent Invoices</span>
                </div>
                <span class="activity-badge">{{ recent_invoices|length }}</span>
            </div>
            
            {% if recent_invoices %}
            <ul class="activity-list">
                {% for invoice in recent_invoices %}
                <li class="activity-item">
                    <div class="activity-info">
                        <div class="activity-name">{{ invoice.invoice_number }}</div>
                        <div class="activity-meta">{{ invoice.customer_name }} ‚Ä¢ {{ invoice.invoice_date.strftime('%d %b') }}</div>
                    </div>
                    <div class="activity-amount">‚Çπ{{ "{:,.0f}".format(invoice.total_amount) }}</div>
                </li>
                {% endfor %}
            </ul>
            <div style="text-align: center; margin-top: 15px;">
                <a href="/admin/invoices" style="color: #667eea; font-weight: 600; text-decoration: none; font-size: 14px;">View All Invoices ‚Üí</a>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üìÑ</div>
                <div>No invoices yet</div>
            </div>
            {% endif %}
        </div>
        
        <!-- Recent Purchase Bills -->
        <div class="activity-card">
            <div class="activity-header">
                <div class="activity-title">
                    <span>üíº</span>
                    <span>Recent Purchase Bills</span>
                </div>
                <span class="activity-badge" style="background: #3498db;">{{ recent_bills|length }}</span>
            </div>
            
            {% if recent_bills %}
            <ul class="activity-list">
                {% for bill in recent_bills %}
                <li class="activity-item">
                    <div class="activity-info">
                        <div class="activity-name">{{ bill.bill_number }}</div>
                        <div class="activity-meta">{{ bill.vendor_name }} ‚Ä¢ {{ bill.bill_date.strftime('%d %b') }}</div>
                    </div>
                    <div class="activity-amount expense">‚Çπ{{ "{:,.0f}".format(bill.total_amount) }}</div>
                </li>
                {% endfor %}
            </ul>
            <div style="text-align: center; margin-top: 15px;">
                <a href="/admin/purchase-bills" style="color: #3498db; font-weight: 600; text-decoration: none; font-size: 14px;">View All Bills ‚Üí</a>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üíº</div>
                <div>No purchase bills yet</div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Add Widget Section -->
    <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; border: 2px dashed #e0e0e0;">
        <div style="font-size: 18px; color: #7f8c8d; margin-bottom: 10px;">üìä Customize Your Dashboard</div>
        <div style="font-size: 14px; color: #95a5a6; margin-bottom: 20px;">Add widgets to track what matters most to your business</div>
        <button onclick="openWidgetModal()" class="btn btn-primary" style="padding: 12px 30px; font-size: 15px;">
            ‚ûï Add Widget
        </button>
    </div>
</div>

<!-- Widget Selection Modal -->
<div id="widgetModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
    <div style="min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 16px; max-width: 900px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;">
            <!-- Modal Header -->
            <div style="padding: 25px 30px; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 24px; color: #2c3e50;">Add Widget to Dashboard</h2>
                    <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 14px;">Select widgets to customize your dashboard view</p>
                </div>
                <button onclick="closeWidgetModal()" style="background: none; border: none; font-size: 28px; color: #95a5a6; cursor: pointer; line-height: 1; padding: 0; width: 32px; height: 32px;">√ó</button>
            </div>
            
            <!-- Modal Body -->
            <div style="padding: 30px;">
                <!-- Widget Categories -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 16px; color: #2c3e50; margin-bottom: 15px; font-weight: 600;">üí∞ Financial Widgets</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        <div class="widget-option" onclick="addWidget('purchases')">
                            <div style="font-size: 24px; margin-bottom: 8px;">üõí</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Total Purchases</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Track all purchase expenses</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('expenses')">
                            <div style="font-size: 24px; margin-bottom: 8px;">üí∏</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Expenses</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Monitor business expenses</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('profit')">
                            <div style="font-size: 24px; margin-bottom: 8px;">üíπ</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Profit Margin</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Sales minus expenses</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 16px; color: #2c3e50; margin-bottom: 15px; font-weight: 600;">üì¶ Inventory Widgets</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        <div class="widget-option" onclick="addWidget('stock_value')">
                            <div style="font-size: 24px; margin-bottom: 8px;">üíé</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Stock Value</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Total inventory worth</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('low_stock_list')">
                            <div style="font-size: 24px; margin-bottom: 8px;">‚ö†Ô∏è</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Low Stock List</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Items needing reorder</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('top_selling')">
                            <div style="font-size: 24px; margin-bottom: 8px;">üî•</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Top Selling Items</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Best performers</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 16px; color: #2c3e50; margin-bottom: 15px; font-weight: 600;">üè¶ Banking & Cash</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        <div class="widget-option" onclick="addWidget('cash_in_hand')">
                            <div style="font-size: 24px; margin-bottom: 8px;">üíµ</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Cash In Hand</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Available cash balance</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('bank_balance')">
                            <div style="font-size: 24px; margin-bottom: 8px;">üè¶</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Bank Balance</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Total bank accounts</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('outstanding')">
                            <div style="font-size: 24px; margin-bottom: 8px;">üìä</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Outstanding Report</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Pending collections</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 16px; color: #2c3e50; margin-bottom: 15px; font-weight: 600;">üìã Reports & Analytics</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        <div class="widget-option" onclick="addWidget('gst_summary')">
                            <div style="font-size: 24px; margin-bottom: 8px;">üìÑ</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">GST Summary</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Quick GST overview</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('sales_chart')">
                            <div style="font-size: 24px; margin-bottom: 8px;">üìà</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Sales Chart</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Visual sales trends</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('party_wise')">
                            <div style="font-size: 24px; margin-bottom: 8px;">üë•</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Party-wise Summary</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Customer transactions</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div style="padding: 20px 30px; border-top: 2px solid #f0f0f0; background: #f8f9fa; border-radius: 0 0 16px 16px;">
                <div style="font-size: 13px; color: #7f8c8d;">
                    üí° <strong>Pro Tip:</strong> Widgets will appear on your dashboard below this section. You can customize your view based on your business needs.
                </div>
            </div>
        </div>
    </div>
</div>


<script>
function openWidgetModal() {
    document.getElementById('widgetModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeWidgetModal() {
    document.getElementById('widgetModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function addWidget(widgetType) {
    // Map widget types to their respective pages
    const widgetRoutes = {
        'purchases': '/admin/purchase-bills',
        'expenses': '/admin/expenses',
        'profit': '/admin/reports/profit-loss',
        'stock_value': '/admin/items/reports?tab=valuation',
        'low_stock_list': '/admin/items?low_stock=1',
        'top_selling': '/admin/items/reports?tab=sales',
        'cash_in_hand': '/admin/cash-bank',
        'bank_balance': '/admin/cash-bank',
        'outstanding': '/admin/customers/outstanding',
        'gst_summary': '/admin/gst-reports',
        'sales_chart': '/admin/reports/sales',
        'party_wise': '/admin/customers'
    };
    
    const widgetNames = {
        'purchases': 'Purchases',
        'expenses': 'Expenses',
        'profit': 'Profit Margin',
        'stock_value': 'Stock Value',
        'low_stock_list': 'Low Stock Items',
        'top_selling': 'Top Selling Items',
        'cash_in_hand': 'Cash In Hand',
        'bank_balance': 'Bank Balance',
        'outstanding': 'Outstanding Report',
        'gst_summary': 'GST Summary',
        'sales_chart': 'Sales Chart',
        'party_wise': 'Party-wise Summary'
    };
    
    // For now, redirect to the relevant page
    // In future, we can save preferences and dynamically load widgets
    alert('‚úÖ Opening ' + widgetNames[widgetType] + '...\n\nNote: Widget customization will be saved in future updates!');
    window.location.href = widgetRoutes[widgetType];
}

// Close modal when clicking outside
document.getElementById('widgetModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeWidgetModal();
    }
});

// ========================================
// üöÄ CLIENT-SIDE CACHING FOR INSTANT LOAD
// ========================================
// This makes the dashboard feel INSTANT by showing cached data first,
// then silently refreshing in the background!

(function() {
    const CACHE_KEY = 'dashboard_data_v1';
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
    
    // Try to load from cache immediately on page load
    function loadFromCache() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (!cached) return null;
            
            const data = JSON.parse(cached);
            const age = Date.now() - data.timestamp;
            
            // If cache is fresh (< 5 minutes), use it!
            if (age < CACHE_DURATION) {
                console.log(`‚úÖ Loading dashboard from cache (${Math.floor(age/1000)}s old)`);
                return data;
            } else {
                console.log(`‚è∞ Cache expired (${Math.floor(age/1000)}s old), will fetch fresh data`);
                localStorage.removeItem(CACHE_KEY);
                return null;
            }
        } catch (e) {
            console.error('Cache read error:', e);
            return null;
        }
    }
    
    // Save current dashboard data to cache
    function saveToCache() {
        try {
            const data = {
                timestamp: Date.now(),
                today_sales: {{ today_sales }},
                today_invoice_count: {{ today_invoice_count }},
                month_sales: {{ month_sales }},
                month_invoice_count: {{ month_invoice_count }},
                pending_receivables: {{ pending_receivables }},
                month_purchases: {{ month_purchases }},
                month_bill_count: {{ month_bill_count }},
                total_items: {{ total_items }},
                low_stock_count: {{ low_stock_count }},
                total_customers: {{ total_customers }},
                total_vendors: {{ total_vendors }}
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
            console.log('üíæ Dashboard data cached for 5 minutes');
        } catch (e) {
            console.error('Cache write error:', e);
        }
    }
    
    // Check cache on page load
    const cachedData = loadFromCache();
    
    // If we have fresh cache, show a brief "refreshing" indicator
    if (cachedData) {
        // Add a small badge to show data is from cache
        const banner = document.querySelector('.welcome-banner');
        if (banner) {
            const badge = document.createElement('div');
            badge.style.cssText = 'display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px;';
            badge.textContent = '‚ö° Instant load';
            banner.querySelector('.welcome-title').appendChild(badge);
            
            // Remove badge after 2 seconds
            setTimeout(() => badge.style.display = 'none', 2000);
        }
    }
    
    // Always save current data to cache for next visit
    saveToCache();
    
    // Add cache age indicator in console
    if (cachedData) {
        const age = Math.floor((Date.now() - cachedData.timestamp) / 1000);
        console.log(`üìä Dashboard data age: ${age} seconds (cache expires in ${300 - age} seconds)`);
    }
})();
</script>

{% endblock %}
