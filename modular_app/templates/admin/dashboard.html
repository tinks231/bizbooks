{% extends "base_sidebar.html" %}

{% block title %}Dashboard - {{ tenant.company_name }}{% endblock %}

{% block page_title %}Business Dashboard{% endblock %}

{% block header_actions %}
<button onclick="openWidgetModal()" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
    â• Add More
</button>
{% endblock %}

{% block content %}


<div class="dashboard-container">
    <!-- Welcome Banner -->
    <div class="welcome-banner">
        <div class="welcome-title">ğŸ‘‹ Welcome back, {{ session.admin_name }}!</div>
        <div class="welcome-subtitle">{{ tenant.company_name }} | Today is {{ today.strftime('%A, %d %B %Y') }}</div>
    </div>
    
    <!-- Financial Summary -->
    <div class="financial-grid">
        <div class="metric-card sales">
            <div class="metric-label">ğŸ’° Today's Sales</div>
            <div class="metric-value">â‚¹{{ "{:,.0f}".format(today_sales) }}</div>
            <div class="metric-change">{{ today_invoice_count }} invoices</div>
        </div>
        
        <div class="metric-card sales">
            <div class="metric-label">ğŸ“Š This Month's Sales</div>
            <div class="metric-value">â‚¹{{ "{:,.0f}".format(month_sales) }}</div>
            <div class="metric-change">{{ month_invoice_count }} invoices</div>
        </div>
        
        <div class="metric-card receivables">
            <div class="metric-label">â³ Pending Receivables</div>
            <div class="metric-value">â‚¹{{ "{:,.0f}".format(pending_receivables) }}</div>
            <div class="metric-change">To be collected</div>
        </div>
        
        <div class="metric-card purchases">
            <div class="metric-label">ğŸ›’ This Month's Purchases</div>
            <div class="metric-value">â‚¹{{ "{:,.0f}".format(month_purchases) }}</div>
            <div class="metric-change">{{ month_bill_count }} bills</div>
        </div>
    </div>
    
    <!-- Quick Stats (Clickable) -->
    <div class="stats-grid">
        <a href="/admin/items" class="stat-box green" style="text-decoration: none; cursor: pointer;">
            <div class="stat-icon">ğŸ“¦</div>
            <div class="stat-number">{{ total_items }}</div>
            <div class="stat-label">Total Items</div>
        </a>
        
        <a href="/admin/items?low_stock=1" class="stat-box red" style="text-decoration: none; cursor: pointer;">
            <div class="stat-icon">âš ï¸</div>
            <div class="stat-number">{{ low_stock_count }}</div>
            <div class="stat-label">Low Stock Items</div>
        </a>
        
        <a href="/admin/customers" class="stat-box blue" style="text-decoration: none; cursor: pointer;">
            <div class="stat-icon">ğŸ‘¥</div>
            <div class="stat-number">{{ total_customers }}</div>
            <div class="stat-label">Customers</div>
        </a>
        
        <a href="/admin/vendors" class="stat-box orange" style="text-decoration: none; cursor: pointer;">
            <div class="stat-icon">ğŸ¢</div>
            <div class="stat-number">{{ total_vendors }}</div>
            <div class="stat-label">Vendors</div>
        </a>
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="/admin/invoices/create" class="action-btn">
            <div class="action-icon">ğŸ“</div>
            <div class="action-label">New Invoice</div>
        </a>
        
        <a href="/admin/purchase-bills/create" class="action-btn">
            <div class="action-icon">ğŸ›’</div>
            <div class="action-label">New Purchase</div>
        </a>
        
        <a href="/admin/items/add" class="action-btn">
            <div class="action-icon">â•</div>
            <div class="action-label">Add Item</div>
        </a>
        
        <a href="/admin/gst-reports" class="action-btn">
            <div class="action-icon">ğŸ“‹</div>
            <div class="action-label">GST Reports</div>
        </a>
        
        <a href="/admin/items" class="action-btn">
            <div class="action-icon">ğŸ“Š</div>
            <div class="action-label">View Inventory</div>
        </a>
    </div>
    
    <!-- Recent Activity -->
    <div class="activity-grid">
        <!-- Recent Invoices -->
        <div class="activity-card">
            <div class="activity-header">
                <div class="activity-title">
                    <span>ğŸ“„</span>
                    <span>Recent Invoices</span>
                </div>
                <span class="activity-badge">{{ recent_invoices|length }}</span>
            </div>
            
            {% if recent_invoices %}
            <ul class="activity-list">
                {% for invoice in recent_invoices %}
                <li class="activity-item">
                    <div class="activity-info">
                        <div class="activity-name">{{ invoice.invoice_number }}</div>
                        <div class="activity-meta">{{ invoice.customer_name }} â€¢ {{ invoice.invoice_date.strftime('%d %b') }}</div>
                    </div>
                    <div class="activity-amount">â‚¹{{ "{:,.0f}".format(invoice.total_amount) }}</div>
                </li>
                {% endfor %}
            </ul>
            <div style="text-align: center; margin-top: 15px;">
                <a href="/admin/invoices" style="color: #667eea; font-weight: 600; text-decoration: none; font-size: 14px;">View All Invoices â†’</a>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">ğŸ“„</div>
                <div>No invoices yet</div>
            </div>
            {% endif %}
        </div>
        
        <!-- Recent Purchase Bills -->
        <div class="activity-card">
            <div class="activity-header">
                <div class="activity-title">
                    <span>ğŸ’¼</span>
                    <span>Recent Purchase Bills</span>
                </div>
                <span class="activity-badge" style="background: #3498db;">{{ recent_bills|length }}</span>
            </div>
            
            {% if recent_bills %}
            <ul class="activity-list">
                {% for bill in recent_bills %}
                <li class="activity-item">
                    <div class="activity-info">
                        <div class="activity-name">{{ bill.bill_number }}</div>
                        <div class="activity-meta">{{ bill.vendor_name }} â€¢ {{ bill.bill_date.strftime('%d %b') }}</div>
                    </div>
                    <div class="activity-amount expense">â‚¹{{ "{:,.0f}".format(bill.total_amount) }}</div>
                </li>
                {% endfor %}
            </ul>
            <div style="text-align: center; margin-top: 15px;">
                <a href="/admin/purchase-bills" style="color: #3498db; font-weight: 600; text-decoration: none; font-size: 14px;">View All Bills â†’</a>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">ğŸ’¼</div>
                <div>No purchase bills yet</div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Add Widget Section -->
    <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; border: 2px dashed #e0e0e0;">
        <div style="font-size: 18px; color: #7f8c8d; margin-bottom: 10px;">ğŸ“Š Customize Your Dashboard</div>
        <div style="font-size: 14px; color: #95a5a6; margin-bottom: 20px;">Add widgets to track what matters most to your business</div>
        <button onclick="openWidgetModal()" class="btn btn-primary" style="padding: 12px 30px; font-size: 15px;">
            â• Add Widget
        </button>
    </div>
</div>

<!-- Widget Selection Modal -->
<div id="widgetModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
    <div style="min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 16px; max-width: 900px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;">
            <!-- Modal Header -->
            <div style="padding: 25px 30px; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 24px; color: #2c3e50;">Add Widget to Dashboard</h2>
                    <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 14px;">Select widgets to customize your dashboard view</p>
                </div>
                <button onclick="closeWidgetModal()" style="background: none; border: none; font-size: 28px; color: #95a5a6; cursor: pointer; line-height: 1; padding: 0; width: 32px; height: 32px;">Ã—</button>
            </div>
            
            <!-- Modal Body -->
            <div style="padding: 30px;">
                <!-- Widget Categories -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 16px; color: #2c3e50; margin-bottom: 15px; font-weight: 600;">ğŸ’° Financial Widgets</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        <div class="widget-option" onclick="addWidget('purchases')">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ›’</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Total Purchases</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Track all purchase expenses</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('expenses')">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ’¸</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Expenses</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Monitor business expenses</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('profit')">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ’¹</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Profit Margin</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Sales minus expenses</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 16px; color: #2c3e50; margin-bottom: 15px; font-weight: 600;">ğŸ“¦ Inventory Widgets</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        <div class="widget-option" onclick="addWidget('stock_value')">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ’</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Stock Value</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Total inventory worth</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('low_stock_list')">
                            <div style="font-size: 24px; margin-bottom: 8px;">âš ï¸</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Low Stock List</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Items needing reorder</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('top_selling')">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ”¥</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Top Selling Items</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Best performers</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 16px; color: #2c3e50; margin-bottom: 15px; font-weight: 600;">ğŸ¦ Banking & Cash</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        <div class="widget-option" onclick="addWidget('cash_in_hand')">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ’µ</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Cash In Hand</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Available cash balance</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('bank_balance')">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ¦</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Bank Balance</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Total bank accounts</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('outstanding')">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“Š</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Outstanding Report</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Pending collections</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 16px; color: #2c3e50; margin-bottom: 15px; font-weight: 600;">ğŸ“‹ Reports & Analytics</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        <div class="widget-option" onclick="addWidget('gst_summary')">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“„</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">GST Summary</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Quick GST overview</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('sales_chart')">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“ˆ</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Sales Chart</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Visual sales trends</div>
                        </div>
                        
                        <div class="widget-option" onclick="addWidget('party_wise')">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ‘¥</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Party-wise Summary</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Customer transactions</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div style="padding: 20px 30px; border-top: 2px solid #f0f0f0; background: #f8f9fa; border-radius: 0 0 16px 16px;">
                <div style="font-size: 13px; color: #7f8c8d;">
                    ğŸ’¡ <strong>Pro Tip:</strong> Widgets will appear on your dashboard below this section. You can customize your view based on your business needs.
                </div>
            </div>
        </div>
    </div>
</div>


<script>
function openWidgetModal() {
    document.getElementById('widgetModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeWidgetModal() {
    document.getElementById('widgetModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function addWidget(widgetType) {
    // Map widget types to their respective pages
    const widgetRoutes = {
        'purchases': '/admin/purchase-bills',
        'expenses': '/admin/expenses',
        'profit': '/admin/reports/profit-loss',
        'stock_value': '/admin/items/reports?tab=valuation',
        'low_stock_list': '/admin/items?low_stock=1',
        'top_selling': '/admin/items/reports?tab=sales',
        'cash_in_hand': '/admin/cash-bank',
        'bank_balance': '/admin/cash-bank',
        'outstanding': '/admin/customers/outstanding',
        'gst_summary': '/admin/gst-reports',
        'sales_chart': '/admin/reports/sales',
        'party_wise': '/admin/customers'
    };
    
    const widgetNames = {
        'purchases': 'Purchases',
        'expenses': 'Expenses',
        'profit': 'Profit Margin',
        'stock_value': 'Stock Value',
        'low_stock_list': 'Low Stock Items',
        'top_selling': 'Top Selling Items',
        'cash_in_hand': 'Cash In Hand',
        'bank_balance': 'Bank Balance',
        'outstanding': 'Outstanding Report',
        'gst_summary': 'GST Summary',
        'sales_chart': 'Sales Chart',
        'party_wise': 'Party-wise Summary'
    };
    
    // For now, redirect to the relevant page
    // In future, we can save preferences and dynamically load widgets
    alert('âœ… Opening ' + widgetNames[widgetType] + '...\n\nNote: Widget customization will be saved in future updates!');
    window.location.href = widgetRoutes[widgetType];
}

// Close modal when clicking outside
document.getElementById('widgetModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeWidgetModal();
    }
});

// ========================================
// ğŸš€ CLIENT-SIDE CACHING FOR INSTANT LOAD
// ========================================
// This makes the dashboard feel INSTANT by showing cached data first,
// then silently refreshing in the background!

(function() {
    const CACHE_KEY = 'dashboard_data_v1';
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
    
    // Try to load from cache immediately on page load
    function loadFromCache() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (!cached) return null;
            
            const data = JSON.parse(cached);
            const age = Date.now() - data.timestamp;
            
            // If cache is fresh (< 5 minutes), use it!
            if (age < CACHE_DURATION) {
                console.log(`âœ… Loading dashboard from cache (${Math.floor(age/1000)}s old)`);
                return data;
            } else {
                console.log(`â° Cache expired (${Math.floor(age/1000)}s old), will fetch fresh data`);
                localStorage.removeItem(CACHE_KEY);
                return null;
            }
        } catch (e) {
            console.error('Cache read error:', e);
            return null;
        }
    }
    
    // Save current dashboard data to cache
    function saveToCache() {
        try {
            const data = {
                timestamp: Date.now(),
                today_sales: {{ today_sales }},
                today_invoice_count: {{ today_invoice_count }},
                month_sales: {{ month_sales }},
                month_invoice_count: {{ month_invoice_count }},
                pending_receivables: {{ pending_receivables }},
                month_purchases: {{ month_purchases }},
                month_bill_count: {{ month_bill_count }},
                total_items: {{ total_items }},
                low_stock_count: {{ low_stock_count }},
                total_customers: {{ total_customers }},
                total_vendors: {{ total_vendors }}
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
            console.log('ğŸ’¾ Dashboard data cached for 5 minutes');
        } catch (e) {
            console.error('Cache write error:', e);
        }
    }
    
    // Check cache on page load
    const cachedData = loadFromCache();
    
    // If we have fresh cache, show a brief "refreshing" indicator
    if (cachedData) {
        // Add a small badge to show data is from cache
        const banner = document.querySelector('.welcome-banner');
        if (banner) {
            const badge = document.createElement('div');
            badge.style.cssText = 'display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px;';
            badge.textContent = 'âš¡ Instant load';
            banner.querySelector('.welcome-title').appendChild(badge);
            
            // Remove badge after 2 seconds
            setTimeout(() => badge.style.display = 'none', 2000);
        }
    }
    
    // Always save current data to cache for next visit
    saveToCache();
    
    // Add cache age indicator in console
    if (cachedData) {
        const age = Math.floor((Date.now() - cachedData.timestamp) / 1000);
        console.log(`ğŸ“Š Dashboard data age: ${age} seconds (cache expires in ${300 - age} seconds)`);
    }
})();
</script>

{% endblock %}
