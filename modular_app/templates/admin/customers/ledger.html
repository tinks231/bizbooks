{% extends 'base_sidebar.html' %}

{% block title %}Customer Ledger - {{ customer.name }} - {{ tenant.company_name }}{% endblock %}

{% block page_title %}Customer Ledger{% endblock %}

{% block header_actions %}
<a href="{{ url_for('customers.index') }}" class="btn btn-secondary">
    ‚Üê Back to Customers
</a>
<a href="{{ url_for('customers.edit', customer_id=customer.id) }}" class="btn btn-primary">
    ‚úèÔ∏è Edit Customer
</a>
{% endblock %}

{% block content %}

<!-- Customer Info Card -->
<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 20px;">
        <div>
            <h2 style="margin: 0 0 5px 0; font-size: 24px;">{{ customer.name }}</h2>
            <p style="margin: 0; opacity: 0.9;">{{ customer.customer_code }}</p>
            {% if customer.phone %}
            <p style="margin: 5px 0 0 0; opacity: 0.9;">üìû {{ customer.phone }}</p>
            {% endif %}
        </div>
        <div style="text-align: right;">
            <p style="margin: 0; font-size: 14px; opacity: 0.9;">Outstanding Balance</p>
            <h1 style="margin: 5px 0 0 0; font-size: 36px;">‚Çπ{{ "%.2f"|format(total_outstanding) }}</h1>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
    <div class="stat-card" style="background: #3498db;">
        <p class="stat-label">Total Billed</p>
        <p class="stat-value">‚Çπ{{ "%.2f"|format(total_billed) }}</p>
    </div>
    <div class="stat-card" style="background: #2ecc71;">
        <p class="stat-label">Total Paid</p>
        <p class="stat-value">‚Çπ{{ "%.2f"|format(total_paid) }}</p>
    </div>
    <div class="stat-card" style="background: #e74c3c;">
        <p class="stat-label">Total Outstanding</p>
        <p class="stat-value">‚Çπ{{ "%.2f"|format(total_outstanding) }}</p>
    </div>
    <div class="stat-card" style="background: #f39c12;">
        <p class="stat-label">Total Invoices</p>
        <p class="stat-value">{{ invoices|length }}</p>
    </div>
</div>

<!-- Loyalty Points History (if enabled) -->
{% if loyalty_program and loyalty_program.is_active and customer_loyalty %}
<div class="card" style="margin-bottom: 20px; border-left: 4px solid #10b981;">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; color: #10b981;">üéÅ Loyalty Points</h3>
    </div>
    
    <!-- Summary Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="padding: 15px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 8px;">
            <p style="margin: 0; font-size: 12px; color: #059669; font-weight: 600;">Current Balance</p>
            <p style="margin: 5px 0 0 0; font-size: 28px; font-weight: 700; color: #10b981;">{{ customer_loyalty.current_points }} pts</p>
            <p style="margin: 5px 0 0 0; font-size: 13px; color: #059669;">= ‚Çπ{{ (customer_loyalty.current_points * loyalty_program.points_to_rupees_ratio)|round(2) }}</p>
        </div>
        <div style="padding: 15px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 8px;">
            <p style="margin: 0; font-size: 12px; color: #1e40af; font-weight: 600;">Lifetime Earned</p>
            <p style="margin: 5px 0 0 0; font-size: 28px; font-weight: 700; color: #3b82f6;">{{ customer_loyalty.lifetime_earned_points }} pts</p>
        </div>
        <div style="padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px;">
            <p style="margin: 0; font-size: 12px; color: #92400e; font-weight: 600;">Lifetime Redeemed</p>
            <p style="margin: 5px 0 0 0; font-size: 28px; font-weight: 700; color: #f59e0b;">{{ customer_loyalty.lifetime_redeemed_points }} pts</p>
        </div>
    </div>
    
    <!-- Transaction History -->
    {% if loyalty_history %}
    <h4 style="margin: 0 0 15px 0; color: #374151;">Transaction History</h4>
    <div style="overflow-x: auto;">
            <table class="table">
            <thead>
                <tr>
                    <th style="width: 180px;">Date</th>
                    <th style="width: 400px;">Transaction Details</th>
                    <th style="width: 120px;">Invoice</th>
                    <th style="width: 120px;">Balance After</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in loyalty_history %}
                <tr>
                    <td style="color: #6b7280; font-size: 14px;">
                        {{ transaction.created_at.strftime('%d %b %Y') }}<br>
                        <small style="color: #9ca3af;">{{ transaction.created_at.strftime('%I:%M %p') }}</small>
                    </td>
                    <td>
                        {% if transaction.transaction_type in ['earned', 'bonus'] %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #10b981; font-size: 20px;">‚ûï</span>
                            <div>
                                <div style="font-weight: 600; color: #065f46; font-size: 15px;">
                                    Earned <strong style="color: #059669;">{{ transaction.points }} pts</strong>
                                    {% if transaction.invoice_amount %}
                                    from ‚Çπ{{ "%.2f"|format(transaction.invoice_amount) }} invoice
                                    {% endif %}
                                </div>
                                {% if transaction.description %}
                                <div style="color: #6b7280; font-size: 13px; margin-top: 2px;">
                                    {{ transaction.description }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% elif transaction.transaction_type == 'redeemed' %}
                        {% set discount_amount = (transaction.points|abs) * loyalty_program.points_to_rupees_ratio %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #ef4444; font-size: 20px;">‚ûñ</span>
                            <div>
                                <div style="font-weight: 600; color: #991b1b; font-size: 15px;">
                                    Redeemed <strong style="color: #dc2626;">{{ transaction.points|abs }} pts</strong>
                                    ‚Ä¢ Saved ‚Çπ{{ "%.2f"|format(discount_amount) }}
                                </div>
                                {% if transaction.description %}
                                <div style="color: #6b7280; font-size: 13px; margin-top: 2px;">
                                    {{ transaction.description }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #6b7280; font-size: 20px;">üîÑ</span>
                            <div>
                                <div style="font-weight: 600; color: #374151; font-size: 15px;">
                                    {{ transaction.transaction_type.upper() }} ‚Ä¢ {{ transaction.points }} pts
                                </div>
                                {% if transaction.description %}
                                <div style="color: #6b7280; font-size: 13px; margin-top: 2px;">
                                    {{ transaction.description }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        {% if transaction.invoice_id %}
                        <a href="{{ url_for('invoices.view', invoice_id=transaction.invoice_id) }}" 
                           style="color: #3b82f6; text-decoration: none; font-weight: 500; font-size: 14px;">
                            {{ transaction.invoice_number or 'View' }}
                        </a>
                        {% else %}
                        <span style="color: #9ca3af;">-</span>
                        {% endif %}
                    </td>
                    <td style="font-weight: 600; color: #1f2937; font-size: 15px;">
                        {{ transaction.points_after }} pts
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #9ca3af;">
        <p style="font-size: 48px; margin: 0;">üìä</p>
        <p style="margin: 10px 0 0 0;">No transaction history yet.</p>
        <p style="margin: 5px 0 0 0; font-size: 13px;">Points will appear here when customer makes purchases.</p>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Aging Analysis (Overdue Invoices) -->
{% set total_overdue = aging_data['0-30']|length + aging_data['31-60']|length + aging_data['61-90']|length + aging_data['90+']|length %}
{% if total_overdue > 0 %}
<div class="card" style="margin-bottom: 20px; border-left: 4px solid #e74c3c;">
    <h3 style="margin: 0 0 15px 0; color: #e74c3c;">‚ö†Ô∏è Overdue Invoices</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
        <div style="padding: 10px; background: #fee; border-radius: 6px;">
            <p style="margin: 0; font-size: 12px; color: #666;">0-30 Days</p>
            <p style="margin: 5px 0 0 0; font-size: 20px; font-weight: 600; color: #e74c3c;">{{ aging_data['0-30']|length }}</p>
        </div>
        <div style="padding: 10px; background: #fdd; border-radius: 6px;">
            <p style="margin: 0; font-size: 12px; color: #666;">31-60 Days</p>
            <p style="margin: 5px 0 0 0; font-size: 20px; font-weight: 600; color: #c0392b;">{{ aging_data['31-60']|length }}</p>
        </div>
        <div style="padding: 10px; background: #fcc; border-radius: 6px;">
            <p style="margin: 0; font-size: 12px; color: #666;">61-90 Days</p>
            <p style="margin: 5px 0 0 0; font-size: 20px; font-weight: 600; color: #a93226;">{{ aging_data['61-90']|length }}</p>
        </div>
        <div style="padding: 10px; background: #faa; border-radius: 6px;">
            <p style="margin: 0; font-size: 12px; color: #666;">90+ Days</p>
            <p style="margin: 5px 0 0 0; font-size: 20px; font-weight: 600; color: #922b21;">{{ aging_data['90+']|length }}</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Invoices Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">All Invoices</h3>
    </div>
    
    {% if invoices %}
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Invoice No</th>
                    <th>Date</th>
                    <th>Due Date</th>
                    <th>Amount</th>
                    <th>Paid</th>
                    <th>Balance</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in invoices %}
                <tr>
                    <td><strong>{{ invoice.invoice_number }}</strong></td>
                    <td>{{ invoice.invoice_date.strftime('%d-%b-%Y') }}</td>
                    <td>
                        {% if invoice.due_date %}
                            {{ invoice.due_date.strftime('%d-%b-%Y') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td style="text-align: right;">‚Çπ{{ "%.2f"|format(invoice.total_amount) }}</td>
                    <td style="text-align: right;">‚Çπ{{ "%.2f"|format(invoice.paid_amount) }}</td>
                    <td style="text-align: right;">
                        <strong style="color: {% if invoice.payment_status == 'unpaid' %}#e74c3c{% else %}#27ae60{% endif %};">
                            ‚Çπ{{ "%.2f"|format(invoice.total_amount - invoice.paid_amount) }}
                        </strong>
                    </td>
                    <td>
                        {% if invoice.payment_status == 'paid' %}
                            <span class="badge badge-success">Paid</span>
                        {% elif invoice.payment_status == 'partial' %}
                            <span class="badge badge-warning">Partial</span>
                        {% else %}
                            <span class="badge badge-danger">Unpaid</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('invoices.view', invoice_id=invoice.id) }}" class="btn btn-sm btn-primary">
                            View
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="padding: 40px; text-align: center; color: #7f8c8d;">
        <p style="font-size: 48px; margin-bottom: 10px;">üìÑ</p>
        <p style="font-size: 16px;">No invoices found for this customer</p>
    </div>
    {% endif %}
</div>


{% endblock %}

