{% extends "base_sidebar.html" %}

{% block title %}Edit Item - {{ item.name }} - BizBooks{% endblock %}

{% block page_title %}Edit Item{% endblock %}

{% block header_actions %}
<a href="{{ url_for('items.index') }}" class="btn btn-secondary">
    ‚Üê Back to Items
</a>
{% endblock %}

{% block content %}
<form method="POST" id="itemForm" onsubmit="return validateForm('itemForm')">
    <div class="card">
        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
            <strong>SKU:</strong> {{ item.sku }}
            <span class="text-muted" style="margin-left: 20px;">Created: {{ item.created_at.strftime('%d %b %Y') }}</span>
        </div>

        <!-- Barcode Field -->
        <div class="form-row">
            <div class="form-group">
                <label class="field-label">üì± Barcode</label>
                <input type="text" 
                       id="barcodeInput" 
                       name="barcode" 
                       value="{{ item.barcode or '' }}"
                       placeholder="Scan or enter barcode (e.g., 8901234567890)"
                       maxlength="50"
                       onblur="checkBarcodeDuplicate()">
                <small class="help-text" id="barcodeHint">
                    Scan with barcode scanner or type manually. Leave empty if not applicable.
                </small>
            </div>
        </div>

        <!-- Type Selection -->
        <div class="form-group">
            <label class="field-label field-label--required">Type</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="type" value="goods" {% if item.type == 'goods' %}checked{% endif %} required>
                    <span>Goods</span>
                </label>
                <label>
                    <input type="radio" name="type" value="service" {% if item.type == 'service' %}checked{% endif %} required>
                    <span>Service</span>
                </label>
            </div>
        </div>

        <!-- Basic Information -->
        <div class="form-row">
            <div class="form-group">
                <label class="field-label field-label--required">Item Name</label>
                <input type="text" name="name" required value="{{ item.name }}">
            </div>
            
            <div class="form-group">
                <label class="field-label field-label--required">Unit</label>
                <select name="unit" required>
                    <option value="nos" {% if item.unit == 'nos' %}selected{% endif %}>Nos (Numbers)</option>
                    <option value="pcs" {% if item.unit == 'pcs' %}selected{% endif %}>Pcs (Pieces)</option>
                    <option value="dozen" {% if item.unit == 'dozen' %}selected{% endif %}>Dozen</option>
                    <option value="kg" {% if item.unit == 'kg' %}selected{% endif %}>Kg (Kilogram)</option>
                    <option value="qtl" {% if item.unit == 'qtl' %}selected{% endif %}>Qtl (Quintal)</option>
                    <option value="ton" {% if item.unit == 'ton' or item.unit == 'tons' %}selected{% endif %}>Ton</option>
                    <option value="g" {% if item.unit == 'g' %}selected{% endif %}>G (Gram)</option>
                    <option value="ltr" {% if item.unit == 'ltr' %}selected{% endif %}>Ltr (Liter)</option>
                    <option value="ml" {% if item.unit == 'ml' %}selected{% endif %}>Ml (Milliliter)</option>
                    <option value="mtr" {% if item.unit == 'mtr' %}selected{% endif %}>Mtr (Meter)</option>
                    <option value="cm" {% if item.unit == 'cm' %}selected{% endif %}>Cm (Centimeter)</option>
                    <option value="ft" {% if item.unit == 'ft' %}selected{% endif %}>Ft (Foot)</option>
                    <option value="sqm" {% if item.unit == 'sqm' %}selected{% endif %}>Sqm (Square Meter)</option>
                    <option value="cum" {% if item.unit == 'cum' or item.unit == 'cubic_meter' %}selected{% endif %}>Cum (Cubic Meter)</option>
                    <option value="cft" {% if item.unit == 'cft' %}selected{% endif %}>Cft (Cubic Feet)</option>
                    <option value="box" {% if item.unit == 'box' %}selected{% endif %}>Box</option>
                    <option value="bag" {% if item.unit == 'bag' %}selected{% endif %}>Bag</option>
                    <option value="packet" {% if item.unit == 'packet' %}selected{% endif %}>Packet</option>
                    <option value="bundle" {% if item.unit == 'bundle' %}selected{% endif %}>Bundle</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label">Category</label>
                <select name="category_id">
                    <option value="">Select Category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if item.category_id == category.id %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="field-label">Item Group</label>
                <select name="item_group_id">
                    <option value="">Select Group</option>
                    {% for group in groups %}
                    <option value="{{ group.id }}" {% if item.item_group_id == group.id %}selected{% endif %}>
                        {{ group.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label">HSN/SAC Code (for GST)</label>
                <input type="text" name="hsn_code" placeholder="e.g., 8414, 8544" maxlength="20" value="{{ item.hsn_code or '' }}">
                <small class="help-text">Optional - Used in GST reports and invoices</small>
            </div>
            <div class="form-group">
                <!-- Empty placeholder for alignment -->
            </div>
        </div>

        <div class="form-group">
            <label class="checkbox-group">
                <input type="checkbox" name="is_returnable" {% if item.is_returnable %}checked{% endif %}>
                <span>Returnable Item</span>
            </label>
        </div>

        <div class="form-group">
            <label class="checkbox-group">
                <input type="checkbox" name="is_active" {% if item.is_active %}checked{% endif %}>
                <span>Active</span>
            </label>
        </div>

        <!-- Sales & Purchase Information (Simplified for Edit) -->
        <h3 class="section-title">
            üí∞ Pricing
        </h3>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label">MRP - Maximum Retail Price (‚Çπ)</label>
                <input type="number" id="mrpInput" name="mrp" step="0.01" min="0" value="{{ item.mrp or '' }}" placeholder="0.00" oninput="onMRPChange()">
                <small class="help-text">Optional - Price printed on product package</small>
            </div>
            <div class="form-group">
                <label class="field-label">Discount % on MRP</label>
                <input type="number" id="discountPercentInput" name="discount_percent" step="0.01" min="0" max="100" value="{{ item.discount_percent or 0 }}" placeholder="0.00" oninput="onDiscountPercentChange()">
                <small class="help-text">e.g., 15 for 15% discount</small>
            </div>
            <div class="form-group">
                <label class="field-label field-label--required">Selling Price (‚Çπ) <span style="color: #27ae60; font-weight: normal; font-size: 12px;">‚ö° Auto-calculated</span></label>
                <input type="number" id="sellingPriceInput" name="selling_price" step="0.01" min="0" required value="{{ item.selling_price }}" oninput="onSellingPriceChange()">
                <small class="help-text" id="discountInfo" style="color: #27ae60; font-weight: 600;"></small>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label field-label--required">Cost Price (‚Çπ)</label>
                <input type="number" name="cost_price" step="0.01" min="0" required value="{{ item.cost_price }}">
            </div>
            <div class="form-group">
                <!-- Empty for alignment -->
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label field-label--required">GST Rate</label>
                <select name="gst_rate" required>
                    <option value="0" {% if item.gst_rate == 0 %}selected{% endif %}>0% - Exempted</option>
                    <option value="5" {% if item.gst_rate == 5 %}selected{% endif %}>5% GST</option>
                    <option value="12" {% if item.gst_rate == 12 %}selected{% endif %}>12% GST</option>
                    <option value="18" {% if item.gst_rate == 18 or item.gst_rate is none %}selected{% endif %}>18% GST (Default)</option>
                    <option value="28" {% if item.gst_rate == 28 %}selected{% endif %}>28% GST</option>
                </select>
                <small class="help-text">Default GST rate for this item</small>
            </div>
            <div class="form-group">
                <!-- Empty placeholder for alignment -->
            </div>
        </div>

        <!-- Inventory Tracking -->
        <h3 class="section-title">
            üìä Inventory Settings
        </h3>

        <div class="form-group">
            <label class="checkbox-group" style="font-weight: 700; font-size: 15px;">
                <input type="checkbox" name="track_inventory" id="trackInventory" {% if item.track_inventory %}checked{% endif %}>
                <span>‚úì Track Inventory for this item</span>
            </label>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label">Reorder Point</label>
                <input type="number" name="reorder_point" step="0.01" min="0" value="{{ item.reorder_point }}">
                <small class="help-text">Alert when stock falls below this level</small>
            </div>
            <div class="form-group">
                <!-- Empty placeholder for alignment -->
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions" style="margin-bottom: 100px;">
            <a href="{{ url_for('items.index') }}" class="btn btn-secondary">
                Cancel
            </a>
            <button type="submit" class="btn btn-primary" style="padding: 12px 30px;">
                üíæ Update Item
            </button>
        </div>
    </div>
</form>

<script>
// ========================================
// BARCODE DUPLICATE CHECK
// ========================================

// Check for duplicate barcode
function checkBarcodeDuplicate() {
    const barcodeInput = document.getElementById('barcodeInput');
    const barcodeHint = document.getElementById('barcodeHint');
    const barcode = barcodeInput.value.trim();
    
    // Skip if empty
    if (!barcode) {
        barcodeHint.textContent = 'Scan with barcode scanner or type manually. Leave empty if not applicable.';
        barcodeHint.style.color = '#95a5a6';
        barcodeInput.style.borderColor = '#dfe6e9';
        return;
    }
    
    // Show checking status
    barcodeHint.textContent = '‚è≥ Checking...';
    barcodeHint.style.color = '#3498db';
    
    fetch('/api/barcode/check-duplicate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            barcode: barcode,
            item_id: {{ item.id }}  // Exclude current item from check
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.exists) {
            // Duplicate found
            barcodeHint.innerHTML = `‚ö†Ô∏è Barcode already used by: <strong>${data.item.name}</strong> (SKU: ${data.item.sku})`;
            barcodeHint.style.color = '#e74c3c';
            barcodeInput.style.borderColor = '#e74c3c';
            barcodeInput.style.background = '#fff5f5';
        } else {
            // Available
            barcodeHint.innerHTML = '‚úÖ Barcode available';
            barcodeHint.style.color = '#27ae60';
            barcodeInput.style.borderColor = '#27ae60';
            barcodeInput.style.background = '#f0fff4';
        }
    })
    .catch(error => {
        console.error('Error checking barcode:', error);
        barcodeHint.textContent = '‚ùå Error checking barcode';
        barcodeHint.style.color = '#e74c3c';
    });
}

// ========================================
// MRP, DISCOUNT %, AND SELLING PRICE AUTO-CALCULATION
// ========================================

let isCalculating = false; // Prevent infinite loops

function onMRPChange() {
    if (isCalculating) return;
    isCalculating = true;
    
    const mrp = parseFloat(document.getElementById('mrpInput').value) || 0;
    const discountPercent = parseFloat(document.getElementById('discountPercentInput').value) || 0;
    
    if (mrp > 0 && discountPercent > 0) {
        // Auto-calculate selling price from MRP and discount %
        const sellingPrice = mrp * (1 - discountPercent / 100);
        document.getElementById('sellingPriceInput').value = sellingPrice.toFixed(2);
    } else if (mrp > 0 && discountPercent === 0) {
        // No discount, selling price = MRP
        document.getElementById('sellingPriceInput').value = mrp.toFixed(2);
    }
    
    updateDiscountInfo();
    isCalculating = false;
}

function onDiscountPercentChange() {
    if (isCalculating) return;
    isCalculating = true;
    
    const mrp = parseFloat(document.getElementById('mrpInput').value) || 0;
    const discountPercent = parseFloat(document.getElementById('discountPercentInput').value) || 0;
    
    // Validate discount percent
    if (discountPercent < 0) {
        document.getElementById('discountPercentInput').value = 0;
        isCalculating = false;
        return;
    }
    if (discountPercent > 100) {
        alert('‚ùå Discount cannot exceed 100%');
        document.getElementById('discountPercentInput').value = 100;
        isCalculating = false;
        return;
    }
    
    if (mrp > 0) {
        // Auto-calculate selling price from MRP and discount %
        const sellingPrice = mrp * (1 - discountPercent / 100);
        document.getElementById('sellingPriceInput').value = sellingPrice.toFixed(2);
    } else {
        // No MRP set, can't calculate
        alert('‚ÑπÔ∏è Please set MRP first to use discount percentage');
        document.getElementById('discountPercentInput').value = 0;
    }
    
    updateDiscountInfo();
    isCalculating = false;
}

function onSellingPriceChange() {
    if (isCalculating) return;
    isCalculating = true;
    
    const mrp = parseFloat(document.getElementById('mrpInput').value) || 0;
    const sellingPrice = parseFloat(document.getElementById('sellingPriceInput').value) || 0;
    
    // Validate: Selling price cannot exceed MRP
    if (mrp > 0 && sellingPrice > mrp) {
        alert('‚ùå Selling price (‚Çπ' + sellingPrice.toFixed(2) + ') cannot exceed MRP (‚Çπ' + mrp.toFixed(2) + ')\n\nIn India, it is illegal to sell above Maximum Retail Price.');
        document.getElementById('sellingPriceInput').value = mrp.toFixed(2);
        document.getElementById('discountPercentInput').value = '0';
        isCalculating = false;
        return;
    }
    
    // Auto-calculate discount % from MRP and selling price
    if (mrp > 0 && sellingPrice > 0) {
        const discountPercent = ((mrp - sellingPrice) / mrp) * 100;
        document.getElementById('discountPercentInput').value = discountPercent.toFixed(2);
    }
    
    updateDiscountInfo();
    isCalculating = false;
}

function updateDiscountInfo() {
    const mrp = parseFloat(document.getElementById('mrpInput').value) || 0;
    const sellingPrice = parseFloat(document.getElementById('sellingPriceInput').value) || 0;
    const discountPercent = parseFloat(document.getElementById('discountPercentInput').value) || 0;
    const discountInfo = document.getElementById('discountInfo');
    
    document.getElementById('sellingPriceInput').style.borderColor = '#dfe6e9';
    
    if (mrp > 0 && discountPercent > 0) {
        const savings = mrp - sellingPrice;
        discountInfo.textContent = `üí∞ ${discountPercent.toFixed(1)}% OFF ¬∑ Save ‚Çπ${savings.toFixed(2)} per unit`;
        discountInfo.style.color = '#27ae60';
    } else if (mrp > 0 && sellingPrice === mrp) {
        discountInfo.textContent = 'üíµ Selling at MRP (No discount)';
        discountInfo.style.color = '#666';
    } else {
        discountInfo.textContent = '';
    }
}

// Calculate on page load
window.addEventListener('DOMContentLoaded', function() {
    updateDiscountInfo();
});
</script>
{% endblock %}
