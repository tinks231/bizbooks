{% extends "base_sidebar.html" %}

{% block title %}Add New Item - BizBooks{% endblock %}

{% block page_title %}Add New Item{% endblock %}

{% block header_actions %}
<a href="{{ url_for('items.index') }}" class="btn btn-secondary">
    ‚Üê Back to Items
</a>
{% endblock %}

{% block content %}
<form method="POST" id="itemForm" onsubmit="return validateForm('itemForm')">
    <div class="card">
        <!-- Type Selection -->
        <div class="form-group">
            <label>Type *</label>
            <div style="display: flex; gap: 20px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="type" value="goods" checked required>
                    <span>Goods</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="type" value="service" required>
                    <span>Service</span>
                </label>
            </div>
        </div>

        <!-- Basic Information -->
        <div class="form-row" style="margin-bottom: 15px;">
            <div class="form-group" style="flex: 1;">
                <label>Item Name *</label>
                <input type="text" name="name" required placeholder="e.g., Wire - 2.5mm Copper Cable">
            </div>
            
            <div class="form-group" style="flex: 1; position: relative;">
                <!-- main label, identical behavior to Item Name -->
                <label style="display: block;">SKU</label>
                <!-- auto-generate toggle, floated to the right and NOT affecting height -->
                <label style="position: absolute; right: 0; top: 0; display: inline-flex; align-items: center; gap: 5px; font-weight: normal; font-size: 13px; margin: 0;">
                    <input type="checkbox" id="autoSkuCheckbox" checked onchange="toggleSKUMode()">
                    <span>Auto-generate</span>
                </label>
                <!-- input will now line up perfectly with Item Name input -->
                <input type="text" id="skuInput" name="sku" placeholder="Auto-generated" disabled style="background: #f5f7fa; color: #7f8c8d;">
            </div>
        </div>

        <div class="form-row" style="margin-bottom: 15px;">
            <div class="form-group" style="flex: 1;">
                <label>Unit *</label>
                <select name="unit" required style="margin-bottom: 10px;">
                    <option value="nos">Pieces (nos)</option>
                    <option value="kg">Kilogram (kg)</option>
                    <option value="g">Gram (g)</option>
                    <option value="ltr">Liter (ltr)</option>
                    <option value="ml">Milliliter (ml)</option>
                    <option value="mtr">Meter (mtr)</option>
                    <option value="cm">Centimeter (cm)</option>
                    <option value="box">Box</option>
                    <option value="bag">Bag</option>
                    <option value="packet">Packet</option>
                    <option value="bundle">Bundle</option>
                    <option value="dozen">Dozen</option>
                </select>
                <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer; margin: 0;">
                    <input type="checkbox" name="is_returnable" checked>
                    <span>Returnable Item</span>
                </label>
            </div>

            <div class="form-group" style="flex: 1;">
                <label>Category</label>
                <select name="category_id">
                    <option value="">Select Category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
                <small style="color: #7f8c8d;">
                    Don't see your category? <a href="{{ url_for('items.categories') }}" target="_blank">Add Category</a>
                </small>
            </div>

            <div class="form-group" style="flex: 1;">
                <label>Item Group</label>
                <select name="item_group_id">
                    <option value="">Select Group</option>
                    {% for group in groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
                <small style="color: #7f8c8d;">
                    Don't see your group? <a href="{{ url_for('items.groups') }}" target="_blank">Add Group</a>
                </small>
            </div>
        </div>


        <!-- Sales Information -->
        <h3 style="margin: 25px 0 12px; color: #2c3e50; font-size: 16px; border-top: 2px solid #f5f7fa; padding-top: 15px;">
            üí∞ Sales Information
        </h3>

        <div class="form-row" style="margin-bottom: 15px;">
            <div class="form-group" style="flex: 1;">
                <label>Selling Price (‚Çπ) *</label>
                <input type="number" name="selling_price" step="0.01" min="0" required placeholder="0.00">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>GST Rate *</label>
                <select name="gst_rate" required>
                    <option value="0">0% - Exempted</option>
                    <option value="5">5% GST</option>
                    <option value="12">12% GST</option>
                    <option value="18" selected>18% GST (Default)</option>
                    <option value="28">28% GST</option>
                </select>
                <small style="color: #7f8c8d;">Default GST rate for this item</small>
            </div>
        </div>

        <div class="form-row" style="margin-bottom: 15px;">
            <div class="form-group" style="flex: 1;">
                <label>HSN/SAC Code (for GST)</label>
                <input type="text" name="hsn_code" placeholder="e.g., 8414, 8544" maxlength="20">
                <small style="color: #7f8c8d;">Optional - Used in GST reports and invoices</small>
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Account</label>
                <select name="sales_account">
                    <option value="Sales">Sales</option>
                    <option value="Revenue">Revenue</option>
                    <option value="Income">Income</option>
                </select>
            </div>
        </div>

        <div class="form-row" style="margin-bottom: 15px;">
            <div class="form-group" style="flex: 1;">
                <label>Sales Description</label>
                <textarea name="sales_description" rows="3" placeholder="Description shown on invoices..."></textarea>
            </div>
        </div>

        <!-- Purchase Information -->
        <h3 style="margin: 25px 0 12px; color: #2c3e50; font-size: 16px; border-top: 2px solid #f5f7fa; padding-top: 15px;">
            üõí Purchase Information
        </h3>

        <div class="form-row" style="margin-bottom: 15px;">
            <div class="form-group" style="flex: 1;">
                <label>Cost Price (‚Çπ) *</label>
                <input type="number" id="costPrice" name="cost_price" step="0.01" min="0" required placeholder="0.00" onchange="calculateOpeningStockValue()">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Account</label>
                <select name="purchase_account">
                    <option value="Cost of Goods Sold">Cost of Goods Sold</option>
                    <option value="Purchases">Purchases</option>
                    <option value="Inventory">Inventory</option>
                </select>
            </div>
        </div>

        <div class="form-row" style="margin-bottom: 15px;">
            <div class="form-group" style="flex: 1;">
                <label>Preferred Vendor</label>
                <input type="text" name="preferred_vendor" placeholder="Vendor name (optional)">
                <small style="color: #7f8c8d;">Your default supplier for this item</small>
            </div>
            <div class="form-group" style="flex: 1;">
                <!-- Empty placeholder for alignment -->
            </div>
        </div>

        <div class="form-row" style="margin-bottom: 15px;">
            <div class="form-group" style="flex: 1;">
                <label>Purchase Description</label>
                <textarea name="purchase_description" rows="3" placeholder="Description for purchase orders..."></textarea>
            </div>
        </div>

        <!-- Inventory Tracking -->
        <h3 style="margin: 25px 0 12px; color: #2c3e50; font-size: 16px; border-top: 2px solid #f5f7fa; padding-top: 15px;">
            üìä Inventory Tracking
        </h3>

        <div class="form-group" style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 700; font-size: 15px;">
                <input type="checkbox" name="track_inventory" id="trackInventory" checked onchange="toggleInventoryFields()">
                <span>‚úì Track Inventory for this item</span>
            </label>
            <small style="color: #7f8c8d;">Enable this to track stock levels across sites</small>
        </div>

        <div id="inventoryFields">
            <div class="form-row" style="margin-bottom: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Opening Stock</label>
                    <input type="number" id="openingStock" name="opening_stock" step="0.01" min="0" placeholder="0.00" onchange="calculateOpeningStockValue()">
                    <small style="color: #7f8c8d;">Initial stock quantity (how much you already have)</small>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Opening Stock Value (‚Çπ) <span style="color: #27ae60; font-weight: normal; font-size: 12px;">‚ö° Auto-calculated</span></label>
                    <input type="number" id="openingStockValue" name="opening_stock_value" step="0.01" min="0" placeholder="0.00" readonly style="background: #f8f9fa; cursor: not-allowed;">
                    <small style="color: #7f8c8d;">= Opening Stock √ó Cost Price (auto-calculated)</small>
                </div>
            </div>

            <div class="form-row" style="margin-bottom: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Reorder Point</label>
                    <input type="number" name="reorder_point" step="0.01" min="0" placeholder="0.00">
                    <small style="color: #7f8c8d;">Alert when stock falls below this level</small>
                </div>
                <div class="form-group" style="flex: 1;">
                    <!-- Empty placeholder for alignment -->
                </div>
            </div>
        </div>

        <!-- Advanced Options Toggle -->
        <div style="margin: 25px 0 15px; padding: 18px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 0; font-size: 15px; font-weight: 600;">
                <input type="checkbox" id="showAdvancedOptions" onchange="toggleAdvancedOptions()" style="width: 18px; height: 18px; cursor: pointer;">
                <span>üì¶ Show Advanced Options (Dimensions & Product Identifiers)</span>
            </label>
            <small style="color: #7f8c8d; margin-left: 30px; display: block; margin-top: 5px;">
                Add physical dimensions, weight, and international product codes (UPC, EAN, MPN, etc.)
            </small>
        </div>

        <!-- Advanced Options Section (Hidden by default) -->
        <div id="advancedOptionsSection" style="display: none;">
            <!-- Dimensions & Weight -->
            <h3 style="margin: 15px 0 12px; color: #2c3e50; font-size: 16px; border-top: 2px solid #f5f7fa; padding-top: 15px;">
                üìê Dimensions & Weight
            </h3>

            <div class="form-row" style="margin-bottom: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Length</label>
                    <input type="number" name="dimensions_length" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Width</label>
                    <input type="number" name="dimensions_width" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Height</label>
                    <input type="number" name="dimensions_height" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Unit</label>
                    <select name="dimensions_unit">
                        <option value="cm">Centimeter (cm)</option>
                        <option value="m">Meter (m)</option>
                        <option value="inch">Inch</option>
                        <option value="ft">Feet</option>
                    </select>
                </div>
            </div>

            <div class="form-row" style="margin-bottom: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Weight</label>
                    <input type="number" name="weight" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Weight Unit</label>
                    <select name="weight_unit">
                        <option value="kg">Kilogram (kg)</option>
                        <option value="g">Gram (g)</option>
                        <option value="lb">Pound (lb)</option>
                    </select>
                </div>
            </div>

            <!-- Product Identifiers -->
            <h3 style="margin: 20px 0 12px; color: #2c3e50; font-size: 16px; border-top: 2px solid #f5f7fa; padding-top: 15px;">
                üè∑Ô∏è Product Identifiers
            </h3>

            <div class="form-row" style="margin-bottom: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Manufacturer</label>
                    <input type="text" name="manufacturer" placeholder="e.g., Anchor">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Brand</label>
                    <input type="text" name="brand" placeholder="e.g., Anchor">
                </div>
            </div>

            <div class="form-row" style="margin-bottom: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>UPC</label>
                    <input type="text" name="upc" placeholder="Universal Product Code">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>EAN</label>
                    <input type="text" name="ean" placeholder="European Article Number">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>MPN</label>
                    <input type="text" name="mpn" placeholder="Manufacturer Part Number">
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div style="margin-top: 30px; margin-bottom: 80px; display: flex; gap: 15px; justify-content: flex-end; border-top: 2px solid #f5f7fa; padding-top: 20px;">
            <a href="{{ url_for('items.index') }}" class="btn btn-secondary">
                Cancel
            </a>
            <button type="submit" class="btn btn-primary" style="padding: 12px 30px;">
                üíæ Save Item
            </button>
        </div>
    </div>
</form>

<script>
    function toggleSKUMode() {
        const autoSkuCheckbox = document.getElementById('autoSkuCheckbox');
        const skuInput = document.getElementById('skuInput');
        const skuHint = document.getElementById('skuHint');
        
        if (autoSkuCheckbox.checked) {
            // Auto-generate mode
            skuInput.disabled = true;
            skuInput.value = '';
            skuInput.placeholder = 'Auto-generated';
            skuInput.style.background = '#f5f7fa';
            skuInput.style.color = '#7f8c8d';
            skuHint.textContent = 'SKU will be automatically generated';
        } else {
            // Manual mode
            skuInput.disabled = false;
            skuInput.placeholder = 'Enter SKU (e.g., PE-FS-W-40)';
            skuInput.style.background = 'white';
            skuInput.style.color = '#2c3e50';
            skuInput.focus();
            skuHint.textContent = 'Enter your custom SKU code';
        }
    }
    
    function toggleInventoryFields() {
        const trackInventory = document.getElementById('trackInventory');
        const inventoryFields = document.getElementById('inventoryFields');
        
        if (trackInventory.checked) {
            inventoryFields.style.display = 'block';
        } else {
            inventoryFields.style.display = 'none';
        }
    }
    
    // Auto-calculate Opening Stock Value
    function calculateOpeningStockValue() {
        const openingStock = parseFloat(document.getElementById('openingStock').value) || 0;
        const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
        
        // Formula: Opening Stock Value = Opening Stock √ó Cost Price
        const openingStockValue = openingStock * costPrice;
        
        // Update the field
        document.getElementById('openingStockValue').value = openingStockValue.toFixed(2);
        
        // Visual feedback (flash green briefly)
        const valueField = document.getElementById('openingStockValue');
        valueField.style.background = '#d4edda';
        valueField.style.borderColor = '#28a745';
        setTimeout(() => {
            valueField.style.background = '#f8f9fa';
            valueField.style.borderColor = '#dfe6e9';
        }, 500);
    }
    
    // Toggle Advanced Options Section
    function toggleAdvancedOptions() {
        const checkbox = document.getElementById('showAdvancedOptions');
        const section = document.getElementById('advancedOptionsSection');
        
        if (checkbox.checked) {
            section.style.display = 'block';
            // Smooth scroll to the section
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            section.style.display = 'none';
        }
    }
    
    // Initialize on page load
    toggleInventoryFields();
</script>
{% endblock %}

