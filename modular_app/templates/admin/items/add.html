{% extends "base_sidebar.html" %}

{% block title %}Add New Item - BizBooks{% endblock %}

{% block page_title %}Add New Item{% endblock %}

{% block header_actions %}
<a href="{{ url_for('items.index') }}" class="btn btn-secondary">
    ‚Üê Back to Items
</a>
{% endblock %}

{% block content %}
<form method="POST" id="itemForm" onsubmit="return validateForm('itemForm')">
    <div class="card">
        <!-- Type Selection -->
        <div class="form-group">
            <label class="field-label field-label--required">Type</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="type" value="goods" checked required>
                    <span>Goods</span>
                </label>
                <label>
                    <input type="radio" name="type" value="service" required>
                    <span>Service</span>
                </label>
            </div>
        </div>

        <!-- Basic Information -->
        <div class="form-row">
            <div class="form-group">
                <div class="label-row">
                    <label class="field-label field-label--required">Item Name</label>
                </div>
                <input type="text" name="name" required placeholder="e.g., Wire - 2.5mm Copper Cable">
            </div>
            
            <div class="form-group">
                <div class="label-row">
                    <label class="field-label">SKU</label>
                    <label class="inline-checkbox">
                        <input type="checkbox" id="autoSkuCheckbox" checked onchange="toggleSKUMode()">
                        <span>Auto-generate</span>
                    </label>
                </div>
                <input type="text" id="skuInput" name="sku" placeholder="Auto-generated" disabled>
                <small id="skuHint" class="help-text">SKU will be automatically generated</small>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label field-label--required">Unit</label>
                <select name="unit" required>
                    <option value="nos">Nos (Numbers)</option>
                    <option value="pcs">Pcs (Pieces)</option>
                    <option value="dozen">Dozen</option>
                    <option value="kg">Kg (Kilogram)</option>
                    <option value="qtl">Qtl (Quintal)</option>
                    <option value="ton">Ton</option>
                    <option value="g">G (Gram)</option>
                    <option value="ltr">Ltr (Liter)</option>
                    <option value="ml">Ml (Milliliter)</option>
                    <option value="mtr">Mtr (Meter)</option>
                    <option value="cm">Cm (Centimeter)</option>
                    <option value="ft">Ft (Foot)</option>
                    <option value="sqm">Sqm (Square Meter)</option>
                    <option value="cum">Cum (Cubic Meter)</option>
                    <option value="cft">Cft (Cubic Feet)</option>
                    <option value="box">Box</option>
                    <option value="bag">Bag</option>
                    <option value="packet">Packet</option>
                    <option value="bundle">Bundle</option>
                </select>
                <label class="inline-checkbox mt-1">
                    <input type="checkbox" name="is_returnable" checked>
                    <span>Returnable Item</span>
                </label>
            </div>

            <div class="form-group">
                <label class="field-label">Category</label>
                <select name="category_id" id="categorySelect">
                    <option value="">Select Category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
                <small class="help-text">
                    Don't see your category? <a href="javascript:void(0)" onclick="openAddCategoryModal()" style="color: #667eea; font-weight: 600;">‚ûï Add Category</a>
                </small>
            </div>

            <div class="form-group">
                <label class="field-label">Item Group</label>
                <select name="item_group_id" id="groupSelect">
                    <option value="">Select Group</option>
                    {% for group in groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
                <small class="help-text">
                    Don't see your group? <a href="javascript:void(0)" onclick="openAddGroupModal()" style="color: #667eea; font-weight: 600;">‚ûï Add Group</a>
                </small>
            </div>
        </div>


        <!-- Sales Information -->
        <h3 class="section-title">
            üí∞ Sales Information
        </h3>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label">MRP - Maximum Retail Price (‚Çπ)</label>
                <input type="number" id="mrpInput" name="mrp" step="0.01" min="0" placeholder="0.00" oninput="onMRPChange()">
                <small class="help-text">Optional - Price printed on product package</small>
            </div>
            <div class="form-group">
                <label class="field-label">Discount % on MRP</label>
                <input type="number" id="discountPercentInput" name="discount_percent" step="0.01" min="0" max="100" placeholder="0.00" oninput="onDiscountPercentChange()">
                <small class="help-text">e.g., 15 for 15% discount</small>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label field-label--required">Selling Price (‚Çπ) <span style="color: #27ae60; font-weight: normal; font-size: 12px;">‚ö° Auto-calculated</span></label>
                <input type="number" id="sellingPriceInput" name="selling_price" step="0.01" min="0" required placeholder="0.00" oninput="onSellingPriceChange()">
                <small class="help-text" id="discountInfo" style="color: #27ae60; font-weight: 600;"></small>
            </div>
            <div class="form-group">
                <!-- Empty for alignment -->
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label field-label--required">GST Rate</label>
                <select name="gst_rate" required>
                    <option value="0">0% - Exempted</option>
                    <option value="5">5% GST</option>
                    <option value="12">12% GST</option>
                    <option value="18" selected>18% GST (Default)</option>
                    <option value="28">28% GST</option>
                </select>
                <small class="help-text">Default GST rate for this item</small>
            </div>
            <div class="form-group">
                <!-- Empty placeholder for alignment -->
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label">HSN/SAC Code (for GST)</label>
                <input type="text" name="hsn_code" placeholder="e.g., 8414, 8544" maxlength="20">
                <small class="help-text">Optional - Used in GST reports and invoices</small>
            </div>
            <div class="form-group">
                <label class="field-label">Account</label>
                <select name="sales_account">
                    <option value="Sales">Sales</option>
                    <option value="Revenue">Revenue</option>
                    <option value="Income">Income</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group form-group--full">
                <label class="field-label">Sales Description</label>
                <textarea name="sales_description" rows="3" placeholder="Description shown on invoices..."></textarea>
            </div>
        </div>

        <!-- Purchase Information -->
        <h3 class="section-title">
            üõí Purchase Information
        </h3>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label field-label--required">Cost Price (‚Çπ)</label>
                <input type="number" id="costPrice" name="cost_price" step="0.01" min="0" required placeholder="0.00" onchange="calculateOpeningStockValue()">
            </div>
            <div class="form-group">
                <label class="field-label">Account</label>
                <select name="purchase_account">
                    <option value="Cost of Goods Sold">Cost of Goods Sold</option>
                    <option value="Purchases">Purchases</option>
                    <option value="Inventory">Inventory</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label">Preferred Vendor</label>
                <input type="text" name="preferred_vendor" placeholder="Vendor name (optional)">
                <small class="help-text">Your default supplier for this item</small>
            </div>
            <div class="form-group">
                <!-- Empty placeholder for alignment -->
            </div>
        </div>

        <div class="form-row">
            <div class="form-group form-group--full">
                <label class="field-label">Purchase Description</label>
                <textarea name="purchase_description" rows="3" placeholder="Description for purchase orders..."></textarea>
            </div>
        </div>

        <!-- Inventory Tracking -->
        <h3 class="section-title">
            üìä Inventory Tracking
        </h3>

        <div class="form-group">
            <label class="checkbox-group" style="font-weight: 700; font-size: 15px; cursor: pointer;">
                <input type="checkbox" name="track_inventory" id="trackInventory" checked onchange="toggleInventoryFields()">
                <span>‚úì Track Inventory for this item</span>
            </label>
            <small class="help-text">Enable this to track stock levels across sites</small>
        </div>

        <div id="inventoryFields">
            <div class="form-row">
                <div class="form-group">
                    <label class="field-label">Opening Stock</label>
                    <input type="number" id="openingStock" name="opening_stock" step="0.01" min="0" placeholder="0.00" onchange="calculateOpeningStockValue()">
                    <small class="help-text">Initial stock quantity (how much you already have)</small>
                </div>
                <div class="form-group">
                    <label class="field-label">Opening Stock Value (‚Çπ) <span style="color: #27ae60; font-weight: normal; font-size: 12px;">‚ö° Auto-calculated</span></label>
                    <input type="number" id="openingStockValue" name="opening_stock_value" step="0.01" min="0" placeholder="0.00" readonly>
                    <small class="help-text">= Opening Stock √ó Cost Price (auto-calculated)</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="field-label">Reorder Point</label>
                    <input type="number" name="reorder_point" step="0.01" min="0" placeholder="0.00">
                    <small class="help-text">Alert when stock falls below this level</small>
                </div>
                <div class="form-group">
                    <!-- Empty placeholder for alignment -->
                </div>
            </div>
        </div>

        <!-- Advanced Options Toggle -->
        <div class="collapsible-section" style="padding: 18px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
            <label class="collapsible-trigger">
                <input type="checkbox" id="showAdvancedOptions" onchange="toggleAdvancedOptions()" style="width: 18px; height: 18px;">
                <span>üì¶ Show Advanced Options (Dimensions & Product Identifiers)</span>
            </label>
            <small class="help-text" style="margin-left: 30px;">
                Add physical dimensions, weight, and international product codes (UPC, EAN, MPN, etc.)
            </small>
        </div>

        <!-- Advanced Options Section (Hidden by default) -->
        <div id="advancedOptionsSection" class="collapsible-content">
            <!-- Dimensions & Weight -->
            <h3 class="section-title">
                üìê Dimensions & Weight
            </h3>

            <div class="form-row">
                <div class="form-group">
                    <label class="field-label">Length</label>
                    <input type="number" name="dimensions_length" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="field-label">Width</label>
                    <input type="number" name="dimensions_width" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="field-label">Height</label>
                    <input type="number" name="dimensions_height" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="field-label">Unit</label>
                    <select name="dimensions_unit">
                        <option value="cm">Centimeter (cm)</option>
                        <option value="m">Meter (m)</option>
                        <option value="inch">Inch</option>
                        <option value="ft">Feet</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="field-label">Weight</label>
                    <input type="number" name="weight" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="field-label">Weight Unit</label>
                    <select name="weight_unit">
                        <option value="kg">Kilogram (kg)</option>
                        <option value="g">Gram (g)</option>
                        <option value="lb">Pound (lb)</option>
                    </select>
                </div>
            </div>

            <!-- Product Identifiers -->
            <h3 class="section-title">
                üè∑Ô∏è Product Identifiers
            </h3>

            <div class="form-row">
                <div class="form-group">
                    <label class="field-label">Manufacturer</label>
                    <input type="text" name="manufacturer" placeholder="e.g., Anchor">
                </div>
                <div class="form-group">
                    <label class="field-label">Brand</label>
                    <input type="text" name="brand" placeholder="e.g., Anchor">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="field-label">UPC</label>
                    <input type="text" name="upc" placeholder="Universal Product Code">
                </div>
                <div class="form-group">
                    <label class="field-label">EAN</label>
                    <input type="text" name="ean" placeholder="European Article Number">
                </div>
                <div class="form-group">
                    <label class="field-label">MPN</label>
                    <input type="text" name="mpn" placeholder="Manufacturer Part Number">
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <a href="{{ url_for('items.index') }}" class="btn btn-secondary">
                Cancel
            </a>
            <button type="submit" class="btn btn-primary" style="padding: 12px 30px;">
                üíæ Save Item
            </button>
        </div>
    </div>
</form>

<!-- Add Category Modal -->
<div id="addCategoryModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">üìÅ Add New Category</h3>
            <button onclick="closeAddCategoryModal()" class="modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
        </div>
        <form id="addCategoryForm" onsubmit="submitCategory(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label class="field-label field-label--required">Category Name</label>
                    <input type="text" name="name" id="categoryName" class="form-control" required placeholder="e.g., Cables, Switches, Lights">
                </div>
                <div class="form-group">
                    <label class="field-label">Description</label>
                    <textarea name="description" class="form-control" rows="2" placeholder="Optional category description"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeAddCategoryModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ Add Category</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Group Modal -->
<div id="addGroupModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">üè∑Ô∏è Add New Group</h3>
            <button onclick="closeAddGroupModal()" class="modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
        </div>
        <form id="addGroupForm" onsubmit="submitGroup(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label class="field-label field-label--required">Group Name</label>
                    <input type="text" name="name" id="groupName" class="form-control" required placeholder="e.g., Electrical, Plumbing, Hardware">
                </div>
                <div class="form-group">
                    <label class="field-label">Description</label>
                    <textarea name="description" class="form-control" rows="2" placeholder="Optional group description"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeAddGroupModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ Add Group</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 500px;
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 2px solid #f0f0f0;
}

.modal-body {
    padding: 25px;
}

.modal-footer {
    padding: 15px 25px;
    border-top: 2px solid #f0f0f0;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.modal-close {
    transition: all 0.2s ease;
}

.modal-close:hover {
    transform: scale(1.2);
    color: #dc3545 !important;
}
</style>

<script>
    function toggleSKUMode() {
        const autoSkuCheckbox = document.getElementById('autoSkuCheckbox');
        const skuInput = document.getElementById('skuInput');
        const skuHint = document.getElementById('skuHint');
        
        if (autoSkuCheckbox.checked) {
            // Auto-generate mode
            skuInput.disabled = true;
            skuInput.value = '';
            skuInput.placeholder = 'Auto-generated';
            skuHint.textContent = 'SKU will be automatically generated';
        } else {
            // Manual mode
            skuInput.disabled = false;
            skuInput.placeholder = 'Enter SKU (e.g., PE-FS-W-40)';
            skuInput.focus();
            skuHint.textContent = 'Enter your custom SKU code';
        }
    }
    
    function toggleInventoryFields() {
        const trackInventory = document.getElementById('trackInventory');
        const inventoryFields = document.getElementById('inventoryFields');
        
        if (trackInventory.checked) {
            inventoryFields.style.display = 'block';
        } else {
            inventoryFields.style.display = 'none';
        }
    }
    
    // Auto-calculate Opening Stock Value
    function calculateOpeningStockValue() {
        const openingStock = parseFloat(document.getElementById('openingStock').value) || 0;
        const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
        
        // Formula: Opening Stock Value = Opening Stock √ó Cost Price
        const openingStockValue = openingStock * costPrice;
        
        // Update the field
        document.getElementById('openingStockValue').value = openingStockValue.toFixed(2);
        
        // Visual feedback (flash green briefly)
        const valueField = document.getElementById('openingStockValue');
        valueField.style.background = '#d4edda';
        valueField.style.borderColor = '#28a745';
        setTimeout(() => {
            valueField.style.background = '#f8f9fa';
            valueField.style.borderColor = '#dfe6e9';
        }, 500);
    }
    
    // Toggle Advanced Options Section
    function toggleAdvancedOptions() {
        const checkbox = document.getElementById('showAdvancedOptions');
        const section = document.getElementById('advancedOptionsSection');
        
        if (checkbox.checked) {
            section.style.display = 'block';
            // Smooth scroll to the section
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            section.style.display = 'none';
        }
    }
    
    // Initialize on page load
    toggleInventoryFields();
    
    // ========================================
    // CATEGORY MODAL FUNCTIONS
    // ========================================
    
    function openAddCategoryModal() {
        document.getElementById('addCategoryModal').style.display = 'flex';
        document.getElementById('categoryName').focus();
    }
    
    function closeAddCategoryModal() {
        document.getElementById('addCategoryModal').style.display = 'none';
        document.getElementById('addCategoryForm').reset();
    }
    
    function submitCategory(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        
        // Disable button
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Adding...';
        
        fetch('{{ url_for("items.add_category") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(html => {
            // Success! Refresh the category dropdown
            const categoryName = formData.get('name');
            
            // Parse the new category ID from the response (flash message contains success)
            if (html.includes('successfully') || html.includes('added')) {
                // Fetch updated categories list
                fetch('{{ url_for("items.get_categories_json") }}')
                    .then(r => r.json())
                    .then(data => {
                        const select = document.getElementById('categorySelect');
                        const currentValue = select.value;
                        
                        // Rebuild dropdown
                        select.innerHTML = '<option value="">Select Category</option>';
                        data.categories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.id;
                            option.textContent = cat.name;
                            if (cat.name === categoryName) {
                                option.selected = true;  // Auto-select the new category
                            }
                            select.appendChild(option);
                        });
                        
                        // Show success message
                        alert(`‚úÖ Category "${categoryName}" added successfully!`);
                        closeAddCategoryModal();
                    });
            } else {
                alert('‚ùå Error adding category. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Add Category';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error adding category. Please try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'üíæ Add Category';
        });
    }
    
    // ========================================
    // GROUP MODAL FUNCTIONS
    // ========================================
    
    function openAddGroupModal() {
        document.getElementById('addGroupModal').style.display = 'flex';
        document.getElementById('groupName').focus();
    }
    
    function closeAddGroupModal() {
        document.getElementById('addGroupModal').style.display = 'none';
        document.getElementById('addGroupForm').reset();
    }
    
    function submitGroup(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        
        // Disable button
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Adding...';
        
        fetch('{{ url_for("items.add_group") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(html => {
            // Success! Refresh the group dropdown
            const groupName = formData.get('name');
            
            // Parse the new group ID from the response
            if (html.includes('successfully') || html.includes('added')) {
                // Fetch updated groups list
                fetch('{{ url_for("items.get_groups_json") }}')
                    .then(r => r.json())
                    .then(data => {
                        const select = document.getElementById('groupSelect');
                        
                        // Rebuild dropdown
                        select.innerHTML = '<option value="">Select Group</option>';
                        data.groups.forEach(grp => {
                            const option = document.createElement('option');
                            option.value = grp.id;
                            option.textContent = grp.name;
                            if (grp.name === groupName) {
                                option.selected = true;  // Auto-select the new group
                            }
                            select.appendChild(option);
                        });
                        
                        // Show success message
                        alert(`‚úÖ Group "${groupName}" added successfully!`);
                        closeAddGroupModal();
                    });
            } else {
                alert('‚ùå Error adding group. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Add Group';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error adding group. Please try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'üíæ Add Group';
        });
    }
    
    // Close modals on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeAddCategoryModal();
            closeAddGroupModal();
        }
    });
    
    // Close modals on outside click
    document.getElementById('addCategoryModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeAddCategoryModal();
        }
    });
    
    document.getElementById('addGroupModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeAddGroupModal();
        }
    });
    
    // ========================================
    // MRP, DISCOUNT %, AND SELLING PRICE AUTO-CALCULATION
    // ========================================
    
    let isCalculating = false; // Prevent infinite loops
    
    function onMRPChange() {
        if (isCalculating) return;
        isCalculating = true;
        
        const mrp = parseFloat(document.getElementById('mrpInput').value) || 0;
        const discountPercent = parseFloat(document.getElementById('discountPercentInput').value) || 0;
        
        if (mrp > 0 && discountPercent > 0) {
            // Auto-calculate selling price from MRP and discount %
            const sellingPrice = mrp * (1 - discountPercent / 100);
            document.getElementById('sellingPriceInput').value = sellingPrice.toFixed(2);
        } else if (mrp > 0 && discountPercent === 0) {
            // No discount, selling price = MRP
            document.getElementById('sellingPriceInput').value = mrp.toFixed(2);
        }
        
        updateDiscountInfo();
        isCalculating = false;
    }
    
    function onDiscountPercentChange() {
        if (isCalculating) return;
        isCalculating = true;
        
        const mrp = parseFloat(document.getElementById('mrpInput').value) || 0;
        const discountPercent = parseFloat(document.getElementById('discountPercentInput').value) || 0;
        
        // Validate discount percent
        if (discountPercent < 0) {
            document.getElementById('discountPercentInput').value = 0;
            isCalculating = false;
            return;
        }
        if (discountPercent > 100) {
            alert('‚ùå Discount cannot exceed 100%');
            document.getElementById('discountPercentInput').value = 100;
            isCalculating = false;
            return;
        }
        
        if (mrp > 0) {
            // Auto-calculate selling price from MRP and discount %
            const sellingPrice = mrp * (1 - discountPercent / 100);
            document.getElementById('sellingPriceInput').value = sellingPrice.toFixed(2);
        } else {
            // No MRP set, can't calculate
            alert('‚ÑπÔ∏è Please set MRP first to use discount percentage');
            document.getElementById('discountPercentInput').value = 0;
        }
        
        updateDiscountInfo();
        isCalculating = false;
    }
    
    function onSellingPriceChange() {
        if (isCalculating) return;
        isCalculating = true;
        
        const mrp = parseFloat(document.getElementById('mrpInput').value) || 0;
        const sellingPrice = parseFloat(document.getElementById('sellingPriceInput').value) || 0;
        
        // Validate: Selling price cannot exceed MRP
        if (mrp > 0 && sellingPrice > mrp) {
            alert('‚ùå Selling price (‚Çπ' + sellingPrice.toFixed(2) + ') cannot exceed MRP (‚Çπ' + mrp.toFixed(2) + ')\n\nIn India, it is illegal to sell above Maximum Retail Price.');
            document.getElementById('sellingPriceInput').value = mrp.toFixed(2);
            document.getElementById('discountPercentInput').value = '0';
            isCalculating = false;
            return;
        }
        
        // Auto-calculate discount % from MRP and selling price
        if (mrp > 0 && sellingPrice > 0) {
            const discountPercent = ((mrp - sellingPrice) / mrp) * 100;
            document.getElementById('discountPercentInput').value = discountPercent.toFixed(2);
        }
        
        updateDiscountInfo();
        isCalculating = false;
    }
    
    function updateDiscountInfo() {
        const mrp = parseFloat(document.getElementById('mrpInput').value) || 0;
        const sellingPrice = parseFloat(document.getElementById('sellingPriceInput').value) || 0;
        const discountPercent = parseFloat(document.getElementById('discountPercentInput').value) || 0;
        const discountInfo = document.getElementById('discountInfo');
        
        document.getElementById('sellingPriceInput').style.borderColor = '#dfe6e9';
        
        if (mrp > 0 && discountPercent > 0) {
            const savings = mrp - sellingPrice;
            discountInfo.textContent = `üí∞ ${discountPercent.toFixed(1)}% OFF ¬∑ Save ‚Çπ${savings.toFixed(2)} per unit`;
            discountInfo.style.color = '#27ae60';
        } else if (mrp > 0 && sellingPrice === mrp) {
            discountInfo.textContent = 'üíµ Selling at MRP (No discount)';
            discountInfo.style.color = '#666';
        } else {
            discountInfo.textContent = '';
        }
    }
</script>
{% endblock %}
