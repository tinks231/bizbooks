{% extends "base_sidebar.html" %}

{% block title %}Add New Item - BizBooks{% endblock %}

{% block page_title %}Add New Item{% endblock %}

{% block header_actions %}
<a href="{{ url_for('items.index') }}" class="btn btn-secondary">
    ‚Üê Back to Items
</a>
{% endblock %}

{% block content %}
<form method="POST" id="itemForm" onsubmit="return validateForm('itemForm')">
    <div class="card">
        <!-- Type Selection -->
        <div class="form-group">
            <label class="field-label field-label--required">Type</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="type" value="goods" checked required>
                    <span>Goods</span>
                </label>
                <label>
                    <input type="radio" name="type" value="service" required>
                    <span>Service</span>
                </label>
            </div>
        </div>

        <!-- Basic Information -->
        <div class="form-row">
            <div class="form-group">
                <div class="label-row">
                    <label class="field-label field-label--required">Item Name</label>
                </div>
                <input type="text" name="name" required placeholder="e.g., Wire - 2.5mm Copper Cable">
            </div>
            
            <div class="form-group">
                <div class="label-row">
                    <label class="field-label">SKU</label>
                    <label class="inline-checkbox">
                        <input type="checkbox" id="autoSkuCheckbox" checked onchange="toggleSKUMode()">
                        <span>Auto-generate</span>
                    </label>
                </div>
                <input type="text" id="skuInput" name="sku" placeholder="Auto-generated" disabled>
                <small id="skuHint" class="help-text">SKU will be automatically generated</small>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label field-label--required">Unit</label>
                <select name="unit" required>
                    <option value="nos">Nos (Numbers)</option>
                    <option value="pcs">Pcs (Pieces)</option>
                    <option value="dozen">Dozen</option>
                    <option value="kg">Kg (Kilogram)</option>
                    <option value="qtl">Qtl (Quintal)</option>
                    <option value="ton">Ton</option>
                    <option value="g">G (Gram)</option>
                    <option value="ltr">Ltr (Liter)</option>
                    <option value="ml">Ml (Milliliter)</option>
                    <option value="mtr">Mtr (Meter)</option>
                    <option value="cm">Cm (Centimeter)</option>
                    <option value="ft">Ft (Foot)</option>
                    <option value="sqm">Sqm (Square Meter)</option>
                    <option value="cum">Cum (Cubic Meter)</option>
                    <option value="cft">Cft (Cubic Feet)</option>
                    <option value="box">Box</option>
                    <option value="bag">Bag</option>
                    <option value="packet">Packet</option>
                    <option value="bundle">Bundle</option>
                </select>
                <label class="inline-checkbox mt-1">
                    <input type="checkbox" name="is_returnable" checked>
                    <span>Returnable Item</span>
                </label>
            </div>

            <div class="form-group">
                <label class="field-label">Category</label>
                <select name="category_id">
                    <option value="">Select Category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
                <small class="help-text">
                    Don't see your category? <a href="{{ url_for('items.categories') }}" target="_blank">Add Category</a>
                </small>
            </div>

            <div class="form-group">
                <label class="field-label">Item Group</label>
                <select name="item_group_id">
                    <option value="">Select Group</option>
                    {% for group in groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
                <small class="help-text">
                    Don't see your group? <a href="{{ url_for('items.groups') }}" target="_blank">Add Group</a>
                </small>
            </div>
        </div>


        <!-- Sales Information -->
        <h3 class="section-title">
            üí∞ Sales Information
        </h3>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label field-label--required">Selling Price (‚Çπ)</label>
                <input type="number" name="selling_price" step="0.01" min="0" required placeholder="0.00">
            </div>
            <div class="form-group">
                <label class="field-label field-label--required">GST Rate</label>
                <select name="gst_rate" required>
                    <option value="0">0% - Exempted</option>
                    <option value="5">5% GST</option>
                    <option value="12">12% GST</option>
                    <option value="18" selected>18% GST (Default)</option>
                    <option value="28">28% GST</option>
                </select>
                <small class="help-text">Default GST rate for this item</small>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label">HSN/SAC Code (for GST)</label>
                <input type="text" name="hsn_code" placeholder="e.g., 8414, 8544" maxlength="20">
                <small class="help-text">Optional - Used in GST reports and invoices</small>
            </div>
            <div class="form-group">
                <label class="field-label">Account</label>
                <select name="sales_account">
                    <option value="Sales">Sales</option>
                    <option value="Revenue">Revenue</option>
                    <option value="Income">Income</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group form-group--full">
                <label class="field-label">Sales Description</label>
                <textarea name="sales_description" rows="3" placeholder="Description shown on invoices..."></textarea>
            </div>
        </div>

        <!-- Purchase Information -->
        <h3 class="section-title">
            üõí Purchase Information
        </h3>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label field-label--required">Cost Price (‚Çπ)</label>
                <input type="number" id="costPrice" name="cost_price" step="0.01" min="0" required placeholder="0.00" onchange="calculateOpeningStockValue()">
            </div>
            <div class="form-group">
                <label class="field-label">Account</label>
                <select name="purchase_account">
                    <option value="Cost of Goods Sold">Cost of Goods Sold</option>
                    <option value="Purchases">Purchases</option>
                    <option value="Inventory">Inventory</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="field-label">Preferred Vendor</label>
                <input type="text" name="preferred_vendor" placeholder="Vendor name (optional)">
                <small class="help-text">Your default supplier for this item</small>
            </div>
            <div class="form-group">
                <!-- Empty placeholder for alignment -->
            </div>
        </div>

        <div class="form-row">
            <div class="form-group form-group--full">
                <label class="field-label">Purchase Description</label>
                <textarea name="purchase_description" rows="3" placeholder="Description for purchase orders..."></textarea>
            </div>
        </div>

        <!-- Inventory Tracking -->
        <h3 class="section-title">
            üìä Inventory Tracking
        </h3>

        <div class="form-group">
            <label class="checkbox-group" style="font-weight: 700; font-size: 15px; cursor: pointer;">
                <input type="checkbox" name="track_inventory" id="trackInventory" checked onchange="toggleInventoryFields()">
                <span>‚úì Track Inventory for this item</span>
            </label>
            <small class="help-text">Enable this to track stock levels across sites</small>
        </div>

        <div id="inventoryFields">
            <div class="form-row">
                <div class="form-group">
                    <label class="field-label">Opening Stock</label>
                    <input type="number" id="openingStock" name="opening_stock" step="0.01" min="0" placeholder="0.00" onchange="calculateOpeningStockValue()">
                    <small class="help-text">Initial stock quantity (how much you already have)</small>
                </div>
                <div class="form-group">
                    <label class="field-label">Opening Stock Value (‚Çπ) <span style="color: #27ae60; font-weight: normal; font-size: 12px;">‚ö° Auto-calculated</span></label>
                    <input type="number" id="openingStockValue" name="opening_stock_value" step="0.01" min="0" placeholder="0.00" readonly>
                    <small class="help-text">= Opening Stock √ó Cost Price (auto-calculated)</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="field-label">Reorder Point</label>
                    <input type="number" name="reorder_point" step="0.01" min="0" placeholder="0.00">
                    <small class="help-text">Alert when stock falls below this level</small>
                </div>
                <div class="form-group">
                    <!-- Empty placeholder for alignment -->
                </div>
            </div>
        </div>

        <!-- Advanced Options Toggle -->
        <div class="collapsible-section" style="padding: 18px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
            <label class="collapsible-trigger">
                <input type="checkbox" id="showAdvancedOptions" onchange="toggleAdvancedOptions()" style="width: 18px; height: 18px;">
                <span>üì¶ Show Advanced Options (Dimensions & Product Identifiers)</span>
            </label>
            <small class="help-text" style="margin-left: 30px;">
                Add physical dimensions, weight, and international product codes (UPC, EAN, MPN, etc.)
            </small>
        </div>

        <!-- Advanced Options Section (Hidden by default) -->
        <div id="advancedOptionsSection" class="collapsible-content">
            <!-- Dimensions & Weight -->
            <h3 class="section-title">
                üìê Dimensions & Weight
            </h3>

            <div class="form-row">
                <div class="form-group">
                    <label class="field-label">Length</label>
                    <input type="number" name="dimensions_length" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="field-label">Width</label>
                    <input type="number" name="dimensions_width" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="field-label">Height</label>
                    <input type="number" name="dimensions_height" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="field-label">Unit</label>
                    <select name="dimensions_unit">
                        <option value="cm">Centimeter (cm)</option>
                        <option value="m">Meter (m)</option>
                        <option value="inch">Inch</option>
                        <option value="ft">Feet</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="field-label">Weight</label>
                    <input type="number" name="weight" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="field-label">Weight Unit</label>
                    <select name="weight_unit">
                        <option value="kg">Kilogram (kg)</option>
                        <option value="g">Gram (g)</option>
                        <option value="lb">Pound (lb)</option>
                    </select>
                </div>
            </div>

            <!-- Product Identifiers -->
            <h3 class="section-title">
                üè∑Ô∏è Product Identifiers
            </h3>

            <div class="form-row">
                <div class="form-group">
                    <label class="field-label">Manufacturer</label>
                    <input type="text" name="manufacturer" placeholder="e.g., Anchor">
                </div>
                <div class="form-group">
                    <label class="field-label">Brand</label>
                    <input type="text" name="brand" placeholder="e.g., Anchor">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="field-label">UPC</label>
                    <input type="text" name="upc" placeholder="Universal Product Code">
                </div>
                <div class="form-group">
                    <label class="field-label">EAN</label>
                    <input type="text" name="ean" placeholder="European Article Number">
                </div>
                <div class="form-group">
                    <label class="field-label">MPN</label>
                    <input type="text" name="mpn" placeholder="Manufacturer Part Number">
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <a href="{{ url_for('items.index') }}" class="btn btn-secondary">
                Cancel
            </a>
            <button type="submit" class="btn btn-primary" style="padding: 12px 30px;">
                üíæ Save Item
            </button>
        </div>
    </div>
</form>

<script>
    function toggleSKUMode() {
        const autoSkuCheckbox = document.getElementById('autoSkuCheckbox');
        const skuInput = document.getElementById('skuInput');
        const skuHint = document.getElementById('skuHint');
        
        if (autoSkuCheckbox.checked) {
            // Auto-generate mode
            skuInput.disabled = true;
            skuInput.value = '';
            skuInput.placeholder = 'Auto-generated';
            skuHint.textContent = 'SKU will be automatically generated';
        } else {
            // Manual mode
            skuInput.disabled = false;
            skuInput.placeholder = 'Enter SKU (e.g., PE-FS-W-40)';
            skuInput.focus();
            skuHint.textContent = 'Enter your custom SKU code';
        }
    }
    
    function toggleInventoryFields() {
        const trackInventory = document.getElementById('trackInventory');
        const inventoryFields = document.getElementById('inventoryFields');
        
        if (trackInventory.checked) {
            inventoryFields.style.display = 'block';
        } else {
            inventoryFields.style.display = 'none';
        }
    }
    
    // Auto-calculate Opening Stock Value
    function calculateOpeningStockValue() {
        const openingStock = parseFloat(document.getElementById('openingStock').value) || 0;
        const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
        
        // Formula: Opening Stock Value = Opening Stock √ó Cost Price
        const openingStockValue = openingStock * costPrice;
        
        // Update the field
        document.getElementById('openingStockValue').value = openingStockValue.toFixed(2);
        
        // Visual feedback (flash green briefly)
        const valueField = document.getElementById('openingStockValue');
        valueField.style.background = '#d4edda';
        valueField.style.borderColor = '#28a745';
        setTimeout(() => {
            valueField.style.background = '#f8f9fa';
            valueField.style.borderColor = '#dfe6e9';
        }, 500);
    }
    
    // Toggle Advanced Options Section
    function toggleAdvancedOptions() {
        const checkbox = document.getElementById('showAdvancedOptions');
        const section = document.getElementById('advancedOptionsSection');
        
        if (checkbox.checked) {
            section.style.display = 'block';
            // Smooth scroll to the section
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            section.style.display = 'none';
        }
    }
    
    // Initialize on page load
    toggleInventoryFields();
</script>
{% endblock %}
