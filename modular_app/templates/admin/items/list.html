{% extends "base_sidebar.html" %}

{% block title %}All Items - BizBooks{% endblock %}

{% block page_title %}All Items{% endblock %}

{% block header_actions %}
<div style="display: flex; gap: 10px; flex-wrap: wrap;">
    <a href="{{ url_for('items.export_excel') }}" class="btn btn-secondary" style="background: #27ae60;">
        üì• Export to Excel
    </a>
    <form method="POST" action="{{ url_for('items.bulk_generate_barcodes') }}" style="display: inline;" 
          onsubmit="return confirm('Generate barcodes for all items without barcodes?\n\nThis will create unique EAN-13 barcodes.\n\nContinue?')">
        <button type="submit" class="btn btn-secondary" style="background: #f39c12;">
            üè∑Ô∏è Generate Barcodes
        </button>
    </form>
    <a href="{{ url_for('items.print_labels') }}" class="btn btn-secondary" style="background: #9b59b6;">
        üñ®Ô∏è Print Labels
    </a>
    <a href="{{ url_for('items.add') }}" class="btn btn-primary">
        ‚ûï Add New Item
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-grid" style="margin-bottom: 30px;">
    <div class="stat-card">
        <div class="stat-value">{{ total_items }}</div>
        <div class="stat-label">Total Items (Filtered)</div>
    </div>
    <div class="stat-card" style="border-left-color: #667eea;">
        <div class="stat-value">{{ items|length }}</div>
        <div class="stat-label">Showing on Page {{ page }}</div>
    </div>
    <div class="stat-card" style="border-left-color: #e74c3c;">
        <div class="stat-value">{{ low_stock_count }}</div>
        <div class="stat-label">Low Stock Alerts</div>
    </div>
</div>

<!-- Filters & Search -->
<div class="card">
    <form method="GET" class="form-row" style="margin-bottom: 0;">
        <div class="form-group" style="margin-bottom: 0;">
            <input type="text" name="search" placeholder="üîç Search by name or SKU..." 
                   value="{{ request.args.get('search', '') }}"
                   style="min-width: 300px;">
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
            <select name="category" onchange="this.form.submit()">
                <option value="">All Categories</option>
                {% for category in categories %}
                <option value="{{ category.id }}" {% if request.args.get('category', '0')|int == category.id %}selected{% endif %}>
                    {{ category.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
            <select name="group" onchange="this.form.submit()">
                <option value="">All Groups</option>
                {% for group in groups %}
                <option value="{{ group.id }}" {% if request.args.get('group', '0')|int == group.id %}selected{% endif %}>
                    {{ group.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
            <select name="status" onchange="this.form.submit()">
                <option value="active" {% if request.args.get('status', 'active') == 'active' %}selected{% endif %}>Active</option>
                <option value="inactive" {% if request.args.get('status') == 'inactive' %}selected{% endif %}>Inactive</option>
                <option value="all" {% if request.args.get('status') == 'all' %}selected{% endif %}>All</option>
            </select>
        </div>
        
        <button type="submit" class="btn btn-primary" style="margin-bottom: 0;">
            Search
        </button>
        
        {% if request.args.get('low_stock') %}
        <span style="background: #fff3cd; color: #856404; padding: 8px 15px; border-radius: 6px; font-weight: 600; margin-bottom: 0;">
            ‚ö†Ô∏è Showing Low Stock Items Only
        </span>
        {% endif %}
        
        {% if request.args.get('search') or request.args.get('category') or request.args.get('group') or request.args.get('status', 'active') != 'active' or request.args.get('low_stock') %}
        <a href="{{ url_for('items.index') }}" class="btn btn-secondary" style="margin-bottom: 0;">
            Clear All Filters
        </a>
        {% endif %}
    </form>
</div>

<!-- View Toggle (Mobile Only) -->
<div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
    <button id="viewToggle" class="btn btn-primary" onclick="toggleView()" style="display: none;">
        <span id="toggleIcon">üìä</span> <span id="toggleText">Table View</span>
    </button>
</div>

<!-- Items Table/Card Container -->
<div class="card">
    {% if items %}
    
    <!-- Desktop Table View (Always visible on desktop) -->
    <div id="tableView" class="desktop-table">
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>SKU</th>
                    <th>Item Name</th>
                    <th>Barcode</th>
                    <th>Type</th>
                    <th>Category</th>
                    <th>Unit</th>
                    <th>Selling Price</th>
                    <th>Cost Price</th>
                    <th>Stock</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>
                        <strong style="color: #3498db;">{{ item.sku }}</strong>
                    </td>
                    <td>
                        <div style="font-weight: 600;">{{ item.name }}</div>
                        {% if item.brand %}
                        <small style="color: #7f8c8d;">{{ item.brand }}</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.barcode %}
                        <span style="font-family: monospace; font-size: 13px; color: #27ae60; font-weight: 600;">
                            üì± {{ item.barcode }}
                        </span>
                        {% else %}
                        <span style="color: #e74c3c; font-size: 12px;">
                            ‚ö†Ô∏è No barcode
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        <span style="padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; 
                                     background: {% if item.type == 'goods' %}#e3f2fd{% else %}#f3e5f5{% endif %};
                                     color: {% if item.type == 'goods' %}#1976d2{% else %}#7b1fa2{% endif %};
                                     white-space: nowrap;">
                            {{ item.type|title }}
                        </span>
                    </td>
                    <td>
                        {% if item.category %}
                        {{ item.category.name }}
                        {% else %}
                        <span style="color: #95a5a6;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>{{ item.unit }}</td>
                    <td>
                        <strong>‚Çπ {{ "%.2f"|format(item.selling_price) }}</strong>
                    </td>
                    <td>
                        ‚Çπ {{ "%.2f"|format(item.cost_price) }}
                    </td>
                    <td>
                        {% if item.track_inventory %}
                            {% set total_stock = item.get_total_stock() %}
                            <div style="position: relative; display: inline-block; cursor: help;" 
                                 onmouseenter="showStockTooltip(this, {{ item.id }})" 
                                 onmouseleave="hideStockTooltip(this)">
                                <span style="{% if item.is_low_stock() %}color: #e74c3c; font-weight: 700;{% else %}font-weight: 600;{% endif %}">
                                    {{ "%.2f"|format(total_stock) }} üìç
                                </span>
                                {% if item.is_low_stock() %}
                                <small style="color: #e74c3c;"> ‚ö†Ô∏è Low</small>
                                {% endif %}
                                
                                <!-- Stock breakdown tooltip -->
                                <div class="stock-tooltip" style="display: none; position: absolute; 
                                     background: white; border: 2px solid #3498db; border-radius: 8px; 
                                     padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
                                     z-index: 1000; min-width: 200px; left: 50%; transform: translateX(-50%); 
                                     top: -10px; margin-top: -100%;">
                                    <div style="font-weight: 700; color: #2c3e50; margin-bottom: 8px; 
                                                border-bottom: 2px solid #ecf0f1; padding-bottom: 6px;">
                                        üì¶ Stock by Site
                                    </div>
                                    {% if item.stocks %}
                                        {% for stock in item.stocks %}
                                        <div style="display: flex; justify-content: space-between; padding: 4px 0; 
                                                    border-bottom: 1px solid #ecf0f1;">
                                            <span style="color: #7f8c8d; font-size: 13px;">{{ stock.site.name if stock.site else 'Unknown' }}</span>
                                            <span style="font-weight: 600; color: #2c3e50;">{{ "%.2f"|format(stock.quantity_available) }}</span>
                                        </div>
                                        {% endfor %}
                                        <div style="display: flex; justify-content: space-between; padding: 6px 0; 
                                                    margin-top: 6px; border-top: 2px solid #3498db; font-weight: 700;">
                                            <span style="color: #2c3e50;">Total</span>
                                            <span style="color: #3498db;">{{ "%.2f"|format(total_stock) }}</span>
                                        </div>
                                    {% else %}
                                        <div style="color: #95a5a6; font-size: 13px; text-align: center; padding: 8px;">
                                            No stock records
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                        <span style="color: #95a5a6;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.is_active %}
                        <span style="color: #28a745; font-weight: 600;">‚óè Active</span>
                        {% else %}
                        <span style="color: #dc3545; font-weight: 600;">‚óè Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <a href="{{ url_for('items.edit', item_id=item.id) }}" 
                               class="btn btn-secondary" 
                               style="padding: 8px 12px; font-size: 18px; line-height: 1;"
                               title="Edit">
                                ‚úèÔ∏è
                            </a>
                            <form method="POST" action="{{ url_for('items.delete', item_id=item.id) }}" 
                                  style="display: inline;"
                                  onsubmit="return confirm('‚ö†Ô∏è Delete {{ item.name }}?\n\nThis will also delete:\n‚Ä¢ All stock records\n‚Ä¢ All stock movements\n\nThis cannot be undone!')">
                                <button type="submit" 
                                        class="btn btn-danger" 
                                        style="padding: 8px 12px; font-size: 18px; line-height: 1;"
                                        title="Delete">
                                    üóëÔ∏è
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    </div>
    <!-- End Table View -->
    
    <!-- Mobile Card View (Default on mobile) -->
    <div id="cardView" class="mobile-cards" style="display: none;">
        {% for item in items %}
        <div class="item-card" style="background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <!-- Card Header -->
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 16px; color: #2c3e50; margin-bottom: 4px;">
                        {{ item.name }}
                    </div>
                    <div style="color: #7f8c8d; font-size: 13px;">
                        SKU: <strong style="color: #3498db;">{{ item.sku }}</strong>
                    </div>
                    {% if item.brand %}
                    <div style="color: #95a5a6; font-size: 12px; margin-top: 2px;">
                        üè∑Ô∏è {{ item.brand }}
                    </div>
                    {% endif %}
                </div>
                <div>
                    {% if item.is_active %}
                    <span style="background: #d4edda; color: #155724; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                        ‚óè Active
                    </span>
                    {% else %}
                    <span style="background: #f8d7da; color: #721c24; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                        ‚óè Inactive
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Prices Section -->
            <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                <div style="flex: 1; background: #e3f2fd; padding: 10px; border-radius: 6px;">
                    <div style="font-size: 11px; color: #1976d2; margin-bottom: 4px;">Selling Price</div>
                    <div style="font-size: 18px; font-weight: 700; color: #0d47a1;">‚Çπ{{ "%.2f"|format(item.selling_price) }}</div>
                </div>
                <div style="flex: 1; background: #fff3e0; padding: 10px; border-radius: 6px;">
                    <div style="font-size: 11px; color: #e65100; margin-bottom: 4px;">Cost Price</div>
                    <div style="font-size: 18px; font-weight: 700; color: #bf360c;">‚Çπ{{ "%.2f"|format(item.cost_price) }}</div>
                </div>
            </div>
            
            <!-- Info Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <div>
                    <div style="font-size: 11px; color: #6c757d;">Type</div>
                    <div style="font-size: 13px; font-weight: 600; color: #495057;">
                        <span style="padding: 2px 8px; border-radius: 10px; font-size: 11px; 
                                     background: {% if item.type == 'goods' %}#e3f2fd{% else %}#f3e5f5{% endif %};
                                     color: {% if item.type == 'goods' %}#1976d2{% else %}#7b1fa2{% endif %};
                                     white-space: nowrap;">
                            {{ item.type|title }}
                        </span>
                    </div>
                </div>
                <div>
                    <div style="font-size: 11px; color: #6c757d;">Category</div>
                    <div style="font-size: 13px; font-weight: 600; color: #495057;">
                        {% if item.category %}{{ item.category.name }}{% else %}‚Äî{% endif %}
                    </div>
                </div>
                <div>
                    <div style="font-size: 11px; color: #6c757d;">Unit</div>
                    <div style="font-size: 13px; font-weight: 600; color: #495057;">{{ item.unit }}</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: #6c757d;">Stock</div>
                    <div style="font-size: 13px; font-weight: 600; {% if item.is_low_stock() %}color: #e74c3c;{% else %}color: #28a745;{% endif %}">
                        {% if item.track_inventory %}
                            {{ "%.2f"|format(item.get_total_stock()) }}
                            {% if item.is_low_stock() %}‚ö†Ô∏è{% endif %}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div style="display: flex; gap: 8px; justify-content: flex-end; padding-top: 12px; border-top: 1px solid #e9ecef;">
                <a href="{{ url_for('items.edit', item_id=item.id) }}" 
                   style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
                          padding: 10px; border-radius: 6px; text-align: center; text-decoration: none; font-weight: 600; font-size: 14px;">
                    ‚úèÔ∏è Edit
                </a>
                <form method="POST" action="{{ url_for('items.delete', item_id=item.id) }}" 
                      style="flex: 1;"
                      onsubmit="return confirm('‚ö†Ô∏è Delete {{ item.name }}?\n\nThis will also delete:\n‚Ä¢ All stock records\n‚Ä¢ All stock movements\n\nThis cannot be undone!')">
                    <button type="submit" 
                            style="width: 100%; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; 
                                   padding: 10px; border-radius: 6px; border: none; font-weight: 600; font-size: 14px; cursor: pointer;">
                        üóëÔ∏è Delete
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    <!-- End Card View -->
    
    {% else %}
    <div style="text-align: center; padding: 60px 20px; color: #95a5a6;">
        <div style="font-size: 64px; margin-bottom: 20px;">üì¶</div>
        <h3 style="color: #7f8c8d; margin-bottom: 10px;">No Items Found</h3>
        <p>Start by adding your first item!</p>
        <a href="{{ url_for('items.add') }}" class="btn btn-primary" style="margin-top: 20px;">
            ‚ûï Add New Item
        </a>
    </div>
    {% endif %}
    
    <!-- Pagination Controls -->
    {% if total_pages > 1 %}
    <div style="display: flex; justify-content: center; align-items: center; margin-top: 30px; gap: 10px;">
        {% if page > 1 %}
        <a href="{{ url_for('items.index', page=page-1, category=request.args.get('category', ''), group=request.args.get('group', ''), search=request.args.get('search', ''), status=request.args.get('status', 'active'), low_stock=request.args.get('low_stock', '')) }}" 
           style="padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
            ‚Üê Previous
        </a>
        {% endif %}
        
        <span style="padding: 8px 16px; background: #f8f9fa; border-radius: 6px; font-weight: 600; color: #2c3e50;">
            Page {{ page }} of {{ total_pages }} ({{ total_items }} total items)
        </span>
        
        {% if page < total_pages %}
        <a href="{{ url_for('items.index', page=page+1, category=request.args.get('category', ''), group=request.args.get('group', ''), search=request.args.get('search', ''), status=request.args.get('status', 'active'), low_stock=request.args.get('low_stock', '')) }}" 
           style="padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
            Next ‚Üí
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>


<script>
// Stock tooltip functions
function showStockTooltip(element, itemId) {
    const tooltip = element.querySelector('.stock-tooltip');
    if (tooltip) {
        tooltip.style.display = 'block';
    }
}

function hideStockTooltip(element) {
    const tooltip = element.querySelector('.stock-tooltip');
    if (tooltip) {
        tooltip.style.display = 'none';
    }
}

// View toggle function
function toggleView() {
    const body = document.body;
    const toggleIcon = document.getElementById('toggleIcon');
    const toggleText = document.getElementById('toggleText');
    
    if (body.classList.contains('show-table')) {
        // Switch to Card View
        body.classList.remove('show-table');
        toggleIcon.textContent = 'üìä';
        toggleText.textContent = 'Table View';
        localStorage.setItem('itemsViewPreference', 'cards');
    } else {
        // Switch to Table View
        body.classList.add('show-table');
        toggleIcon.textContent = 'üì±';
        toggleText.textContent = 'Card View';
        localStorage.setItem('itemsViewPreference', 'table');
    }
}

// Load user preference on page load
document.addEventListener('DOMContentLoaded', function() {
    const preference = localStorage.getItem('itemsViewPreference');
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile && preference === 'table') {
        document.body.classList.add('show-table');
        document.getElementById('toggleIcon').textContent = 'üì±';
        document.getElementById('toggleText').textContent = 'Card View';
    }
});
</script>

{% endblock %}

