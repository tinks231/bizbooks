<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Log - {{ tenant.company_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/customer_portal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/forms.css') }}">
    <style>
        /* Override: Ensure consistent taller green header (match dashboard) */
        .portal-header {
            padding: 25px 20px !important; /* Taller header */
        }
        
        .header-left h1 {
            font-size: 24px !important;
            margin-bottom: 8px !important;
            line-height: 1.3 !important;
        }
        
        .header-left p {
            font-size: 14px !important;
            margin: 0 !important;
            line-height: 1.5 !important;
        }
        
        .main-content { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .section { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .section-title { font-size: 20px; font-weight: 600; }
        .btn-view-all { color: #4CAF50; text-decoration: none; font-size: 14px; font-weight: 500; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid #4CAF50; }
        .stat-card .icon { font-size: 24px; margin-bottom: 8px; }
        .stat-card .value { font-size: 28px; font-weight: 700; color: #333; margin-bottom: 5px; }
        .stat-card .label { color: #666; font-size: 13px; }
        
        /* Delivery Cards */
        .delivery-card { padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .delivery-card.delivered { background: #d4edda; border-left: 4px solid #4CAF50; }
        .delivery-card.paused { background: #f8d7da; border-left: 4px solid #dc3545; }
        .delivery-card.modified { background: #fff3cd; border-left: 4px solid #ffc107; }
        .delivery-date { font-weight: 600; font-size: 15px; color: #333; }
        .delivery-status { margin-left: 10px; font-size: 13px; }
        .delivery-right { text-align: right; }
        .delivery-quantity { font-size: 18px; font-weight: 700; color: #4CAF50; }
        .delivery-amount { font-size: 14px; color: #666; margin-top: 3px; }
        
        /* Action Buttons */
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-block; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #388E3C; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; }
        .modal-header { font-size: 22px; font-weight: 600; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
        .form-group input { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        
        .no-data { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="portal-header">
        <div class="header-content">
            <div class="header-left">
                <h1>Welcome, {{ session.get('customer_name', 'Customer') }}!</h1>
                <p>{{ tenant.company_name }}</p>
            </div>
            <div class="header-right">
                <a href="{{ url_for('customer_portal.profile') }}" class="btn-logout">üë§ Profile</a>
                <a href="{{ url_for('customer_portal.logout') }}" class="btn-logout">üö™ Logout</a>
            </div>
        </div>
    </div>
    
    <!-- Navigation -->
    <div class="portal-nav">
        <div class="nav-content">
            <a href="{{ url_for('customer_portal.dashboard') }}" class="nav-link">üè† Dashboard</a>
            <a href="{{ url_for('customer_portal.browse_products') }}" class="nav-link">üõçÔ∏è Products</a>
            <a href="{{ url_for('customer_portal.view_orders') }}" class="nav-link">üì¶ My Orders</a>
            <a href="{{ url_for('customer_portal.subscriptions') }}" class="nav-link active">üîÑ Subscriptions</a>
            <a href="{{ url_for('customer_portal.invoices') }}" class="nav-link">üìÑ Invoices</a>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Title -->
        <div class="section">
            <h2 style="margin: 0; font-size: 22px; color: #333;">
                üìÖ Delivery Log - {{ subscription.plan.name }}
            </h2>
        </div>
        
        <!-- Summary Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">üì¶</div>
                <div class="value">{{ total_quantity }}</div>
                <div class="label">Total {{ subscription.plan.unit_name }} Delivered</div>
            </div>
            <div class="stat-card">
                <div class="icon">üí∞</div>
                <div class="value">‚Çπ{{ '{:,.2f}'.format(total_amount) }}</div>
                <div class="label">Total Amount</div>
            </div>
            <div class="stat-card">
                <div class="icon">‚è∏Ô∏è</div>
                <div class="value">{{ paused_days }}</div>
                <div class="label">Paused Days</div>
            </div>
            <div class="stat-card">
                <div class="icon">‚úèÔ∏è</div>
                <div class="value">{{ modified_days }}</div>
                <div class="label">Modified Days</div>
            </div>
        </div>
        
        <!-- Monthly Deliveries (Collapsible Accordion) -->
        {% for month_data in monthly_summaries %}
        <div class="section">
            <!-- Month Header (Clickable) -->
            <div class="month-header" onclick="toggleMonth('month-{{ loop.index }}')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 2px solid #f0f0f0;">
                <div>
                    <h3 style="margin: 0; font-size: 20px; color: #333;">
                        üìÖ {{ month_data.month_name }}
                        {% if month_data.is_current_month %}
                            <span style="background: #4CAF50; color: white; padding: 2px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px;">CURRENT</span>
                        {% endif %}
                    </h3>
                    <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">
                        {{ month_data.total_quantity }} {{ subscription.plan.unit_name }} delivered ‚Ä¢ ‚Çπ{{ '{:,.2f}'.format(month_data.total_amount) }}
                    </p>
                </div>
                <span id="month-{{ loop.index }}-icon" style="font-size: 24px; transition: transform 0.3s;">
                    {% if month_data.is_current_month %}‚ñº{% else %}‚ñ∂{% endif %}
                </span>
            </div>
            
            <!-- Month Content (Collapsible) -->
            <div id="month-{{ loop.index }}-content" class="month-content" style="display: {% if month_data.is_current_month %}block{% else %}none{% endif %}; margin-top: 20px;">
                {% if month_data.deliveries %}
                    {% for date, delivery in month_data.deliveries.items() | sort %}
                    {% set is_today = date == today %}
                    {% set is_past = date < today %}
                    <div class="delivery-card {% if delivery.status == 'paused' %}paused{% elif delivery.is_modified %}modified{% else %}delivered{% endif %}" style="{% if is_past or is_today %}opacity: 0.6; border-left-color: #999;{% endif %}">
                        <div>
                            <span class="delivery-date">{{ date.strftime('%a, %d %B %Y') }}</span>
                            {% if is_today %}
                                <span class="delivery-status" style="color: #4CAF50;">ü•õ Today (Already Delivered)</span>
                            {% elif is_past %}
                                <span class="delivery-status" style="color: #999;">üìÖ Past</span>
                            {% elif delivery.status == 'paused' %}
                                <span class="delivery-status" style="color: #dc3545;">‚è∏Ô∏è PAUSED</span>
                            {% elif delivery.is_modified %}
                                <span class="delivery-status" style="color: #ffc107;">‚úèÔ∏è Modified</span>
                            {% endif %}
                        </div>
                        <div class="delivery-right">
                            {% if delivery.status != 'paused' %}
                                <div class="delivery-quantity">{{ delivery.quantity }} {{ subscription.plan.unit_name }}</div>
                                <div class="delivery-amount">‚Çπ{{ '{:,.2f}'.format(delivery.amount) }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-data">
                        <p>No deliveries for this month.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
        <!-- Action Buttons (Fixed at bottom) -->
        <div class="section">
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="openModal('pauseModal')">‚è∏Ô∏è Pause Deliveries</button>
                <button class="btn btn-secondary" onclick="openModal('resumeModal')">‚ñ∂Ô∏è Resume Deliveries</button>
                <button class="btn btn-secondary" onclick="openModal('modifyModal')">‚úèÔ∏è Modify Quantity</button>
            </div>
        </div>
    </div>
    
    <!-- Pause Modal -->
    <div id="pauseModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header">‚è∏Ô∏è Pause Deliveries</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">‚ö†Ô∏è You can only pause from tomorrow onwards (today's milk is already on its way! ü•õ)</p>
            <form method="POST" action="{{ url_for('customer_portal.pause_deliveries', subscription_id=subscription.id) }}">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" name="start_date" min="{{ tomorrow.isoformat() }}" required>
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" name="end_date" min="{{ tomorrow.isoformat() }}" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Pause</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('pauseModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Resume Modal -->
    <div id="resumeModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header">‚ñ∂Ô∏è Resume Deliveries</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">‚ö†Ô∏è You can only resume from tomorrow onwards (today's milk is already on its way! ü•õ)</p>
            <form method="POST" action="{{ url_for('customer_portal.resume_deliveries', subscription_id=subscription.id) }}">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" name="start_date" min="{{ tomorrow.isoformat() }}" required>
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" name="end_date" min="{{ tomorrow.isoformat() }}" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Resume</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('resumeModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modify Modal -->
    <div id="modifyModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header">‚úèÔ∏è Modify Quantity</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">‚ö†Ô∏è You can only modify from tomorrow onwards (today's milk is already on its way! ü•õ)</p>
            <form method="POST" action="{{ url_for('customer_portal.modify_delivery', subscription_id=subscription.id) }}">
                <div class="form-group">
                    <label>Delivery Date</label>
                    <input type="date" name="delivery_date" min="{{ tomorrow.isoformat() }}" required>
                </div>
                <div class="form-group">
                    <label>New Quantity ({{ subscription.plan.unit_name }})</label>
                    <input type="number" name="new_quantity" step="0.1" min="0.1" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Modify</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modifyModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }
    
    // Toggle month accordion
    function toggleMonth(monthId) {
        const content = document.getElementById(monthId + '-content');
        const icon = document.getElementById(monthId + '-icon');
        
        if (content.style.display === 'none' || content.style.display === '') {
            content.style.display = 'block';
            icon.textContent = '‚ñº';
        } else {
            content.style.display = 'none';
            icon.textContent = '‚ñ∂';
        }
    }
    
    // Close modal on background click
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(this.id);
            }
        });
    });
    </script>
</body>
</html>
